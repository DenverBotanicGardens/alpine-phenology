---
title: "Code in one block"
author: "Michelle DePrenger-Levin"
date: "January 27, 2017"
output: html_document
---
load libraries   
```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
library(Taxonstand)
library(directlabels)
```

#Fresh start
Save the GDD variables - those take hours to calculate/extract
```{r, eval=FALSE}
rm(list= setdiff(ls(), c("avgTemps.max","avgTemps.min","tmps","HDD","HDD.all", "HDD.yrs")))
```

Functions
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "SpeciesAuthority","Species", "Fam", "adj.r.squ","ID",
                   "Duration","GrowthHabit")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

# exact match multisub <http://stackoverflow.com/questions/15253954/replace-multiple-arguments-with-gsub>
multisub <- function(pattern, replacement, x){
  result <- x
    for(i in 1:length(pattern)){
      result <- gsub(pattern = paste("^",pattern[i],"$",sep=""),
                     replacement = replacement[i], result)
      }
  result
}


appd <- function(x){
  x <- merge(x,merge.name[!duplicated(merge.name$ID),c("ID","scientificName","AUTH",
                                                       "Growth.Habit","Duration")], 
                      by.x = "Species", by.y = "scientificName")
  lmodel <- paste("F(",x$numDF,",",x$denDF,") = ",round(x$`F Stat`,2),
                  ", Slope = ",round(x$Slope,2),
                  ", p-value = ", round(x$p.value,2),
                  ", r2 = ", round(x$adj.r.squ,2), 
                  sep = "")
  data.frame(Family = x$Fam,
             Species = x$AUTH,
             Sp = x$Species,
             GrowthHabit = x$Growth.Habit,
             Duration = x$Duration,
             CollectionDate = lmodel)
  }

```

Herbarium collections linked with synonomy
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/CO_SEINet_3200_20160304.csv"))

colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr","Bud")
colo.sm <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE,ignore.case = TRUE)),]

colo.sm <- colo[,c(1,5,40,13,31,32,21,22,23,24)] #added 5 = Authority

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm <- colo.sm[nchar(colo.sm$Year)==4,] #keep years with 4 digits 
colo.sm <- colo.sm[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year),] #keep ones that are 4 digits but all numeric
colo.sm <- colo.sm[colo.sm$Year>=1950,] #only years 1950 and beyond, before 2011
colo.sm <- colo.sm[colo.sm$Year<2012,] #only years 1950 and beyond, before 2012

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
max.meter <- 14500/3.2808
colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[colo.sm$elevation<max.meter,] #four are recorded wrong
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))

colo.sm <- colo.sm[!is.na(colo.sm$startDayOfYear),]

#SEINet
seinet <- seinet[seinet$scientificName!="",]
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert","fl","Fr")
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]
seinet.sm <- seinet[,c(12,14,13,56,63:64,31,73,34,2)]
# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]
# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]
# Remove any rows missing startDayOfYear
seinet.sm <- seinet.sm[!is.na(seinet.sm$startDayOfYear),]

colo.sm$institutionCode <- "COLO"
names <- names(colo.sm[,c(1:3,5:6,11:14)]) 
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:3,5:6,11:14)]
seinet.bind <- seinet.sm[,-4] #take out state
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)

#All herbarium records
bloom2 <- rbind(seinet.bind,colo.bind) 

proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3,9) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:(length(bloom2)-1))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)

bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# To correct as many typos/errors from the herbarium sheets
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

# for each row
bloom2$scientificName <- multisub(fixbloom2$Wrong.1,
                                  fixbloom2$Replacement,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]



# Use this list to merge synonyms that have unique IDs synonyms
synonyms2 <- read.csv("Q:/Research/Projects/alpine-phenology/synonyms2_MI.csv")

bloom2$scientificName <- multisub(synonyms2$Species, 
                                  synonyms2$SYNONYMS, bloom2$scientificName)


synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt")) # from DBG database taken from USDA (got from Rick)


#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.",
                          synonyms$SYNONYMS)

synonyms <- synonyms[synonyms$AUTH %in% grep("auct.", synonyms$AUTH, value = TRUE, invert = TRUE),]
synonyms <- synonyms[synonyms$AUTH %in% grep(" non ", synonyms$AUTH, value = TRUE, invert = TRUE),]
# Agroelymus adamsii is in there twice with all the same information
synonyms <- unique(synonyms) # gets rid of 13 rows
synonyms <- synonyms[synonyms$AUTH != "Aster foliaceus Lindl. ex DC., database artifact",]


# Accepted name according to USDA
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",") # missing those extra ones but including life habit... and indicating which are accepted (to later be double checked according to akerfield.) 
# Merge is an exact match, that's what we want

f <- sapply(plantsyn, is.factor)
plantsyn[f] <- lapply(plantsyn[f], as.character)

#A. Remove Antennaria parvifolia sensu Greene, non Nutt. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author != "sensu Greene, non Nutt.",]

#Remove auct. non. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author %in% 
                       grep("auct.", plantsyn$Genera.Binomial.Author,
                            value = TRUE, invert = TRUE),]
# in as non Poir, want real Anemone mutifida as accepted name, not synonym for Pulsatilla patens ssp. multifida
plantsyn$Synonym.Symbol[plantsyn$Synonym.Symbol == "ANMU8"] <- ""

# plantsyn is missing both the synonym Chlorocrepis tristis and accepted name Hieracium triste.
plantsyn <- rbind(plantsyn, c("HITR2","","HITR2","Hieracium triste","","Hieracium","",
                              "triste","","",
                              "","","","","","","","","","","","","","",
                              "Asteraceae","Perennial","Forb/herb",
                              "L48 (N), AK (N), CAN (N)", "Late Summer",
                              "",""))










synonyms$ID[synonyms$SYNONYMS=="Eritrichium aretioides"]<-
  synonyms$ID[synonyms$SYNONYMS=="Eritrichium nanum var. elongatum"]









bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")




```


Figures and Tables
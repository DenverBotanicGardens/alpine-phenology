---
title: "Code in one block"
author: "Michelle DePrenger-Levin"
date: "January 27, 2017"
output: html_document
---
load libraries   
```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
library(Taxonstand)
library(directlabels)
```

#Fresh start
Save the GDD variables - those take hours to calculate/extract
```{r, eval=FALSE}
rm(list= setdiff(ls(), c("avgTemps.max","avgTemps.min","tmps","HDD","HDD.all", "HDD.yrs")))
```

Functions
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "SpeciesAuthority","Species", "Fam", "adj.r.squ","ID",
                   "Duration","GrowthHabit")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

# exact match multisub <http://stackoverflow.com/questions/15253954/replace-multiple-arguments-with-gsub>
multisub <- function(pattern, replacement, x){
  result <- x
    for(i in 1:length(pattern)){
      result <- gsub(pattern = paste("^",pattern[i],"$",sep=""),
                     replacement = replacement[i], result)
      }
  result
}

```

Herbarium collections linked with synonomy
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/CO_SEINet_3200_20160304.csv"))

colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr","Bud")
colo.sm <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE,ignore.case = TRUE)),]

colo.sm <- colo[,c(1,5,40,13,31,32,21,22,23,24)] #added 5 = Authority

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm <- colo.sm[nchar(colo.sm$Year)==4,] #keep years with 4 digits 
colo.sm <- colo.sm[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year),] #keep ones that are 4 digits but all numeric
colo.sm <- colo.sm[colo.sm$Year>=1950,] #only years 1950 and beyond, before 2011
colo.sm <- colo.sm[colo.sm$Year<2012,] #only years 1950 and beyond, before 2012

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
max.meter <- 14500/3.2808
colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[colo.sm$elevation<max.meter,] #four are recorded wrong
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))

colo.sm <- colo.sm[!is.na(colo.sm$startDayOfYear),]

#SEINet
seinet <- seinet[seinet$scientificName!="",]
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert","fl","Fr")
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]
seinet.sm <- seinet[,c(12,14,13,56,63:64,31,73,34,2)]
# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]
# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]
# Remove any rows missing startDayOfYear
seinet.sm <- seinet.sm[!is.na(seinet.sm$startDayOfYear),]

colo.sm$institutionCode <- "COLO"
names <- names(colo.sm[,c(1:3,5:6,11:14)]) 
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:3,5:6,11:14)]
seinet.bind <- seinet.sm[,-4] #take out state
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)

##############################################################
##############################################################
##############################################################
#All herbarium records
bloom2 <- rbind(seinet.bind,colo.bind) 

proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3,9) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:(length(bloom2)-1))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)

bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# To correct as many typos/errors from the herbarium sheets
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

# for each row
bloom2$scientificName <- multisub(fixbloom2$Wrong.1,
                                  fixbloom2$Replacement,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]



# Use this list to merge synonyms that have unique IDs synonyms
synonyms2 <- read.csv("Q:/Research/Projects/alpine-phenology/synonyms2_MI.csv")

bloom2$scientificName <- multisub(synonyms2$Species, 
                                  synonyms2$SYNONYMS, bloom2$scientificName)

## One set of collection in SEINet entered as 02/07/1996 should be July 2, not Feb 7th.
bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1996] <- 184
bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 1996] <- 184
bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1998] <- 183
bloom2$startDayOfYear[bloom2$startDayOfYear == 8 & bloom2$Year == 2001] <- 213 #Aug 1, 2001
bloom2$startDayOfYear[bloom2$startDayOfYear == 66 & bloom2$Year == 2009] <- 184 #July 3, 2009
bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 2004] <- 185 #July 3, 2004 leap year


##############################################################
##############################################################
##############################################################



synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt")) # from DBG database taken from USDA (got from Rick)


#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.",
                          synonyms$SYNONYMS)

synonyms <- synonyms[synonyms$AUTH %in% grep("auct.", synonyms$AUTH, value = TRUE, invert = TRUE),]
synonyms <- synonyms[synonyms$AUTH %in% grep(" non ", synonyms$AUTH, value = TRUE, invert = TRUE),]
# Agroelymus adamsii is in there twice with all the same information
synonyms <- unique(synonyms) # gets rid of 13 rows
synonyms <- synonyms[synonyms$AUTH != "Aster foliaceus Lindl. ex DC., database artifact",]


# Accepted name according to USDA
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",") # missing those extra ones but including life habit... and indicating which are accepted (to later be double checked according to akerfield.) 
# Merge is an exact match, that's what we want

f <- sapply(plantsyn, is.factor)
plantsyn[f] <- lapply(plantsyn[f], as.character)

#A. Remove Antennaria parvifolia sensu Greene, non Nutt. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author != "sensu Greene, non Nutt.",]

#Remove auct. non. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author %in% 
                       grep("auct.", plantsyn$Genera.Binomial.Author,
                            value = TRUE, invert = TRUE),]
# in as non Poir, want real Anemone mutifida as accepted name, not synonym for Pulsatilla patens ssp. multifida
plantsyn$Synonym.Symbol[plantsyn$Synonym.Symbol == "ANMU8"] <- ""

# plantsyn is missing both the synonym Chlorocrepis tristis and accepted name Hieracium triste.
plantsyn <- rbind(plantsyn, c("HITR2","","HITR2","Hieracium triste","","Hieracium","",
                              "triste","","",
                              "","","","","","","","","","","","","","",
                              "Asteraceae","Perennial","Forb/herb",
                              "L48 (N), AK (N), CAN (N)", "Late Summer",
                              "",""))


plantsyn$Scientific.Name <- multisub(synonyms2$Species,
                     synonyms2$SYNONYMS, plantsyn$Scientific.Name)
plantsyn <- plantsyn[!is.na(plantsyn$Scientific.Name),]

synonyms$ID[synonyms$SYNONYMS=="Eritrichium aretioides"]<-
  synonyms$ID[synonyms$SYNONYMS=="Eritrichium nanum var. elongatum"]

synonyms.plantsyn <- merge(synonyms,plantsyn,by.x="SYNONYMS",by.y="Scientific.Name")
synonyms.plantsyn <- synonyms.plantsyn[!duplicated(synonyms.plantsyn$SYNONYMS),]
synonyms.plantsyn.accpt <- synonyms.plantsyn[synonyms.plantsyn$Synonym.Symbol=="",]
synonyms.plantsyn.accpt$ID   <- as.numeric(synonyms.plantsyn.accpt$ID)




bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")


##########################################################
##########################################################
##########################################################
# Just the first collection per species per year
earl.sp.yr <- do.call(rbind,
                      lapply(split(bloom.sp, bloom.sp$ID), function(id){
                        id <- id[order(id$Year),]
                        id$DataYrs <- nrow(id[!duplicated(id$Year) & !is.na(id$Year),])
                        rows <- aggregate(startDayOfYear~Year, id, FUN=min)
                        out <- merge(id, rows, by=c("startDayOfYear","Year"))
                        out <- out[order(out$Year),]
                        out <- out[!duplicated(out$Year),]
                        out
                        })
)

sp.10plus <- earl.sp.yr[earl.sp.yr$DataYrs>=10,] #413
merge.name.accpt <- merge(sp.10plus, synonyms.plantsyn.accpt, by = "ID") #390

##########################################################
earliestcollection <- data.frame(colSums(table(merge.name.accpt$ID,
                                               merge.name.accpt$Year)))

earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),] # 1998 342
mean(earcol$Collections) #168.4098 -> 165.0656


allcollections <- data.frame(colSums(table(bloom.sp$ID,bloom.sp$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])

library(RCurl)
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/QR_final_R_plant_climate_data_2.csv"))

bloom$Raw_Precip <- (bloom$Raw_Precip)/100

merge.name.accpt <- merge(merge.name.accpt,unique(bloom[,c(19,20,21,23)]), by="Year")
unbloom <- unique(bloom[,c(19,20,21,23)])

```

Growing Degree Days
```{r}
tmps <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/tmps.csv"))

totalGDD <- lapply(split(tmps, tmps$Year), function(year){
  max(year$HDD)
})
totalGDDyr <- data.frame(Year=1981:2011, MaxGDD = do.call(rbind, totalGDD))

min1950GDD_2 <- mergeMinGDD(merge.name.accpt,tmps)
gdddatayrs <- as.data.frame(table(min1950GDD_2$Year,min1950GDD_2$ID))
yrspsp <- aggregate(gdddatayrs$Freq, by = list(gdddatayrs$Var2), FUN=sum)
min1950GDD_2_10 <- merge(min1950GDD_2,yrspsp[yrspsp$x>=10,],
                         by.x="ID",by.y="Group.1") #312
min1950GDDmax <- merge(totalGDDyr,min1950GDD_2_10, by="Year")

```







#Figures and Tables
Figure 1a
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of species collected")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()

```

Figure 1b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()

```

Table Year and Ordinal day
```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",merge.name.accpt)

nrow(yr.1950_2) #390

write.table(yr.1950_2, file = "Q:/Research/Projects/alpine-phenology/phensum_yr_390.csv", sep=",")

nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #344
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #46

# select random subset of 20 species that did signficantly change over time and 20 that did not

sig.rows <- which(yr.1950_2$p.value<0.05)
set.seed(123)
yr.1950_2[sample(sig.rows,20,replace=FALSE),c("Species","ID")]
nonsig.rows <- which(yr.1950_2$p.value>=0.05)
set.seed(123)
non.sig.sp <- yr.1950_2[sample(nonsig.rows,20,replace=FALSE),c("Species","ID")]
synonyms.plantsyn[synonyms.plantsyn$ID %in% non.sig.sp$ID,]
synonyms[synonyms$SYNONYMS == "Senecio fremontii var. blitoides",]
sig.sp <- c(9042,1125,8243,6934,45837,17265,14088,35604,41517)  ###START HERE

nrow(yr.1950_2[yr.1950_2$p.value<0.05,])/nrow(yr.1950_2) #0.1179487

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #46
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #-0.5320037
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0])*61 #-32.45222
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #0.2201669

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,]) #4->0

mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #NaN
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])*61
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #NaN
```

Figure 3a
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Avg_Hi))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression("Average high"~degree*C)) + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8))

dev.off()

summary(lm(Avg_Hi~Year, data=unbloom))
```

Figure 3b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)


ggplot(unbloom, aes(Year,Avg_Lo))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab(expression("Average low"~degree*C))+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Avg_Lo~Year, data = unbloom))

```

Figure 3c
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Raw_Precip))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Raw_Precip~Year, data = unbloom))

```


Figure 3d 
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point(size=0.5,shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab(expression(paste("Maximum GDD (T"[base] == 0, degree*C,")")))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(MaxGDD~Year,data=totalGDDyr))


```


Figure 4
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4.tiff", width = 174, height = 150, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 

dev.off()

summary(lm(startDayOfYear~Year, data=merge.name.accpt))
```

Table Ordinal by high temp
```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", merge.name.accpt)

nrow(high.1950_2) #390
write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2_390.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,]) #78
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.2

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,])  #76
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) # -10.73682
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) #0.2187169

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) # 2
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(high.1950_2$Species[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0],
                                collapse="|"), high.1950_2$Species, value=TRUE)])

mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #8.893071
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #0.3025555

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.2
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2) #0.8

```

Table Ordinal by low temp
```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", merge.name.accpt)

nrow(low.1950_2) #390

write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2_390.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #73
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2) #0.1871795
mean(low.1950_2$Slope) #-4.317658

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #72
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #-9.367761
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #0.1693134

#later
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #1
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(
      low.1950_2$Species[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]
      ,
                                collapse="|"), low.1950_2$Species, value=TRUE)]) #Crepis nana Richardson
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #10.08779
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #0.249457
```

Table Ordinal on Precip
```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", merge.name.accpt)

write.table(precip.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2_390.csv", sep=",")

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #35
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2) # 0.08974359
mean(precip.1950_2$Slope) #0.02084484


#earlier
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #2
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                               precip.1950_2$ID[precip.1950_2$p.value<0.05 & 
                                                  precip.1950_2$Slope<0])]) 
# Oxytropis borealis var. viscida and Dryas octopetala ssp. hookeriana
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) # -0.05841561
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) #0.2260552

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #33
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.07953377
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.2242796

```

Table Ordinal by maxGDD
```{r}
rst <- JulBloomDate.min1950("MaxGDD", min1950GDDmax)

nrow(rst) #312
nrow(rst[rst$p.value<0.05,]) #65

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #64
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -0.06205813
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.2570596

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) #1
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                             rst$ID[rst$p.value<0.05 & rst$Slope>=0])]) #Sambucus racemosa L. var. racemosa
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) # 0.06436998
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) #0.2293882


write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_max_312.csv", sep=",")

```

Figure 5a
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Avg_Hi, startDayOfYear))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=7))


dev.off()

summary(lm(startDayOfYear~Avg_Hi, data=merge.name.accpt))

```

Figure 5b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1, size= 0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Avg_Lo, data = merge.name.accpt))
```

Figure 5c 
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1,size=0.25)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Raw_Precip, data = merge.name.accpt))
```

Figure 5d
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDDmax, aes( MaxGDD, startDayOfYear))+
  geom_point(shape=1, size=0.5)+
  geom_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab("Maximum annual GDD")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~MaxGDD, data = min1950GDDmax))

```


#NPN
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

npn.all$SciName <- multisub(synonyms2$Species,
                            synonyms2$SYNONYMS,npn.all$SciName)
npn.all <- npn.all[!is.na(npn.all$SciName),]

npn.big2 <- intersect(npn.all$SciName, merge.name.accpt$scientificName)
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big2) #27
length(npn.big) #75


npn.ID <- merge(npn.all, synonyms, by.x = "SciName", by.y = "SYNONYMS")
length(unique(npn.ID$ID)) #716

npn.min1950 <- merge(npn.ID, merge.name.accpt, by ="ID")
length(unique(npn.min1950$ID)) #28
unique(npn.min1950$SciName)

```

Table NPN year ordinal
```{r}
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

nrow(yr.npn_2) #28 
mean(yr.npn_2$Slope) #-0.2734498

write.table(yr.npn_2, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr_28.csv", sep=",")
nrow(yr.npn_2[yr.npn_2$p.value<0.05,]) #5
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2) #0.1785714

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) #5
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       yr.npn_2$ID[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0])])
#Salix petrophila Rydb.                     
#Salix planifolia Pursh                     
#Castilleja miniata Douglas ex Hook.        
#Calamagrostis canadensis (Michx.) P. Beauv.
#Aquilegia coerulea James  

mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #-0.5049358
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #0.1831828

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #0
```

Table NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

nrow(high.npn_2) #28

write.table(high.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2_28.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,]) #5

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) #5

unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       high.npn_2$ID[high.npn_2$p.value<0.05 &
                                                       high.npn_2$Slope<0])])
#Mimulus guttatus DC.                               
#Picea engelmannii Parry ex Engelm. var. engelmannii
#Salix planifolia Pursh                             
#Achillea millefolium L.                            
#Lonicera involucrata (Richardson) Banks ex Spreng.

mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #-13.82806
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #0.2228063

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) #0

```
Table NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

nrow(low.npn_2) #28
mean(low.npn_2$Slope) #-6.216788

write.table(low.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_2_28.csv", sep=",")

nrow(low.npn_2[low.npn_2$p.value<0.05,]) #8
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2) #0.2857143

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) # 8

mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #-10.32498
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #0.1659896

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,]) #0
```

Table NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

nrow(precip.NPN_2) #28

write.table(precip.NPN_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_precip_28.csv", sep=",")

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #2
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2) #0.07142857

#earlier
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0,]) #1
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #-0.05341472
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #0.1559357

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) #1
unique(merge.name.accpt$AUTH.x[which(merge.name.accpt$ID %in%
                                 precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                                   precip.NPN_2$Slope>=0])])
#Erythronium grandiflorum Pursh
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.09425329
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.4683842

```

NPN Growing Degree Days
```{r}
minNPNGDDmax <- merge(totalGDDyr,npn.min1950, by="Year")

npngdd <- data.frame(table(minNPNGDDmax$Year,minNPNGDDmax$ID))

ID.10 <- aggregate(npngdd$Freq, list(npngdd$Var2), sum)
minNPNGDD_2 <- merge(minNPNGDDmax, ID.10[ID.10$x >=10,], by.x = "ID", by.y = "Group.1")

length(unique(minNPNGDD_2$ID)) #24

rst.npn <- JulBloomDate.min1950("MaxGDD", minNPNGDD_2)

nrow(rst.npn) #24
nrow(rst.npn[rst.npn$p.value<0.05,]) #2

#lower GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #2
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) # -0.05353431
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope< 0]) # 0.1801672
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                                rst.npn$ID[rst.npn$p.value<0.05 & rst.npn$Slope < 0])])
#Achillea millefolium L.                    
#Calamagrostis canadensis (Michx.) P. Beauv.

#bigger GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) #0

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_24.csv", sep=",")

```





---
title: "Code in one block"
author: "Michelle DePrenger-Levin"
date: "January 27, 2017"
output: html_document
---
load libraries   
```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
library(Taxonstand)
library(directlabels)
```

#Fresh start
Save the GDD variables - those take hours to calculate/extract
```{r, eval=FALSE}
rm(list=ls())
```

Functions
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1], #Intercept
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "SpeciesAuthority","Species", "Fam", "adj.r.squ","ID",
                   "Duration","GrowthHabit")
  JYC
}


mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

# exact match multisub <http://stackoverflow.com/questions/15253954/replace-multiple-arguments-with-gsub>
multisub <- function(pattern, replacement, x){
  result <- x
    for(i in 1:length(pattern)){
      result <- gsub(pattern = paste("^",pattern[i],"$",sep=""),
                     replacement = replacement[i], result)
      }
  result
}

```

Herbarium collections linked with synonomy
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/CO_SEINet_3200_20160304.csv"))

colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,colo$InfraInfo,sep=" ")

#trim leading trailing whitespace
colo$scientificName <- trimws(colo$scientificName)

#remove authoritiy... just keep the first 4 words Genus species var. variety
colo$scientificName <- sapply(1:length(colo$scientificName),
                              function(x){
  newname <- if(sapply(gregexpr("\\W+", colo$scientificName[x]), length) + 1 > 2) {
        ul <- unlist(strsplit(colo$scientificName[x], split="\\s+"))[1:4]
        paste(ul,collapse = " ")
        } else {
          colo$scientificName[x]
        }
  newname
  })


colo$scientificName <- gsub(pattern = "var", replacement = "var.",
                            colo$scientificName)
colo$scientificName <- gsub(pattern = "ssp", replacement = "ssp.",
                            colo$scientificName)

colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr","Bud")
colo.sm1 <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE,ignore.case = TRUE)),]

colo.sm <- colo.sm1[,c(1,5,40,13,31,32,21,22,23,24)] #added 5 = Authority

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm <- colo.sm[nchar(colo.sm$Year)==4,] #keep years with 4 digits 
colo.sm <- colo.sm[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year),] #keep ones that are 4 digits but all numeric
colo.sm <- colo.sm[colo.sm$Year>=1950,] #only years 1950 and beyond, before 2011
colo.sm <- colo.sm[colo.sm$Year<2012,] #only years 1950 and beyond, before 2012

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
max.meter <- 14500/3.2808
colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[colo.sm$elevation<max.meter,] #four are recorded wrong
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))

colo.sm <- colo.sm[!is.na(colo.sm$startDayOfYear),]

#SEINet
seinet <- seinet[seinet$scientificName!="",]
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert","fl","Fr")
seinet.sm1 <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]
seinet.sm <- seinet.sm1[,c(12,14,13,56,63:64,31,73,34,2)]
# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]
# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]
#Mt Elbert is highest peak at 14,439ft == 4401meters
seinet.sm <- seinet.sm[seinet.sm$minimumElevationInMeters < 4402,]
# Remove any rows missing startDayOfYear
seinet.sm <- seinet.sm[!is.na(seinet.sm$startDayOfYear),]

colo.sm$institutionCode <- "COLO"
names <- names(colo.sm[,c(1:3,5:6,11:14)]) 
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:3,5:6,11:14)]
seinet.bind <- seinet.sm[,-4] #take out state
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)

##############################################################
##############################################################
##############################################################
#All herbarium records
bloom2 <- rbind(seinet.bind,colo.bind) 

proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3,9) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:(length(bloom2)-1))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)

bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# To correct as many typos/errors from the herbarium sheets
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

# for each row
bloom2$scientificName <- multisub(fixbloom2$Wrong.1,
                                  fixbloom2$Replacement,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]



# Use this list to merge synonyms that have unique IDs synonyms
synonyms2 <- read.csv("Q:/Research/Projects/alpine-phenology/synonyms2_MI.csv")

bloom2$scientificName <- multisub(synonyms2$Species, 
                                  synonyms2$SYNONYMS, bloom2$scientificName)

## One set of collection in SEINet entered as 02/07/1996 should be July 2, not Feb 7th.
bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1996] <- 184
bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 1996] <- 184
bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1998] <- 183
bloom2$startDayOfYear[bloom2$startDayOfYear == 8 & bloom2$Year == 2001] <- 213 #Aug 1, 2001
bloom2$startDayOfYear[bloom2$startDayOfYear == 66 & bloom2$Year == 2009] <- 184 #July 3, 2009
bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 2004] <- 185 #July 3, 2004 leap year


##############################################################
##############################################################
##############################################################



synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt")) # from DBG database taken from USDA (got from Rick)


#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.",
                          synonyms$SYNONYMS)

synonyms <- synonyms[synonyms$AUTH %in% grep("auct.", synonyms$AUTH, value = TRUE, invert = TRUE),]
synonyms <- synonyms[synonyms$AUTH %in% grep(" non ", synonyms$AUTH, value = TRUE, invert = TRUE),]
# Agroelymus adamsii is in there twice with all the same information
synonyms <- unique(synonyms) # gets rid of 13 rows
synonyms <- synonyms[synonyms$AUTH != "Aster foliaceus Lindl. ex DC., database artifact",]


# Accepted name according to USDA
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",") # missing those extra ones but including life habit... and indicating which are accepted (to later be double checked according to akerfield.) 
# Merge is an exact match, that's what we want

f <- sapply(plantsyn, is.factor)
plantsyn[f] <- lapply(plantsyn[f], as.character)

#A. Remove Antennaria parvifolia sensu Greene, non Nutt. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author != "sensu Greene, non Nutt.",]

#Remove auct. non. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author %in% 
                       grep("auct.", plantsyn$Genera.Binomial.Author,
                            value = TRUE, invert = TRUE),]
# in as non Poir, want real Anemone mutifida as accepted name, not synonym for Pulsatilla patens ssp. multifida
plantsyn$Synonym.Symbol[plantsyn$Synonym.Symbol == "ANMU8"] <- ""

# plantsyn is missing both the synonym Chlorocrepis tristis and accepted name Hieracium triste.
plantsyn <- rbind(plantsyn, c("HITR2","","HITR2","Hieracium triste","","Hieracium","",
                              "triste","","",
                              "","","","","","","","","","","","","","",
                              "Asteraceae","Perennial","Forb/herb",
                              "L48 (N), AK (N), CAN (N)", "Late Summer",
                              "",""))

#could add Erigeron peregrinus ssp. callianthemus, only have E. peregrinus ssp. callianthemus var. callianthemus... not doing it now.


plantsyn$Scientific.Name <- multisub(synonyms2$Species,
                     synonyms2$SYNONYMS, plantsyn$Scientific.Name)
plantsyn <- plantsyn[!is.na(plantsyn$Scientific.Name),]

synonyms$ID[synonyms$SYNONYMS=="Eritrichium aretioides"]<-
  synonyms$ID[synonyms$SYNONYMS=="Eritrichium nanum var. elongatum"]

synonyms.plantsyn <- merge(synonyms,plantsyn,by.x="SYNONYMS",by.y="Scientific.Name")
synonyms.plantsyn <- synonyms.plantsyn[!duplicated(synonyms.plantsyn$SYNONYMS),]

# Caught error in final table
synonyms.plantsyn$ID[grep("Cerastium bee", synonyms.plantsyn$SYNONYMS)] <- 9608
synonyms.plantsyn$ID[grep("Carex scirpoi", synonyms.plantsyn$SYNONYMS)] <- 8637
synonyms.plantsyn$ID[synonyms.plantsyn$ID == 18057] <- 18059
synonyms.plantsyn$ID[synonyms.plantsyn$ID == 36505] <- 36459

synonyms.plantsyn.accpt <- synonyms.plantsyn[synonyms.plantsyn$Synonym.Symbol=="",]
synonyms.plantsyn.accpt$ID   <- as.numeric(synonyms.plantsyn.accpt$ID)




bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")


##########################################################
##########################################################
##########################################################
# Just the first collection per species per year
earl.sp.yr <- do.call(rbind,
                      lapply(split(bloom.sp, bloom.sp$ID), function(id){
                        id <- id[order(id$Year),]
                        id$DataYrs <- nrow(id[!duplicated(id$Year) & !is.na(id$Year),])
                        rows <- aggregate(startDayOfYear~Year, id, FUN=min)
                        out <- merge(id, rows, by=c("startDayOfYear","Year"))
                        out <- out[order(out$Year),]
                        out <- out[!duplicated(out$Year),]
                        out
                        })
)

sp.10plus <- earl.sp.yr[earl.sp.yr$DataYrs>=10,] #413
merge.name.accpt <- merge(sp.10plus, synonyms.plantsyn.accpt, by = "ID") #389

##########################################################
earliestcollection <- data.frame(colSums(table(merge.name.accpt$ID,
                                               merge.name.accpt$Year)))

earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),] # 1998 346
mean(earcol$Collections) #165.4262


allcollections <- data.frame(colSums(table(bloom.sp$ID,bloom.sp$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])

library(RCurl)
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/QR_final_R_plant_climate_data_2.csv"))

bloom$Raw_Precip <- (bloom$Raw_Precip)/100

merge.name.accpt <- merge(merge.name.accpt,unique(bloom[,c(19,20,21,23)]), by="Year")
unbloom <- unique(bloom[,c(19,20,21,23)])

```

# When including all collections each year, need to check for and remove any duplicate records.
#For reviewer, compare to mean flowering time, not first    
## merge.name.accpt.ALL
```{r}
#don't split bloom.sp to find earliest each year (as in earl.sp.yr) just keep all of bloom.sp and merge with accepted names by ID from synonyms.plantsyn.accpt

#first check for duplicates before getting to bloom.sp
# Primary collector number: 13329 samesies
nrow(as.data.frame(table(colo$Primary.Collector.Number))[as.data.frame(table(colo$Primary.Collector.Number))$Freq >1,])

#same date and year and elevation (since don't have lat long for all)?
n_occur <- data.frame(table(colo$scientificName,colo$Date..dd.month.yyyy.))
head(n_occur[n_occur$Freq > 1,])
nrow(n_occur[n_occur$Freq > 1,])

colo[colo$scientificName == "Trisetum spicatum ssp. congdonii" &
       colo$Date..dd.month.yyyy. == "01 August 1954",]

n_occurXelevation <- aggregate(State~Date..dd.month.yyyy.+Elevation..meters.+scientificName,
                               function(x) length(x),
                               data=colo)

n_occurXelevation[n_occurXelevation$State>1,]

#Oy, this one is in once as vegetative and once as flowering but all other information is the same. The vegetative one would be removed anyway..
colo[colo$Date..dd.month.yyyy.=="29 May 1963"&
       colo$Elevation..meters.==2210&
       colo$scientificName=="Acer glabrum",]


colo[colo$Date..dd.month.yyyy.=="30 July 1937"&
       colo$Elevation..meters.==2286&
       colo$scientificName=="Achillea lanulosa",]

#get rid of duplicates that way
colo2 <- colo[!duplicated(colo$Date..dd.month.yyyy.=="30 July 1937"&
       colo$Elevation..meters.==2286&
       colo$scientificName=="Achillea lanulosa"),]

colo2[colo2$Date..dd.month.yyyy.=="30 July 1937"&
       colo2$Elevation..meters.==2286&
       colo2$scientificName=="Achillea lanulosa",]


ALL.sp.yr <- do.call(rbind, 
                     lapply(split(bloom.sp, bloom.sp$ID), function(id){
                       id <- id[order(id$Year),]
                       id$DataYrs <- nrow(id[!duplicated(id$Year) & !is.na(id$Year),])
                       out <- id[id$DataYrs>9,]
                       out
                     }))



merge.name.accpt.ALL <- merge(ALL.sp.yr, synonyms.plantsyn.accpt, by = "ID")
length(unique(merge.name.accpt.ALL$ID)) #385, makes sense! 


```





Growing Degree Days
```{r}
tmps <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/tmps.csv"))

totalGDD <- lapply(split(tmps, tmps$Year), function(year){
  max(year$HDD)
})
totalGDDyr <- data.frame(Year=1981:2011, MaxGDD = do.call(rbind, totalGDD))


min1950GDD_2 <- mergeMinGDD(merge.name.accpt,tmps)
gdddatayrs <- as.data.frame(table(min1950GDD_2$Year,min1950GDD_2$ID))
yrspsp <- aggregate(gdddatayrs$Freq, by = list(gdddatayrs$Var2), FUN=sum)
min1950GDD_2_10 <- merge(min1950GDD_2,yrspsp[yrspsp$x>=10,],
                         by.x="ID",by.y="Group.1") #313
min1950GDDmax <- merge(totalGDDyr,min1950GDD_2_10, by="Year")

```


# Start here after download from github
```{r}
merge.name.accpt <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/mergenameaccpt.csv"))

min1950GDDmax <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/min1950GDDmax.csv"))

```



#Figures and Tables
Figure 1a
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of species collected")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()

```

Figure 1b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()

```


Figure 1a - mean flowering time
```{r}
meancollection <- data.frame(colSums(table(merge.name.accpt.ALL$ID,
                                           merge.name.accpt.ALL$Year)))

meancol <- data.frame(Year = row.names(meancollection),
                      Collections = meancollection)

colnames(meancol)[2] <- "Collections"

meancol[,1] <- as.numeric(levels(meancol[,1]))


dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1a-meancollection.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(meancol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of biological collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()

```


Table Year and Ordinal day
```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",merge.name.accpt)

nrow(yr.1950_2) #385

write.table(yr.1950_2, file = "Q:/Research/Projects/alpine-phenology/phensum_yr_385.csv", sep=",")

nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #343 -> 340
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #45

nrow(yr.1950_2[yr.1950_2$p.value<0.05,])/nrow(yr.1950_2) #0.1159794 -> 0.1162791

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #45
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #-0.5275986
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0])*61 #-32.18351
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #0.2173058

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,]) #4->0

mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #NaN
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])*61
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #NaN
```


#For reviewer, mean bloom day
Table Year and Ordinal day WITH MEAN BLOOM
```{r}
yr.1950_2.ALL <- JulBloomDate.min1950("Year",merge.name.accpt.ALL)

nrow(yr.1950_2.ALL) #385

write.table(yr.1950_2.ALL, file = "Q:/Research/Projects/alpine-phenology/phensum_yr_385_meanbloomday.csv", sep=",")

nrow(yr.1950_2.ALL[yr.1950_2.ALL$p.value>=0.05,]) #343 -> 340 -> 316
nrow(yr.1950_2.ALL[yr.1950_2.ALL$p.value<0.05,]) #45 -> 69

nrow(yr.1950_2.ALL[yr.1950_2.ALL$p.value<0.05,])/nrow(yr.1950_2.ALL) #0.1162791 -> 0.1792208

#earlier
nrow(yr.1950_2.ALL[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope<0,]) #45->39
mean(yr.1950_2.ALL$Slope[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope<0]) #-0.3836091
mean(yr.1950_2.ALL$Slope[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope<0])*61 #-23.40016
mean(yr.1950_2.ALL$adj.r.squ[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope<0]) #0.1010248

#later
nrow(yr.1950_2.ALL[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope>=0,]) #4->0 -> 30

mean(yr.1950_2.ALL$Slope[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope>=0]) #0.3497761
mean(yr.1950_2.ALL$Slope[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope>=0])*61 #21.33634
mean(yr.1950_2.ALL$adj.r.squ[yr.1950_2.ALL$p.value<0.05 & yr.1950_2.ALL$Slope>=0]) #0.09204598


```



Figure 3a
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Avg_Hi))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
  xlab("Year")+
  ylab(expression("Mean annual maximum temperature"~degree*C)) + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8))

dev.off()

summary(lm(Avg_Hi~Year, data=unbloom))
```

Figure 3b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)


ggplot(unbloom, aes(Year,Avg_Lo))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab(expression("Mean annual minimum temperature"~degree*C))+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Avg_Lo~Year, data = unbloom))

```

Figure 3c
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Raw_Precip))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("Annual precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Raw_Precip~Year, data = unbloom))

```


Figure 3d 
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point(size=0.5,shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Annual maximum growing degree days")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(MaxGDD~Year,data=totalGDDyr))


```


Figure 4
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4.tiff", width = 174, height = 150, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 

dev.off()

summary(lm(startDayOfYear~Year, data=merge.name.accpt))
```

#Figure 4 with MEAN FLOWERING   
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4_meanflowering.tiff", width = 174, height = 150, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt.ALL, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 

dev.off()

summary(lm(startDayOfYear~Year, data=merge.name.accpt.ALL))
-0.027006*61
```

Table Ordinal by high temp
```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", merge.name.accpt)

nrow(high.1950_2) #388 -> 385
write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2_385.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,]) #81
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.2087629 -> 0.2103896

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,])  #79
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) # -10.44416
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) #0.2191173

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) # 2
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(high.1950_2$Species[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0],
                                collapse="|"), high.1950_2$Species, value=TRUE)])

mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #8.893071
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #0.3025555

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.2187629
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2) #0.8

```

Table Ordinal by low temp
```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", merge.name.accpt)

nrow(low.1950_2) #389 -> 385

write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2_385.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #73
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2) #0.1881443 -> 0.1896104
mean(low.1950_2$Slope) #-4.268747

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #72
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #-9.185434
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #0.1702239

#later
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #1
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(
      low.1950_2$Species[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]
      ,
                                collapse="|"), low.1950_2$Species, value=TRUE)]) #Crepis nana Richardson
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #10.08779
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #0.249457
```

Table Ordinal on Precip
```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", merge.name.accpt)

write.table(precip.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2_385.csv", sep=",")

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #36
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2) # 0.09536082 -> 0.09350649
mean(precip.1950_2$Slope) #0.02090737 -> 0.02073033


#earlier
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #2
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                               precip.1950_2$ID[precip.1950_2$p.value<0.05 & 
                                                  precip.1950_2$Slope<0])]) 
# Oxytropis borealis var. viscida and Dryas octopetala ssp. hookeriana
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) # -0.05841561
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) #0.2260552

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #34
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.07871088
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.2203618

```

Table Ordinal by maxGDD
```{r}
rst <- JulBloomDate.min1950("MaxGDD", min1950GDDmax)

nrow(rst) #312 -> 311
nrow(rst[rst$p.value<0.05,]) #65

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #64
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -0.0621439
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.253648

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) #1
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                             rst$ID[rst$p.value<0.05 & rst$Slope>=0])]) #Sambucus racemosa L. var. racemosa
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) # 0.06436998
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) #0.2293882


write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_max_311.csv", sep=",")

```




Figure 5a
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Avg_Hi, startDayOfYear))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Mean annual maximum temperature"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=7))


dev.off()

summary(lm(startDayOfYear~Avg_Hi, data=merge.name.accpt))

```

Figure 5b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1, size= 0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression("Mean annual minimum temperature"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Avg_Lo, data = merge.name.accpt))
```

Figure 5c 
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1,size=0.25)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Annual precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Raw_Precip, data = merge.name.accpt))
```

Figure 5d
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDDmax, aes(MaxGDD, startDayOfYear))+
  geom_point(shape=1, size=0.5)+
  geom_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab("Annual maximum growing degree days")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~MaxGDD, data = min1950GDDmax))

```


#NPN
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

npn.all$SciName <- multisub(synonyms2$Species,
                            synonyms2$SYNONYMS,npn.all$SciName)
npn.all <- npn.all[!is.na(npn.all$SciName),]

npn.big2 <- intersect(npn.all$SciName, merge.name.accpt$scientificName)
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big2) #27 -> 26
length(npn.big) #72

# match NPN names against all synonyms. Get those IDs, link those



npn.ID <- merge(npn.all, synonyms.plantsyn, by.x = "SciName", by.y = "SYNONYMS")
length(unique(npn.ID$ID)) #716 -> 215 when I use synonyms.plantsyn instead of synonyms

npn.min1950 <- merge.name.accpt[merge.name.accpt$ID %in% unique(npn.ID$ID),]

#npn.min1950 <- merge(npn.ID, merge.name.accpt, by ="ID")
length(unique(npn.min1950$ID)) #28
unique(npn.min1950$SYNONYMS)

```

Table NPN year ordinal
```{r}
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

nrow(yr.npn_2) #28
mean(yr.npn_2$Slope) #-0.2688984

write.table(yr.npn_2, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr_28.csv", sep=",")
nrow(yr.npn_2[yr.npn_2$p.value<0.05,]) #4
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2) #0.1428571

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) #4
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       yr.npn_2$ID[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0])])
#Salix petrophila Rydb.                     
#Salix planifolia Pursh                     
#Castilleja miniata Douglas ex Hook.        
#Calamagrostis canadensis (Michx.) P. Beauv.

mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #-0.5272818
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #0.1863358

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #0
```

Table NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

nrow(high.npn_2) #28

write.table(high.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2_28.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,]) #5

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) #5

unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       high.npn_2$ID[high.npn_2$p.value<0.05 &
                                                       high.npn_2$Slope<0])])
#Mimulus guttatus DC.                               
#Picea engelmannii Parry ex Engelm. var. engelmannii
#Salix planifolia Pursh                             
#Achillea millefolium L.                            
#Lonicera involucrata (Richardson) Banks ex Spreng.

mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #-13.82806
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #0.2228063

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) #0

```
Table NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

nrow(low.npn_2) #28
mean(low.npn_2$Slope) #-6.161866

write.table(low.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_28.csv", sep=",")

nrow(low.npn_2[low.npn_2$p.value<0.05,]) #8
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2) #0.2857143

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) # 8
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       low.npn_2$ID[low.npn_2$p.value<0.05 &
                                                       low.npn_2$Slope<0])])

mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #-10.27738
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #0.164536

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,]) #0
```

Table NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

nrow(precip.NPN_2) #28

write.table(precip.NPN_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_prec_28.csv", sep=",")

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #1
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2) #0.03571429

#earlier
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0,]) #1

unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                                      precip.NPN_2$Slope<0])])

mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #-0.05341472
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #0.1559357

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) #1 -> 0
unique(merge.name.accpt$AUTH.x[which(merge.name.accpt$ID %in%
                                 precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                                   precip.NPN_2$Slope>=0])])
#Erythronium grandiflorum Pursh -> Not when combinded with subspecies. 
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.09425329
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.4683842

```

NPN Growing Degree Days
```{r}
minNPNGDDmax <- merge(totalGDDyr,npn.min1950, by="Year")

npngdd <- data.frame(table(minNPNGDDmax$Year,minNPNGDDmax$ID))

ID.10 <- aggregate(npngdd$Freq, list(npngdd$Var2), sum)
minNPNGDD_2 <- merge(minNPNGDDmax, ID.10[ID.10$x >=10,], by.x = "ID", by.y = "Group.1")

length(unique(minNPNGDD_2$ID)) #24

rst.npn <- JulBloomDate.min1950("MaxGDD", minNPNGDD_2)

nrow(rst.npn) #24
nrow(rst.npn[rst.npn$p.value<0.05,]) #4

#lower GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #4
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) # -0.05148802
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope< 0]) # 0.1728869
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                                rst.npn$ID[rst.npn$p.value<0.05 & rst.npn$Slope < 0])])
#Achillea millefolium L.                    
#Calamagrostis canadensis (Michx.) P. Beauv.
#Aquilegia coerulea James
#Carex aquatilis Wahlenb.

#bigger GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) #0

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_24.csv", sep=",")

```

Methods and Results     
```{r}
length(unique(merge.name.accpt$ID)) #388 -> 385
nrow(yr.1950_2) #385
nrow(low.1950_2) #385
nrow(yr.npn_2) #28
length(unique(min1950GDDmax$ID)) #311

#How many years have each species been collected?
bysp <- split(merge.name.accpt, merge.name.accpt$ID, drop=TRUE)

spyears <- do.call(rbind,
                   lapply(bysp, function(x){
                     data.frame(DataYrs = length(unique(x$Year)),ID = unique(x$ID))
                     })
                   )

# 389 species
spyears[which.max(spyears$DataYrs),] # 54
spyears[which.min(spyears$DataYrs),] # 10
nrow(spyears[spyears$DataYrs>=10,]) #385
mean(spyears$DataYrs[spyears$DataYrs>=10]) #26.04416

# species collected per year (from 10 years or more, 389 species)
sp.p.year <- data.frame(table(merge.name.accpt$ID,merge.name.accpt$Year))
sp.p.year.1 <- sp.p.year[sp.p.year$Freq>0,]
sum.p.year <- aggregate(sp.p.year.1$Freq, list(sp.p.year.1$Var2), length)
mean(sum.p.year$x) #165.4 -> 164.377
sum.p.year[which.max(sum.p.year$x),]
rm(sp.p.year,sp.p.year.1)

# peak collection period (over the year) for all herbarium specimens. 
col.yr <- data.frame(table(bloom.sp$startDayOfYear, bloom.sp$Year))
peak.yr <- do.call(rbind, lapply(split(col.yr, col.yr$Var2), function(x) x[which.max(x$Freq),]))
peak.yr$Var1 <- as.numeric(levels(peak.yr$Var1))[peak.yr$Var1]
mean(peak.yr$Var1) #206.541
rm(col.yr, peak.yr)

# The mean colleciton for all specimens of all species (389) used in analyses...      
#    so the IDs from merge.name.accpt but all specimens from bloom.sp
bloom.sp.389 <- bloom.sp[bloom.sp$ID %in% unique(merge.name.accpt$ID),]
col.period <- data.frame(table(bloom.sp.389$startDayOfYear, bloom.sp.389$Year))
col.period <- col.period[col.period$Freq>0,]
col.period[,1:2] <- sapply(col.period[,1:2], function(x) as.numeric(as.character(x)))

peak.yr <- aggregate(col.period$Var1, list(col.period$Var2), mean)
mean(peak.yr$x) #208.9292 -> 208.9539

summary(lm(startDayOfYear~Year, data=bloom.sp.389))

peak.yr[which.min(peak.yr$x),]
as.Date(sprintf("%05d", 74198), format= "%y%j")
peak.yr[which.max(peak.yr$x),]
as.Date(sprintf("%05d", 79223), format= "%y%j")

ggplot(bloom.sp.389, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")

# just the first collection date, moving over time?
summary(lm(startDayOfYear~Year, data=merge.name.accpt))

```
Additional questions/information  
```{r}
nrow(bloom2) #42757
nrow(merge.name.accpt) #10134

# data with lat long 
## see CMIP_NCAR.Rmd for pulling lat longs

#To Do
# image of per species change over time (the 45 advancing over years) - done
# pull list of 45 species - in excel "Species_sign_changes.xlsx"

# do a temperature change over time period blocks. with precip, and snow if I can get it run. 
```

```{r}

dpi = 1200
tiff("Q:/Research/Presentations/External Conference presentations/CPC meetings/CPC 2017/Sign_yr_45.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                              yr.1950_2$Slope<0]),],
       aes(Year, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1, size = 0.5)+
  stat_smooth(method="lm", alpha=0.05, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),axis.title=element_text(size=7))+
  theme(legend.position="none")

dev.off()


write.table(unique(merge.name.accpt[which(merge.name.accpt$ID %in% yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                              yr.1950_2$Slope<0]),c(2,4:5)]),
            "clipboard", sep="\t")
```

```{r}
tiff("Q:/Research/Presentations/External Conference presentations/CPC meetings/CPC 2017/Sign_low_later.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
                                low.1950_2$ID[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]),],
       aes(Avg_Lo, startDayOfYear, colour = AUTH.y))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),axis.title=element_text(size=7))

dev.off()

```

```{r}
tiff("Q:/Research/Presentations/External Conference presentations/CPC meetings/CPC 2017/Sign_low_early.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
                                low.1950_2$ID[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]),],
       aes(Avg_Lo, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1, size = 0.5)+
  stat_smooth(method="lm", alpha=0.05, size = 0.5)+
  theme_bw()+
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),axis.title=element_text(size=7))+
  theme(legend.position="none")

dev.off()

lowearly <- merge.name.accpt[which(merge.name.accpt$ID %in% 
        low.1950_2$ID[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]),c(2,4:5)]

length(unique(lowearly$ID))
lowearly[!duplicated(lowearly$ID),]

write.table(lowearly[!duplicated(lowearly$ID),],
            "clipboard", sep="\t")

```


```{r}
dpi = 1200
tiff("Q:/Research/Presentations/External Conference presentations/CPC meetings/CPC 2017/Sign_precip_early.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
   precip.1950_2$ID[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]),],
       aes(Raw_Precip, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1, size = 0.5)+
  stat_smooth(method="lm", alpha=0.05, size = 0.5)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),axis.title=element_text(size=7))+
  theme(legend.position="none")

dev.off()

precipearly <- merge.name.accpt[which(merge.name.accpt$ID %in% 
        precip.1950_2$ID[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]),c(2,4:5)]

length(unique(precipearly$ID))
precipearly[!duplicated(precipearly$ID),]

write.table(precipearly[!duplicated(precipearly$ID),],
            "clipboard", sep="\t")

```


```{r}
dpi = 1200
tiff("Q:/Research/Presentations/External Conference presentations/CPC meetings/CPC 2017/Sign_precip_later.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
   precip.1950_2$ID[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]),],
       aes(Raw_Precip, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1, size = 0.5)+
  stat_smooth(method="lm", alpha=0.05, size = 0.5)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),axis.title=element_text(size=7))+
  theme(legend.position="none")

dev.off()

preciplater <- merge.name.accpt[which(merge.name.accpt$ID %in% 
        precip.1950_2$ID[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]),c(2,4:5)]

length(unique(preciplater$ID))
preciplater[!duplicated(preciplater$ID),]

write.table(preciplater[!duplicated(preciplater$ID),],
            "clipboard", sep="\t")

```
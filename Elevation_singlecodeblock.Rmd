---
title: "Code in one block"
author: "Michelle DePrenger-Levin"
date: "January 27, 2017"
output: html_document
---
load libraries   
```{r}
  .libPaths(c(.libPaths(), "C:/Users/deprengm/Documents/R/win-library/3.3"))
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
library(rasterVis)
require(rgdal)
library(RColorBrewer)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
library(Taxonstand)
library(directlabels)

#functions
is.NullOb <- function(x) is.null(x) | all(sapply(x, is.null))

## Recursively step down into list, removing all such objects 
rmNullObs <- function(x) {
   x <- Filter(Negate(is.NullOb), x)
   lapply(x, function(x) if (is.list(x)) rmNullObs(x) else x)
}

```

#Fresh start
Save the GDD variables - those take hours to calculate/extract
```{r, eval=FALSE}
rm(list=ls())
```

Functions
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1], #Intercept
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "SpeciesAuthority","Species", "Fam", "adj.r.squ","ID",
                   "Duration","GrowthHabit")
  JYC
}

## lm on elevation instead of startDayOfYear
JulBloomDate.elev2 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$elevation~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1], #Intercept
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "SpeciesAuthority","Species", "Fam", "adj.r.squ","ID",
                   "Duration","GrowthHabit")
  JYC
}





# lm with elevation as covariate
JulBloomDate.elevation <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~(blnew[,colnum]*blnew$elevation)))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])), #variable
                                    data.frame(t(foo1$coefficients[3,])), #elevation
                                    data.frame(t(foo1$coefficients[4,])), #interaction
                                    foo1$coefficients[1,1],  #intercept
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c(paste(variable,"Slope",sep=""),paste(variable,"StErr",sep=""),
                          paste(variable,"t.value",sep=""),
                          paste(variable,"p.value",sep=""),
                     "ElevationSlope","ElevationStErr",
                          "Elevationt.value","Elevationp.value",
                     "InteractionSlope", "InteractionStErr",
                          "Interactiont.value","Interactionp.value",
                     "Intercept", "F Stat", "numDF","denDF",
                     "SpeciesAuthority","Species", "Fam",
                     "adj.r.squ","ID","Duration","GrowthHabit")
  JYC
}

# lm with covariates
JulBloomDate.covariates <- function(variable1, variable2,dataset){
  namesID <- unique(dataset$ID)
  colnum1 <- match(variable1,names(dataset))
  colnum2 <- match(variable2,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~(blnew[,colnum1]*blnew[,colnum2])))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])), #variable
                                    data.frame(t(foo1$coefficients[3,])), #elevation
                                    data.frame(t(foo1$coefficients[4,])), #interaction
                                    foo1$coefficients[1,1],  #intercept
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c(paste(variable1,"Slope",sep=""),paste(variable1,"StErr",sep=""),
                          paste(variable1,"t.value",sep=""),
                          paste(variable1,"p.value",sep=""),
                     paste(variable2,"Slope",sep=""),paste(variable2,"StErr",sep=""),
                          paste(variable2,"t.value",sep=""),
                          paste(variable2,"p.value",sep=""),
                     "InteractionSlope", "InteractionStErr",
                          "Interactiont.value","Interactionp.value",
                     "Intercept", "F Stat", "numDF","denDF",
                     "SpeciesAuthority","Species", "Fam",
                     "adj.r.squ","ID","Duration","GrowthHabit")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

# exact match multisub <http://stackoverflow.com/questions/15253954/replace-multiple-arguments-with-gsub>
multisub <- function(pattern, replacement, x){
  result <- x
    for(i in 1:length(pattern)){
      result <- gsub(pattern = paste("^",pattern[i],"$",sep=""),
                     replacement = replacement[i], result)
      }
  result
}

```



# Start here after download from github
```{r}
merge.name.accpt <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/mergenameaccpt.csv"))

min1950GDDmax <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/min1950GDDmax.csv"))

```



#Figures and Tables
Figure 1a
```{r}

ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of species collected")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))


```

Figure 1b
```{r}

ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

```

```{r}

ggplot(merge.name.accpt,  aes(x = Year, y = elevation, group=Year))+
  geom_boxplot()+
  xlab("Year")+
  ylab("elevation")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1949.5,2011), breaks = seq(1950,2011, by=10))+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

```

```{r}
#library(devtools)
#install_github("ropensci/plotly")
#install.packages("digest")
#library(ploty)

ggplot(merge.name.accpt,  aes(x = Year, y = elevation))+
  geom_point(aes(colour = startDayOfYear))+
  xlab("Year")+
  ylab("elevation")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1949.5,2011), breaks = seq(1950,2011, by=10))+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))+
  scale_color_gradient(low = "white", high = "red", space = "Lab", guide = "colourbar") 

```




Table Year and Ordinal day
```{r}
yr.elevation <- JulBloomDate.elevation("Year",merge.name.accpt)

nrow(yr.elevation) #385

nrow(yr.elevation[yr.elevation$Interactionp.value>=0.05,]) #362
nrow(yr.elevation[yr.elevation$Interactionp.value<0.05,]) #23 significantly changed over time given the changes in elevation

nrow(yr.elevation[yr.elevation$Interactionp.value<0.05,])/nrow(yr.elevation) #0.05974026

#earlier
nrow(yr.elevation[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope<0,]) #14
mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope<0]) #-0.003431289
mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope<0])*61 #-0.2093086
mean(yr.elevation$adj.r.squ[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope<0]) #0.263519

#later
nrow(yr.elevation[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0,]) #9

mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0]) #NaN
mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0])*61
mean(yr.elevation$adj.r.squ[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0]) #NaN
```


Year given changes in elevation of first bloom
```{r}
yr.elevation.co <- JulBloomDate.covariates("Year","elevation", merge.name.accpt)

nrow(yr.elevation.co) #385

nrow(yr.elevation.co[yr.elevation.co$Yearp.value>=0.05,]) #360
nrow(yr.elevation.co[yr.elevation.co$Yearp.value<0.05,]) #25 significantly changed over time given the changes in elevation

nrow(yr.elevation.co[yr.elevation.co$Yearp.value<0.05,])/nrow(yr.elevation.co) #0.06493506

#earlier
nrow(yr.elevation.co[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope<0,]) #11
mean(yr.elevation.co$YearSlope[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope<0]) #-17.51887
mean(yr.elevation.co$YearSlope[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope<0])*61 #-1068.651 ??!!?!?
mean(yr.elevation.co$adj.r.squ[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope<0]) #0.3802031

#later
nrow(yr.elevation.co[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope>=0,]) #14

mean(yr.elevation.co$YearSlope[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope>=0]) #11.6923
mean(yr.elevation.co$YearSlope[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope>=0])*61 #713.2306
mean(yr.elevation.co$adj.r.squ[yr.elevation.co$Yearp.value<0.05 & yr.elevation.co$YearSlope>=0]) #0.263519
```



```{r}

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
                                yr.elevation.co$ID[yr.elevation.co$Interactionp.value<0.05 &
                                                     yr.elevation.co$InteractionSlope < 0]),], 
       aes(Year,startDayOfYear, colour = as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("First Bloom") + 
  scale_x_continuous(breaks = seq(1950,2011,10))

```



```{r}

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
                                yr.elevation.co$ID[yr.elevation.co$Yearp.value<0.05 &
                                                     yr.elevation.co$YearSlope<0]),], 
       aes(Year,startDayOfYear, colour = as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("First Bloom") + 
  scale_x_continuous(breaks = seq(1950,2011,10))

```


```{r}

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
                                yr.elevation.co$ID[yr.elevation.co$Yearp.value<0.05 &
                                                     yr.elevation.co$YearSlope<0]),], 
       aes(elevation,startDayOfYear, colour = as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha = 0.05)+
  geom_point(shape=1, size=0.5)+
  theme_bw()+
  xlab("Elevation")+
  ylab("First Bloom") 

```





```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
                                yr.elevation.co$ID[yr.elevation.co$Yearp.value<0.05 &
                                                     yr.elevation.co$YearSlope<0]),], 
       aes(Year, elevation, colour = as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha = 0.05)+
  geom_point(shape=1, size=0.5)+
  theme_bw()+
  ylab("Elevation")+
  xlab("Year") 

```










Figure 4
```{r}

ggplot(merge.name.accpt, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 


summary(lm(startDayOfYear~Year, data=merge.name.accpt))
```

Table Ordinal by high temp
```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", merge.name.accpt)

nrow(high.1950_2) #389
write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2_389.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,]) #81
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.2

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,])  #79
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) # -10.44416
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) #0.2189276

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) # 2
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(high.1950_2$Species[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0],
                                collapse="|"), high.1950_2$Species, value=TRUE)])

mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #8.893071
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #0.3025555

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.2
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2) #0.8

```

Table Ordinal by low temp
```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", merge.name.accpt)

nrow(low.1950_2) #389

write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2_389.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #72
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2) #0.18509
mean(low.1950_2$Slope) #-4.272713

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #71
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #-9.258539
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #0.1717332

#later
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #1
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(
      low.1950_2$Species[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]
      ,
                                collapse="|"), low.1950_2$Species, value=TRUE)]) #Crepis nana Richardson
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #10.08779
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #0.249457
```

Table Ordinal on Precip
```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", merge.name.accpt)

write.table(precip.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2_389.csv", sep=",")

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #37
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2) # 0.09511568
mean(precip.1950_2$Slope) #0.02095683


#earlier
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #2
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                               precip.1950_2$ID[precip.1950_2$p.value<0.05 & 
                                                  precip.1950_2$Slope<0])]) 
# Oxytropis borealis var. viscida and Dryas octopetala ssp. hookeriana
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) # -0.05841561
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) #0.2260552

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #35
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.07915495
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.2274481

```

Table Ordinal by maxGDD
```{r}
head(min1950GDDmax)

rst <- JulBloomDate.min1950("MaxGDD", min1950GDDmax)

nrow(rst) #313 -> 311
nrow(rst[rst$p.value<0.05,]) #65

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #64
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -0.0621439
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.253648

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) #1
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                             rst$ID[rst$p.value<0.05 & rst$Slope>=0])]) #Sambucus racemosa L. var. racemosa
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) # 0.06436998
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) #0.2293882


write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_max_313.csv", sep=",")

```
```{r}
ggplot(min1950GDDmax[which(min1950GDDmax$ID %in%
                                rst$ID[rst$p.value<0.05 & rst$Slope >= 0]),],
       aes(MaxGDD, startDayOfYear, colour=as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.75)+
  theme_bw()+
  xlab("Annual maximum growing degree days")+
  ylab("Ordinal Date") + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(legend.position="none")

```

```{r}
ggplot(min1950GDDmax[which(min1950GDDmax$ID %in%
                                rst$ID[rst$p.value<0.05 & rst$Slope < 0]),],
       aes(MaxGDD, startDayOfYear, colour=as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.5)+
  theme_bw()+
  xlab("Annual maximum growing degree days")+
  ylab("Ordinal Date") + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(legend.position="none")

```

```{r}
elev2 <- JulBloomDate.elev2("Year", merge.name.accpt)

nrow(elev2)

#LOWER over time
nrow(elev2[elev2$p.value<0.05 & elev2$Slope < 0,]) #10
mean(elev2$Slope[elev2$p.value<0.05 & elev2$Slope < 0]) #-8.186309
mean(elev2$Slope[elev2$p.value<0.05 & elev2$Slope < 0])*61 #-499.3649
mean(elev2$adj.r.squ[elev2$p.value<0.05 & elev2$Slope < 0]) #0.2656773


#higher over time
nrow(elev2[elev2$p.value<0.05 & elev2$Slope >= 0,]) #15
mean(elev2$Slope[elev2$p.value<0.05 & elev2$Slope >= 0]) #4.724469
mean(elev2$Slope[elev2$p.value<0.05 & elev2$Slope >= 0])*61 #288.1926
mean(elev2$adj.r.squ[elev2$p.value<0.05 & elev2$Slope >= 0]) #0.1669237


```

```{r}

ggplot(merge.name.accpt, aes(Year,elevation))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Elevation (m)") + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(legend.position="none")

summary(lm(elevation~Year, data=merge.name.accpt))

```

```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elev2$ID[elev2$p.value<0.05&elev2$Slope>=0]),],
       aes(Year,elevation, colour=as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Elevation (m)") + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(legend.position="none")


```

```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elev2$ID[elev2$p.value<0.05&elev2$Slope<0]),],
       aes(Year,elevation, colour=as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Elevation (m)") + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(legend.position="none")


```



Methods and Results     
```{r}
length(unique(merge.name.accpt$ID)) #389
nrow(yr.1950_2) #389
nrow(low.1950_2) #389
nrow(yr.npn_2) #28
length(unique(min1950GDDmax$ID)) #313

#How many years have each species been collected?
bysp <- split(merge.name.accpt, merge.name.accpt$ID, drop=TRUE)

spyears <- do.call(rbind,
                   lapply(bysp, function(x){
                     data.frame(DataYrs = length(unique(x$Year)),ID = unique(x$ID))
                     })
                   )

# 389 species
spyears[which.max(spyears$DataYrs),] # 54
spyears[which.min(spyears$DataYrs),] # 10
nrow(spyears[spyears$DataYrs>=10,]) #389
mean(spyears$DataYrs[spyears$DataYrs>=10]) #23.77708

# species collected per year (from 10 years or more, 389 species)
sp.p.year <- data.frame(table(merge.name.accpt$ID,merge.name.accpt$Year))
sp.p.year.1 <- sp.p.year[sp.p.year$Freq>0,]
sum.p.year <- aggregate(sp.p.year.1$Freq, list(sp.p.year.1$Var2), length)
mean(sum.p.year$x) #165.4
sum.p.year[which.max(sum.p.year$x),]
rm(sp.p.year,sp.p.year.1)

# peak collection period (over the year) for all herbarium specimens. 
col.yr <- data.frame(table(bloom.sp$startDayOfYear, bloom.sp$Year))
peak.yr <- do.call(rbind, lapply(split(col.yr, col.yr$Var2), function(x) x[which.max(x$Freq),]))
peak.yr$Var1 <- as.numeric(levels(peak.yr$Var1))[peak.yr$Var1]
mean(peak.yr$Var1) #206.541
rm(col.yr, peak.yr)

# The mean colleciton for all specimens of all species (389) used in analyses...      
#    so the IDs from merge.name.accpt but all specimens from bloom.sp
bloom.sp.389 <- bloom.sp[bloom.sp$ID %in% unique(merge.name.accpt$ID),]
col.period <- data.frame(table(bloom.sp.389$startDayOfYear, bloom.sp.389$Year))
col.period <- col.period[col.period$Freq>0,]
col.period[,1:2] <- sapply(col.period[,1:2], function(x) as.numeric(as.character(x)))

peak.yr <- aggregate(col.period$Var1, list(col.period$Var2), mean)
mean(peak.yr$x) #208.9292

summary(lm(startDayOfYear~Year, data=bloom.sp.389))

peak.yr[which.min(peak.yr$x),]
as.Date(sprintf("%05d", 74198), format= "%y%j")
peak.yr[which.max(peak.yr$x),]
as.Date(sprintf("%05d", 79223), format= "%y%j")

ggplot(bloom.sp.389, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")

# just the first collection date, moving over time?
summary(lm(startDayOfYear~Year, data=merge.name.accpt))

```


Figure 5a
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Avg_Hi, startDayOfYear))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=7))


dev.off()

summary(lm(startDayOfYear~Avg_Hi, data=merge.name.accpt))

```

Figure 5b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1, size= 0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Avg_Lo, data = merge.name.accpt))
```

Figure 5c 
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1,size=0.25)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Raw_Precip, data = merge.name.accpt))
```

Figure 5d
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDDmax, aes(MaxGDD, startDayOfYear))+
  geom_point(shape=1, size=0.5)+
  geom_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab("Maximum annual GDD")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~MaxGDD, data = min1950GDDmax))

```


#NPN
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

npn.all$SciName <- multisub(synonyms2$Species,
                            synonyms2$SYNONYMS,npn.all$SciName)
npn.all <- npn.all[!is.na(npn.all$SciName),]

npn.big2 <- intersect(npn.all$SciName, merge.name.accpt$scientificName)
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big2) #27
length(npn.big) #72


npn.ID <- merge(npn.all, synonyms, by.x = "SciName", by.y = "SYNONYMS")
length(unique(npn.ID$ID)) #716

npn.min1950 <- merge(npn.ID, merge.name.accpt, by ="ID")
length(unique(npn.min1950$ID)) #28
unique(npn.min1950$SciName)

```

Table NPN year ordinal
```{r}
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

nrow(yr.npn_2) #28 
mean(yr.npn_2$Slope) #-0.2664686

write.table(yr.npn_2, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr_28.csv", sep=",")
nrow(yr.npn_2[yr.npn_2$p.value<0.05,]) #4
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2) #0.1428571

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) #4
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       yr.npn_2$ID[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0])])
#Salix petrophila Rydb.                     
#Salix planifolia Pursh                     
#Castilleja miniata Douglas ex Hook.        
#Calamagrostis canadensis (Michx.) P. Beauv.

mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #-0.5272818
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #0.1863358

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #0
```

Table NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

nrow(high.npn_2) #28

write.table(high.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2_28.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,]) #5

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) #5

unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       high.npn_2$ID[high.npn_2$p.value<0.05 &
                                                       high.npn_2$Slope<0])])
#Mimulus guttatus DC.                               
#Picea engelmannii Parry ex Engelm. var. engelmannii
#Salix planifolia Pursh                             
#Achillea millefolium L.                            
#Lonicera involucrata (Richardson) Banks ex Spreng.

mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #-13.82806
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #0.2228063

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) #0

```
Table NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

nrow(low.npn_2) #28
mean(low.npn_2$Slope) #-6.216788

write.table(low.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_2_28.csv", sep=",")

nrow(low.npn_2[low.npn_2$p.value<0.05,]) #8
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2) #0.2857143

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) # 8
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       low.npn_2$ID[low.npn_2$p.value<0.05 &
                                                       low.npn_2$Slope<0])])

mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #-10.27738
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #0.164536

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,]) #0
```

Table NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

nrow(precip.NPN_2) #28

write.table(precip.NPN_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_precip_28.csv", sep=",")

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #2
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2) #0.07142857

#earlier
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0,]) #1

unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                                      precip.NPN_2$Slope<0])])

mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #-0.05341472
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #0.1559357

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) #1
unique(merge.name.accpt$AUTH.x[which(merge.name.accpt$ID %in%
                                 precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                                   precip.NPN_2$Slope>=0])])
#Erythronium grandiflorum Pursh
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.09425329
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.4683842

```

NPN Growing Degree Days
```{r}
minNPNGDDmax <- merge(totalGDDyr,npn.min1950, by="Year")

npngdd <- data.frame(table(minNPNGDDmax$Year,minNPNGDDmax$ID))

ID.10 <- aggregate(npngdd$Freq, list(npngdd$Var2), sum)
minNPNGDD_2 <- merge(minNPNGDDmax, ID.10[ID.10$x >=10,], by.x = "ID", by.y = "Group.1")

length(unique(minNPNGDD_2$ID)) #24

rst.npn <- JulBloomDate.min1950("MaxGDD", minNPNGDD_2)

nrow(rst.npn) #24
nrow(rst.npn[rst.npn$p.value<0.05,]) #4

#lower GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #4
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) # -0.05148802
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope< 0]) # 0.1728869
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                                rst.npn$ID[rst.npn$p.value<0.05 & rst.npn$Slope < 0])])
#Achillea millefolium L.                    
#Calamagrostis canadensis (Michx.) P. Beauv.
#Aquilegia coerulea James
#Carex aquatilis Wahlenb.

#bigger GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) #0

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_24.csv", sep=",")

```


# For CPC talk      

Elevation first bloom collected change over time?   
```{r}
ggplot(merge.name.accpt, aes(Year,elevation))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression("Average high"~degree*C)) + 
  scale_x_continuous(breaks = seq(1950,2011,10))

```


Elevation all collections change over time?   
```{r}
ggplot(bloom.sp, aes(Year,elevation))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
  xlab("Year")+
  ylab("Elevation meters") + 
  scale_x_continuous(breaks = seq(1950,2011,10))


summary(lm(elevation~Year, data= bloom.sp))
```
Elevation by species
```{r}
ggplot(bloom.sp, aes(Year,elevation, colour = as.factor(ID)))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("Elevation meters") + 
  scale_x_continuous(breaks = seq(1950,2011,10)) + 
  theme(legend.position="none")

```

Table: how did the first bloom of species change with elevation collected?
```{r}
elevation <- JulBloomDate.min1950("elevation", merge.name.accpt)

nrow(elevation) #385

nrow(elevation[elevation$p.value>=0.05,]) #333
nrow(elevation[elevation$p.value<0.05,]) #52
mean(elevation$Slope)
0.009621837*61

nrow(elevation[elevation$p.value<0.05,])/nrow(elevation) #0.1307692
nrow(elevation[elevation$p.value<0.05 & elevation$Slope < 0,])/nrow(elevation) #0.01542416
nrow(elevation[elevation$p.value<0.05 & elevation$Slope >= 0,])/nrow(elevation) #0.1182519

#earlier higher up
nrow(elevation[elevation$p.value<0.05 & elevation$Slope<0,]) #6
mean(elevation$Slope[elevation$p.value<0.05 & elevation$Slope<0]) #-0.07484596
mean(elevation$adj.r.squ[elevation$p.value<0.05 & elevation$Slope<0]) #0.3061596

#later higher up
nrow(elevation[elevation$p.value<0.05 & elevation$Slope>=0,]) #46

mean(elevation$Slope[elevation$p.value<0.05 & elevation$Slope>=0]) #0.04719446
mean(elevation$adj.r.squ[elevation$p.value<0.05 & elevation$Slope>=0]) #0.1974384


ggplot(merge.name.accpt[merge.name.accpt$elevation<4300,], 
       aes(elevation, startDayOfYear))+
  geom_point(shape=1, size= 0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  xlab("Elevation")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

summary(lm(startDayOfYear~elevation, data=merge.name.accpt[merge.name.accpt$elevation<4300,]))
```


```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elevation$ID[elevation$p.value<0.05 & elevation$Slope>=0]),],
       aes(elevation, startDayOfYear, colour=as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.75)+
  theme_bw()+
  xlab("Elevation (m)")+
  ylab("Ordinal Date") + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(legend.position="none")



```

```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elevation$ID[elevation$p.value<0.05 & elevation$Slope<0]),],
       aes(elevation, startDayOfYear, colour=as.factor(ID)))+
  stat_smooth(method="lm", size = 0.5, alpha= 0.05)+
  geom_point(shape=1, size=0.75)+
  theme_bw()+
  xlab("Elevation (m)")+
  ylab("Ordinal Date") + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(legend.position="none")



```



```{r}

####
# Bloom over time given elevation
# YEAR
yr.elevation <- JulBloomDate.elevation("Year", merge.name.accpt)

nrow(yr.elevation[yr.elevation$Yearp.value>=0.05,]) #364
nrow(yr.elevation[yr.elevation$Yearp.value<0.05,]) #25

nrow(yr.elevation[yr.elevation$Interactionp.value>=0.05,]) #366
nrow(yr.elevation[yr.elevation$Interactionp.value<0.05,]) #23


nrow(yr.elevation[yr.elevation$Interactionp.value<0.05,])/nrow(yr.elevation) #0.05912596

#earlier given elevation
nrow(yr.elevation[yr.elevation$Interactionp.value<0.05 &
                    yr.elevation$InteractionSlope<0,]) #14
mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 &
                                     yr.elevation$InteractionSlope<0]) #-0.003431289
mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 &
                                     yr.elevation$InteractionSlope<0])*61 #-0.2093086
mean(yr.elevation$adj.r.squ[yr.elevation$Interactionp.value<0.05 &
                              yr.elevation$InteractionSlope<0]) #0.263519

#later
nrow(yr.elevation[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0,]) #9

mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0]) #0.005678209
mean(yr.elevation$InteractionSlope[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0])*61 #0.3463707
mean(yr.elevation$adj.r.squ[yr.elevation$Interactionp.value<0.05 & yr.elevation$InteractionSlope>=0]) #0.3980167

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                            yr.elevation$ID[yr.elevation$Interactionp.value<0.05 &
                                              yr.elevation$InteractionSlope<0]),],
       aes(Year, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")


ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                yr.elevation$ID[yr.elevation$Interactionp.value<0.05 &
                                               yr.elevation$InteractionSlope<0]),],
       aes(elevation, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Elevation")+
  ylab("Ordinal Date")+
  theme(legend.position="none")  

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                yr.elevation$ID[yr.elevation$Interactionp.value<0.05 &
                                               yr.elevation$InteractionSlope<0]),],
       aes(Year, elevation, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.075)+
  theme_bw()+
  xlab("Year")+
  ylab("Elevation")+
  theme(legend.position="none")  


#HIGH TEMP
high.elevation <- JulBloomDate.elevation("Avg_Hi", merge.name.accpt)
low.elevation <- JulBloomDate.elevation("Avg_Lo", merge.name.accpt)
precip.elevation <- JulBloomDate.elevation("Raw_Precip", merge.name.accpt)

nrow(yr.elevation[yr.elevation$p.value<0.05,]) #26
nrow(yr.elevation[yr.elevation$p.value<0.05,])/nrow(yr.elevation) # 0.06666667


#####################
#####################
# select random subset of 20 species that did signficantly change over time and 20 that did not

sig.rows <- which(yr.1950_2$p.value<0.05)
set.seed(123)
yr.1950_2[sig.rows, "Species"]
yr.1950_2[sample(sig.rows,20,replace=FALSE),c("Species","ID")]
nonsig.rows <- which(yr.1950_2$p.value>=0.05)

yr.1950_2[nonsig.rows, "Species"]
set.seed(123)
non.sig.sp <- yr.1950_2[sample(nonsig.rows,20,replace=FALSE),c("Species","ID")]
synonyms.plantsyn[synonyms.plantsyn$ID %in% non.sig.sp$ID,]
synonyms[synonyms$SYNONYMS == "Senecio fremontii var. blitoides",]
sig.sp <- c(9042,1125,8243,6934,45837,17265,14088,35604,41517)  
```

Check if species synonyms and accepted names match
```{r}
synonyms.plantsyn[grep("Carex scirpoi", synonyms.plantsyn$SYNONYMS),]

synonyms.plantsyn$ID[grep("Carex scirpoi", synonyms.plantsyn$SYNONYMS)] <- 8637

table(bloom.sp$scientificName[grep("Carex scirpoid",bloom.sp$scientificName)])

synonyms.plantsyn$ID[grep("Carex scirpoidea")]


synonyms.plantsyn$ID[grep("Cerastium bee", synonyms.plantsyn$SYNONYMS)] <- 9608

```


Paste it down in the console to spit out in plot
```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elevation$ID[elevation$p.value<0.05 &
                                               elevation$Slope<0]),],
       aes(Year, startDayOfYear, colour = SYNONYMS))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elevation$ID[elevation$p.value<0.05 &
                                               elevation$Slope<0]),],
       aes(elevation, startDayOfYear, colour = SYNONYMS))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Elevation")+
  ylab("Ordinal Date")


# are there ones going later over time? Not significnatly 
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                       yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                                       yr.1950_2$Slope>=0]),],
       aes(Year, startDayOfYear, colour = SYNONYMS))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

head(merge.name.accpt)
#Insignificantly later in bloom date
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                       yr.1950_2$ID[yr.1950_2$Slope>=0]),],
       aes(Year, startDayOfYear, colour = Family))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elevation$ID[elevation$p.value<0.05 &
                                               elevation$Slope>=0]),],
       aes(Year, startDayOfYear, colour = SYNONYMS))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                elevation$ID[elevation$p.value<0.05 &
                                               elevation$Slope>=0]),],
       aes(elevation, startDayOfYear, colour = SYNONYMS))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Elevation")+
  ylab("Ordinal Date")


###
ggplot(merge.name.accpt, aes(elevation, startDayOfYear))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  xlab("Elevation")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~elevation, data=merge.name.accpt))
summary(lm(startDayOfYear~(Year+elevation)^2, data=merge.name.accpt))

ggplot(merge.name.accpt, aes(Year, elevation))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("Elevation")



```



#covariates?   
```{r}
min.precip <- JulBloomDate.covariates("Avg_Lo","Raw_Precip",merge.name.accpt)

nrow(min.precip[min.precip$Avg_Lop.value>=0.05,]) #354
nrow(min.precip[min.precip$Interactionp.value<0.05,]) #30


nrow(min.precip[min.precip$Interactionp.value>=0.05,]) #359
nrow(min.precip[min.precip$InteractionSlope < 0 &
                  min.precip$Interactionp.value < 0.05,]) #3


ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                min.precip$ID[min.precip$InteractionSlope < 0 &
                                         min.precip$Interactionp.value < 0.05]),],
       aes(Avg_Lo, startDayOfYear, colour=AUTH.x)) +
  stat_smooth(method="lm", alpha=0.5)+
  theme_bw()

ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                min.precip$ID[min.precip$InteractionSlope < 0 &
                                         min.precip$Interactionp.value < 0.05]),],
       aes(Raw_Precip, startDayOfYear, colour=AUTH.x)) +
  stat_smooth(method="lm", alpha=0.5)+
  theme_bw()


ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                min.precip$ID[min.precip$InteractionSlope < 0 &
                                         min.precip$Interactionp.value < 0.05]),],
       aes(Raw_Precip, Avg_Lo, colour=AUTH.x)) +
  stat_smooth(method="lm", alpha=0.5)+
  theme_bw()
```


Testing full range changes in elevation
```{r}
caca <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Alpine_Phenology_Field_Data/Calamagrostis_canadensis_post-1980.csv")

head(caca)

armo <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/Arnica_mollis.csv")
head(armo)
names(armo)

table(armo$minimumElevationInMeters)

ggplot(armo, aes(year,minimumElevationInMeters))+
  geom_point()+
  stat_smooth(method="lm")

summary(lm(minimumElevationInMeters~year,data=armo))

caev <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/Carex evenea.csv")

ggplot(caev[caev$year>1850,], aes(year,minimumElevationInMeters))+
  geom_point()+
  stat_smooth(method="lm")

summary(lm(minimumElevationInMeters~year,data=caev[caev$year>1850,]))
```

```{r}
#install.packages("spocc")
library(spocc)

#GBIF for occurrence of Ligusticum porterii
lipo <- occ('Ligusticum porteri', 'gbif', limit=300, has_coords=TRUE)
occs <- as.data.frame(lipo$gbif$data$Ligusticum_porteri[,2:3])
head(occs)

lipo$gbif$data$Ligusticum_porteri$elevation

LiPo <- data.frame("Ligusticum porteri", occs, 
                   lipo$gbif$data$Ligusticum_porteri$year,
                   NA, lipo$gbif$data$Ligusticum_porteri$elevation,
                   121)

head(LiPo)

write.csv(LiPo, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/LiPo.csv")

#GBIF for Dryas hookeriana
drho <- occ('Dryas hookeriana', 'gbif', limit = 300, has_coords = TRUE)
occs2 <- as.data.frame(drho$gbif$data$Dryas_hookeriana[,2:3])

DrHo <- data.frame("Dryas hookeriana", occs2, 
                   drho$gbif$data$Dryas_hookeriana$year,
                   NA, drho$gbif$data$Dryas_hookeriana$elevation,
                   172)
write.csv(DrHo, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/DrHo.csv")

#GBIF for Stellaria longipes Goldie ssp. longipes 
stlolo <- occ('Alsine longipes', 'gbif', 
              geometry = c(-109, 41, -102, 37), limit = 600, has_coords = TRUE)

occs3 <- as.data.frame(stlolo$gbif$data$Alsine_longipes[,2:3])

StLoLo <- data.frame("Alsine longifolia", occs3, 
                   stlolo$gbif$data$Alsine_longipes$year,
                   NA, stlolo$gbif$data$Alsine_longipes$elevation,
                   357)
write.csv(StLoLo, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/StLoLo.csv")

```

Make a csv of all species with an ID for Vistrails
45 species that signficantly moved earlier of 385 species    
Updated to have sequential numbers (not the sign 1:45 and then notsign 1:339, oops!)
```{r}
#install.packages("list")
library(list)

#339 not significant
notsig_339 <- "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/NotSignEarl_385"
sig_45 <- "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/SignEarl_385"

#339
filenames <- list.files(notsig_339, pattern="*.csv")
#45
filenames_1 <- list.files(sig_45, pattern="*.csv")

# 339
sps_339 <- lapply(1:339, function(file){
  read.csv(paste(notsig_339, filenames[file], sep="/"))
})

# 45
signsps_45 <- lapply(1:45, function(file){
  read.csv(paste(sig_45,filenames_1[file], sep="/"))
})


nrow(signsps_45[[9]][!is.na(signsps_45[[9]]$decimalLatitude),])

# Select only species that have more than 80 individual points
# "MaxEnt uses thenumber of presences to determine which feature classes to use, more than 80 presences leads to all feature classes being used" - Merow et al 2013
# the 45 significantly changed in phenology ones
cols4VT <- lapply(1:45, function(x){
  sp <- signsps_45[[x]][,c("scientificName","decimalLongitude",
                          "decimalLatitude","year",
                          "minimumElevationInMeters")]
  sp <- sp[sp$decimalLatitude < 41.1 & sp$decimalLatitude > 36.9 &
             sp$decimalLongitude > -109 & sp$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  sp
})


# need to be 46:384
cols4VT_339 <- lapply(1:339, function(x){
  sp1 <- sps_339[[x]][,c("scientificName","decimalLongitude",
                        "decimalLatitude","year",
                          "minimumElevationInMeters")]
  sp <- sp1[sp1$decimalLatitude < 41.1 & sp1$decimalLatitude > 36.9 &
             sp1$decimalLongitude > -109 & sp1$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  if(nrow(sp) == 0){
    sp <- data.frame(scientificName = unique(sp1$scientificName),decimalLongitude = NA,
                     decimalLatitude = NA,year = NA,
                     minimumElevationInMeters = NA,
                     ID = NA, N=nrow(sp))
    } else {
    if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x+45, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  }
  sp
})


AlPh384 <- rbind(do.call(rbind,cols4VT), do.call(rbind,cols4VT_339))
AlPh384 <- AlPh384[!is.na(AlPh384$ID),]

seqAlPh <- transform(AlPh384, id=match(AlPh384$ID, unique(AlPh384$ID)))

write.table(seqAlPh, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80.csv", sep=",", row.names=FALSE)


```


Create pre 1980 list with still over 80 occurances 
```{r}
# Select only species that have more than 80 individual points
#Select only individuals with year before 1980
# "MaxEnt uses thenumber of presences to determine which feature classes to use, more than 80 presences leads to all feature classes being used" - Merow et al 2013
# the 45 significantly changed in phenology ones
cols4VT <- lapply(1:45, function(x){
  sp <- signsps_45[[x]][,c("scientificName","decimalLongitude",
                          "decimalLatitude","year",
                          "minimumElevationInMeters")]
  sp <- sp[sp$decimalLatitude < 41.1 & sp$decimalLatitude > 36.9 &
             sp$decimalLongitude > -109 & sp$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  sp <- sp[sp$year < 1980,]
  sp <- sp[!is.na(sp$year),]
  if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  sp
})


# need to be 46:384
cols4VT_339 <- lapply(1:339, function(x){
  sp1 <- sps_339[[x]][,c("scientificName","decimalLongitude",
                        "decimalLatitude","year",
                          "minimumElevationInMeters")]
  sp <- sp1[sp1$decimalLatitude < 41.1 & sp1$decimalLatitude > 36.9 &
             sp1$decimalLongitude > -109 & sp1$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  sp <- sp[sp$year < 1980,]
  sp <- sp[!is.na(sp$year),]
  if(nrow(sp) == 0){
    sp <- data.frame(scientificName = unique(sp1$scientificName),decimalLongitude = NA,
                     decimalLatitude = NA,year = NA,
                     minimumElevationInMeters = NA,
                     ID = NA, N=nrow(sp))
    } else {
    if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x+45, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  }
  sp
})


AlPh384 <- rbind(do.call(rbind,cols4VT), do.call(rbind,cols4VT_339))
AlPh384 <- AlPh384[!is.na(AlPh384$ID),]

seqAlPh <- transform(AlPh384, id=match(AlPh384$ID, unique(AlPh384$ID)))

write.table(seqAlPh, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80pre1980.csv", sep=",", row.names=FALSE)


```


#create post 1980 list with over 80 occurances 
```{r}
# Select only species that have more than 80 individual points
#Select only individuals with year before 1980
# "MaxEnt uses thenumber of presences to determine which feature classes to use, more than 80 presences leads to all feature classes being used" - Merow et al 2013
# the 45 significantly changed in phenology ones

library(list)

#339 not significant
notsig_339 <- "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/NotSignEarl_385"
sig_45 <- "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/SignEarl_385"

#339
filenames <- list.files(notsig_339, pattern="*.csv")
#45
filenames_1 <- list.files(sig_45, pattern="*.csv")

# 339
sps_339 <- lapply(1:339, function(file){
  read.csv(paste(notsig_339, filenames[file], sep="/"))
})

# 45
signsps_45 <- lapply(1:45, function(file){
  read.csv(paste(sig_45,filenames_1[file], sep="/"))
})



cols4VT <- lapply(1:45, function(x){
  sp <- signsps_45[[x]][,c("scientificName","decimalLongitude",
                          "decimalLatitude","year",
                          "minimumElevationInMeters")]
  sp <- sp[sp$decimalLatitude < 41.1 & sp$decimalLatitude > 36.9 &
             sp$decimalLongitude > -109 & sp$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  sp <- sp[sp$year >= 1980,]
  sp <- sp[!is.na(sp$year),]
  if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  sp
})


# need to be 46:384
cols4VT_339 <- lapply(1:339, function(x){
  sp1 <- sps_339[[x]][,c("scientificName","decimalLongitude",
                        "decimalLatitude","year",
                          "minimumElevationInMeters")]
  sp <- sp1[sp1$decimalLatitude < 41.1 & sp1$decimalLatitude > 36.9 &
             sp1$decimalLongitude > -109 & sp1$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  sp <- sp[sp$year >= 1980,]
  sp <- sp[!is.na(sp$year),]
  if(nrow(sp) == 0){
    sp <- data.frame(scientificName = unique(sp1$scientificName),decimalLongitude = NA,
                     decimalLatitude = NA,year = NA,
                     minimumElevationInMeters = NA,
                     ID = NA, N=nrow(sp))
    } else {
    if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x+45, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  }
  sp
})


AlPh384 <- rbind(do.call(rbind,cols4VT), do.call(rbind,cols4VT_339))
AlPh384 <- AlPh384[!is.na(AlPh384$ID),]

seqAlPh <- transform(AlPh384, id=match(AlPh384$ID, unique(AlPh384$ID)))

write.table(seqAlPh, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80post1980.csv", sep=",", row.names=FALSE)


```



# 8/24/2017
#Compare change in average elevation of past to current niche model
```{r}


elevs <- list.files("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Elevation_VT/All_CO_elevation_TIFFS", pattern="*.tif")

elevtiffs <- elevs[seq(1,138,by=3)]

elevation <- lapply(seq(1,138,by=3),function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Elevation_VT/All_CO_elevation_TIFFS/",elevs[x],sep=""))
})

length(grep("zone=13",elevation[[1]]@crs@projargs))==0
# need to catch integer(0)

# some are zone 12, some are zone 13, project all to zone 13
for(i in 1:length(elevation)){
  if(length(grep("zone=12",elevation[[i]]@crs@projargs))==1){
 #   projectRaster(elevation[[i]], crs = "+proj=utm +zone=13 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")
    print(elevation[[i]]@crs)
  }
}

elevation13 <- lapply(elevation, function(x){
  if(length(grep("zone=13", x@crs@projargs))==1){
    x
  }
}) 

length(elevation)
elevation13[sapply(elevation13, is.null)] <- NULL
length(elevation13)
class(elevation13[[1]])
elevation13

elevation13$filename <- "elevationCO.tif"
elevation13$fun <- mean
elevation13$overwrite <- TRUE
elevationCO <- do.call(mosaic,elevation13)

s <- do.call(stack, elevation13)

nlayers(elevation13)
```


#Take results from VisTrails and compare bin maps for each past projected to current with points from current
```{r}


applymax <- paste("ApplyMAXENT",1:89,"_1", sep="")
Maxent <- paste("Maxent_",1:89,sep="")

models <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current/",x,"/maxent_bin_map.tif",sep=""))
})

applymodels <- lapply(applymax, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current/",x,"/maxent_bin_map.tif",sep=""))
})

# All have 0 or 1, these are the bin values of suitable or not
overlap <- lapply(1:length(models), function(x){
  past <- models[[x]]
  current <- applymodels[[x]]
  out <- past+current
  out
})

# Add only when 
overlap10 <- lapply(1:length(models), function(x){
  past <- models[[x]]
  current <- applymodels[[x]]
  current[applymodels[[x]] == 1] <- 2
  out <- past+current
  out
})

res(overlap10[[1]])[1]^2 # square the resolution for area in square meters

# add 2: new habitat and 3: maintained habitat minus 1:previous habitat
netchange <- lapply(overlap10, function(x){
  net <- ( (sum(x[] == 2) + sum( x[] == 3) )- sum(x[] == 1) ) * res(x)[1]^2 
  net
})

netchangevector <- do.call(rbind,netchange)

# how do herbarium specimens line up with habitat model?
FieldData_all <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80.csv")

# to match which number (id) is what species (ID)
FieldData_pre1980 <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80pre1980.csv")

```

Plot results
```{r}
plot(overlap10[[59]])

boxplot(netchangevector)
hist(netchangevector)

#convert raster to dataframes for plotting in ggplot
df1 <- data.frame(rasterToPoints(overlap10[[1]]))
colnames(df1) <- c("X","Y","SHM") #suitable habitat model

# vector for color breaks
b.col <- seq(0,3,length.out=4)

ggplot(df1,aes(X,Y))+
  geom_raster()

plot(overlap10[[1]])
points(FieldData_all$decimalLongitude[FieldData_all$year>1980 &
                                        FieldData_all$ID == 1],
       FieldData_all$decimalLatitude[FieldData_all$year>1980 &
                                        FieldData_all$ID == 1],
       pch = 21, cex = 0.5, col = "red")
points(FieldData_all$decimalLongitude[FieldData_all$year<1980 &
                                        FieldData_all$ID == 1],
       FieldData_all$decimalLatitude[FieldData_all$year<1980 &
                                        FieldData_all$ID == 1],
       pch = 8, cex = 0.5, col = "black")
```


So how many points pre 1980 correspond to 1 - lost, 2 - new, or 3 kept vs. how many points after 1980 correspond to 1, 2, or 3?
```{r}

collpnts_pre <- lapply(1:89, function(x){
  fullID <- unique(FieldData_pre1980$ID[FieldData_pre1980$id == x])
  pntsplot <- FieldData_all[FieldData_all$ID == fullID & FieldData_all$year <= 1980,
                            c("decimalLongitude","decimalLatitude")]
  out <- extract(overlap10[[x]], pntsplot, fun=mean)
})


hist(collpnts_pre[[7]])


collpnts_post <- lapply(1:89, function(x){
  fullID <- unique(FieldData_pre1980$ID[FieldData_pre1980$id == x])
  pntsplot <- FieldData_all[FieldData_all$ID == fullID & FieldData_all$year > 1980,
                            c("decimalLongitude","decimalLatitude")]
  out <- extract(overlap10[[x]], pntsplot, fun=mean)
})

hist(collpnts_post[[30]])

## Don't want chi square for model performance. 
# Want AUC for model performance for current, want 
anovatest <- lapply(1:89, function(x){
  zero <- length(collpnts_pre[[x]][collpnts_pre[[x]]==0])
  one <-length(collpnts_pre[[x]][collpnts_pre[[x]]==1])
  two <-length(collpnts_pre[[x]][collpnts_pre[[x]]==2])
  three <-length(collpnts_pre[[x]][collpnts_pre[[x]]==3])
  
  zero.p <- length(collpnts_post[[x]][collpnts_post[[x]]==0])
  one.p <-length(collpnts_post[[x]][collpnts_post[[x]]==1])
  two.p <-length(collpnts_post[[x]][collpnts_post[[x]]==2])
  three.p <-length(collpnts_post[[x]][collpnts_post[[x]]==3])
  
  pre2post <- matrix(c(zero,
    one,two,three,zero.p,
    one.p,two.p,three.p),
    nrow=2, byrow=TRUE)
  
  pre2post
  }
)

chitest <- do.call(rbind,anovatest)

chitest[chitest$Pval<0.05,]
# 34 are signficantly different as you'd expect. The pre-distribution should have more 1s while the post should have more 2s.
```


#AUC or BIC from models?
```{r}
library(ENMeval)

exploreorder <- lapply(1:48, function(x){
  whatorder <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x,"/species_samplePredictions.csv", sep=""))
})

# are the Explore a list of betamultipliers [1,2,3,4,5] with 5 species done by species or by beta multplier?
# 6 species and 8 beta values [6, 8, 10, 12, 14, 16, 18, 20]

orderiswhat <- apply(expand.grid(1:6,1:48), 1, function(x){
  out <- data.frame(t(x),sameno = identical(exploreorder[[ x[1] ]]$X, exploreorder[[ x[2] ]]$X))
  out
})

orderis <- do.call(rbind,orderiswhat)

library(jpeg)

matched <- orderis[orderis$sameno == TRUE & orderis$Var1 != orderis$Var2,]

unique(matched$Var1)

## Look at how response curves compare
for(i in 1:6){
  x <- matched$Var2[matched$Var1 == i]
  
  for(y in 1:(length(x)-2)){
  
    file.rename(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x[y],"/responseCurves/all_response_curves.jpg",sep=""),
                paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/CompareImages/response_curves",i,"_",x[y],".jpg",sep=""))
    
 # jpeg(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/CompareImages/response_curves",i,"_",x[y],".jpg",sep=""))
    
 # print(readJPEG(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x[y],"/responseCurves/all_response_curves.jpg",sep="")))
    
    }

}



identical(exploreorder[[1]]$X, exploreorder[[2]]$X) # the first and 6th, so it goes through one beta value for the 5 species then then the next beta value...
match(exploreorder[[2]]$X, exploreorder[[7]]$X) 

#training samples

trainingsamples <- lapply(1:10, function(x){
  ts <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_1/cvSplit",x,"/trainingSamples.csv", sep=""))
  ts
})

head(trainingsamples[[1]])


#samplePredictions 
sampPred <- lapply(1:5, function(x){
  sp <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x,"/species_samplePredictions.csv", sep=""))
  sp
})

#omission
omm <- lapply(1:5, function(x){
  om <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x,"/species_omission.csv", sep=""))
  om
})

head(sampPred[[1]])

boxplot(sampPred[[1]]$Raw.prediction, col="red")

density(sampPred[[1]]$Cumulative.prediction)

library(dismo)
e <- evaluate(p=sampPred[[1]]$Raw.prediction, a=omm[[1]]$Raw.value)

density(e)
plot(e, 'ROC')

```



# Model Performance  
check how many points from post 1980 fall within the predicted range. Do a PCA to see if there's a difference in points within and points that fall not in the range. What do those mean? They didn't shift so they're adapting? Are they tolerating a shift in one direction of certain environmental factors?    
```{r}

elevCO <- raster("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Elevation_VT/CO_Mosaic_Elevation_VT/co_elev_VT_WGS84.tif")


applymax <- paste("ApplyMAXENT",1:89,"_1", sep="")
Maxent <- paste("Maxent_",1:89,sep="")

past_models <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta5/",x,"/maxent_bin_map.tif",sep=""))
})

#elevCOcrop <- crop(elevCO, past_models[[1]])
elevCOcrop <- resample(elevCO, past_models[[1]], method='bilinear')

## not vectorized?!?

avgElev <- lapply(past_models, function(model){
  avgelev <- overlay(model, elevCOcrop, fun = function(x,y) {
    y[x == 0] <- NA
    y
  })
  shape <- rasterToPolygons()
})



apply_models <- lapply(applymax, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta5/",x,"/maxent_bin_map.tif",sep=""))
})


past_models_prob <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta5/",x,"/maxent_prob_map.tif",sep=""))
})


apply_models_prob <- lapply(applymax, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta5/",x,"/maxent_prob_map.tif",sep=""))
})






```








# https://cran.r-project.org/web/packages/dismo/vignettes/sdm.pdf
```{r}
#These are the 10 splits k-fold (cross-validation)
# Try one model first with splits

e <- lapply(1:10, function(x){
  p <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_1/cvSplit",x,"/species_samplePredictions.csv", sep=""))
  a <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_1/cvSplit",x,"/species_omission.csv", sep=""))
  eout <- evaluate(p=p$Raw.prediction, a=a$Raw.value)
  eout
  })

auc <- sapply(e, function(x){slot(x, 'auc')})
mean(auc)
```





















```{r}
filenames_1tiff <- gsub(".csv", ".jpg", filenames_1)
plottitle_1 <- gsub(".jpg","",filenames_1tiff)

for(i in 1:45){
  jpeg(paste("Q:/Research/EXTERNAL PARTNERS/NCAR/Elevation_changes/",filenames_1tiff[i],sep=""), 
       width = 84, height = 75,  units = "mm", res=1200)
  
  print(ggplot(signsps_1[[i]][signsps_1[[i]]$year>1850&
                                signsps_1[[i]]$year<2017&
                                signsps_1[[i]]$minimumElevationInMeters<4500&
                                signsps_1[[i]]$minimumElevationInMeters>1000,], aes(year,minimumElevationInMeters))+
          geom_point(shape=1, size=0.5)+
          stat_smooth(method="lm")+
          theme(axis.text=element_text(size=5),
                axis.title=element_text(size=7))+
          ggtitle(paste(plottitle_1[i]))+
          xlab("Year")+
          ylab("Elevation")+
          theme_bw()
  )
  
  dev.off()
  
}

lm_sum <- lapply(signsps_1, function(sp){
  summary(lm(minimumElevationInMeters~year,
             data=sp[sp$year>1850&sp$year<2017&
                       sp$minimumElevationInMeters<4500&
                       sp$minimumElevationInMeters>1000,]))
})

summary_tble <- lapply(1:45, function(x){
  sp <- lm_sum[[x]]
  data.frame(filenames_1[[x]],
             cbind(data.frame(t(sp$coefficients[2,])),
                   sp$coefficients[1,1], #Intercept
                   t(sp$fstatistic),
                   sp$adj.r.squared))
  
})

all_sum1 <- do.call(rbind,summary_tble)
write.table(all_sum1, file = "Q:/Research/EXTERNAL PARTNERS/NCAR/Elevation_changes/elev_change_45.csv",
            sep=",",
            row.names=FALSE)

#Signficantly lower
nrow(all_sum1[all_sum1$Pr...t.. < 0.05 & all_sum1$Estimate < 0,]) #5
mean(all_sum1$Estimate[all_sum1$Pr...t.. < 0.05 & all_sum1$Estimate < 0]) # -2.723875
mean(all_sum1$sp.adj.r.squared[all_sum1$Pr...t.. < 0.05 & all_sum1$Estimate < 0]) # 0.03749326


#Signficantly higher
nrow(all_sum1[all_sum1$Pr...t.. < 0.05 & all_sum1$Estimate >=0 ,]) #11
mean(all_sum1$Estimate[all_sum1$Pr...t.. < 0.05 & all_sum1$Estimate >= 0]) # 2.570823
mean(all_sum1$sp.adj.r.squared[all_sum1$Pr...t.. < 0.05 & all_sum1$Estimate >= 0]) # 0.03568444



```


340 species that did not signficantly moved earlier of 385 species (but there are 346 species in there?)
Missing location information for Ligusticum porterii
```{r}
#install.packages("list")

#which one is 172?
nms <- c(filenames_1,filenames)

nms[172] #Dryas octopetala ssp. hookeriana
nms[121] #supposed to be Carex norvegica ssp. stevenii - I made it Ligusticum porteri
nms[357] #Stellaria longipes Goldie ssp. longipes 


# Find the csvs without data and reload, redownload from seinet

library(list)
filenames <- list.files("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/NotSignEarl_385", pattern="*.csv")

#Got rid of quotes in Festuca idahoensis 

signsps <- lapply(1:length(filenames), function(file){
  read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/NotSignEarl_385/",filenames[file], sep=""))
})

length(signsps) #339

filenamestiff <- gsub(".csv", ".jpg", filenames)
plottitle <- gsub(".jpg","",filenamestiff)

for(i in 1:length(signsps) ){
  jpeg(paste("Q:/Research/EXTERNAL PARTNERS/NCAR/Elevation_changes/",filenamestiff[i],sep=""), 
       width = 84, height = 75,  units = "mm", res=1200)
  
  print(ggplot(signsps[[i]][signsps[[i]]$year>1850 & signsps[[i]]$year<2017 &
                              !is.na(signsps[[i]]$year>1850) &
                              signsps[[i]]$minimumElevationInMeters>1000&
                              signsps[[i]]$minimumElevationInMeters<4500 &
                              !is.na(signsps[[i]]$minimumElevationInMeters),],
               aes(year,minimumElevationInMeters))+
          geom_point(shape=1, size=0.5)+
          stat_smooth(method="lm")+
          theme(axis.text=element_text(size=5),
                axis.title=element_text(size=7))+
          ggtitle(paste(plottitle[i]))+
          xlab("Year")+
          ylab("Elevation")+
          theme_bw()
  )
  dev.off()
}

lm_sum <- lapply(signsps, function(sp){
  sp1 <- sp[sp$year>1850 &
              sp$year<2017&
              sp$minimumElevationInMeters>1000&
              sp$minimumElevationInMeters<4500,]
  if(nrow(sp1)>0){
  summary(lm(as.numeric(minimumElevationInMeters)~as.numeric(year),
             data=sp1))
  }
}
)

summary_tble <- lapply(1:339, function(x){
  sp <- lm_sum[[x]]
  data.frame(filenames[[x]],
             cbind(data.frame(t(sp$coefficients[2,])),
                   sp$coefficients[1,1], #Intercept
                   t(sp$fstatistic),
                   sp$adj.r.squared))
  
})


all_sum <- do.call(rbind,summary_tble)
write.table(all_sum, file = "Q:/Research/EXTERNAL PARTNERS/NCAR/Elevation_changes/elev_change_339_non.csv",
            sep=",",
            row.names=FALSE)



nrow(all_sum) #339
nrow(all_sum[all_sum$Pr...t..<0.05& all_sum$Estimate<0,]) #13
mean(all_sum$Estimate[all_sum$Pr...t..<0.05 & all_sum$Estimate<0]) #-3.21485
mean(all_sum$sp.adj.r.squared[all_sum$Pr...t..<0.05 & all_sum$Estimate<0]) #0.08261447

nrow(all_sum[all_sum$Pr...t..<0.05 & all_sum$Estimate>=0,]) #103
mean(all_sum$Estimate[all_sum$Pr...t..<0.05 & all_sum$Estimate>=0]) #2.43129
mean(all_sum$sp.adj.r.squared[all_sum$Pr...t..<0.05 & all_sum$Estimate>=0]) #0.04472727



```

```{r}
head(signsps_1[[1]])
names(signsps_1[[1]])

# Assuming all are really in one datum for Lat Long

cols4VT <- lapply(1:length(signsps_1), function(x){
  sp <- signsps_1[[x]][,c("scientificName","decimalLongitude",
                          "decimalLatitude","year","geodeticDatum",
                          "minimumElevationInMeters")]
  if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x)
  } else {
    sp <- cbind(sp, "ID" = NA)
  }
  sp
})

cols4VT_339 <- lapply(1:length(signsps), function(x){
  sp <- signsps[[x]][,c("scientificName","decimalLongitude",
                        "decimalLatitude","year","geodeticDatum",
                          "minimumElevationInMeters")]
  if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x)
  } else {
    sp <- cbind(sp, "ID" = NA)
  }
  sp
})

AlPh384 <- rbind(do.call(rbind,cols4VT),do.call(rbind,cols4VT_339))
AlPh384 <- AlPh384[complete.cases(AlPh384),]

head(AlPh384)

sequentialAlPh <- transform(AlPh384, id=match(AlPh384$ID, unique(AlPh384$ID)))
head(sequentialAlPh)

write.table(sequentialAlPh, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80.csv", sep=",", row.names=FALSE)

#Add background points by locations found in database where target species isn't found. Would need to buffer a bit. 
# one decimals is about 6.9 miles (36,000 ft, 11,104.5 m)


library(rgeos)
library(doParallel)

# For all years? Assuming some movement into and out of, maybe bracket by years, before and after 1980? 
# need to add the locaiton of that far enough away nearest location, and maybe split with doParallel [https://stackoverflow.com/questions/27558115/improve-speed-use-of-gdistance-function-by-using-parallel-processing-and-or-plyr]

# [https://stackoverflow.com/questions/21977720/r-finding-closest-neighboring-point-and-number-of-neighbors-within-a-given-rad]  
# Need to get info, lat long, of next nearest that is far enough away to be an absence - distance of cell size for preditor levels

set.seed(1)
cl <- makeCluster(detectCores())
registerDoParallel(cl)
#export the environment variables to each cluster
clusterExport(cl,ls())
#Load library "rgeos"
clusterEvalQ(cl, library(rgeos))
clusterEvalQ(cl, library(raster))
#split da data
ID.split <- clusterSplit(cl,1:384)
a <- function(x){
  focal <- SpatialPoints(AlPh384[AlPh384$ID == x,2:3])
  others <- SpatialPoints(AlPh384[AlPh384$ID != x, 2:3])
  cbind(focal, apply(gDistance(focal,others,byid=TRUE),1, function(x) sort(x, decreasing=FALSE)[2]))
} 
#Run function in each cluster
system.time(m<-clusterApply(cl, x=ID.split, fun=a))
stopCluster(cl)

pt.dist <- lapply(1:384, function(x){
  focal <- SpatialPoints(AlPh384[AlPh384$ID == x,2:3])
  others <- SpatialPoints(AlPh384[AlPh384$ID != x, 2:3])
  apply(gDistance(focal,others,byid=TRUE),1, function(x) sort(x, decreasing=FALSE)[2])
})

```

List for VisTrails
```{r}
library(list)
filenames <- list.files("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/NotSignEarl_385", pattern="*.csv")

signsps <- lapply(1:length(filenames), function(file){
  read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/NotSignEarl_385/",filenames[file], sep=""))
})

filenames_1 <- list.files("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/SignEarl_385", pattern="*.csv")

signsps_1 <- lapply(1:45, function(file){
  read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/SignEarl_385/",filenames_1[file], sep=""))
})
#Only take ones that have at least 80 data points
cols4VT <- lapply(1:length(signsps_1), function(x){
  sp <- signsps_1[[x]][,c("scientificName","decimalLongitude","decimalLatitude","year",
                          "minimumElevationInMeters")]
  if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x)
  } else {
    sp <- cbind(sp, "ID" = NA)
  }
  sp
})

cols4VT_339 <- lapply(1:length(signsps), function(x){
  sp <- signsps[[x]][,c("scientificName","decimalLongitude","decimalLatitude","year",
                          "minimumElevationInMeters")]
  sp <- cbind(sp, "ID"=x+45) #to have unique numbers after the 45 sign changing ones
})

AlPh384 <- rbind(do.call(rbind,cols4VT),do.call(rbind,cols4VT_339))
AlPh384 <- AlPh384[complete.cases(AlPh384),]



#write.table(AlPh384, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh.csv", sep=",", row.names=FALSE)


```

```{r}
head(AlPh384)

unique(AlPh384$scientificName[AlPh384$ID == 1])

unique(AlPh384$scientificName[AlPh384$ID == 2])

unique(AlPh384[,c("scientificName","ID")])

table(AlPh384$geodeticDatum)


```

All the variables
```{r}
#library(list)
filenamesHistorical <- list.files("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Prism_Climate_Data/Historical_Data_1895-1980")

filenamesRecent <- list.files("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Prism_Climate_Data/Recent_Data_1981-2016")



```

Average raster layers from PRISM
```{r}
years <- 1895:1980
months <- sprintf('%0.2d', 1:12)
lays <- apply(expand.grid(years,months),1,function(x) paste(x[1],x[2],sep=""))

layers <- lapply(lays, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Prism_Climate_Data/Historical_Data_1895-1980/PRISM_ppt_stable_4kmM2_189501_198012_bil/PRISM_ppt_stable_4kmM2_",x,"_bil.bil", sep=""))
})


avgs <- lapply(1895:1980, function(year){
  stackyear <- lapply(layers,function(x) {
    if(length(grep(paste(year),x@data@names))==1) x
    })
  stackyear1 <- rmNullObs(stackyear)
  s1 <- calc(stack(stackyear1),fun=mean)
  s1
  })

early <- calc(stack(avgs[1:30]),fun=mean)


```


Testing   
```{r}

#average over 30 years 

# 1895-1925


plot(avgs[[30]])
plot(early)

length(layers) #1032 , monthy for each year 12*(1981-1895)
(length(grep("1895",layers[[2]]@data@names))==1)

s1895 <- lapply(layers,function(x) {
  if(length(grep("1895",x@data@names))==1) x
  })


s1895 <- rmNullObs(s1895)



s1 <- stack(s1895)
avg1895 <- calc(s1, fun=mean)

plot(s1895[[1]])
plot(avg1895)
```
<http://rspatial.org/sdm/rst/3_sdm_absence-background.html>    
Make circles around the presence points to select where to put the psudo-absence points Could use the other points, where collections were made but focus species not found and put absence points only in there. Maybe make circles, then get rid of circles where the target species is found and put absence points in the remaining circles - instead of the long time to calculate distances between all points. 
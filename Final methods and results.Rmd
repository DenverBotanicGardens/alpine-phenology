---
title: "Final Methods and Results"
author: "Michelle DePrenger-Levin"
date: "March 3, 2016"
output: html_document
---

load libraries   
```{r}

library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
```

## load functions   
```{r}

JulBloomDate.subset <- function(variable,dataset){
  namesID <- unique(dataset$sppListID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$sppListID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$Scientific.Name[1],
                                    #Species = blnew$Species[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

```


From Q:\Reserach\Plant Lists\
Data to subset
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/CO_SEINet_3200_20160304.csv"))
```

Manipulate dates and names to be consistant before rbind databases
```{r}
colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
names(colo[,c(1,40,13,31,32,21,22,23,24)])
colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr")
colo.sm <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE)),]

colo.sm <- colo[,c(1,40,12,13,31,32,21,22,23,24)]

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm <- colo.sm[grep("[[:digit:]]", colo.sm$Year),]
colo.sm <- colo.sm[colo.sm$Year>=1950,]

length(unique(colo.sm$scientificName)) #2999

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]
colo.sm <- colo.sm[colo.sm$elevation < 4572,]

length(unique(colo.sm$scientificName)) #558

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
wrongdates <- colo.sm$Date..dd.month.yyyy.[colo.sm$Date..dd.month.yyyy. %in% grep("-", colo.sm$Date..dd.month.yyyy., value=TRUE)]

table(wrongdates)

colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))
```

SEInet  
pull out names to match colo.sm and have data needed to subset   
 [1] "Family.Name"          "scientificName"       "Country"              "State"                "Decimal.Latitude"      
 [6] "Decimal.Longitude"    "Elevation..feet."     "Elevation..meters."   "Date..dd.month.yyyy." "Reproductive.Status"   
[11] "Year"                 "elevation"            "startDayOfYear"   
```{r}
head(seinet[seinet$scientificName=="",])
seinet <- seinet[seinet$scientificName!="",]

head(seinet[,c(12:13,56,63:64,31,73,34)])
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert")
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]

seinet.sm <- seinet[,c(12:13,56,63:64,31,73,34)]

# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]

# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
nrow(seinet.sm[is.na(seinet.sm$minimumElevationInMeters),]) #498
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]
identical(seinet.sm,seinet.sm[seinet.sm$minimumElevationInMeters >=3200,])
```

Combine datasets to create bloom2   
```{r}
names <- names(colo.sm[,c(1:2,5:6,11:13)])
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:2,5:6,11:13)]
seinet.bind <- seinet.sm[,c(1:2,4:8)]
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)

bloom2 <- rbind(seinet.bind,colo.bind) 
barplot(table(bloom2$Year))

length(unique(bloom2$scientificName)) #2303
unique(bloom2$Family.Name)[1:100]
proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
```

Fix spelling errors   
<http://cumuseum-archive.colorado.edu/Research/Botany/Databases/vascular_plants.pdf>
```{r}
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:2)
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(3:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
```


#Check for synonyms   
```{r}
synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt"))

tail(synonyms)

length(grep("ssp.",bloom2$scientificName)) #75
length(grep("subsp.",bloom2$scientificName)) #1502
length(grep("ssp.",synonyms$SYNONYMS)) #6400 -> 6426
length(grep("subsp.",synonyms$SYNONYMS)) #27 -> 0

#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.", synonyms$SYNONYMS)
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# names before the merge from our dataset
namebloom2 <- unique(bloom2$scientificName)
length(namebloom2) #2284

# ID links synonyms
# to not lose ones from bloom2 that have no match in synonyms, add all.x = TRUE (left outer join)
bloom.lo <- merge(bloom2, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS", all.x = TRUE)
bloom.o <- merge(bloom2, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS")

length(unique(synonyms$SYNONYMS)) #91,084 names (91094 after adding 12 by hand - 2 were repeated?)
length(unique(synonyms$ID)) #48,141 unique taxa
length(unique(bloom.lo$scientificName)) #2284
length(unique(bloom.o$scientificName)) #1986 -> 1996 after adding ones by hand
length(unique(bloom2$scientificName)) #(2284) 2299 different names in bloom2 before merge - then 1986 after

#which names are in bloom2 before merge (namebloom2) vs. after merge (bloom2$scientificName)
badnames.o <- setdiff(namebloom2,bloom.o$scientificName)
head(badnames.o)
length(badnames.o) #288
badnames.lo <- setdiff(namebloom2,bloom.lo$scientificName)
head(badnames.lo)
length(badnames.lo) #471 -> 0
badnames2 <- namebloom2[!(namebloom2 %in% bloom2$scientificName)]
length(badnames2) #471
badnames3 <- bloom2$scientificName[!(bloom2$scientificName %in% namebloom2)]
length(badnames3) #0
write.table(badnames,"clipboard", sep="\t", row.names=FALSE)

#Use these 'badnames' which are names in bloom2 not found in the USDA synonym list to correct errors
# some are crosses, some misspellings. 
# csv has $Wrong: list of bloom2 names with no UDSA match 
#         $Replacement: corrected or NA if it should just be removed/ignored
# Should just remove ssp. and var. to lump. 
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

#try again, first replace names with corrections, then do the merge for left outer again)
fixbloom2.all <- fixbloom2[complete.cases(fixbloom2[,2]),-3]

#maybe try a merge - make the new column scientificName be same if no matching, new if matching

bloomfoo <- bloom2

#where is there a match for each?
matches <- apply(fixbloom2.all,1,function(checknames){
  grep(checknames[1],bloomfoo$scientificName)
})
allmat <- do.call(c,matches)
length(allmat) #679 switches

```


```{r}
multisub <- function(pattern,replacement,x){
  result <- x
  for(i in 1:length(pattern)){
    result <- gsub(pattern[i], replacement[i],result)
  }
  result
}

bloomfoo$scientificName <- multisub(fixbloom2.all$Wrong,fixbloom2.all$Replacement,bloomfoo$scientificName)

str(bloomfoo)
tochar <- 1
bloomfoo[,tochar] <- sapply(bloomfoo[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(3:length(bloomfoo))
bloomfoo[,tonumeric] <- sapply(bloomfoo[,tonumeric], function(s){
  as.numeric(as.character(s))
})

```

Did it work?
Sure looks like it did!!
```{r}
bloomfoo[bloomfoo$scientificName %in% "Aconitum columbianum",]
bloomfoo[bloomfoo$scientificName %in% "Aconitum columbianum Nutt.",]

bloomfoo[bloomfoo$scientificName %in% "Agoseris aurantiaca",]
bloomfoo[bloomfoo$scientificName %in% "Agoseris aurantiaca var.",]

# Ok, do it!
bloom2 <- bloomfoo
```

After combining datasets, find species with at least 10 years of data
```{r}
# all important data is there
bloom2[bloom2$scientificName=="",]
bloom2[bloom2$Year=="",]
bloom2[bloom2$ID=="",]

#how many species in dataset
length(unique(bloom2$scientificName)) #2294 -> 1828 -> 2207

# how many years collected per species
sp.yr <- as.data.frame(table(bloom2$Year,bloom2$ID))
nrow(sp.yr[sp.yr$Var2=="",])
#sp.yr <- sp.yr[sp.yr$Var2!="",]
nrow(sp.yr[sp.yr$Freq>0,]) #16685 -> 16666 -> 14498 after synonyms
max(sp.yr$Freq[sp.yr$Freq>0]) #80
head(sp.yr)
sp.yr[100:130,]

# How many vouchers per species per year
colpyear <- data.frame(table(bloom2$ID,bloom2$Year))
colpyear.2 <- do.call(rbind,lapply(split(colpyear,as.factor(colpyear$Var2)), function(x) x[which.max(x$Freq),]))
colpyear.2[with(colpyear.2, order(colpyear.2$Freq)),]

# change all values above 0 to 1 from number of collections for that species a year
sp.yr$Freq <- sapply(sp.yr$Freq,function(x){
  if(x>0) {1}
  else 0
  }, USE.NAMES = FALSE)

sp.yr.sp <- sp.yr[sp.yr$Freq>0,]
bysp <- split(sp.yr.sp, sp.yr.sp$Var2, drop=TRUE)

spyears <- data.frame(DataYrs = do.call(rbind,lapply(bysp, function(x){
  sum(x$Freq)
})))

spyears[with(spyears, order(spyears$DataYrs)),]
spyears[which.max(spyears$DataYrs),] # 52
length(spyears[spyears$DataYrs>=10,]) #544 -> 479
mean(spyears$DataYrs[spyears$DataYrs>=10]) #23.65553

# With the ID, no longer have species names as row names...   
# Select the first instance of each synonym - not the accepted, just one of them
first <- synonyms[!duplicated(synonyms$ID),]
nrow(first)
head(spyears)
spyears$ID <- row.names(spyears)
spyears <- merge(first[,-3],spyears, by="ID")
colnames(spyears)[2] <- "Species"
  
sp.10plus <- spyears[spyears$DataYrs>=10,]
nrow(sp.10plus) #547 -> 479, after changing all spelling to coerulea from caerulea and Eritrichum to Eritrichium, fixing arabis/boechera, synonymy
```

compare to previous dataset
```{r}
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/QR_final_R_plant_climate_data_2.csv")) 

minJul.dates <- lapply(unique(bloom$sppListID), function(x){
  this.species <- bloom[bloom$sppListID == x,c(4:5,11,19:26)]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species, these.rows, by = c("startDayOfYear","Year")))
  })

mindate <- function(bl50){
  lapply(unique(bl50$sppListID), function(x){
  #almost, need to use grep with "Avg" or type them all out...
  this.species <- bl50[bl50$sppListID == x,names(bl50) %in% c("Scientific.Name",
                                             "sppListID",
                                             "startDayOfYear",
                                             "Year","Raw_Precip",
                                             "Avg_Hi","Avg_Lo")]   #c(4:5,11,19:28)]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species, these.rows, by = c("startDayOfYear","Year")))
  })
  names(minJul.dates) <- unique(bl50$sppListID)
  min.dates <- do.call(rbind,minJul.dates)
}

bl50 <- subset(bloom, bloom$year_plant > 1949) 
min1950 <- mindate(bl50)
min1950 <- as.data.frame(sapply(min1950, gsub, 
                                  pattern = "coerulea", 
                                  replacement = "caerulea"))

#Fix double space in Hierochola hirta
min1950 <- as.data.frame(sapply(min1950, gsub,
                                  pattern="Hierochlo  hirta",
                                  replacement = "Hierochlo hirta"))

tonumeric <- c(1:2,4:length(min1950))
min1950[,tonumeric] <- sapply(min1950[,tonumeric], function(s){
  as.numeric(as.character(s))
})

i <- sapply(min1950,is.factor)
min1950[i] <- lapply(min1950[i], as.character)

min1950$SciName <- sub( "(^[^ ]+[ ][^ ]+)(.+$)", "\\1", min1950$Scientific.Name)

unique(bloom2$scientificName[complete.cases(match(unique(bloom2$scientificName),unique(min1950$SciName)))])
```

#Family names for each genus    
```{r}
genera <- gsub(" .*$", "", bloom2[,2])
head(genera)

write.table(unique(genera), file =  "Q:/Research/Projects/alpine-phenology/speciesbloom2.csv", sep=",")

#In SEINet loaded genera, updated with ASU Taxonomic Thesaurus
# 121 Families, 457 Genera
asuFams <- read.csv("Q:/Research/Projects/alpine-phenology/colo_seinet_alpine_2016_genus.csv")

asuFams$genus <- gsub(" .*$", "", asuFams[,2])

tochar <- c(1:3)
asuFams[,tochar] <- sapply(asuFams[,tochar], function(ch){
  as.character(ch)
}) 

#missing Polemonium
asuFams <- rbind(asuFams,data.frame(Family = "Polemoniaceae",
                                    ScientificName = "Polemonium sp.",
                                    ScientificNameAuthorship = "L.",
                                    TaxonId = max(asuFams$TaxonId)+1,
                                    genus = "Polemonium"))

```

Pull only the species that have 10 or more years of data for analyses
```{r}
tenyearplus <- merge(bloom2,sp.10plus,by.x="scientificName",by.y="Species")
length(unique(tenyearplus$scientificName)) #545 -> 544 -> 449
tenyearplus[,-c(1:2)] <- lapply(tenyearplus[,-c(1:2)], function(x) as.numeric(as.character(x)))

```

Pull out earliest collection
```{r}
x<- unique(tenyearplus$ID.x)[1]

minJul.dates.2 <- lapply(unique(tenyearplus$ID.x), function(x){
  this.species <- tenyearplus[tenyearplus$ID.x == x,]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  merge(unique(this.species[,c(1,5,7,8)]), these.rows, by = c("startDayOfYear","Year"))
  })

#minJul.dates.2 <- lapply(unique(tenyearplus$scientificName), function(x){
#  this.species <- tenyearplus[tenyearplus$scientificName == x,]
#  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
#  unique(merge(this.species[,c(1,5,7,8)], these.rows, by = c("startDayOfYear","Year")))
#  })

min1950_2 <- do.call(rbind,minJul.dates.2)
head(min1950_2)
singlefoo <- data.frame(table(min1950_2$Year,min1950_2$scientificName))
nrow(singlefoo[singlefoo$Freq> 1,]) #154?

singlefoo <- data.frame(table(min1950_2$Year,min1950_2$ID.x))
nrow(singlefoo[singlefoo$Freq> 1,]) #11? -> 1??

```

Of the first bloom data of species that matched sampling critera, the hightest diversity of species collections were made in the 1990s and early 2000s with a peak of 449 species collected in 1998. Average over the study period was 211 alpine/subalpine species collected per year. 
```{r}
earliestcollection <- data.frame(colSums(table(min1950_2$scientificName,
                                                min1950_2$Year)))
earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),]
mean(earcol$Collections)

```

#Figure 1A
```{r}
ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of Study Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10))

```

 
```{r}

allcollections <- data.frame(colSums(table(bloom2$scientificName,bloom2$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])
```

#Figure 1B  
```{r}
ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500))
```

The day each year with the most collections has on average been Julian day 207 and the day with the most collections has not moved significantly over time from 1950 to 2011. The earliest peak collection day was Julian day 175 (June 30th) in 2007 and the latest peak collection day was Julian day 238 in 1957 (August 29th)   
```{r}
collJ.sp <- data.frame(table(bloom2$Year,bloom2$startDayOfYear))

collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
collmax <- do.call(rbind,collJ.max)
collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))

mean(collmax$Var2)
collmax[which.min(collmax$Var2),]
collmax[which.max(collmax$Var2),]
summary(lm(Var2~Var1, data=collmax))

```


Average high, low, and precip per year  
Take annual climate data from previous dataset
```{r}
head(bloom)
head(bloom[,c(19,20,21,23)])
head(min1950_2)
min1950_2 <- merge(min1950_2,unique(bloom[,c(19,20,21,23)]), by="Year")

unbloom <- unique(bloom[,c(19,20,21,23)])
```

Correlations of climate
```{r}
cor(unbloom[,-1])
cor.test(unbloom[,2],unbloom[,3])
cor.test(unbloom[,2],unbloom[,4])
cor.test(unbloom[,3],unbloom[,4])

```

#Figure 2A  
Using just the average temp per year, not repeated for everytime we have specimen data in a year
```{r}
ggplot(unbloom, aes(Year,Avg_Hi))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Hi~Year, data=unbloom))
```


#Figure 2B
```{r}
ggplot(unbloom, aes(Year,Avg_Lo))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab(~degree~C)+
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Lo~Year, data = unbloom))

```

#Figure 2C   
```{r}
ggplot(unbloom, aes(Year,Raw_Precip))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))


summary(lm(Raw_Precip~Year, data = unbloom))

```


# Figure 3 before A
### Minimum Julian bloom date by year
```{r}
ggplot(min.dates, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest collection date by year")+
  xlab("Year")+
  ylab("Ordinal Date")

summary(lm(min.dates$startDayOfYear~min.dates$Year))
max(min.dates$startDayOfYear)
```

#Figure 3A  
```{r}
ggplot(min1950_2, aes(Avg_Hi, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Hi, data=min1950_2))

```


#Figure 3B
```{r}
ggplot(min1950_2, aes(Avg_Lo, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Lo, data = min1950_2))
```

#Figure 3C
```{r}
ggplot(min1950_2, aes(Raw_Precip, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Raw_Precip, data = min1950_2))

```

Growing Degree Days   
```{r, eval=FALSE}
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
# mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

# Takes an hour to run
avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)
# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

```


Calculate Growing Degree Days
```{r, eval=FALSE}
tbase <- 0

#method 1 from McMaster and Wilhelm 1997
HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})

HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all

nrow(min1950_2[min1950_2$Year > 1980,]) # 7737 -> 7730

#min.dates <- merge(min.dates, tmps, 
#                   by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))

min1950GDD_2 <- mergeMinGDD(min1950_2,tmps)

length(unique(min1950GDD_2$day)) #1152
length(unique(min1950GDD_2$scientificName)) #544

#Years of data for GDD years per species
gdddatayrs <- as.data.frame(table(min1950GDD_2$Year,min1950GDD_2$scientificName))
yrspsp <- aggregate(gdddatayrs[,3], by = list(gdddatayrs$Var2), FUN=sum)
nrow(yrspsp[yrspsp$x>=10,]) #407


### Reduce min1950GDD_2 to only species where 10 or more years of data
min1950GDD_2_10 <- merge(min1950GDD_2,yrspsp[yrspsp$x>=10,],
                         by.x="scientificName",by.y="Group.1")
length(unique(min1950GDD_2_10$scientificName)) #545 -> 407

```

correlations with GDD and climate factors
```{r}
.unbloomGDD <- merge(unbloom,hddyrs,by="Year")
cor(unbloomGDD[,-1])
cor.test(unbloomGDD$avgHDD,unbloomGDD$Raw_Precip)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Hi)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Lo)

```

#Figure 4A   
Average GDD for the ealiest collection date did not change significantly over the study years 
```{r}

ggplot(min1950GDD_2_10, aes(Year,HDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))

summary(lm(HDD~Year, data=min1950GDD_2_10))
```

Growing Degree Days over time
```{r}

ggplot(unbloomGDD, aes(Year,avgHDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("cummulative GDD at collection date")

summary(lm(avgHDD~Year, data=unbloomGDD))
```


#Figure 4B
```{r}
totalGDD <- lapply(HDD.yrs, function(x){
  max(x)
})
totalGDDyr <- data.frame(Year=1981:2011,MaxGDD = do.call(rbind,totalGDD))
head(totalGDDyr)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Maximum cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at ordinal date 273 (T"[base] == 0, degree*C,")")))
summary(lm(MaxGDD~Year,data=totalGDDyr))

```


#Figure 4C
```{r}
#meltd is from Results figures and tables.Rmd
fit1 <- lapply(unique(meltd$Year), function(x){
  stepAIC(lm(GDD~Day+I(Day^2), data=meltd[meltd$Year==x,]),
          scope = lm(GDD~1, data=meltd[meltd$Year==x,]),
          direction = "backward")
})

poly.p <- lapply(fit1, function(fx){
  polynomial(coef(fx))
})
sday <- 1
eday <- 273

secant.poly <- lapply(poly.p,function(x){
  ((as.function(x)(eday)+1000) - (as.function(x)(sday)+1000))/(eday-sday)
})
secant.poly.all <- data.frame(Year=1981:2011, 
                              Secant= do.call(rbind,secant.poly))

ggplot(secant.poly.all, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  ylab("Average rate of change in GDD (day 1 to 273)")

summary(lm(Secant~Year, data=secant.poly.all))

```

#Figure 4D 
```{r}
min1950GDDsecant2 <- merge(min1950GDD_2_10, secant.poly.all,by="Year")
head(min1950GDDsecant2)

ggplot(min1950GDDsecant2, aes(Secant,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by average rate of GDD accumulation") +
  xlab("Average rate of GDD accumulation")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Secant, data=min1950GDDsecant2))

```

```{r, eval=FALSE}
ggplot(min1950GDD_2_10, aes(HDD,startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("GDD")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~HDD, data=min1950GDD_2_10))

```


NPN species   
(from Climate)
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

npn.big <- intersect(npn.all$SciName, min1950_2$scientificName)
length(npn.big) #27

npn.min1950 <- min1950_2[min1950_2$scientificName %in% npn.big,]
length(unique(npn.min1950$scientificName))
```

Clunky but need to change the function
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$scientificName)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$scientificName == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$scientificName[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}

```


Phenology summary tables   
```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",min1950_2)

yr.1950_2$genus <- gsub(" .*$", "", yr.1950_2$Species)
m1 <- merge(yr.1950_2,asuFams,by="genus")
nrow(m1) #545 

write.table(m1, file = "Q:/Research/Projects/alpine-phenology/phensum_yr.csv", sep=",")

nrow(yr.1950_2) #545
nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #475
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #70

nrow(yr.1950_2[yr.1950_2$p.value<0.05,])/nrow(yr.1950_2)


#which ones were left out after the merge?
subset(yr.1950_2, !(yr.1950_2$genus %in% m1$genus))
# Eritrichum and Polemonium
# still Eritrichum aretoidides and Eritrichum nanum var. elongatum

spe_fam <- data.frame(table(asuFams$Family,asuFams$genus))
spe_fam[spe_fam$Freq>1,]

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #65
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) 
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0])

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,]) #5
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])

head(m1)
m1[grep("Arabis", m1$ScientificName),] #none
m1[grep("Boechera", m1$ScientificName),] #Boechera drummondii, B. lemmonii, B. stricta

```

```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", min1950_2)

high.1950_2$genus <- gsub(" .*$", "", high.1950_2$Species)
m2 <- merge(high.1950_2,asuFams,by="genus")
nrow(m2) #545 

write.table(m2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,])
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2)

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,]) 
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) 
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0])

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) 
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0])
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0])

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2)
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2)

```

```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", min1950_2)

low.1950_2$genus <- gsub(" .*$", "", low.1950_2$Species)
m3 <- merge(low.1950_2,asuFams,by="genus")
nrow(m3) #545 

write.table(m3, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #79
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2)

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #75
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) 
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0])

#later
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #4
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0])
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0])

nrow(low.1950_2[low.1950_2$p.value<0.05,])
nrow(low.1950_2[low.1950_2$p.value>=0.05,])

```


```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", min1950_2)

precip.1950_2$genus <- gsub(" .*$", "", precip.1950_2$Species)
m4 <- merge(precip.1950_2,asuFams,by="genus")
nrow(m4) #545 

write.table(m4, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2.csv", sep=",")
nrow(precip.1950_2)

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #51
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2)

#earlier
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #2
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) 
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0])

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #49
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0])
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0])

nrow(precip.1950_2[precip.1950_2$p.value<0.05,])
nrow(precip.1950_2[precip.1950_2$p.value>=0.05,])

```


Figure 4C ??? 
```{r}
ggplot(min1950GDD_2_10, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD))


```

# NPN only precip, high, low
###NPN year
```{r}
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

yr.npn_2$genus <- gsub(" .*$", "", yr.npn_2$Species)
m5 <- merge(yr.npn_2,asuFams,by="genus")
nrow(m5) #27 

write.table(m5, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr.csv", sep=",")

nrow(yr.npn_2) 
nrow(yr.npn_2[yr.npn_2$p.value>=0.05,]) 
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2)

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) 
mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) 
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0])

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #5
mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0])
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0])

```
###NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

high.npn_2$genus <- gsub(" .*$", "", high.npn_2$Species)
m6 <- merge(high.npn_2,asuFams,by="genus")
nrow(m6) #27 

write.table(m6, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,])

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) 
mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) 
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0])

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) 
mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0])
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0])
```
###NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

low.npn_2$genus <- gsub(" .*$", "", low.npn_2$Species)
m7 <- merge(low.npn_2,asuFams,by="genus")
nrow(m7) #27 

write.table(m7, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_2.csv", sep=",")
nrow(low.npn_2)

nrow(low.npn_2[low.npn_2$p.value<0.05,])
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2)

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) 
mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) 
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0])

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,])
mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0])
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0])

```
###NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

precip.NPN_2$genus <- gsub(" .*$", "", precip.NPN_2$Species)
m8 <- merge(precip.NPN_2,asuFams,by="genus")
nrow(m8) #27 

write.table(m8, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_precip_2.csv", sep=",")
nrow(precip.NPN_2)

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #1
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2)

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) 
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0])
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0])

```


Growing Degree Days
```{r}
results <- lapply(unique(min1950GDD_2_10$scientificName), function(x){
  if(nrow(min1950GDD_2_10[min1950GDD_2_10$scientificName==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=min1950GDD_2_10[min1950GDD_2_10$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(min1950GDD_2_10[min1950GDD_2_10$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  }
  })


results[[1]]
rst <- do.call(rbind,results)
head(rst)


nrow(rst) #406
rst[rst$p.value<0.05,]
nrow(rst[rst$p.value<0.05,])

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,])
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) 
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) 

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) 
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) 
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) 

rst$genus <- gsub(" .*$", "", rst$Species)
m10 <- merge(rst,asuFams,by="genus")
nrow(m10)

write.table(m10,file="Q:/Research/Projects/alpine-phenology/GDD_table5a.csv", sep=",")

```

###NPN Growing Degree Days
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)

results.npn <- lapply(unique(minNPNGDD_2$scientificName), function(x){
  if(nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=minNPNGDD_2[minNPNGDD_2$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  }
  })


results.npn[[1]]
rst.npn <- do.call(rbind,results.npn)
head(rst.npn)


nrow(rst.npn) #22
rst[rst.npn$p.value<0.05,]
nrow(rst.npn[rst.npn$p.value<0.05,])

#earlier
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,])
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) 
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) 

#later
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) 
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) 
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) 

rst.npn$genus <- gsub(" .*$", "", rst.npn$Species)
m9 <- merge(rst.npn,asuFams,by="genus")
nrow(m9)  

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a.csv", sep=",")

```

Figure 4C too ????
```{r}
ggplot(minNPNGDD_2, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "black")+
  theme_bw()+
  ylab(expression(GDD))
```


Write to clipboard
```{r}
nrow(m1)
write.table(m1[1:100,], "clipboard", sep="\t", row.names=FALSE)
write.table(m1[101:250,], "clipboard", sep="\t", row.names=FALSE)
write.table(m1[251:400,], "clipboard", sep="\t", row.names=FALSE)
write.table(m1[401:545,], "clipboard", sep="\t", row.names=FALSE)
```

```{r, eval=FALSE}
m1$stat <- 
head(  substitute(
  byquote(F[(ndf*","*ddf)]==f*","~p-value=*p*","~r^2==r), 
                                 list(ndf = m1$numDF,
                                      ddf = m1$denDF,
                                      f = m1$`F Stat`,
                                      p=m1$p.value,
                                      r=m1$adj.r.squ)))
```

#NPN
```{r}
write.table(m5, "clipboard", sep="\t", row.names=FALSE)
write.table(m6, "clipboard", sep="\t", row.names=FALSE)
write.table(m7, "clipboard", sep="\t", row.names=FALSE)
write.table(m8, "clipboard", sep="\t", row.names=FALSE)

write.table(rst.npn, "clipboard", sep="\t", row.names=FALSE)


```









---
title: "Final Methods and Results"
author: "Michelle DePrenger-Levin"
date: "March 3, 2016"
output: html_document
---

load libraries   
```{r}

library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
```

## load functions   
```{r}

JulBloomDate.subset <- function(variable,dataset){
  namesID <- unique(dataset$sppListID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$sppListID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$Scientific.Name[1],
                                    #Species = blnew$Species[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

```


From Q:\Reserach\Plant Lists\
Data to subset
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/CO_SEINet_3200_20160304.csv"))
```

Manipulate dates and names to be consistant before rbind databases
```{r}
colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
names(colo[,c(1,5,40,12,13,31,32,21,22,23,24)])
# [1] "Family.Name"          "Authority"            "scientificName"       "Country"              "State"                "Decimal.Latitude"    
# [7] "Decimal.Longitude"    "Elevation..feet."     "Elevation..meters."   "Date..dd.month.yyyy." "Reproductive.Status" 

colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr")
colo.sm <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE)),]

colo.sm <- colo[,c(1,5,40,12,13,31,32,21,22,23,24)] #added 5 = Authority
names(colo.sm)

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm$Year[nchar(colo.sm$Year)!=4]
length(colo.sm$Year[nchar(colo.sm$Year)==4 & grepl("^[A-Za-z]+$",colo.sm$Year)])
length(colo.sm$Year[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year)])
length(colo.sm$Year[nchar(colo.sm$Year)==4])

colo.sm$Year[(nchar(colo.sm$Year)==4 & grepl("^[A-Za-z]+$",colo.sm$Year)) | nchar(colo.sm$Year)!=4]

#these are all the ones to get rid of.
colo.sm <- colo.sm[nchar(colo.sm$Year)==4,]
colo.sm <- colo.sm[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year),]
colo.sm <- colo.sm[colo.sm$Year>=1950,] #only years 1950 and beyond, before 2011
colo.sm <- colo.sm[colo.sm$Year<2012,] #only years 1950 and beyond, before 2012

table(colo.sm$Year)

length(unique(colo.sm$scientificName)) #2992

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
max(colo.sm$Elevation..feet., na.rm=TRUE) #120000 
colo.sm$Elevation..feet.[colo.sm$Elevation..feet. > 14500 & !is.na(colo.sm$Elevation..feet.)]
max.meter <- 14500/3.2808

colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[colo.sm$elevation<max.meter,] #four are recorded wrong
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]
# colo.sm <- colo.sm[colo.sm$elevation < 4572,]

length(unique(colo.sm$scientificName)) #557

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
wrongdates <- colo.sm$Date..dd.month.yyyy.[colo.sm$Date..dd.month.yyyy. %in% grep("-", colo.sm$Date..dd.month.yyyy., value=TRUE)]

table(wrongdates)

colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))
```


#Need to use authority and name to match synonyms and species together
```{r}
unique(colo.sm$Authority)
unique(colo.sm$Authority[colo.sm$Authority %in% grep("Gray", colo.sm$Authority, value=TRUE)])
unique(colo.sm$Authority[colo.sm$Authority %in% grep("Hooker", colo.sm$Authority, value=TRUE)])
unique(colo.sm$Authority[colo.sm$Authority %in% grep("auct", colo.sm$Authority, value=TRUE)])
```

SEInet  
pull out names to match colo.sm and have data needed to subset   
 [1] "Family.Name"     author     "scientificName"       "Country"              "State"                "Decimal.Latitude"      
 [6] "Decimal.Longitude"    "Elevation..feet."     "Elevation..meters."   "Date..dd.month.yyyy." "Reproductive.Status"   
[11] "Year"                 "elevation"            "startDayOfYear"   
```{r}
head(seinet[seinet$scientificName=="",])
seinet <- seinet[seinet$scientificName!="",]

head(seinet[,c(12,14,13,56,63:64,31,73,34)])
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert")
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]

seinet.sm <- seinet[,c(12,14,13,56,63:64,31,73,34)]

# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
table(seinet.sm$year)
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]

# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
nrow(seinet.sm[is.na(seinet.sm$minimumElevationInMeters),]) #498
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]
identical(seinet.sm,seinet.sm[seinet.sm$minimumElevationInMeters >=3200,])
```

Combine datasets to create bloom2   
```{r}
names <- names(colo.sm[,c(1:3,6:7,12:14)]) #shoot, added aurthority as 2
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:3,6:7,12:14)]
seinet.bind <- seinet.sm[,-4] #take out state
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)

bloom2 <- rbind(seinet.bind,colo.bind) 
barplot(table(bloom2$Year))

length(unique(bloom2$scientificName)) #2303 -> 2302
unique(bloom2$Family.Name)[1:100]
proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
```

Fix spelling errors   
<http://cumuseum-archive.colorado.edu/Research/Botany/Databases/vascular_plants.pdf>
```{r}
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
```


remove genus only, 241 records of only genus
```{r}
nrow(bloom2) #44300
nrow(bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]) #44059
nrow(bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) == 1,]) #241
bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
```

#Check for synonyms  
#What did I do now to synonym_list_byhand2.txt? I think I added a few synonyms at the end that weren't in there. Must have looked on SEINet and Weber and Hartman to find what ID those names (from Herbarium specimens) should be assigned to. 
```{r,eval=TRUE}
synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt"))


length(grep("ssp.",bloom2$scientificName)) #1577 (75) -> 1375 after genus removed ?? 1577
length(grep("subsp.",bloom2$scientificName)) #1502 (0)
length(grep("ssp.",synonyms$SYNONYMS)) #6400 -> 6426
length(grep("subsp.",synonyms$SYNONYMS)) #27 -> 0

#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.", synonyms$SYNONYMS)
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# names before the merge from our dataset
namebloom2 <- unique(bloom2$scientificName)
length(namebloom2) #2284 -> 1960 -> 2219

# deal with the auct non (wrong use of name) from synonym list
nrow(bloom2[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE),]) #163 -> 87
unique(bloom2[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE),])

unique(bloom2$scientificName[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE)])

nrow(synonyms[synonyms$AUTH %in% grep("auct. non", synonyms$AUTH, value=TRUE),]) #827
nrow(synonyms[synonyms$AUTH %in% grep("auct. non", synonyms$AUTH, value=TRUE, invert=TRUE),]) #90737
nrow(synonyms)

# change the four species, "Dasiphora fruticosa" "Gentiana aquatica"   "Thlaspi alpestre"    "Saxifraga arguta", that when used with auct. non will cause synonomy problems
bloom2$scientificName[bloom2$scientificName %in% grep("Dasiphora fruticosa", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non (L.) Rydb."] <- "Potentilla fruticosa"

bloom2$scientificName[bloom2$scientificName %in% grep("Gentiana aquatica", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non L."] <- "Gentiana fremontii"

bloom2$scientificName[bloom2$scientificName %in% grep("Saxifraga arguta", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non D. Don"] <- "Saxifraga odontoloma"

bloom2$scientificName[bloom2$scientificName %in% grep("Thlaspi alpestre", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non L."] <- "Noccaea fendleri ssp. glauca"



# ID links synonyms
# to not lose ones from bloom2 that have no match in synonyms, add all.x = TRUE (left outer join)
bloom.o <- merge(bloom2, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS")

length(unique(synonyms$SYNONYMS)) #91,084 names (91094 after adding 12 by hand to 'byhand2')
length(unique(synonyms$ID)) #48,141 unique taxa
length(unique(bloom.lo$scientificName)) #2284 --> 1960 before adding ones by hand
length(unique(bloom.o$scientificName)) #1986 -> 1934
length(unique(bloom2$scientificName)) #(2284) 2215

#which names are in bloom2 before merge (namebloom2) vs. after merge (bloom2$scientificName)
badnames.o <- setdiff(namebloom2,bloom.o$scientificName)
head(badnames.o)
length(badnames.o) #288 -> 281 -> 285

badnames2 <- namebloom2[!(namebloom2 %in% bloom2$scientificName)]
length(badnames2) #471
badnames3 <- bloom2$scientificName[!(bloom2$scientificName %in% namebloom2)]
length(badnames3) #0
write.table(badnames.o,"clipboard", sep="\t", row.names=FALSE)

#Use these 'badnames' which are names in bloom2 not found in the USDA synonym list to correct errors
# some are crosses, some misspellings. 
# csv has $Wrong: list of bloom2 names with no UDSA match 
#         $Replacement: corrected or NA if it should just be removed/ignored
# Should just remove ssp. and var. to lump. 
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

#try again, first replace names with corrections, then do the merge for left outer again)
fixbloom2.all <- fixbloom2[complete.cases(fixbloom2[,2]),-3]

#maybe try a merge - make the new column scientificName be same if no matching, new if matching

bloomfoo <- bloom2

#where is there a match for each?
matches <- apply(fixbloom2.all,1,function(checknames){
  grep(checknames[1],bloomfoo$scientificName)
})
allmat <- do.call(c,matches)
length(allmat) #679 switches
```



```{r,eval=TRUE}
multisub <- function(pattern,replacement,x){
  result <- x
  for(i in 1:length(pattern)){
    result <- gsub(pattern[i], replacement[i],result)
  }
  result
}

bloomfoo$scientificName <- multisub(fixbloom2.all$Wrong,fixbloom2.all$Replacement,bloomfoo$scientificName)

str(bloomfoo)
```


Did it work?
Sure looks like it did!!
```{r,eval=FALSE}
bloomfoo[bloomfoo$scientificName %in% "Aconitum columbianum",]
bloomfoo[bloomfoo$scientificName %in% "Aconitum columbianum Nutt.",]
bloom2[bloom2$scientificName %in% "Aconitum columbianum Nutt.",]

bloomfoo[bloomfoo$scientificName %in% "Agoseris aurantiaca",]
bloomfoo[bloomfoo$scientificName %in% "Agoseris aurantiaca var.",]
bloom2[bloom2$scientificName %in% "Agoseris aurantiaca var.",]
```


How many species have two species ID numbers?
```{r,eval=FALSE}
foo <- data.frame(table(bloom2$scientificName,bloom2$ID))
sort(table(foo$Var1[foo$Freq>0])) #19 throw them out!
foo2 <- table(foo$Var1[foo$Freq>0])
dups <- foo2[foo2>1]
unique(bloom2[bloom2$scientificName %in% names(dups),c(1,2,8)])

dupids <- unique(bloom2$ID[bloom2$scientificName %in% names(dups)])

```
# remove these from the database
Agrostis variabilis, Anemone multifida, Antennaria parvifolia, Antennaria umbrinella, Bromus anomalus, Carex atrata, Carex hallii, Dasiphora fruticosa, Eleocharis, Erigeron acris, Festuca ovina, Galium boreale, Linum lewisii, Oxytropis deflexa, Paronychia pulvinata  (go with Caryophyllaceae instead of Alsinaceae??), Rorippa teres, Salix anglorum, Salix arctica, Senecio cymbalarioides     

```{r}
issues.bloom2 <- bloom2[bloom2$scientificName %in% unique(grep(paste(names(dups), collapse="|"),
                                              bloom2$scientificName, value = TRUE)),]

unique(issues.bloom2[,c(1,2,3,length(issues.bloom2))])

issues.synonyms <- synonyms[synonyms$ID %in% grep(paste(dupids, collapse="|"),
                            synonyms$ID, value = TRUE),]
issues.synonyms[,c(1,3)]

plantinfo[plantinfo$Symbol %in% grep("AGVA",plantinfo$Symbol,value=TRUE),]
plantinfo[plantinfo$Symbol %in% grep("DAFR",plantinfo$Symbol,value=TRUE),]
# impliment on synonyms before applying IDs

#synonyms <- synonyms$ID[synonyms$ID != 1197]


bloom2[bloom2$scientificName %in% grep("Dasiphora fruticosa", bloom2$scientificName,value=TRUE),]
#All are auct. non (L.) Rydb. Will change all to Potentilla fruiticosa L. (although they will still say the wrong authority)
bloom2[bloom2$scientificName == "Dasiphora fruticosa",]
bloom2$scientificName[bloom2$scientificName == "Dasiphora fruticosa"] <- "Potentilla fruticosa"

# None are auct. non L. p.p. which would be Erigeron acris ssp. debilis
bloom2[bloom2$scientificName %in% grep("Erigeron acris", bloom2$scientificName,value=TRUE),]

bloom2[bloom2$scientificName %in% grep("Festuca ovina", bloom2$scientificName,value=TRUE),]

bloom2[bloom2$scientificName %in% grep("Galium boreale", bloom2$scientificName,value=TRUE),]

bloom2[bloom2$scientificName %in% grep("Linum lewisii", bloom2$scientificName,value=TRUE),]

bloom2[bloom2$scientificName %in% grep("Oxytropis deflexa", bloom2$scientificName,value=TRUE),]

bloom2[bloom2$scientificName %in% grep("Paronychia pulvinata", bloom2$scientificName,value=TRUE),]

bloom2[bloom2$scientificName %in% grep("Rorippa teres", bloom2$scientificName,value=TRUE),]

bloom2[bloom2$scientificName %in% grep("Salix anglorum", bloom2$scientificName,value=TRUE),]
bloom2[bloom2$scientificName %in% grep("Salix arctica", bloom2$scientificName,value=TRUE),]
bloom2[bloom2$scientificName %in% grep("Salix arctophila", bloom2$scientificName,value=TRUE),]

#remove the wrong ones then go back to merging 
```


# Remove the errant names from the synonym list so connections can be made by species name without author. Author adds too much error with different abreviations. 
```{r}
head(synonyms) # too big!

unique(synonyms[synonyms$SYNONYMS %in% names(dups),])
unique(bloom2[bloom2$ID %in% dupids,c(1,2,8)])

unique(colo[grep("non", colo$Authority),]) #Balsamita major Desfontaines, non L.

unique(seinet[grep("non", seinet$scientificNameAuthorship),c(12,13,14)]) #auct. non (L.) Rydb. 
#auct. non L.         
#auct. p.p. non L.    (Scribn.) Wagnon     auct. non D. Don   


library(stringr)
word(unique(synonyms$AUTH[synonyms$SYNONYMS %in% names(dups)]),start=3, end=-1)

```

#Change synonyms to reflect the needed synonomy changes
```{r}
head(synonyms)

#Agrostis variabilis: listed with Rydb. and Rydberg for 1197 and 1202, neither say auct. non Rydb which is  Agrostis rossiae Vasey; will remove 1197 auct. non Rydb., Also remove 1202 Agrostis rossiae acut. non Vasey 
synonyms[synonyms$ID == 1197 & synonyms$SYNONYMS == "Agrostis variabilis",]
which(synonyms$ID == 1197 & synonyms$SYNONYMS == "Agrostis variabilis") #2081
synonyms[synonyms$ID == 1202,] #2101

synonyms[synonyms$ID == 37415 & synonyms$SYNONYMS == "Anemone multifida",]
which(synonyms$ID == 37415 & synonyms$SYNONYMS == "Anemone multifida")

synonyms[as.numeric(c(25940,25944)),]
synonyms[60030,]

removerows <- c(which(synonyms$ID == 1197 & synonyms$SYNONYMS == "Agrostis variabilis"),
                2101,
                which(synonyms$ID == 37415 & synonyms$SYNONYMS == "Anemone multifida"),
                which(synonyms$ID == 2380 & synonyms$SYNONYMS == "Antennaria parvifolia"),
                which(synonyms$ID == 2399 & synonyms$SYNONYMS == "Antennaria umbrinella"),
                which(synonyms$ID == 6434 & synonyms$SYNONYMS == "Bromus anomalus"),
                which(synonyms$ID == 8326 & synonyms$SYNONYMS == "Carex atrata"),
                which(synonyms$ID == 8505 & synonyms$SYNONYMS == "Carex hallii"),
                which(synonyms$ID == 14111 & synonyms$SYNONYMS == "Dasiphora fruticosa"),
                which(synonyms$ID == 17028 & synonyms$SYNONYMS == "Erigeron acris"),
                which(synonyms$ID == 19023 & synonyms$SYNONYMS == "Festuca ovina"),
                which(synonyms$ID == 19802 & synonyms$SYNONYMS == "Galium boreale"),
                which(synonyms$ID == 26389 & synonyms$SYNONYMS == "Linum lewisii"),
                which(synonyms$ID == 31730 & synonyms$SYNONYMS == "Oxytropis deflexa"),
                which(synonyms$ID == 32230 & synonyms$SYNONYMS == "Paronychia pulvinata"),
                which(synonyms$ID == 39088 & synonyms$SYNONYMS == "Rorippa teres"),
                which(synonyms$ID == 39918 & synonyms$SYNONYMS == "Salix anglorum"),
                which(synonyms$ID == 39919 & synonyms$SYNONYMS == "Salix arctica"),
                which(synonyms$ID == 31847 & synonyms$SYNONYMS == "Senecio cymbalarioides"))

nrow(synonyms[-c(removerows),])
nrow(synonyms[c(removerows),])
nrow(synonyms)

synonyms <- synonyms[-c(removerows),]
```

# Create bloom2 again after removing the problem names   
From methods: "Looking for ‘auct. non’ authorities in the herbarium collections. Seven names appear on herbarium collections in this dataset with inappropriate uses of the name (‘auct. non”). These will cause problems with synonymy by scientific name without including the author. Authority has problems when matching R verbatim due to spelling and abbreviation errors."
```{r}
bloom2 <- bloomfoo

bloom2[bloom2$scientificName %in% grep("major", bloom2$scientificName, value=TRUE),] # no Balsamita major?!

bloom2$scientificName[bloom2$scientificName %in% grep("Dasiphora fruticosa", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non (L.) Rydb."] <- "Potentilla fruticosa"

bloom2$scientificName[bloom2$scientificName %in% grep("Gentiana aquatica", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non L."] <- "Gentiana fremontii"

bloom2$scientificName[bloom2$scientificName %in% grep("Carex atrata", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. p.p. non L."] <- "Carex heteroneura var. epapillosa"

bloom2$scientificName[bloom2$scientificName %in% grep("Thlaspi alpestre", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non L."] <- "Noccaea fendleri ssp. glauca"

bloom2$scientificName[bloom2$scientificName %in% grep("Gentiana amarella", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. p.p. non L."] <- "Gentiana amarella ssp. acuta"

bloom2$scientificName[bloom2$scientificName %in% grep("Saxifraga arguta", bloom2$scientificName, value=TRUE)&
        bloom2$Authority == "auct. non D. Don"] <- "Saxifraga odontoloma"
```


### THIS SHOULD BE AFTER FIXING SYNONYM LIST
```{r, eval=FALSE}
# Now merge with synonyms
bloom.temp <- merge(bloom2, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS")

str(bloom.temp)
bloom2 <- bloom.temp

```


After combining datasets, find species with at least 10 years of data
```{r}
#how many species in dataset
length(unique(bloom.o$scientificName)) #2299 -> 1835 -> 1938
length(unique(bloom.o$ID)) # 1563 grouped by synonyms -> 1582

# how many years collected per species
sp.yr <- as.data.frame(table(bloom2$Year,bloom2$ID))

nrow(sp.yr[sp.yr$Freq>0,]) #14369 -> 14837
mean(sp.yr$Freq[sp.yr$Freq > 0]) 
max(sp.yr$Freq[sp.yr$Freq>0]) #80
tail(sp.yr)

# How many vouchers per species per year
colpyear <- data.frame(table(bloom2$ID,bloom2$Year))
colpyear.2 <- do.call(rbind,lapply(split(colpyear,as.factor(colpyear$Var2)),
                                   function(x) x[which.max(x$Freq),]))

colpyear.2[with(colpyear.2, order(colpyear.2$Freq)),]

# change all values above 0 to 1 from number of collections for that species a year
# finding which years have any data, not the minimum date
sp.yr$Freq <- sapply(sp.yr$Freq,function(x){
  if(x>0) {1}
  else 0
  }, USE.NAMES = FALSE)

sp.yr.sp <- sp.yr[sp.yr$Freq>0,]
bysp <- split(sp.yr.sp, sp.yr.sp$Var2, drop=TRUE)
names(bysp[1]) #will need to change to names from ID number USDA later....

spyears <- do.call(rbind,lapply(bysp, function(x){
  data.frame(DataYrs = sum(x$Freq),ID = unique(x$Var2))
}))

spyears[with(spyears, order(spyears$DataYrs)),]
spyears[which.max(spyears$DataYrs),] # 52
nrow(spyears[spyears$DataYrs>=10,]) #473 -> 490
mean(spyears$DataYrs[spyears$DataYrs>=10]) #23.71429

sp.10plus <- spyears[spyears$DataYrs>=10,]
```


Pull only the species that have 10 or more years of data for analyses   
Not earliest but does tell me if one per species per year to tell how many species have at least 10 years a year   
```{r}
tenyearplus <- merge(bloom2,sp.10plus,by = "ID")
length(unique(sp.10plus$ID)) # 498 -> 473 -> 490
length(unique(tenyearplus$scientificName)) #654 -> 730
length(unique(tenyearplus$ID)) #473 -> 490

synlist <- lapply(split(tenyearplus, tenyearplus$ID), function(x){
  data.frame(Names = unique(x$scientificName), ID = unique(x$ID))
})

synlist <- do.call(rbind,synlist)
synlist[1:30,]
```



Pull out earliest collection   
```{r}
#x<- unique(tenyearplus$ID)[100]

minJul.dates.2 <- lapply(unique(tenyearplus$ID), function(x){
  this.species <- tenyearplus[tenyearplus$ID == x,]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  merge(unique(this.species[,c("ID","Year","startDayOfYear","DataYrs")]), these.rows,
        by=c("startDayOfYear","Year"))
  })

min1950_2 <- do.call(rbind,minJul.dates.2)
head(min1950_2)

length(unique(min1950_2$ID)) #473 -> 490
```

###START HERE#### can't figure out which names don't have growth habit info - to fill it in!
```{r}
# check that none have more than one a year
singlefoo <- data.frame(table(min1950_2$Year,min1950_2$ID))
nrow(singlefoo[singlefoo$Freq> 1,]) #154? -> 0 Yay!

```


What if I go through all the data, then worry about finding the accepted name and associated plant informaiton at the end?
```{r}
# Before linking one name with the IDs that have 10 or more years of data, link the names with plantsyn traits. 
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",")

names(plantsyn)
table(plantsyn$Growth.Habit)
#plantsyn[plantsyn$Growth.Habit!="",]
length(unique(plantsyn$Accepted.Symbol)) #4635

###START HERE####
# Should do this before getting to species with 10 years or more to have the accepted name! or could do this just to get the accepted name after... 
#Need to link the ID with the names used 
merge.1 <- merge(unique(bloom2[,-c(4:8)]),
                 unique(plantsyn[,c(1:4,19,26:31)]), 
                 by.x = "scientificName", by.y = "Scientific.Name", all.x =TRUE)
head(merge.1)
merge.1[merge.1$ID == 21,]

#Instead of the first one, the one where Synonym.Symbol (or the first for that) is missing would be the accepted name!
## min1950_2 has just ID, need to pick which name (and info) to go with each ID number
## bloom2 has all the names and ID. Make something from bloom2 to pick the one accepted name then use that to link the 
# one accepted name to the number in min1950_2. Just need to make sure that all the IDs in new thing are in min1950_2
acpted <- merge.1[which(merge.1$Synonym.Symbol==""),]
length(unique(merge.1$ID))
length(unique(merge.1$scientificName))
onename <- acpted[!duplicated(acpted$ID),]

onename[onename$Duration=="",] #Potentilla
onename[onename$Growth.Habit=="",] #Potentilla

length(unique(onename$ID)) #1216 -> 1276
setdiff(unique(min1950_2$ID),unique(onename$ID))
length(setdiff(unique(min1950_2$ID),unique(onename$ID))) #20 numbers that are in min1950_2 but not in onename
unique(bloom2$scientificName[bloom2$ID %in% grep(paste(setdiff(unique(min1950_2$ID),
                                                               unique(onename$ID)),collapse ="|"),
                                                 bloom2$ID, value=TRUE)])
unique(bloom2[bloom2$ID %in% grep(paste(setdiff(unique(min1950_2$ID),unique(onename$ID)),collapse ="|"),
                                  bloom2$ID, value=TRUE),c(1,)])


min1950_2.foo <- merge(min1950_2, onename, by="ID", all.x = TRUE)
head(min1950_2.foo)
length(unique(min1950_2.foo$ID)) #498! Yay! -> 473, but what does that mean for missing names? 490
min1950_2 <- min1950_2.foo

#Check that there is only one species collection date per year
singlefoo <- data.frame(table(min1950_2$Year,min1950_2$ID))
nrow(singlefoo[singlefoo$Freq> 1,]) #11? -> 1?? -> 0

length(unique(min1950_2$ID)) #473 species -> 490
mean(min1950_2$DataYrs[!duplicated(min1950_2$ID)]) #23.71429 years

nrow(min1950_2) #11083 -> 11511
write.table(min1950_2, file="P:/hackathon/alpine-phenology/datasets/min1950_2.csv", sep=",")
```

min1950_2 from away
```{r}
min1950_2 <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/min1950_2.csv"))


```

# How many forbs vs. grasses vs. tree? How many 
######START HERE#######
```{r}
unique(min1950_2$scientificName[min1950_2$Growth.Habit == "" & !is.na(min1950_2$Growth.Habit)])

unique(min1950_2$Growth.Habit)
unique(min1950_2$Bloom.Period)
unique(min1950_2$Duration)

GH <- data.frame(table(min1950_2$Growth.Habit[!duplicated(min1950_2$ID)]))
GH[GH$Freq>0,]
sum(GH$Freq)#470

whaa <- unique(min1950_2$ID[is.na(min1950_2$Growth.Habit)])
min1950_2[min1950_2$ID==whaa[1],]
ns <- unique(bloom2$scientificName[bloom2$ID %in% grep(paste(whaa[1],"|"),bloom2$ID,value=TRUE)])


table(unique(min1950_2$Growth.Habit))
sum(table(unique(min1950_2$scientificName))) #470

sum(GH$Freq) # 434 - is a subset that has this information on it! what to do?! -> 468
min1950_2$scientificName[is.null(min1950_2$Growth.Habit)&!is.na(min1950_2$ID)]

sum(  GH$Freq[GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE)]) #335 Forb/herbs
sum(  GH$Freq[GH$Var1 %in% grep("Vine", GH$Var1, value=TRUE) & GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE, invert=TRUE)]) #1 vine put it with shrub
sum(  GH$Freq[GH$Var1 %in% grep("shrub", GH$Var1, value=TRUE, ignore.case=TRUE) & GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE, invert=TRUE)]) #31 shrubs/subshrubs
sum(  GH$Freq[GH$Var1 %in% grep("Tree", GH$Var1, value=TRUE, ignore.case=TRUE) & 
                GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE, invert=TRUE, ignore.case=TRUE) &
                GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE, invert=TRUE, ignore.case=TRUE)]) #11 trees



```

Of the first bloom data of species that matched sampling critera, the hightest diversity of species collections were made in the 1990s and early 2000s with a peak of 449 species collected in 1998. Average over the study period was 211 alpine/subalpine species collected per year. 
```{r}
earliestcollection <- data.frame(colSums(table(min1950_2$scientificName, #should be only one name now
                                                min1950_2$Year)))

earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),]
mean(earcol$Collections) #182.9508

```
     Year Collections
1998 1998         394  

###START HERE### and put them into the results document!
#Figure 1A
```{r}
ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of Study Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10))

```

 
```{r}
allcollections <- data.frame(colSums(table(bloom2$scientificName,bloom2$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])
```

#Figure 1B  
```{r}
ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500))
```

The day each year with the most collections has on average been Julian day 207 and the day with the most collections has not moved significantly over time from 1950 to 2011. The earliest peak collection day was Julian day 175 (June 30th) in 2007 and the latest peak collection day was Julian day 238 in 1957 (August 29th)   
```{r}
collJ.sp <- data.frame(table(bloom2$Year,bloom2$startDayOfYear))

collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
collmax <- do.call(rbind,collJ.max)
collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))

mean(collmax$Var2)
collmax[which.min(collmax$Var2),]
collmax[which.max(collmax$Var2),]
summary(lm(Var2~Var1, data=collmax))

```


Average high, low, and precip per year  
Take annual climate data from previous dataset
```{r}
head(bloom)
head(bloom[,c(19,20,21,23)])
head(min1950_2)
min1950_2 <- merge(min1950_2,unique(bloom[,c(19,20,21,23)]), by="Year")

write.table(min1950_2, file="P:/hackathon/alpine-phenology/datasets/min1950_2.csv", sep=",")

unbloom <- unique(bloom[,c(19,20,21,23)])
```

Correlations of climate
```{r}
cor(unbloom[,-1])
cor.test(unbloom[,2],unbloom[,3])
cor.test(unbloom[,2],unbloom[,4])
cor.test(unbloom[,3],unbloom[,4])

```

#Figure 2 Year x Bloom date
```{r}
ggplot(min1950_2, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10))  

summary(lm(startDayOfYear~Year, data=min1950_2))

```

#Figure 2A  
Using just the average temp per year, not repeated for everytime we have specimen data in a year
```{r}
ggplot(unbloom, aes(Year,Avg_Hi))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Hi~Year, data=unbloom))
```


#Figure 2B
```{r}
ggplot(unbloom, aes(Year,Avg_Lo))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab(~degree~C)+
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Lo~Year, data = unbloom))

```

#Figure 2C   
```{r}
ggplot(unbloom, aes(Year,Raw_Precip))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))


summary(lm(Raw_Precip~Year, data = unbloom))

```


#Figure 3A  
```{r}
ggplot(min1950_2, aes(Avg_Hi, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Hi, data=min1950_2))

```


#Figure 3B
```{r}
ggplot(min1950_2, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Lo, data = min1950_2))
```

#Figure 3C
```{r}
ggplot(min1950_2, aes(Raw_Precip, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Raw_Precip, data = min1950_2))

```

Growing Degree Days   
```{r, eval=FALSE}
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
# mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

# Takes an hour to run
avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)
# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

```


Calculate Growing Degree Days
```{r, eval=FALSE}
tbase <- 0

#method 1 from McMaster and Wilhelm 1997
HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})

HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all

nrow(min1950_2[min1950_2$Year > 1980,]) # 7737 -> 7730 -> 7447

#min.dates <- merge(min.dates, tmps, 
#                   by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))

min1950GDD_2 <- mergeMinGDD(min1950_2,tmps)

length(unique(min1950GDD_2$day)) #1152 -> 1149
length(unique(min1950GDD_2$scientificName)) #544 -> 493

#Years of data for GDD years per species
gdddatayrs <- as.data.frame(table(min1950GDD_2$Year,min1950GDD_2$scientificName))
yrspsp <- aggregate(gdddatayrs[,3], by = list(gdddatayrs$Var2), FUN=sum)
nrow(yrspsp[yrspsp$x>=10,]) #407 -> 376


### Reduce min1950GDD_2 to only species where 10 or more years of data
min1950GDD_2_10 <- merge(min1950GDD_2,yrspsp[yrspsp$x>=10,],
                         by.x="scientificName",by.y="Group.1")
length(unique(min1950GDD_2_10$scientificName)) #545 -> 376

```

correlations with GDD and climate factors
```{r}
.unbloomGDD <- merge(unbloom,hddyrs,by="Year")
cor(unbloomGDD[,-1])
cor.test(unbloomGDD$avgHDD,unbloomGDD$Raw_Precip)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Hi)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Lo)

```

#Figure 4A   
Average GDD for the ealiest collection date did not change significantly over the study years 
```{r}
ggplot(min1950GDD_2_10, aes(Year,HDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))

summary(lm(HDD~Year, data=min1950GDD_2_10))
```

Growing Degree Days over time
```{r}

ggplot(unbloomGDD, aes(Year,avgHDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("cummulative GDD at collection date")

summary(lm(avgHDD~Year, data=unbloomGDD))
```


#Figure 4B
```{r}
totalGDD <- lapply(HDD.yrs, function(x){
  max(x)
})
totalGDDyr <- data.frame(Year=1981:2011,MaxGDD = do.call(rbind,totalGDD))
head(totalGDDyr)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Maximum cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at ordinal date 273 (T"[base] == 0, degree*C,")")))
summary(lm(MaxGDD~Year,data=totalGDDyr))

```


#Figure 4C
```{r}
#meltd is from Results figures and tables.Rmd
fit1 <- lapply(unique(meltd$Year), function(x){
  stepAIC(lm(GDD~Day+I(Day^2), data=meltd[meltd$Year==x,]),
          scope = lm(GDD~1, data=meltd[meltd$Year==x,]),
          direction = "backward")
})

poly.p <- lapply(fit1, function(fx){
  polynomial(coef(fx))
})
sday <- 1
eday <- 273

secant.poly <- lapply(poly.p,function(x){
  ((as.function(x)(eday)+1000) - (as.function(x)(sday)+1000))/(eday-sday)
})
secant.poly.all <- data.frame(Year=1981:2011, 
                              Secant= do.call(rbind,secant.poly))

ggplot(secant.poly.all, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  ylab("Average rate of change in GDD (day 1 to 273)")

summary(lm(Secant~Year, data=secant.poly.all))

```

#Figure 4D 
```{r}
min1950GDDsecant2 <- merge(min1950GDD_2_10, secant.poly.all,by="Year")
head(min1950GDDsecant2)

ggplot(min1950GDDsecant2, aes(Secant,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by average rate of GDD accumulation") +
  xlab("Average rate of GDD accumulation")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Secant, data=min1950GDDsecant2))

```

```{r, eval=FALSE}
ggplot(min1950GDD_2_10, aes(HDD,startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("GDD")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~HDD, data=min1950GDD_2_10))

```


NPN species   
(from Climate)    
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

#although lots of these might not have 10 years    
#Match names - synonyms and all
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big) #27 -> 77

# find how many unique IDs match
npn.IDs <- bloom2$ID[bloom2$scientificName %in% npn.big]
length(unique(npn.IDs)) #78

# How many IDs that match have collections within 1950 to 2011
npn.foo <- min1950_2[min1950_2$ID %in% npn.IDs,]
nrow(npn.foo)
length(unique(npn.foo$ID)) #29
sort(unique(npn.foo$scientificName))
```

Clunky but need to change the function
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    blnew$scientificName[1],
                                    blnew$Family.Name[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "Fam", "adj.r.squ")
  JYC
}

```


Phenology summary tables    
```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",min1950_2)

nrow(yr.1950_2)

write.table(yr.1950_2, file = "Q:/Research/Projects/alpine-phenology/phensum_yr.csv", sep=",")

nrow(yr.1950_2) #545 -> 498
nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #475 -> 440
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #70 -> 58

nrow(yr.1950_2[yr.1950_2$p.value<0.05,])/nrow(yr.1950_2) #0.1164

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #65 -> 57
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) 
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0])

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,]) #5 -> 1
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])

```


###High Temperature     
```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", min1950_2)

nrow(high.1950_2) #545 -> 498

write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,])
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2)

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,]) 
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) 
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0])

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) 
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0])
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0])

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2)
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2)

```

```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", min1950_2)

nrow(low.1950_2) #545  -> 498

write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #79
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2)

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #75 -> 68
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) 
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0])

#later
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #4 -> 3
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0])
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0])
```

### Precipitation
```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", min1950_2)

nrow(precip.1950_2) #545  -> 498

write.table(precip.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2.csv", sep=",")

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #51 -> 45
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2)

#earlier
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #2 -> 1
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) 
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0])

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #49 -> 44
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0])
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0])
```


Figure 4C ??? 
```{r}
ggplot(min1950GDD_2_10, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD))


```

# NPN only precip, high, low
###NPN year     
```{r}
npn.min1950 <- npn.foo
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

nrow(yr.npn_2) #29 

write.table(yr.npn_2, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr.csv", sep=",")

nrow(yr.npn_2) 
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2)

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) 
mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) 
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0])

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #5 -> 0
mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0])
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0])

```
###NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

nrow(high.npn_2) #27 -> 29

write.table(high.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,])

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) 
mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) 
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0])

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) 
mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0])
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0])
```
###NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

nrow(low.npn_2) #27 -> 29

write.table(low.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_2.csv", sep=",")

nrow(low.npn_2[low.npn_2$p.value<0.05,])
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2)

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) 
mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) 
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0])

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,])
mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0])
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0])

```
###NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

nrow(precip.NPN_2) #27 -> 29

write.table(precip.NPN_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_precip_2.csv", sep=",")

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #1
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2)

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) 
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0])
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0])

```


Growing Degree Days   
```{r}
results <- lapply(unique(min1950GDD_2_10$ID), function(x){
  if(nrow(min1950GDD_2_10[min1950GDD_2_10$ID==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=min1950GDD_2_10[min1950GDD_2_10$ID==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          ID = x,
                          unique(min1950GDD_2_10$scientificName[min1950GDD_2_10$ID == x])[1],
                          unique(min1950GDD_2_10$Family.Name[min1950GDD_2_10$ID == x])[1],
                          foo1$adj.r.squared,
                          N = nrow(min1950GDD_2_10[min1950GDD_2_10$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF",
                   "ID", "Species","Family.Name","adj.r.squ","N")
  JYC
  }
  })


results[[1]]
rst <- do.call(rbind,results)
head(rst)


nrow(rst) #406 -> 377
rst[rst$p.value<0.05,]
nrow(rst[rst$p.value<0.05,])

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,])
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) 
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) 

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) 
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) 
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) 

write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_table5a.csv", sep=",")
```

###NPN Growing Degree Days     
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)

results.npn <- lapply(unique(minNPNGDD_2$scientificName), function(x){
  if(nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=minNPNGDD_2[minNPNGDD_2$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  }
  })


results.npn[[1]]
rst.npn <- do.call(rbind,results.npn)
head(rst.npn)


nrow(rst.npn) #22
rst[rst.npn$p.value<0.05,]
nrow(rst.npn[rst.npn$p.value<0.05,])

#earlier
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,])
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) 
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) 

#later
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) 
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) 
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) 

rst.npn$genus <- gsub(" .*$", "", rst.npn$Species)
m9 <- merge(rst.npn,asuFams,by="genus")
nrow(m9)  

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a.csv", sep=",")

```

Figure 4C too ????
```{r}
ggplot(minNPNGDD_2, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "black")+
  theme_bw()+
  ylab(expression(GDD))
```

#Snow   
Snow report generator <http://wcc.sc.egov.usda.gov/reportGenerator/>   
```{r}
snow <- read.table(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/Monthly19782016_over3200m.txt"),
                   skip=7, header=FALSE,sep=",", na.strings = " ")


header <- scan(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/Monthly19782016_over3200m.txt"),skip=5,nlines=1, what=character(),sep=",")
header2 <- scan(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/Monthly19782016_over3200m.txt"),skip=6,nlines=1,what=character(),sep=",")
names(snow)<-paste(header,header2,sep="_")

head(snow)
```

Average of snow over all stations per month over the years
```{r}
#average over all stations per year
avg.p.yr <- do.call(rbind,lapply(split(snow[,grep("_Snow Depth", names(snow))], 
                                       snow$`Water Year_`), 
                                 function(x) colMeans(x, na.rm = TRUE)))

# get rid of years with no data (every month says 0) - should remove 2016 and Oct and Nov from 1997
avg.p.yr.cc <- avg.p.yr[!is.nan(avg.p.yr[,4]),]
avg.p.yr.cc
# Not to be confused with snowmelt - this is just reformating the data
melt.snow <- melt(avg.p.yr.cc)
head(melt.snow)
melt.snow <- melt.snow[!is.nan(melt.snow$value),]
melt.snow$Var2 <- factor(melt.snow$Var2)
str(melt.snow)


ggplot(melt.snow, aes(as.numeric(Var2),value))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Var1)
```

Reformat snow data:
```{r}
snow.depth <- grep("_Snow Depth", names(snow))
avg.snow <- aggregate(snow[,c(snow.depth)], by=list(snow$`Water Year_`),
                      function(x) mean(x,na.rm=TRUE))
avg.snow <- avg.snow[!is.na(avg.snow[,5]),]

snow.long <- reshape(avg.snow, direction="long",
                     varying=list(names(avg.snow[,-1])),
                     timevar="Month",
                     times=names(avg.snow[,-1]),
                     idvar=c("Group.1"),
                     v.names="Snow.Depth")


snow.long <- snow.long[!is.nan(snow.long$Snow.Depth),]
snow.long$Month <- factor(snow.long$Month, levels = unique(snow.long$Month))
levels(snow.long$Month)
names(snow.long) <- c("Year","Month","Snow.Depth")
```

```{r}
ggplot(snow.long, aes(Year, Snow.Depth, colour=Month))+
  geom_line()+
  theme_bw()+
  facet_wrap(~Month)+
  geom_smooth(method="lm")
```

## LM of snow depth per month over 1997-2015    
```{r}
summary(aov(Snow.Depth~Year*Month, data=snow.long))

summary(lm(Snow.Depth~Year*Month, data=snow.long))

```

```{r}
yr.snow <- aggregate(snow.long$Snow.Depth, by = list(snow.long$Year),
          function(x) sum(x))
#missing data for 1997 and 2016, take those out
yr.snow <- yr.snow[yr.snow$Group.1 %in% c(1998:2015),]
```

#Correlation of snow depth to precip, high and low   
#Snow depth is averaged over sites and then summed for Oct-Sept water year   
Snow depth is only 1998-2015    
precip (unbloom) is only 1950 - 2011
Overlap is 14 years
```{r}
raw.precip.snow <- merge(unbloom, yr.snow, by.x = "Year", by.y = "Group.1")
colnames(raw.precip.snow) <- c("Year","Precip","HighTemp","LowTemp","SnowDepth")

cor(raw.precip.snow[,-1])
pairs(raw.precip.snow[,-1])
```

Growth traits for tables
```{r}
plantinfo <- read.table("P:/hackathon/alpine-phenology/datasets/USDAplantsdata.txt",
                        header=TRUE, sep = ",")
head(plantinfo)


gtyr <- merge(yr.1950_2, plantinfo, by.x = "Species", by.y = "Scientific.Name")

```



#Check for synonyms 
```{r, eval= TRUE}
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",")
names(plantsyn)


bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)
length(grep("ssp.",bloom2$scientificName)) #1577 (75)
length(grep("subsp.",bloom2$scientificName)) #0 (1502)

length(grep("ssp.", plantsyn$Scientific.Name)) #1463
length(grep("subsp.", plantsyn$Scientific.Name)) #0

unique(plantsyn$Genera.Binomial.Author)
# select the first not in parentheses authority to comapare grep
plantsyn$Genera.Binomial.Author[1:10]
# remove anything in parentheses
sub("(?=\\().*?(?<=\\))", "", plantsyn$Genera.Binomial.Author, perl=TRUE)[1:10]
# strsplit to get first word, or use library(stringr)
library(stringr)
word(sub("^\\s+", "",sub("(?=\\().*?(?<=\\))", "", plantsyn$Genera.Binomial.Author, perl=TRUE)),1)[1:10]
#just the last author?
word(plantsyn$Genera.Binomial.Author,-1)[1:10]

length(unique(plantsyn$Scientific.Name)) #15204 (15353)
length(unique(plantsyn$Accepted.Symbol)) #5513
length(unique(plantsyn$Synonym.Symbol)) #9719 (9883)

bloom.o1 <- merge(bloom2, plantsyn[,c(4,1,2,25,26,27,28,29)], by.x = "scientificName", by.y = "Scientific.Name")

badnames.o1 <- setdiff(
  word(bloom2$scientificName,1,end=2)[1:30]
                       ,
                       unique(bloom.o1$scientificName))
head(badnames.o1)
length(badnames.o1) #671 -> 505 -> 516

length(unique(bloom.o1$Accepted.Symbol)) #1429 -> 1384
length(unique(bloom.o1$Synonym.Symbol)) #445 -> 461
```


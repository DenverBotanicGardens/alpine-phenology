---
title: "Final Methods and Results"
author: "Michelle DePrenger-Levin"
date: "March 3, 2016"
output: html_document
---

load libraries   
```{r,echo=FALSE}

library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
```

## load functions   
```{r}

JulBloomDate.subset <- function(variable,dataset){
  namesID <- unique(dataset$sppListID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$sppListID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$Scientific.Name[1],
                                    #Species = blnew$Species[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}
```


From Q:\Reserach\Plant Lists\
Data to subset
```{r}
#too big for getting from GitHub
#colo <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/Complete COLO DB .csv")) 
colo <- read.csv("P:/hackathon/alpine-phenology/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/CO_SEINet_3200_20160304.csv"))
```

Manipulate dates and names to be consistant before rbind databases
```{r}
colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
names(colo[,c(1,40,13,31,32,21,22,23,24)])
colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr")
colo.sm <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE)),]

colo.sm <- colo[,c(1,40,12,13,31,32,21,22,23,24)]

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm <- colo.sm[grep("[[:digit:]]", colo.sm$Year),]
colo.sm <- colo.sm[colo.sm$Year>=1950,]

length(unique(colo.sm$scientificName)) #2999

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]
colo.sm <- colo.sm[colo.sm$elevation < 4572,]

length(unique(colo.sm$scientificName)) #558

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
wrongdates <- colo.sm$Date..dd.month.yyyy.[colo.sm$Date..dd.month.yyyy. %in% grep("-", colo.sm$Date..dd.month.yyyy., value=TRUE)]

table(wrongdates)

colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))
```

SEInet  
pull out names to match colo.sm and have data needed to subset   
 [1] "Family.Name"          "scientificName"       "Country"              "State"                "Decimal.Latitude"      
 [6] "Decimal.Longitude"    "Elevation..feet."     "Elevation..meters."   "Date..dd.month.yyyy." "Reproductive.Status"   
[11] "Year"                 "elevation"            "startDayOfYear"   
```{r}
head(seinet[seinet$scientificName=="",])
seinet <- seinet[seinet$scientificName!="",]

head(seinet[,c(12:13,56,63:64,31,73,34)])
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert")
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]

seinet.sm <- seinet[,c(12:13,56,63:64,31,73,34)]

# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]

# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
nrow(seinet.sm[is.na(seinet.sm$minimumElevationInMeters),]) #498
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]
identical(seinet.sm,seinet.sm[seinet.sm$minimumElevationInMeters >=3200,])
```

Combine datasets
```{r}
names <- names(colo.sm[,c(1:2,5:6,11:13)])
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:2,5:6,11:13)]
seinet.bind <- seinet.sm[,c(1:2,4:8)]
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)

bloom2 <- rbind(seinet.bind,colo.bind) 
barplot(table(bloom2$Year))

length(unique(bloom2$scientificName)) #2303
```


Before subset 
```{r}


```

After combining datasets, find species with at least 10 years of data
```{r}
bloom2[bloom2$scientificName=="",]

bloom2[bloom2$Year=="",]


str(bloom2)
bloom2$scientificName <- as.character(bloom2$scientificName)

# how many years collected per species
sp.yr <- as.data.frame(table(bloom2$Year,bloom2$scientificName))
nrow(sp.yr[sp.yr$Var2=="",])
sp.yr <- sp.yr[sp.yr$Var2!="",]
nrow(sp.yr[sp.yr$Freq>0,]) #16685
max(sp.yr$Freq[sp.yr$Freq>0])
head(sp.yr)
sp.yr[100:130,]


# change all values above 0 to 1 from number of collections for that species a year
sp.yr$Freq <- sapply(sp.yr$Freq,function(x){
  if(x>0) {1}
  else 0
  }, USE.NAMES = FALSE)

sp.yr.sp <- sp.yr[sp.yr$Freq>0,]
bysp <- split(sp.yr.sp, sp.yr.sp$Var2, drop=TRUE)

spyears <- data.frame(DataYrs = do.call(rbind,lapply(bysp, function(x){
  sum(x$Freq)
})))

spyears$Species <- row.names(spyears)
sp.10plus <- spyears[spyears$DataYrs>=10,]
nrow(sp.10plus) #547
```

compare to previous dataset
```{r}
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/QR_final_R_plant_climate_data_2.csv")) 

minJul.dates <- lapply(unique(bloom$sppListID), function(x){
  this.species <- bloom[bloom$sppListID == x,c(4:5,11,19:26)]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species, these.rows, by = c("startDayOfYear","Year")))
  })

mindate <- function(bl50){
  lapply(unique(bl50$sppListID), function(x){
  #almost, need to use grep with "Avg" or type them all out...
  this.species <- bl50[bl50$sppListID == x,names(bl50) %in% c("Scientific.Name",
                                             "sppListID",
                                             "startDayOfYear",
                                             "Year","Raw_Precip",
                                             "Avg_Hi","Avg_Lo")]   #c(4:5,11,19:28)]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species, these.rows, by = c("startDayOfYear","Year")))
  })
  names(minJul.dates) <- unique(bl50$sppListID)
  min.dates <- do.call(rbind,minJul.dates)
}

bl50 <- subset(bloom, bloom$year_plant > 1949) 
min1950 <- mindate(bl50)
min1950 <- as.data.frame(sapply(min1950, gsub, 
                                  pattern = "coerulea", 
                                  replacement = "caerulea"))

#Fix double space in Hierochola hirta
min1950 <- as.data.frame(sapply(min1950, gsub,
                                  pattern="Hierochlo  hirta",
                                  replacement = "Hierochlo hirta"))

tonumeric <- c(1:2,4:length(min1950))
min1950[,tonumeric] <- sapply(min1950[,tonumeric], function(s){
  as.numeric(as.character(s))
})

i <- sapply(min1950,is.factor)
min1950[i] <- lapply(min1950[i], as.character)

min1950$SciName <- sub( "(^[^ ]+[ ][^ ]+)(.+$)", "\\1", min1950$Scientific.Name)

unique(bloom2$scientificName[complete.cases(match(unique(bloom2$scientificName),unique(min1950$SciName)))])
```

Pull only the species that have 10 or more years of data for analyses
```{r}
tenyearplus <- merge(bloom2,sp.10plus,by.x="scientificName",by.y="Species")
length(unique(tenyearplus$scientificName))

```

Pull out earliest collection
```{r}

minJul.dates.2 <- lapply(unique(tenyearplus$scientificName), function(x){
  this.species <- tenyearplus[tenyearplus$scientificName == x,]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species[,c(1,5,7,6,8)], these.rows, by = c("startDayOfYear","Year")))
  })

min1950_2 <- do.call(rbind,minJul.dates.2)
head(min1950_2)

```


Of the first bloom data of species that matched sampling critera, the hightest diversity of species collections were made in the 1990s and early 2000s with a peak of 524 species collected in 1998. Average over the study period was 211 alpine/subalpine species collected per year. 
```{r}
earliestcollection <- data.frame(colSums(table(min1950_2$scientificName,
                                                min1950_2$Year)))
earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),]
mean(earcol$Collections)

```

#Figure 1A
```{r}
ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of Study Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10))+
  scale_y_continuous(limits = c(0,530), breaks = seq(0,530, by=100))

```
 
```{r}

allcollections <- data.frame(colSums(table(bloom2$scientificName,bloom2$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])
```

#Figure 1B  
```{r}
ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2015), breaks = seq(1950,2015, by=10))+
  scale_y_continuous(limits = c(0,4800),breaks = seq(0,4800, by=500))
```

The day each year with the most collections has on average been Julian day 207 and the day with the most collections has not moved significantly over time from 1950 to 2011. The earliest peak collection day was Julian day 175 (June 30th) in 2007 and the latest peak collection day was Julian day 238 in 1957 (August 29th)   
```{r}
collJ.sp <- data.frame(table(bloom2$Year,bloom2$startDayOfYear))

collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
collmax <- do.call(rbind,collJ.max)
collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))

mean(collmax$Var2)
collmax[which.min(collmax$Var2),]
collmax[which.max(collmax$Var2),]
summary(lm(Var2~Var1, data=collmax))

```


Average high, low, and precip per year  
```{r}
head(bloom)
head(bloom[,c(19,20,21,23)])
head(min1950_2)
min1950_2 <- merge(min1950_2,unique(bloom[,c(19,20,21,23)]), by="Year")

unbloom <- unique(bloom[,c(19,20,21,23)])
```

#Figure 2A  
Using just the average temp per year, not repeated for everytime we have specimen data in a year
```{r}
ggplot(unbloom, aes(Year,Avg_Hi))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Hi~Year, data=unbloom))

```


#Figure 2B
```{r}
ggplot(unbloom, aes(Year,Avg_Lo))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab(~degree~C)+
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Lo~Year, data = unbloom))

```

#Figure 2C   
```{r}
ggplot(unbloom, aes(Year,Raw_Precip))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))


summary(lm(Raw_Precip~Year, data = unbloom))

```

#Figure 3A  
```{r}
ggplot(min1950_2, aes(Avg_Hi, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression(~degree~C))+
  ylab("Julian Date")

summary(lm(startDayOfYear~Avg_Hi, data=min1950_2))

```

#Figure 3B
```{r}
ggplot(min1950_2, aes(Avg_Lo, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression(~degree~C))+
  ylab("Julian Date")

summary(lm(startDayOfYear~Avg_Lo, data = min1950_2))
```

#Figure 3C
```{r}
ggplot(min1950_2, aes(Raw_Precip, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Raw_Precip, data = min1950_2))

```

Growing Degree Days   
```{r, eval=FALSE}
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
# mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

# Takes an hour to run
avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)
# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

```


Calculate Growing Degree Days
```{r, eval=FALSE}
tbase <- 0

HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})

HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all

nrow(min1950_2[min1950_2$Year > 1980,]) # 8391

#min.dates <- merge(min.dates, tmps, 
#                   by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))

min1950GDD_2 <- mergeMinGDD(min1950_2,tmps)

length(unique(min1950GDD_2$day)) #1152

```

#Figure 4A
```{r}
ggplot(min1950GDD_2, aes(Year,HDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("cummulative GDD at collection date")

summary(lm(HDD~Year, data=min1950GDD_2))
```

#Figure 4B
```{r}
totalGDD <- lapply(HDD.yrs, function(x){
  max(x)
})
totalGDDyr <- data.frame(Year=1981:2011,MaxGDD = do.call(rbind,totalGDD))
head(totalGDDyr)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Maximum cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("cummulative GDD at end of year")
summary(lm(MaxGDD~Year,data=totalGDDyr))

```

#Figure 4C   
```{r}
ggplot(min1950GDD_2, aes(HDD,startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("GDD")+
  ylab("Julian Date")

summary(lm(startDayOfYear~HDD, data=min1950GDD_2))

```

Clunky but need to change the function
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$scientificName)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$scientificName == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$scientificName[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}

```


Phenology summary tables   
Families merged   
Some are all caps, some not. fix that   
7 with family errors seen in date by year:   
    1. x Castilleja miniata with Orobanchaceae and Scrophulariaceae
    2. Pedicularis bracteosa var. paysoniana with Orobanchaceae and Scrophulariaceae
    3. x Penstemon hallii with plantaginaceae and Scrophulariaceae
    4. x Penstemon harbourii  plantaginaceae and Scrophulariaceae
    5. x Castilleja occidentalis  Orobanchaceae and Scrophulariaceae
    6. x Castilleja rhexiifolia Orobanchaceae and Scrophulariaceae
    7. x Aquilegia coerulea Ranunculaceae and Helleboraceae

```{r}
bloom2$Family.Name <- tolower(bloom2$Family.Name)
fams <- unique(bloom2[,1:2])

fams <- fams[-c(intersect(grep("orobanchaceae", fams$Family.Name), 
                       grep( "Castilleja", fams$scientificName))),]
fams <- fams[-c(intersect(grep("Penstemon",fams$scientificName),
                          grep("plantaginaceae",fams$Family.Name))),]
fams <- fams[-c(intersect(grep("Aquilegia coerulea", fams$scientificName),
                          grep("helleboraceae", fams$Family.Name))),]
fams <- fams[-c(intersect(grep("Pedicularis bracteosa", fams$scientificName),
                          grep("orobanchaceae", fams$Family.Name))),]

```



```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",min1950_2)
write.table(yr.1950_2, file = "Q:/Research/Projects/alpine-phenology/phensum_yr.csv", sep=",")

nrow(yr.1950_2) #547
nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #465
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #82

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #73
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) 
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0])

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,])
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])

#sig.yr.1950_2 <- yr.1950_2[yr.1950_2$p.value<0.05,]
#nrow(sig.yr.1950_2)
#foo12 <- merge(fams,sig.yr.1950_2, by.x = "scientificName", by.y = "Species")
#nrow(foo12)
#write.table(foo12, file = "Q:/Research/Projects/alpine-phenology/phen_sumYearsig.csv", sep=",")

```

```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", min1950_2)
write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,])

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,]) #101
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) 
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0])

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) #5
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0])
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0])

#foo2 <- merge(fams, high.1950_2[high.1950_2$p.value<0.05,])
#nrow(foo2)
#write.table(foo2, file = "Q:/Research/Projects/alpine-phenology/phen_sumhighsig_2.csv", sep=",")
nrow(high.1950_2[high.1950_2$p.value<0.05,])
nrow(high.1950_2[high.1950_2$p.value>=0.05,])

```

```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", min1950_2)
write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2.csv", sep=",")
nrow(low.1950_2)

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #103

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #97
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) 
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0])

#later
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #6
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0])
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0])


#foo3 <- merge(fams[,c(2,4)], low.1950_2[low.1950_2$p.value<0.05,])
#nrow(foo3)
#write.table(foo3, file = "Q:/Research/Projects/alpine-phenology/phen_sumlowsig_2.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,])
nrow(low.1950_2[low.1950_2$p.value>=0.05,])

```

#Figure 4C
```{r}
ggplot(min1950GDD_2, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD[cum]))


```

Growing Degree Days
```{r}
results <- lapply(unique(min1950GDD_2$scientificName), function(x){
  if(nrow(min1950GDD_2[min1950GDD_2$scientificName==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=min1950GDD_2[min1950GDD_2$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(min1950GDD_2[min1950GDD_2$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  }
  })


results[[1]]
rst <- do.call(rbind,results)
head(rst)


nrow(rst) #426
rst[rst$p.value<0.05,]
nrow(rst[rst$p.value<0.05,])

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope <= 0,]) 

nrow(rst1[rst1$p.value>=0.05,])#272
nrow(rst1[rst1$p.value<0.05 & rst1$Slope >0,])#7
rst1[rst1$p.value<0.05 & rst1$Slope >0,]
write.table(rst1[rst1$p.value<0.05 & rst1$Slope >0,],
            file="Q:/Research/Projects/alpine-phenology/table5a.csv", sep=",")
nrow(rst1[rst1$p.value<0.05 & rst1$Slope <=0,])#9

```










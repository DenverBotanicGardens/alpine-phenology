---
title: "Final Methods and Results"
author: "Michelle DePrenger-Levin"
date: "March 3, 2016"
output: html_document
---

load libraries   
```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
library(Taxonstand)
```

#Fresh start
```{r, eval=FALSE}
rm(accpt, allcol, allcollections, bloom, bloom.o, bloom2, bloomfoo,
   collJ.sp, collJ.max, collmax, colo, colo.bind, colo.sm, colpyear, colpyear.2, 
   earcol,
   earliestcollection, fixbloom2, fixbloom2.all, foo, GD, 
   gdddatayrs, GH, hdd.f, HDD.0, 
   high.1950, high.npn_2, high.1950_2, linknames, lo.npn, low.1950,
   low.1950_2, max.swe, Maxpyr, merge.name, min.dates, min.dates.snow, 
   min1950_2,
   min1950GDD_2, min1950GDDmax, minNPNGDD_2, mite, mite.log, mite.log.st, ml.JYC, 
   mpy.df, NAT, npn, 
   npn.all, npn.big, npn.big.m, npn.foo, npn.min1950, npn.only.1950, npn.specimens, 
   npnHigh, 
   npnonly, npnPrecip, npnYear, onename, plantinfo, plantsyn, precip.1950, precip.bl,
   precip.npn, precip.1950_2, precip.sig, precip.npn.sig, pslope, rst, rst.npn, 
   rst1, rsts, 
   se.posno, secant1, secant2, seg.model, seinet, seinet.bind, seinet.sm, sig.in.merge, 
   sig.interaction.JYC, sig.ml.JYC, sig.yr.1950, sig.yr.1950_2, singlefoo, 
   sp.10plus, sp.yr, sp.yr.sp,
   spyears, spyears.snow, synonyms, syns, temps, tenyearplus, 
   toplot, total.p.yr, total.p.yr.cc, 
   total.snow, yr.1950_2, yr.npn_2, yr.sig, yr.sig.min, yrspsp)

```

## load functions   
```{r}

JulBloomDate.subset <- function(variable,dataset){
  namesID <- unique(dataset$sppListID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$sppListID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$Scientific.Name[1],
                                    #Species = blnew$Species[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

```


From Q:\Reserach\Plant Lists\
Data to subset
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/CO_SEINet_3200_20160304.csv"))
```

Manipulate dates and names to be consistant before rbind databases
```{r}
colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
names(colo[,c(1,5,40,13,31,32,21,22,23,24)])
# [1] "Family.Name"          "Authority"            "scientificName"       "State"                "Decimal.Latitude"     "Decimal.Longitude"   
# [7] "Elevation..feet."     "Elevation..meters."   "Date..dd.month.yyyy." "Reproductive.Status" 

colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr")
colo.sm <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE)),]

colo.sm <- colo[,c(1,5,40,13,31,32,21,22,23,24)] #added 5 = Authority
names(colo.sm)

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm$Year[nchar(colo.sm$Year)!=4]
length(colo.sm$Year[nchar(colo.sm$Year)==4 & grepl("^[A-Za-z]+$",colo.sm$Year)])
length(colo.sm$Year[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year)])
length(colo.sm$Year[nchar(colo.sm$Year)==4])

colo.sm$Year[(nchar(colo.sm$Year)==4 & grepl("^[A-Za-z]+$",colo.sm$Year)) | nchar(colo.sm$Year)!=4] #all the bad ones

#these are all the ones to get rid of.
colo.sm <- colo.sm[nchar(colo.sm$Year)==4,] #keep years with 4 digits 
colo.sm <- colo.sm[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year),] #keep ones that are 4 digits but all numeric
colo.sm <- colo.sm[colo.sm$Year>=1950,] #only years 1950 and beyond, before 2011
colo.sm <- colo.sm[colo.sm$Year<2012,] #only years 1950 and beyond, before 2012

table(colo.sm$Year)
barplot(table(colo.sm$Year))

length(unique(colo.sm$scientificName)) #2992

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
max(colo.sm$Elevation..feet., na.rm=TRUE) #120000 
colo.sm$Elevation..feet.[colo.sm$Elevation..feet. > 14500 & !is.na(colo.sm$Elevation..feet.)]
max.meter <- 14500/3.2808

colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[colo.sm$elevation<max.meter,] #four are recorded wrong
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]
# colo.sm <- colo.sm[colo.sm$elevation < 4572,]

length(unique(colo.sm$scientificName)) #557

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
wrongdates <- colo.sm$Date..dd.month.yyyy.[colo.sm$Date..dd.month.yyyy. %in% grep("-", colo.sm$Date..dd.month.yyyy., value=TRUE)]

table(wrongdates)

colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))

table(colo.sm$startDayOfYear)
barplot(table(colo.sm$startDayOfYear))
```

SEInet  
pull out names to match colo.sm and have data needed to subset   
 [1] "family"                   "scientificNameAuthorship" "scientificName"          
 [4] "stateProvince"            "decimalLatitude"          "decimalLongitude"        
 [7] "year"                     "minimumElevationInMeters" "startDayOfYear"          
[10] "reproductiveCondition"
```{r}
nrow(seinet[seinet$scientificName=="",]) #81
seinet <- seinet[seinet$scientificName!="",]

names(seinet[,c(12,14,13,56,63:64,31,73,34,46)])
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)
table(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert","fl","Fr")
sort(table(seinet$reproductiveCondition[seinet$reproductiveCondition %in%unique(grep(paste(repro,collapse="|"),seinet$reproductiveCondition,value=TRUE))]))
sort(table(seinet$reproductiveCondition[seinet$reproductiveCondition %in%unique(grep(paste(repro,collapse="|"),seinet$reproductiveCondition,value=TRUE, invert=TRUE))]))
      
      
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]

seinet.sm <- seinet[,c(12,14,13,56,63:64,31,73,34)]

# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
table(seinet.sm$year)
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]

# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
nrow(seinet.sm[is.na(seinet.sm$minimumElevationInMeters),]) #498
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]
identical(seinet.sm,seinet.sm[seinet.sm$minimumElevationInMeters >=3200,])
barplot(table(seinet.sm$startDayOfYear))
```

#Bloom2
Combine datasets to create bloom2   
[1] "Family.Name"       "Authority"         "scientificName"    "Decimal.Latitude"  "Decimal.Longitude"
[6] "Year"              "elevation"         "startDayOfYear" 
```{r}
names <- names(colo.sm[,c(1:3,5:6,11:13)]) 
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:3,5:6,11:13)]
seinet.bind <- seinet.sm[,-4] #take out state
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)
```

####### BLOOM2 ##########
```{r}
bloom2 <- rbind(seinet.bind,colo.bind) 
barplot(table(bloom2$Year))
barplot(table(bloom2$startDayOfYear))

ggplot(bloom2, aes(as.factor(Year),startDayOfYear))+
  geom_boxplot(aes(fill=Year))

length(unique(bloom2$scientificName)) #2303 -> 2302
proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
```

#Bloom2 
Fix spelling errors   
<http://cumuseum-archive.colorado.edu/Research/Botany/Databases/vascular_plants.pdf>
```{r}
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
```


```{r}
nrow(bloom2) #44300
nrow(bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]) #44059
nrow(bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) == 1,]) #241
```

## 3. Remove any herbarium specimens with Genus only
remove genus only, 241 records of only genus
```{r}
bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
```

#August 29, 2016: try Taxonstand to standardize names and remove orthographic erros using "The Plant List"
```{r}
#install.packages("Taxonstand")
library(Taxonstand)

TPL.bloom2 <-  TPL(bloom2$scientificName) # lots 'have more than one valid synonym'
TPL(unique(bloom2$scientificName[grep("auct", bloom2$Authority)]))
# In TPLck(sp = d, corr = corr, diffchar = diffchar, max.distance = max.distance,  :
#  Gentiana amarella has more than one valid synonym

TPL(c("Dasiphora fruticosa","Potentilla fruticosa"))
```


## 4. found herbarium sheets where name was not in database. 
Check for synonyms - Add ID numbers for unique taxa (link synonyms)    
synonym_list_byhand2.txt? 
added a few synonyms at the end that weren't in there. SEINet and Weber and Hartman to find what ID those names (from Herbarium specimens) should be assigned to. 
```{r,eval=TRUE}
synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt"))

length(grep("ssp.",bloom2$scientificName)) #75 -> 1577 after subsp. -> ssp.
length(grep("subsp.",bloom2$scientificName)) #1502 (0)
length(grep("ssp.",synonyms$SYNONYMS)) #6400 -> 6426
length(grep("subsp.",synonyms$SYNONYMS)) #27 -> 0


synonyms2 <- read.csv("Q:/Research/Projects/alpine-phenology/synonyms2_MI.csv")

#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.", synonyms$SYNONYMS)
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# names before the merge from our dataset
namebloom2 <- unique(bloom2$scientificName)
length(namebloom2) #2219

# deal with the auct non (wrong use of name) from synonym list
nrow(bloom2[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE),]) #163 -> 87
unique(bloom2[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE),])
unique(bloom2$scientificName[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE)])

#Check the auct. non names with The Plant List
TPL(unique(bloom2$scientificName[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE)]))

synonyms[grep("Oreoxis alpina", synonyms$SYNONYMS),]
synonyms2[grep("Cymopterus alpinus", synonyms2$SYNONYMS),]

nrow(synonyms[synonyms$AUTH %in% grep("auct. non", synonyms$AUTH, value=TRUE),]) #827
nrow(synonyms[synonyms$AUTH %in% grep("auct. non", synonyms$AUTH, value=TRUE, invert=TRUE),]) #90737
nrow(synonyms)
```


## 4a. change the four species, "Dasiphora fruticosa" "Gentiana aquatica"   "Thlaspi alpestre"    "Saxifraga arguta", that when used with auct. non will cause synonomy problems
If Dasipohra fruticosa auct. non (L.) Rydb. is out, then left with ID 14110. 


## 4 ID links synonyms
### 4d. to not lose ones from bloom2 that have no match in synonyms, add all.x = TRUE (left outer join), see which aren't in the original and assign those names the appropriate ID to link synonyms
```{r}
synonyms[grep("Thlaspi alpestre", synonyms$SYNONYMS),] #ID = 30635
synonyms[grep("Noccaea fendleri", synonyms$SYNONYMS),] #ID = 30635

synonyms[grep("Dasiphora fruticosa", synonyms$SYNONYMS),] 
# DaFr = 14110
# DaFr ssp. floribunda = 14111
# DaFr auct. non = 14111
synonyms[grep("Potentilla fruticosa", synonyms$SYNONYMS),] 
# PoFr = 14110
# PoFr ssp. floribunda = 14111 (and ssp. farreri, var tenuifolia)

bloom.o <- merge(bloom2, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS")

length(unique(synonyms$SYNONYMS)) #91,084 names (91094 after adding 12 by hand to 'byhand2')
length(unique(synonyms$ID)) #48,141 unique taxa
length(unique(bloom.o$scientificName)) #1986 -> 1934
length(unique(bloom2$scientificName)) #(2284) 2215

#which names are in bloom2 before merge (namebloom2) vs. after merge (bloom2$scientificName)
badnames.o <- setdiff(namebloom2,bloom.o$scientificName)
head(badnames.o)
length(badnames.o) #285

write.table(badnames.o,"clipboard", sep="\t", row.names=FALSE)
```

```{r}
#double check The Plant List against SEINet and TPL used in correcting SpellingErrorCorrestions_v2
TPL.badnames <- TPL(badnames.o)
TPL.badnames[order(TPL.badnames$Genus),c(1:4,10,12:13)]
TPL.badnames[TPL.badnames$Genus == "Gentiana"& TPL.badnames$Species == "fremontii" ,]
```


####Use these 'badnames.o' which are names in bloom2 not found in the USDA synonym list to correct errors some are crosses, some misspellings. 
###### fixbloom2 csv has $Wrong: list of bloom2 names with no UDSA match 
######                   $Replacement: corrected or NA if it should just be removed/ignored     
```{r}
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v2.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

#try again, first replace names with corrections, then do the merge for left outer again)
fixbloom2.all <- fixbloom2[complete.cases(fixbloom2[,2]),-3]

#maybe try a merge - make the new column scientificName be same if no matching, new if matching

bloomfoo <- bloom2

#where is there a match for each?
matches <- apply(fixbloom2.all,1,function(checknames){
  grep(checknames[1],bloomfoo$scientificName)
})
allmat <- do.call(c,matches)

length(allmat) #2240 switches (now 2333)
```

#4e
To change all the wrong column names to the 'replacement' column names, use the multisub function
```{r,eval=TRUE}
multisub <- function(pattern,replacement,x){
  result <- x
  for(i in 1:length(pattern)){
    result <- gsub(pattern[i], replacement[i],result)
  }
  result
}

#Fix with fixbloom2.all
bloomfoo$scientificName <- multisub(fixbloom2.all$Wrong,fixbloom2.all$Replacement,bloomfoo$scientificName)

#Fix with Melissa's list, synonyms2_MI
bloomfoo$scientificName <- multisub(synonyms2$Species,
                                    synonyms2$SYNONYMS,bloomfoo$scientificName)

str(bloomfoo)
```

How many species have two species ID numbers?
```{r,eval=FALSE}
bloom2 <- merge(bloomfoo, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS")
foo <- data.frame(table(bloom2$scientificName,bloom2$ID))
sort(table(foo$Var1[foo$Freq>0])) #19 -> 16 with 2

```
Agrostis variabilis
Anemone multifida
Antennaria parvifolia
Antennaria umbrinella
Bromus anomalus
Carex atrata
Carex hallii
Erigeron acris
Festuca ovina
Galium boreale
Linum lewisii
Oxytropis deflexa
Paronychia pulvinata   
Rorippa teres  
Salix anglorum  
x Salix arctica 

### 4f. Remove auct. non records from the synonyms list. 
######## remove these from the database
Agrostis variabilis, Anemone multifida, Antennaria parvifolia, Antennaria umbrinella, Bromus anomalus, Carex atrata, Carex hallii, ?Dasiphora fruticosa, -Eleocharis, Erigeron acris, Festuca ovina, Galium boreale, Linum lewisii, Oxytropis deflexa, Paronychia pulvinata  (go with Caryophyllaceae instead of Alsinaceae??), Rorippa teres, Salix anglorum, Salix arctica, ?Senecio cymbalarioides  
```{r}
# Duplicate IDs
synonyms["Agrostis variabilis" == synonyms$SYNONYMS,]

# remove all auct. non
synonyms <- synonyms[synonyms$AUTH %in% grep("auct. non", synonyms$AUTH, value = TRUE, invert = TRUE),]

rm(bloom2)
bloom2 <- merge(bloomfoo, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS")
foo <- data.frame(table(bloom2$scientificName,bloom2$ID))
sort(table(foo$Var1[foo$Freq>0])) #6

synonyms["Anemone multifida" == synonyms$SYNONYMS,]
synonyms[synonyms$AUTH %in% grep(" non ", synonyms$AUTH, value=TRUE),]

# remove all " non "
synonyms <- synonyms[synonyms$AUTH %in% grep(" non ", synonyms$AUTH, value = TRUE, invert = TRUE),]
rm(bloom2)
```

# Created bloom2 again after removing the problem names   
From methods: "Looking for ‘auct. non’ authorities in the herbarium collections. Seven names appear on herbarium collections in this dataset with inappropriate uses of the name (‘auct. non”). These will cause problems with synonymy by scientific name without including the author. Authority has problems when matching R verbatim due to spelling and abbreviation errors."
```{r}
bloom2 <- merge(bloomfoo, synonyms[,-3], by.x = "scientificName", by.y = "SYNONYMS")
foo <- data.frame(table(bloom2$scientificName,bloom2$ID))
sort(table(foo$Var1[foo$Freq>0])) #0, no repeated IDs for a plant name (without the authority)

```

After combining datasets, find species with at least 10 years of data
```{r}
#how many species in dataset
length(unique(bloom2$scientificName)) #2299 -> 1835 -> 1938 -> 1809
length(unique(bloom2$ID)) # 1563 grouped by synonyms -> 1583 -> 1508

unique(bloom2$ID[bloom2$scientificName == "Noccaea fendleri ssp. glauca"])

# how many years collected per species
sp.yr <- as.data.frame(table(bloom2$Year,bloom2$ID))

nrow(sp.yr[sp.yr$Freq>0,]) #14369 -> 14845
mean(sp.yr$Freq[sp.yr$Freq > 0])  #2.89
max(sp.yr$Freq[sp.yr$Freq>0]) #80
tail(sp.yr)

# How many vouchers per species per year
colpyear <- data.frame(table(bloom2$ID,bloom2$Year))
colpyear.2 <- do.call(rbind,lapply(split(colpyear,as.factor(colpyear$Var2)),
                                   function(x) x[which.max(x$Freq),]))

colpyear.2[with(colpyear.2, order(colpyear.2$Freq)),]

colpyear.2[with(colpyear.2, order(colpyear.2$Var2)),]

# change all values above 0 to 1 from number of collections for that species a year
# finding which years have any data, not the minimum date
sp.yr$Freq <- sapply(sp.yr$Freq,function(x){
  if(x>0) {1}
  else 0
  }, USE.NAMES = FALSE)

sp.yr.sp <- sp.yr[sp.yr$Freq>0,]
bysp <- split(sp.yr.sp, sp.yr.sp$Var2, drop=TRUE)
names(bysp[1]) #will need to change to names from ID number USDA later....

spyears <- do.call(rbind,lapply(bysp, function(x){
  data.frame(DataYrs = sum(x$Freq),ID = unique(x$Var2))
}))

spyears[with(spyears, order(spyears$DataYrs)),]
spyears[which.max(spyears$DataYrs),] # 54
spyears[which.min(spyears$DataYrs),] # 1
nrow(spyears[spyears$DataYrs>=10,]) #473 -> 491 -> 413
mean(spyears$DataYrs[spyears$DataYrs>=10]) #23.72301

sp.10plus <- spyears[spyears$DataYrs>=10,]
length(unique(sp.10plus$ID)) #491 -> 413
```


Pull only the species that have 10 or more years of data for analyses   
Not earliest but does tell me if one per species per year to tell how many species have at least 10 years a year   
```{r}
tenyearplus <- merge(bloom2,sp.10plus,by = "ID")
length(unique(tenyearplus$ID[tenyearplus$DataYrs>9])) #491 -> 143
length(unique(sp.10plus$ID)) # 498 -> 473 -> 491
length(unique(tenyearplus$scientificName)) #726
length(unique(tenyearplus$ID)) #473 -> 491 -> 413
```


Pull out earliest collection rows   
```{r}
minJul.dates.2 <- lapply(unique(tenyearplus$ID), function(x){
  this.species <- tenyearplus[tenyearplus$ID == x,]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  merge(unique(this.species[,c("ID","Year","startDayOfYear","DataYrs")]), these.rows,
        by=c("startDayOfYear","Year"))
  })

min1950_2 <- do.call(rbind,minJul.dates.2)
head(min1950_2)

length(unique(min1950_2$ID)) #473 -> 491 -> 413
```


```{r}
# check that none have more than one a year
singlefoo <- data.frame(table(min1950_2$Year,min1950_2$ID))
nrow(singlefoo[singlefoo$Freq> 1,]) #154? -> 0 Yay!
rm(singlefoo)
```

#Select the accepted name per code
```{r}
# Before linking one name with the IDs that have 10 or more years of data, link the names with plantsyn traits. 
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",")

names(plantsyn)
table(plantsyn$Growth.Habit)
length(unique(plantsyn$Accepted.Symbol)) #5513
plantsyn[plantsyn$Scientific.Name == "Noccaea fendleri ssp. glauca",]
plantsyn[plantsyn$Scientific.Name == "Thlaspi alpestre",]


length(unique(plantsyn$Symbol[plantsyn$Genera.Binomial.Author %in% grep("auct. non", plantsyn$Genera.Binomial.Author, value = TRUE)])) #161
unique(plantsyn$Genera.Binomial.Author[plantsyn$Genera.Binomial.Author %in% grep(" non ", plantsyn$Genera.Binomial.Author, value = TRUE)])
```

#remove auct non only
```{r}
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author %in% 
                       grep("auct. non", plantsyn$Genera.Binomial.Author, value = TRUE, invert = TRUE),]
str(plantsyn)

```

```{r}
factnames <- names(Filter(is.factor,plantsyn))
plantsyn[factnames] <- lapply(plantsyn[factnames], as.character)

plantsyn$Scientific.Name <- gsub(pattern = "subsp.", replacement = "ssp.", plantsyn$Scientific.Name)

# Should do this before getting to species with 10 years or more to have the accepted name! or could do this just to get the accepted name after... 
#Need to link the ID with the names used 
linknames <- merge(bloom2[,c(1,9)],plantsyn[,c(1:4,25:31)],by.x="scientificName",by.y="Scientific.Name")
#should be the accepted name for each ID
accpt <- unique(linknames[linknames$Synonym.Symbol=="",])

length(unique(bloom2$ID)) #1583
length(unique(accpt$ID)) #1273

merge.name <- merge(accpt,min1950_2, by="ID")
length(unique(min1950_2$ID)) #491
length(unique(merge.name$ID)) #469! (488) missing some names from merge.name
missingnums <- setdiff(unique(min1950_2$ID),unique(merge.name$ID))
missingnames <- unique(bloom2$scientificName[bloom2$ID %in% grep(paste(missingnums,collapse="|"),
                                                 bloom2$ID, value=TRUE)])

#At least one doesn't have the Accepted.Symbol line! 
syns <- linknames[!duplicated(linknames$ID) & linknames$ID %in% missingnums,]

#So add these to accpt
rm(merge.name)
accpt <- rbind(accpt,syns)

merge.name <- merge(accpt,min1950_2, by="ID")
length(unique(min1950_2$ID)) #491
length(unique(merge.name$ID)) #476! (488)

bloom2[bloom2$scientificName%in%missingnames,]
nrow(min1950_2[min1950_2$ID%in%missingnums,])
missingnums <- setdiff(unique(min1950_2$ID),unique(merge.name$ID))
missingnames <- unique(bloom2$scientificName[bloom2$ID %in%
                                               grep(paste(missingnums,collapse="|"),
                                                    bloom2$ID, value=TRUE)])

```

#### checking
```{r}
min1950_2[min1950_2$ID == unique(bloom2$ID[bloom2$scientificName=="Aster foliaceus"]),]
plantsyn[plantsyn$Scientific.Name %in% grep("Symphyotrichum foliaceum",plantsyn$Scientific.Name, value=TRUE), ]
plantsyn[plantsyn$Scientific.Name %in% grep("Aster foliaceus",plantsyn$Scientific.Name, value=TRUE), ]
bloom2[bloom2$scientificName %in% grep("Symphyotrichum foliaceum var. foliaceum",bloom2$scientificName, value=TRUE), ]
bloom2[bloom2$ID==43988,]

unique(bloom2$ID[bloom2$scientificName=="Aster foliaceus"]) #43988

unique(bloom2$ID[bloom2$scientificName=="Carex atrata"]) #8105
bloom2[bloom2$ID==8105,]

unique(bloom2$ID[bloom2$scientificName=="Carex micropoda"]) #8591
unique(bloom2$ID[bloom2$scientificName=="Chlorocrepis tristis"]) #22207
unique(bloom2$ID[bloom2$scientificName=="Eutrema edwardsii"]) #18851
unique(bloom2$ID[bloom2$scientificName=="Hieracium triste"]) #22205

#There are two 'Hieracium triste' in the tables, but bloom2 has only 22205
unique(bloom2$ID[grep("Hieracium triste",bloom2$scientificName)])
unique(bloom2[grep("Hieracium triste",bloom2$scientificName),])

unique(bloom2$ID[bloom2$scientificName=="Ligularia bigelovii"]) # 41494
unique(bloom2$ID[bloom2$scientificName=="Poa nervosa"]) # 35582
unique(bloom2$ID[bloom2$scientificName=="Salix arctica"]) # 39918
unique(bloom2$ID[bloom2$scientificName=="Senecio bigelovii var. bigelovii"]) # 41494
unique(bloom2$ID[bloom2$scientificName=="Symphyotrichum foliaceum var. foliaceum"]) # 43988
unique(bloom2$ID[bloom2$scientificName=="Valeriana capitata"]) # 46589
unique(bloom2$ID[bloom2$scientificName=="Veratrum californicum"]) # 46683

## Remove the following
## Two with the same ID?!?! Remove both of these!
unique(bloom2$ID[bloom2$scientificName=="Eritrichium aretioides"]) #17897
unique(bloom2$ID[bloom2$scientificName=="Eritrichium nanum var. aretioides"]) #17897

## excluded?
unique(bloom2$ID[bloom2$scientificName=="Noccaea montana"]) # 30638

## spelling error
unique(bloom2$ID[bloom2$scientificName=="Castilleja rhexifolia"]) #8950
bloom2[bloom2$ID==8950,]
plantsyn$Scientific.Name[plantsyn$Scientific.Name %in% grep("Castilleja",plantsyn$Scientific.Name, value=TRUE)]
unique(bloom2$scientificName[bloom2$scientificName %in% grep("Castilleja",bloom2$scientificName, value=TRUE)])
unique(bloom2$ID[bloom2$scientificName %in% grep("Castilleja rhexiifolia",bloom2$scientificName, value=TRUE)]) #9086

plantsyn$Scientific.Name[plantsyn$Scientific.Name %in% grep("Poa nervosa",plantsyn$Scientific.Name, value=TRUE)]
unique(bloom2$scientificName[bloom2$scientificName %in% grep("Poa nervosa",bloom2$scientificName, value=TRUE)])
unique(bloom2$ID[bloom2$scientificName %in% grep("Poa nervosa",bloom2$scientificName, value=TRUE)]) 
bloom2[bloom2$ID==35582,]

 

```

 [1] "scientificName"          "ID"                      "Accepted.Symbol"         "Synonym.Symbol"         
 [5] "Symbol"                  "Family"                  "Duration"                "Growth.Habit"           
 [9] "Native.Status"           "Bloom.Period"            "Fruit.Seed.Period.Begin" "Fruit.Seed.Period.End" 
```{r}
## Fill in data for missing names- add these to accpt
accpt <- rbind(accpt,c("Symphyotrichum foliaceum var. foliaceum","43988","","",
                       "","Asteraceae","Perennial","Forb/herb",
                       "AK (N), CAN (N), L48 (N)","","",""))
accpt <- rbind(accpt,c("Carex atrata","8105","","",
                       "","Cyperaceae", "Perennial","Graminoid","GL (N)",
                       "","",""))
accpt <- rbind(accpt,c("Carex micropoda","8591","","",
                       "","Cyperaceae","Perennial","Graminoid","AK (N), CAN (N), L48 (N)",
                       "","",""))
# The Plant List says Hieracium triste var. triste is a synonym of Hieracium triste
#accpt <- rbind(accpt,c("Hieracium triste var. triste","22207","","",
#                       "", "Asteraceae","Perennial","Forb/herb","AK (N), CAN (N)",
#                       "","",""))

accpt <- rbind(accpt,c("Eutrema edwardsii","18851","","",
                       "","Brassicaceae","Perennial","Forb/herb","AK (N), CAN (N), GL (N)",
                       "","",""))
accpt <- rbind(accpt,c("Hieracium triste","22205","","",
                       "","Asteraceae","Perennial","Forb/herb","AK (N), CAN (N), L48 (N)",
                       "","",""))
accpt <- rbind(accpt,c("Senecio bigelovii var. bigelovii","41494","","",
                       "","Asteraceae","Perennial","Forb/herb","L48 (N)",
                       "","",""))
accpt <- rbind(accpt,c("Poa nervosa","35582","","",
                       "","Poaceae","Perennial","Graminoid","CAN (N), L48 (N)",
                       "","",""))
accpt <- rbind(accpt,c("Salix arctica","39918","","",
                       "","Salicaceae","Perennial","Shrub, Subshrub","AK (N), CAN (N), GL (N), L48 (N)",
                       "","",""))
accpt <- rbind(accpt,c("Valeriana capitata","46589","","",
                       "VECA2","Valerianaceae","Perennial","Forb/herb","AK (N), CAN (N)",
                       "","",""))
accpt <- rbind(accpt,c("Veratrum californicum","46683","","",
                       "VECA2","Liliaceae","Perennial","Forb/herb","L48 (N)",
                       "","",""))

```

### One more time, make merge names
```{r}
rm(merge.name)
merge.name <- merge(accpt,min1950_2, by="ID")
length(unique(min1950_2$ID)) #491 -> 413
length(unique(merge.name$ID)) #488 (487 - means no more double Hieracium triste?!) 486 -> 408

#Check that there is only one species collection date per year
singlefoo <- data.frame(table(merge.name$Year,merge.name$ID))
singlefoo[singlefoo$Freq>1,]
nrow(singlefoo[singlefoo$Freq> 1,])

rm(singlefoo)
singlefoo <- data.frame(table(merge.name$Year,merge.name$ID))
nrow(singlefoo[singlefoo$Freq> 1,]) #0

length(unique(merge.name$ID)) #486
mean(merge.name$DataYrs[!duplicated(merge.name$ID)]) # 25.04412 years

nrow(merge.name) #11410 -> 10133
write.table(merge.name, file="P:/hackathon/alpine-phenology/datasets/merge.name.csv", sep=",")
```

merge.name from away
```{r}
merge.name <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/merge.name.csv"))


```


```{r}
TPL(c("Potentilla fruticosa","Dasiphora floribunda",
      "Dasiphora fruticosa ssp. floribunda",
      "Gentiana heterosepala","Boechera lemmonii",
      "Lupinus argenteus var. rubricaulis", "Artemisia borealis",
      "Silene hitchguirei"))

```

# How many forbs vs. grasses vs. tree? How many 
Names without growth habit (and some other infomraiton, often because not accepted name, switch to accepted name)
```{r}
unique(merge.name$scientificName[merge.name$Growth.Habit == "" & !is.na(merge.name$Growth.Habit)])

merge.name[merge.name$scientificName %in% grep("Gentianella amarelle ssp. heterosepala", merge.name$scientificName,value=TRUE),]

merge.name$scientificName[merge.name$scientificName == "Gentiana heterosepala"] <- "Gentianella amarelle ssp. heterosepala"
merge.name$Growth.Habit[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "Forb/herb"
merge.name$Family[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "Gentianaceae"
merge.name$Duration[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "Annual, Biennial"

merge.name$scientificName[merge.name$scientificName == "Boechera lemmonii"] <- "Arabis lemmonii var. lemmonii"
merge.name$Growth.Habit[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "Forb/herb"
merge.name$Family[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "Brassicaceae"
merge.name$Duration[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "Perennial"


merge.name$Growth.Habit[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "Forb/herb"
merge.name$Family[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "Fabaceae"
merge.name$Duration[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "Perennial"


merge.name$scientificName[merge.name$scientificName == "Artemisia borealis"] <- "Artemisia campestris var. purshii"
merge.name$Growth.Habit[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "Forb/herb"
merge.name$Family[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "Asteraceae"
merge.name$Duration[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "Biennial, Perennial"

merge.name$scientificName[merge.name$scientificName == "Silene hitchguirei"] <- "Silene uralensis ssp. montana"
merge.name$Growth.Habit[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "Forb/herb"
merge.name$Family[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "Caryophyllaceae"
merge.name$Duration[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "Perennial"

unique(merge.name$Growth.Habit)
unique(merge.name$Bloom.Period)
unique(merge.name$Duration)
```


#Smaller groups for Growth.Habit
```{r}
merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Graminoid",merge.name$Growth.Habit, value=TRUE)] <- "Graminoid"

merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Forb",merge.name$Growth.Habit, value=TRUE)] <- "Forb"

merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Forb", 
                                  grep("shrub", merge.name$Growth.Habit, 
                                       value=TRUE, ignore.case=TRUE), 
                                  value=TRUE, invert=TRUE)] <- "Shrubs"

merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Shrub", 
                                  grep("Tree", merge.name$Growth.Habit, 
                                       value=TRUE, ignore.case=TRUE), 
                                  value=TRUE, invert=TRUE, ignore.case=TRUE)] <- "Trees"

```

```{r}
GH <- data.frame(table(merge.name$Growth.Habit[!duplicated(merge.name$ID)]))
GH[GH$Freq>0,]
sum(GH$Freq)#488 -> 487

# Number of Families represented!
length(table(merge.name$Family[!duplicated(merge.name$ID)]))

# Growth Habit numbers
table(merge.name$Growth.Habit[!duplicated(merge.name$ID)])

sum(  GH$Freq[GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE)]) #348 Forb/herbs

sum(  GH$Freq[GH$Var1 %in% grep("Forb", grep("shrub", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #33 shrubs/subshrubs

sum(  GH$Freq[GH$Var1 %in% grep("Shrub", grep("Tree", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE, ignore.case=TRUE)]) #11->5 trees


GD <- data.frame(table(merge.name$Duration[!duplicated(merge.name$ID)]))
GD[GH$Freq>0,]
sum(GD$Freq)#487

# Duration
table(merge.name$Duration[!duplicated(merge.name$ID)])

sum(GD$Freq[GD$Var1 %in% grep("Biennial", grep("Annual", GD$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #12

NAT <- data.frame(table(merge.name$Native.Status[!duplicated(merge.name$ID)]))
NAT[NAT$Freq>0,]
sum(NAT$Freq)#487

# Native status
unique(merge.name$scientificName[merge.name$Native.Status == ""])
sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE), "Freq"]) #477
sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE, invert = TRUE), "Freq"]) #10

merge.name$scientificName[!duplicated(merge.name$ID) & merge.name$Native.Status %in% grep("L48", merge.name$Native.Status, value=TRUE, invert=TRUE)]

#which are missing a native status?
length(unique(merge.name$scientificName[grep("L48", merge.name$Native.Status)])) #476
length(unique(merge.name$ID[grep("L48", merge.name$Native.Status)])) #477 native 
length(unique(merge.name$ID[grep("L48", merge.name$Native.Status,
                                             invert=TRUE)])) #10 non-native
length(unique(merge.name$scientificName[grep("L48", merge.name$Native.Status,
                                             invert=TRUE)])) #10 non-native

table(merge.name$Native.Status) #109 missing status
unique(merge.name$scientificName[merge.name$Native.Status == ""])
```

"Dasiphora fruticosa" - L48 (N)    
"Dasiphora fruticosa ssp. floribunda" -  L48 (N)    
   "Eutrema edwardsii" - not from L48      
"Gentianella amarelle ssp. heterosepala" - L48 (N)    
    "Hieracium triste var. triste" - not from L48         
"Arabis lemmonii var. lemmonii" - L48 (N)     
"Lupinus argenteus var. rubricaulis" - L48 (N)     
"Artemisia campestris var. purshii" - L48 (N)      
"Silene uralensis ssp. montana" - L48 (N)    
    "Valeriana capitata"  not in L48     
    "Carex atrata"  not in L48  
    
#Fix missing Native.Status
```{r}
merge.name$Native.Status[merge.name$scientificName == "Dasiphora fruticosa"] <- "L48 (N)"
merge.name$Native.Status[merge.name$scientificName == "Dasiphora fruticosa ssp. floribunda"] <- "L48 (N)"
merge.name$Native.Status[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "L48 (N)"
merge.name$Native.Status[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "L48 (N)"
merge.name$Native.Status[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "L48 (N)"
merge.name$Native.Status[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "L48 (N)"
merge.name$Native.Status[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "L48 (N)"

```

Of the first bloom data of species that matched sampling critera, the hightest diversity of species collections were made in the 1990s and early 2000s with a peak of 449 species collected in 1998. Average over the study period was 211 alpine/subalpine species collected per year. 
```{r}
earliestcollection <- data.frame(colSums(table(merge.name$ID, #should be only one name now
                                                merge.name$Year)))

length(unique(merge.name$ID))
sort(unique(merge.name$DataYrs))

earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),]
mean(earcol$Collections) #189 -> 166.1148

```
     Year Collections
1998 1998         348


#Figure 1A
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of Study Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()
```

Average number of collections over the study period was 187.049 species collected per year
```{r}
mean(earcol$Collections) # 166.1148
```
 
```{r}
allcollections <- data.frame(colSums(table(bloom2$scientificName,bloom2$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])
```

#Figure 1B  
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()
```

The day each year with the most collections has on average been Julian day 207 and the day with the most collections has not moved significantly over time from 1950 to 2011. The earliest peak collection day was Julian day 175 (June 30th) in 2007 and the latest peak collection day was Julian day 238 in 1957 (August 29th)   
```{r}
collJ.sp <- data.frame(table(bloom2$Year,bloom2$startDayOfYear))

collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
collmax <- do.call(rbind,collJ.max)
collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))

mean(collmax$Var2)
collmax[which.min(collmax$Var2),]
collmax[which.max(collmax$Var2),]
summary(lm(Var2~Var1, data=collmax))

```

# Bloom
```{r}
library(RCurl)
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/QR_final_R_plant_climate_data_2.csv"))

```

Average high, low, and precip per year  
Take annual climate data from previous dataset
```{r}
head(bloom)
head(bloom[,c(19,20,21,23)])

# units for precip are: ppt (mm*100) (even though it just says mm on the main website you look at when reading about the variables). So, we need to divide our values by 100 for our figures. 
bloom$Raw_Precip <- (bloom$Raw_Precip)/100

# merge.name$Raw_Precip <- (merge.name$Raw_Precip)/100

# If already have precip and hi lo, don't merge again, don't want .x and .y!
head(merge.name)
merge.name <- merge(merge.name,unique(bloom[,c(19,20,21,23)]), by="Year")

write.table(merge.name, file="P:/hackathon/alpine-phenology/datasets/merge.name.csv", sep=",")

unbloom <- unique(bloom[,c(19,20,21,23)])
```

Correlations of climate
```{r}
cor(unbloom[,-1])
cor.test(unbloom[,2],unbloom[,3])
cor.test(unbloom[,2],unbloom[,4])
cor.test(unbloom[,3],unbloom[,4])

```

#Figure 2 Year x Bloom date
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. ordinalxyear.tiff", width = 174, height = 150, compression="lzw", units = "mm", res=dpi)


ggplot(merge.name, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 

dev.off()

summary(lm(startDayOfYear~Year, data=merge.name))

```

Segmented test
```{r}
segmented.start.year <- segmented(lm(startDayOfYear~Year, data=merge.name), 
                                  seg.Z = ~Year, psi=1980)
summary(segmented.start.year)
slope(segmented.start.year)
```
U1.Year is the difference in slopes between the first and second segment. So if your coefficients are Year = 0.18110 and U1.x = -0.53408, then the slope of the second segment is -0.53408+0.18110 = -0.35298. Using the slope(segmented.mod) command will give you the slopes of each segment, which should match the above calculation.


#Figure 3A  
Using just the average temp per year, not repeated for everytime we have specimen data in a year
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Avg_Hi))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8))

dev.off()

summary(lm(Avg_Hi~Year, data=unbloom))
```

Segmented test
```{r}
segmented.Avg_Hi.year <- segmented(lm(Avg_Hi~Year, data=unbloom), 
                                  seg.Z = ~Year, 
                                  psi= list(Year = c(1985,2000)))
summary(segmented.Avg_Hi.year)
slope(segmented.Avg_Hi.year)
segmented.Avg_Hi.year$psi #1994.5 and 2001.3
#Fitted data
seg.fit <- fitted(segmented.Avg_Hi.year)
seg.model <- data.frame(Year = unbloom$Year, Avg_Hi = seg.fit)

#plot fitted model
ggplot(unbloom, aes(Year,Avg_Hi))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))+
  geom_line(data = seg.model, aes(Year,Avg_Hi), colour = "tomato")
```
<https://rpubs.com/MarkusLoew/12164> 

#Figure 2B
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)


ggplot(unbloom, aes(Year,Avg_Lo))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
#  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab(~degree~C)+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Avg_Lo~Year, data = unbloom))

```

Segmented test
```{r}
segmented.Avg_Lo.year <- segmented(lm(Avg_Lo~Year, data=unbloom), 
                                  seg.Z = ~Year, 
                                  psi= 1980)
summary(segmented.Avg_Lo.year)
slope(segmented.Avg_Lo.year)
segmented.Avg_Lo.year$psi #1988.3
#Fitted data
seg.fit <- fitted(segmented.Avg_Lo.year)
seg.model <- data.frame(Year = unbloom$Year, Avg_Lo = seg.fit)

#plot fitted model
ggplot(unbloom, aes(Year,Avg_Lo))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))+
  geom_line(data = seg.model, aes(Year,Avg_Lo), colour = "tomato")
```

#Figure 2C   
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Raw_Precip))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
#  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Raw_Precip~Year, data = unbloom))

```
11995         -105.9094 2001      3354            181 31380
11996                NA 1957      3726            188 31380
11997         -105.6676 2001      3415            213 31380
11998         -105.7162 2004      3415            224 31380
11999                NA 1985      3810            186 31380
12000         -105.7186 2004      3878            185 31380
12001         -106.2035 1998      3840            178 31380
12002         -106.2410 1998      3415            197 31380
12003         -106.4092 1994      3718            173 31380
12004                NA 1957      3657            174 31380
12005                NA 1985      3780            181 31380
12006                NA 1977      3444            174 31380
12007         -106.0926 1999      3659            216 31380
12008         -106.1769 1981      3840            180 31380
12009                NA 1958      3653            177 31380
12010         -106.5638 1957      3811            190 31380
12011         -105.6339 2004      3902            229 31380
12012                NA 1962      3653            163 31380
12013         -105.6354 2003      3329            205 31380
12014         -107.0557 1996      3873            205 31380
12015         -105.6170 1961      3353            167 31380
12016                NA 1986      3800            212 31380
12017         -105.6087 2010      3246            223 31380
12018         -106.1304 1995      3901            203 31380
12019                NA 1967      3660            184 31380
12020         -107.6378 1971      3901            190 31380
12021         -105.7325 1997      3914            195 31380
12022                NA 1980      3505            193 31380
12023         -105.9418 2001      3659            228 31380
12024         -106.4877 2001      3659            196 31380
12025         -106.0495 1957      3669            174 31380
12026         -105.6822 2003      3390            191 31380
12027         -106.3036 2001      3421            197 31380
12028         -105.7409 2004      3488            185 31380
12029                NA 1994      3718            173 31380
12030         -107.2204 1964      3811            217 31380
12031         -106.2273 1987      3800            168 31380
12032         -106.2061 2003      3354            177 31380
12033         -106.4740 1980      3749            196 31380
12034         -106.1500 1995      3597            181 31380
12035                NA 1958      3691            188 31380
12036         -105.5494 1995      3505            211 31380
12037         -105.8778 1951      3660            213 31380
12038         -105.8176 2010      3683            223 31380
12039         -105.6575 2003      3597            200 31380
12040         -105.9229 2000      3750            203 31380
12041                NA 1964      3688            114 31380
12042         -105.9229 2000      3506            221 31380
12043         -105.9431 1999      3444            185 31380
12044                NA 1961      3536            175 31380
12045         -105.9869 2010      3659            194 31380
12046                NA 1980      3650            187 31380
12047         -106.1000 1981      4091            179 31380
12048         -106.1500 1995      3660            189 31380
12049                NA 1969      3810            186 31380
12050                NA 2007      3628            166 31380
12051         -105.5938 1980      3505            183 31380
12052         -107.1689 1991      3505            178 31380
12053         -105.8879 2003      3500            196 31380
12054                NA 1986      3850             NA 31380
12055         -106.3778 2001      3780            217 31380
12056         -105.9039 2000      3354            187 31380
12057         -106.2510 2001      3537            235 31380
12058         -106.0159 1999      3537            230 31380
12059         -105.7111 1957      3657            173 31380
12060         -106.2846 1995      3475            200 31380
12061                NA 1956      3660            193 31380
12062         -106.0209 1960      3840            176 31380
12063         -105.9431 1999      3444            185 31380
12064         -106.1282 2000      3232            212 31380
12065                NA 1984      3750            181 31380
12066         -105.6339 2004      3902            229 31380
12067                NA 1999      3628            224 31380
12068         -106.8911 1999      3549            238 31380
12069                NA 1999      4281            224 31380
12070         -105.4932 1999      3354            197 31380
12071         -106.1675 1994      3300            169 31380
12072         -105.9229 2000      3659            221 31380
12073                NA 1962      3653            163 31380
12074         -105.9229 2000      3872            203 31380
12075         -105.7313 2003      3537            178 31380
12076                NA 2004      3415            197 31380
12077         -106.3036 2001      3902            215 31380
12078         -106.5634 2003      3791            189 31380
12079         -107.5863 1998      3805            214 31380
12080         -106.1111 2010      3457            219 31380
12081         -106.2098 2000      3719            179 31380
12082                NA 1994      3780            176 31380
12083         -106.2083 1998      3537            208 31380
12084                NA 1986      3850             NA 31380
12085         -105.6900 2004      3506            217 31380
12086         -105.8532 2004      3317            175 31380
12087         -106.2657 2001      3354            198 31380
12088         -105.9413 2003      3232            194 31380
12089         -107.0333 1995      3721            192 31380
12090         -105.6658 2004      3505            186 31380
12091         -106.3592 2001      3537            175 31380
12092         -106.7550 1986      3850             NA 31380
12093         -105.8658 2005      3658            207 31380
12094         -106.2424 1994      3400            177 31380
12095         -105.7524 1971      3505            180 31380
12096         -105.6655 2003      3536            200 31380
12097         -105.8637 2003      3567            178 31380
12098         -105.7113 1957      3561            173 31380
12099                NA 1966      3764            210 31380
12100         -105.8323 2010      3598            202 31380
12101         -106.1668 1999      3354            199 31380
12102         -105.5179 1976      3200            195 31380
12103         -106.2533 2010      3598            200 31380
12104         -106.9277 1998      3488            212 31380
12105         -107.2444 1964      3810            217 31380
12106         -106.4321 2001      3415            200 31380
12107         -106.4149 2001      3720            211 31380
12108         -106.4698 1965      3689            209 31380
12109         -106.0159 1999      3537            230 31380
12409                NA 1967      3322            206 14111
12410         -105.0274 2009      3532            197 14111
12411         -105.0194 2009      3593            229 14111
12412         -105.6437 1984      3642            187 14111
12413                NA 1967      3657            175 14111
13334         -106.3978 1986      3627            207 15419
13335         -106.1483 1999      3506            199 15419
13336         -106.4077 1984      3780            198 15419
13337         -107.5667 1983      3810            205 15419
13338         -107.5172 1982      3581            215 15419
13339         -106.1042 1994      3962            177 15419
13340         -106.1805 1990      3779            173 15419
13341                NA 1951      3749            188 15419
13342         -106.1807 1998      3620            219 15419
13343                NA 1987      3505            209 15419
13344         -106.4337 1986      3780            191 15419
13345         -106.2083 1998      3537            208 15419
13346                NA 1973      3725            213 15419
13347         -105.9229 2000      3750            203 15419
13348         -105.2503 2007      3689            175 15419
13349         -107.5413 1982      3840            193 15419
13350                NA 1986      3850             NA 15419
13351         -106.2094 2000      3720            179 15419
13352                NA 1973      3700            210 15419
13353         -106.4337 1985      3705            198 15419
13354         -106.0969 1998      3779            214 15419
13355         -105.7409 2004      3488            185 15419
13356         -106.4828 1986      3658            241 15419
13357                NA 1988      3475            178 15419
13358                NA 1967      4203            193 15419
13359                NA 1983      3840            190 15419
13360         -106.8002 2003      3512            191 15419
13361         -105.9156 1986      3962            198 15419
13362         -106.0375 1988      3840            203 15419
13363         -107.0333 1995      3691            209 15419
13364         -106.0830 1951      3749            219 15419
13365         -106.0432 1977      3567            202 15419
13366         -105.9686 1985      3612            208 15419
13367         -106.4151 1983      3811            205 15419
13368         -105.9869 2010      3659            194 15419
13369                NA 1992      3658            208 15419
13370                NA 1996      3719            184 15419
13371                NA 1995      3750            233 15419
13372         -108.0750 1993      3938            199 15419
13373         -106.1505 1974      3505            190 15419
13374         -105.5993 1964      3658            213 15419
13375                NA 1951      3749            219 15419
13376         -106.2083 1998      3537            208 15419
13377                NA 1995      3750            233 15419
13378         -105.8185 1961      3426            208 15419
13379         -105.9229 2000      3659            203 15419
13380         -106.4310 2000      3750            205 15419
13381         -106.3778 2001      3598            218 15419
13382                NA 1996      3719            184 15419
13383         -106.2410 1998      3415            197 15419
13384         -106.4184 1989      3749            177 15419
13385         -107.1269 1991      3566            233 15419
13386         -106.2410 1998      3476            197 15419
13387         -106.1826 1998      3619            219 15419
13388         -106.3203 2004      3476            230 15419
13389         -106.0989 1995      3718            222 15419
13390         -106.0983 1995      3719            222 15419
13391         -106.1058 2010      3741            258 15419
13392         -105.9039 2000      3251            213 15419
13393                NA 1973      3834            204 15419
13394         -106.0876 1982      3700            206 15419
13395                NA 1985      3780            197 15419
13396         -105.9689 1985      3502            208 15419
13397                NA 1982      3550            207 15419
13398         -106.1162 2010      3674            258 15419
13399         -106.1933 1998      3657            191 15419
13400         -106.5595 1978      3598            232 15419
13401         -107.1188 2003      3585            194 15419
13402         -105.9418 2001      3659            228 15419
13660                NA 1970      3660            196 15441
13661         -105.7513 1997      3901            195 15442
13662         -105.7739 1993      4023            228 15442
13663         -105.8261 1994      4023            190 15442
13664         -105.7334 1983      3962            254 15442
13665         -105.6575 2003      3597            200 15442
13666         -105.7880 1997      4099            234 15442
13667         -105.8778 1951      3657            213 15442
13668         -105.7856 1963      4267            194 15442
13669         -105.5956 1961      3679            196 15442
13670         -105.7639 1978      3764            182 15442
13671         -105.8233 1997      4008            204 15442
13672         -105.6091 1993      4084            235 15442
13673         -105.9364 2010      3532            212 15442
13674         -107.5339 2004      3782            239 15442
13675         -105.8606 1978      3901            194 15442
13676         -105.8175 1970      3779            199 15442
13677         -105.7513 1997      3871            195 15442
13678         -105.8169 2000      3901            197 15442
13679         -105.6428 1953      3871            211 15442
13680         -105.5956 1962      3672            227 15442
 [ reached getOption("max.print") -- omitted 1513 rows ]
> nrow(min1950_2[min1950_2$ID%in%missingnums,])
[1] 716
> missingnums <- setdiff(unique(min1950_2$ID),unique(merge.name$ID))
> missingnames <- unique(bloom2$scientificName[bloom2$ID %in%
+                                                grep(paste(missingnums,collapse="|"),
+                                                     bloom2$ID, value=TRUE)])
> 
> ## Fill in data for missing names- add these to accpt
> accpt <- rbind(accpt,c("Symphyotrichum foliaceum var. foliaceum","43988","","",
+                        "","Asteraceae","Perennial","Forb/herb",
+                        "AK (N), CAN (N), L48 (N)","","",""))
> accpt <- rbind(accpt,c("Carex atrata","8105","","",
+                        "","Cyperaceae", "Perennial","Graminoid","GL (N)",
+                        "","",""))
> accpt <- rbind(accpt,c("Carex micropoda","8591","","",
+                        "","Cyperaceae","Perennial","Graminoid","AK (N), CAN (N), L48 (N)",
+                        "","",""))
> # The Plant List says Hieracium triste var. triste is a synonym of Hieracium triste
> #accpt <- rbind(accpt,c("Hieracium triste var. triste","22207","","",
> #                       "", "Asteraceae","Perennial","Forb/herb","AK (N), CAN (N)",
> #                       "","",""))
> 
> accpt <- rbind(accpt,c("Eutrema edwardsii","18851","","",
+                        "","Brassicaceae","Perennial","Forb/herb","AK (N), CAN (N), GL (N)",
+                        "","",""))
> accpt <- rbind(accpt,c("Hieracium triste","22205","","",
+                        "","Asteraceae","Perennial","Forb/herb","AK (N), CAN (N), L48 (N)",
+                        "","",""))
> accpt <- rbind(accpt,c("Senecio bigelovii var. bigelovii","41494","","",
+                        "","Asteraceae","Perennial","Forb/herb","L48 (N)",
+                        "","",""))
> accpt <- rbind(accpt,c("Poa nervosa","35582","","",
+                        "","Poaceae","Perennial","Graminoid","CAN (N), L48 (N)",
+                        "","",""))
> accpt <- rbind(accpt,c("Salix arctica","39918","","",
+                        "","Salicaceae","Perennial","Shrub, Subshrub","AK (N), CAN (N), GL (N), L48 (N)",
+                        "","",""))
> accpt <- rbind(accpt,c("Valeriana capitata","46589","","",
+                        "VECA2","Valerianaceae","Perennial","Forb/herb","AK (N), CAN (N)",
+                        "","",""))
> accpt <- rbind(accpt,c("Veratrum californicum","46683","","",
+                        "VECA2","Liliaceae","Perennial","Forb/herb","L48 (N)",
+                        "","",""))
> 
> rm(merge.name)
> merge.name <- merge(accpt,min1950_2, by="ID")
> length(unique(min1950_2$ID)) #491
[1] 413
> length(unique(merge.name$ID)) #488 (487 - means no more double Hieracium triste?!) 486
[1] 408
> singlefoo <- data.frame(table(merge.name$Year,merge.name$ID))
> singlefoo[singlefoo$Freq>1,]
[1] Var1 Var2 Freq
<0 rows> (or 0-length row.names)
> nrow(singlefoo[singlefoo$Freq> 1,])
[1] 0
> rm(singlefoo)
> singlefoo <- data.frame(table(merge.name$Year,merge.name$ID))
> nrow(singlefoo[singlefoo$Freq> 1,]) #0
[1] 0
> length(unique(merge.name$ID)) #486
[1] 408
> mean(merge.name$DataYrs[!duplicated(merge.name$ID)]) # 23.70165 years
[1] 25.04412
> nrow(merge.name) #11410
[1] 10133
> write.table(merge.name, file="P:/hackathon/alpine-phenology/datasets/merge.name.csv", sep=",")
> unique(merge.name$scientificName[merge.name$Growth.Habit == "" & !is.na(merge.name$Growth.Habit)])
 [1] "Dasiphora floribunda"               "Draba cana"                         "Erigeron glacialis"                
 [4] "Erysimum capitatum var. argillosum" "Boechera lemmonii"                  "Mertensia bakeri"                  
 [7] "Eremogone fendleri"                 "Cymopterus alpinus"                 "Artemisia arctica ssp. saxicola"   
[10] "Artemisia borealis"                 "Poa cusickii var. epilis"           "Poa glauca var. rupicola"          
[13] "Sedum integrifolium"                "Ligularia amplectens"               "Ligularia holmii"                  
[16] "Silene hitchguirei"                 "Veronica nutans"                    "Achillea lanulosa"                 
[19] "Carex atrata var. chalciolepis"     "Carex crandallii"                  
> 
> merge.name[merge.name$scientificName %in% grep("Gentianella amarelle ssp. heterosepala", merge.name$scientificName,value=TRUE),]
 [1] ID                      scientificName          Accepted.Symbol         Synonym.Symbol         
 [5] Symbol                  Family                  Duration                Growth.Habit           
 [9] Native.Status           Bloom.Period            Fruit.Seed.Period.Begin Fruit.Seed.Period.End  
[13] startDayOfYear          Year                    DataYrs                
<0 rows> (or 0-length row.names)
> 
> merge.name$scientificName[merge.name$scientificName == "Gentiana heterosepala"] <- "Gentianella amarelle ssp. heterosepala"
> merge.name$Growth.Habit[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "Forb/herb"
> merge.name$Family[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "Gentianaceae"
> merge.name$Duration[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "Annual, Biennial"
> 
> merge.name$scientificName[merge.name$scientificName == "Boechera lemmonii"] <- "Arabis lemmonii var. lemmonii"
> merge.name$Growth.Habit[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "Forb/herb"
> merge.name$Family[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "Brassicaceae"
> merge.name$Duration[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "Perennial"
> 
> 
> merge.name$Growth.Habit[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "Forb/herb"
> merge.name$Family[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "Fabaceae"
> merge.name$Duration[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "Perennial"
> 
> 
> merge.name$scientificName[merge.name$scientificName == "Artemisia borealis"] <- "Artemisia campestris var. purshii"
> merge.name$Growth.Habit[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "Forb/herb"
> merge.name$Family[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "Asteraceae"
> merge.name$Duration[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "Biennial, Perennial"
> 
> merge.name$scientificName[merge.name$scientificName == "Silene hitchguirei"] <- "Silene uralensis ssp. montana"
> merge.name$Growth.Habit[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "Forb/herb"
> merge.name$Family[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "Caryophyllaceae"
> merge.name$Duration[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "Perennial"
> 
> unique(merge.name$Growth.Habit)
 [1] "Forb/herb"                  "Forb/herb, Subshrub"        "Subshrub, Forb/herb"        "Forb/herb, Shrub, Subshrub"
 [5] "Graminoid"                  "Shrub"                      ""                           "Subshrub, Shrub, Forb/herb"
 [9] "Subshrub, Shrub"            "Tree, Shrub"                "Vine, Forb/herb"            "Subshrub"                  
[13] "Tree"                       "Vine, Shrub"                "Tree, Subshrub, Shrub"      "Shrub, Subshrub"           
> unique(merge.name$Bloom.Period)
 [1] ""              "Mid Spring"    "Early Spring"  "Late Spring"   "Indeterminate" "Spring"        "Early Summer" 
 [8] "Mid Summer"    "Summer"        "Late Summer"  
> unique(merge.name$Duration)
[1] "Perennial"                   "Biennial, Perennial"         "Biennial"                   
[4] ""                            "Annual, Biennial, Perennial" "Annual"                     
[7] "Annual, Perennial"          
> merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
+                              grep("Graminoid",merge.name$Growth.Habit, value=TRUE)] <- "Graminoid"
> 
> merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
+                              grep("Forb",merge.name$Growth.Habit, value=TRUE)] <- "Forb"
> 
> merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
+                              grep("Forb", 
+                                   grep("shrub", merge.name$Growth.Habit, 
+                                        value=TRUE, ignore.case=TRUE), 
+                                   value=TRUE, invert=TRUE)] <- "Shrubs"
> 
> merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
+                              grep("Shrub", 
+                                   grep("Tree", merge.name$Growth.Habit, 
+                                        value=TRUE, ignore.case=TRUE), 
+                                   value=TRUE, invert=TRUE, ignore.case=TRUE)] <- "Trees"
> 
> GH <- data.frame(table(merge.name$Growth.Habit[!duplicated(merge.name$ID)]))
> GH[GH$Freq>0,]
                         Var1 Freq
1                               17
2                   Forb/herb  241
3  Forb/herb, Shrub, Subshrub    1
4         Forb/herb, Subshrub    8
5                   Graminoid   83
6                       Shrub    9
7             Shrub, Subshrub    1
8                    Subshrub    3
9         Subshrub, Forb/herb   25
10            Subshrub, Shrub    8
11 Subshrub, Shrub, Forb/herb    1
12                       Tree    4
13                Tree, Shrub    4
14      Tree, Subshrub, Shrub    1
15            Vine, Forb/herb    1
16                Vine, Shrub    1
> sum(GH$Freq)#488 -> 487
[1] 408
> 
> # Number of Families represented!
> length(table(merge.name$Family[!duplicated(merge.name$ID)]))
[1] 45
> 
> # Growth Habit numbers
> table(merge.name$Growth.Habit[!duplicated(merge.name$ID)])

                                            Forb/herb Forb/herb, Shrub, Subshrub        Forb/herb, Subshrub 
                        17                        241                          1                          8 
                 Graminoid                      Shrub            Shrub, Subshrub                   Subshrub 
                        83                          9                          1                          3 
       Subshrub, Forb/herb            Subshrub, Shrub Subshrub, Shrub, Forb/herb                       Tree 
                        25                          8                          1                          4 
               Tree, Shrub      Tree, Subshrub, Shrub            Vine, Forb/herb                Vine, Shrub 
                         4                          1                          1                          1 
> 
> sum(  GH$Freq[GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE)]) #348 Forb/herbs
[1] 277
> 
> sum(  GH$Freq[GH$Var1 %in% grep("Forb", grep("shrub", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #33 shrubs/subshrubs
[1] 27
> 
> sum(  GH$Freq[GH$Var1 %in% grep("Shrub", grep("Tree", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE, ignore.case=TRUE)]) #11->5 trees
[1] 4
> 
> 
> GD <- data.frame(table(merge.name$Duration[!duplicated(merge.name$ID)]))
> GD[GH$Freq>0,]
                            Var1 Freq
1                                  17
2                         Annual    5
3    Annual, Biennial, Perennial    4
4              Annual, Perennial    6
5                       Biennial    1
6            Biennial, Perennial   10
7                      Perennial  365
NA                          <NA>   NA
NA.1                        <NA>   NA
NA.2                        <NA>   NA
NA.3                        <NA>   NA
NA.4                        <NA>   NA
NA.5                        <NA>   NA
NA.6                        <NA>   NA
NA.7                        <NA>   NA
NA.8                        <NA>   NA
> sum(GD$Freq)#487
[1] 408
> 
> # Duration
> table(merge.name$Duration[!duplicated(merge.name$ID)])

                                                 Annual Annual, Biennial, Perennial           Annual, Perennial 
                         17                           5                           4                           6 
                   Biennial         Biennial, Perennial                   Perennial 
                          1                          10                         365 
> 
> sum(GD$Freq[GD$Var1 %in% grep("Biennial", grep("Annual", GD$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #12
[1] 11
> 
> NAT <- data.frame(table(merge.name$Native.Status[!duplicated(merge.name$ID)]))
> NAT[NAT$Freq>0,]
                                                            Var1 Freq
1                                                                  20
2                                        AK (N), CAN (N), GL (N)    1
3                                       AK (N), CAN (N), L48 (N)    3
4                                                         GL (N)    1
5                                                        L48 (N)  145
6                                                L48 (N), AK (N)    1
7                                       L48 (N), AK (N), CAN (N)   81
8                               L48 (N), AK (N), CAN (N), GL (N)   47
9                      L48 (N), AK (N), CAN (N), GL (N), SPM (N)   24
10                             L48 (N), AK (N), CAN (N), SPM (N)   10
11                              L48 (N), AK (N), HI (I), CAN (N)    1
12            L48 (N), AK (N), HI (I?), CAN (N), GL (N), SPM (N)    1
13                    L48 (N), AK (N?), CAN (N), GL (N), SPM (N)    1
14                                              L48 (N), CAN (N)   68
15                                      L48 (N), CAN (N), GL (I)    1
16          L48 (NI), AK (N), HI (I), CAN (NI), GL (N), SPM (NI)    1
17  L48 (NI), AK (NI), HI (I), PR (I), CAN (NI), GL (N), SPM (I)    1
18 L48 (NI), AK (NI), HI (I), PR (I), CAN (NI), GL (NI), SPM (I)    1
> sum(NAT$Freq)#487
[1] 408
> 
> # Native status
> unique(merge.name$scientificName[merge.name$Native.Status == ""])
 [1] "Dasiphora floribunda"               "Draba cana"                         "Erigeron glacialis"                
 [4] "Erysimum capitatum var. argillosum" "Arabis lemmonii var. lemmonii"      "Mertensia bakeri"                  
 [7] "Eremogone fendleri"                 "Cymopterus alpinus"                 "Artemisia arctica ssp. saxicola"   
[10] "Artemisia campestris var. purshii"  "Poa cusickii var. epilis"           "Poa glauca var. rupicola"          
[13] "Sedum integrifolium"                "Ligularia amplectens"               "Ligularia holmii"                  
[16] "Silene uralensis ssp. montana"      "Veronica nutans"                    "Achillea lanulosa"                 
[19] "Carex atrata var. chalciolepis"     "Carex crandallii"                  
> sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE), "Freq"]) #477
[1] 386
> sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE, invert = TRUE), "Freq"]) #10
[1] 22
> 
> merge.name$scientificName[!duplicated(merge.name$ID) & merge.name$Native.Status %in% grep("L48", merge.name$Native.Status, value=TRUE, invert=TRUE)]
 [1] "Dasiphora floribunda"               "Draba cana"                         "Erigeron glacialis"                
 [4] "Erysimum capitatum var. argillosum" "Eutrema edwardsii"                  "Arabis lemmonii var. lemmonii"     
 [7] "Mertensia bakeri"                   "Eremogone fendleri"                 "Cymopterus alpinus"                
[10] "Artemisia arctica ssp. saxicola"    "Artemisia campestris var. purshii"  "Poa cusickii var. epilis"          
[13] "Poa glauca var. rupicola"           "Sedum integrifolium"                "Ligularia amplectens"              
[16] "Ligularia holmii"                   "Silene uralensis ssp. montana"      "Veronica nutans"                   
[19] "Achillea lanulosa"                  "Carex atrata"                       "Carex atrata var. chalciolepis"    
[22] "Carex crandallii"                  
> 
> #which are missing a native status?
> length(unique(merge.name$scientificName[grep("L48", merge.name$Native.Status)])) #476
[1] 386
> length(unique(merge.name$ID[grep("L48", merge.name$Native.Status)])) #477 native 
[1] 386
> length(unique(merge.name$ID[grep("L48", merge.name$Native.Status,
+                                              invert=TRUE)])) #10 non-native
[1] 22
> length(unique(merge.name$scientificName[grep("L48", merge.name$Native.Status,
+                                              invert=TRUE)])) #10 non-native
[1] 22
> 
> table(merge.name$Native.Status) #109 missing status

                                                              
                                                          479 
                                      AK (N), CAN (N), GL (N) 
                                                           10 
                                     AK (N), CAN (N), L48 (N) 
                                                           66 
                                                       GL (N) 
                                                           12 
                                                      L48 (N) 
                                                         3661 
                                              L48 (N), AK (N) 
                                                           48 
                                     L48 (N), AK (N), CAN (N) 
                                                         2043 
                             L48 (N), AK (N), CAN (N), GL (N) 
                                                         1252 
                    L48 (N), AK (N), CAN (N), GL (N), SPM (N) 
                                                          616 
                            L48 (N), AK (N), CAN (N), SPM (N) 
                                                          179 
                             L48 (N), AK (N), HI (I), CAN (N) 
                                                           11 
           L48 (N), AK (N), HI (I?), CAN (N), GL (N), SPM (N) 
                                                           27 
                   L48 (N), AK (N?), CAN (N), GL (N), SPM (N) 
                                                           13 
                                             L48 (N), CAN (N) 
                                                         1616 
                                     L48 (N), CAN (N), GL (I) 
                                                           33 
         L48 (NI), AK (N), HI (I), CAN (NI), GL (N), SPM (NI) 
                                                           29 
 L48 (NI), AK (NI), HI (I), PR (I), CAN (NI), GL (N), SPM (I) 
                                                           17 
L48 (NI), AK (NI), HI (I), PR (I), CAN (NI), GL (NI), SPM (I) 
                                                           21 
> unique(merge.name$scientificName[merge.name$Native.Status == ""])
 [1] "Dasiphora floribunda"               "Draba cana"                         "Erigeron glacialis"                
 [4] "Erysimum capitatum var. argillosum" "Arabis lemmonii var. lemmonii"      "Mertensia bakeri"                  
 [7] "Eremogone fendleri"                 "Cymopterus alpinus"                 "Artemisia arctica ssp. saxicola"   
[10] "Artemisia campestris var. purshii"  "Poa cusickii var. epilis"           "Poa glauca var. rupicola"          
[13] "Sedum integrifolium"                "Ligularia amplectens"               "Ligularia holmii"                  
[16] "Silene uralensis ssp. montana"      "Veronica nutans"                    "Achillea lanulosa"                 
[19] "Carex atrata var. chalciolepis"     "Carex crandallii"                  
> merge.name$Native.Status[merge.name$scientificName == "Dasiphora fruticosa"] <- "L48 (N)"
> merge.name$Native.Status[merge.name$scientificName == "Dasiphora fruticosa ssp. floribunda"] <- "L48 (N)"
> merge.name$Native.Status[merge.name$scientificName == "Gentianella amarelle ssp. heterosepala"] <- "L48 (N)"
> merge.name$Native.Status[merge.name$scientificName == "Arabis lemmonii var. lemmonii"] <- "L48 (N)"
> merge.name$Native.Status[merge.name$scientificName == "Lupinus argenteus var. rubricaulis"] <- "L48 (N)"
> merge.name$Native.Status[merge.name$scientificName == "Artemisia campestris var. purshii"] <- "L48 (N)"
> merge.name$Native.Status[merge.name$scientificName == "Silene uralensis ssp. montana"] <- "L48 (N)"
> 
> earliestcollection <- data.frame(colSums(table(merge.name$ID, #should be only one name now
+                                                 merge.name$Year)))
> 
> length(unique(merge.name$ID))
[1] 408
> sort(unique(merge.name$DataYrs))
 [1] 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 47 48 49
[40] 50 51 52 54
> 
> earcol <- data.frame(Year = row.names(earliestcollection),
+                      Collections = earliestcollection)
> colnames(earcol)[2] <- "Collections"
> earcol[,1] <- as.numeric(levels(earcol[,1]))
> earcol[which.max(earcol$Collections),]
     Year Collections
1998 1998         348
> mean(earcol$Collections) #189 -> 187.0492
[1] 166.1148
> 
> dpi = 1200
> tiff("Q:/Research/Projects/alpine-phenology/Fig. 1a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)
> 
> ggplot(earcol, aes(Year, Collections))+
+   geom_bar(stat="identity")+
+   xlab("Year")+
+   ylab("Number of Study Species")+
+   theme_bw()+
+   theme(axis.text.x = element_text(angle=90, hjust=1))+
+   scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
+   theme(axis.text=element_text(size=7),
+         axis.title=element_text(size=9))
> 
> dev.off()
RStudioGD 
        2 
> mean(earcol$Collections)
[1] 166.1148
> allcollections <- data.frame(colSums(table(bloom2$scientificName,bloom2$Year)))
> allcol <- data.frame(Year = row.names(allcollections),
+                      allcollections)
> colnames(allcol)[2] <- "collections"
> 
> as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
> allcol[,1] <- as.numeric.factor(allcol[,1])
> dpi = 1200
> tiff("Q:/Research/Projects/alpine-phenology/Fig. 1b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)
> 
> ggplot(allcol,  aes(x = Year, y = collections))+
+   geom_bar(stat="identity")+
+   xlab("Year")+
+   ylab("Total Collections")+
+   theme_bw()+
+   theme(axis.text.x = element_text(angle=90, hjust=1))+
+   scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
+   scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500)) +
+   theme(axis.text=element_text(size=7),
+         axis.title=element_text(size=9))
> 
> dev.off()
RStudioGD 
        2 
> collJ.sp <- data.frame(table(bloom2$Year,bloom2$startDayOfYear))
> 
> collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
> collmax <- do.call(rbind,collJ.max)
> collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))
> 
> mean(collmax$Var2)
[1] 207.541
> collmax[which.min(collmax$Var2),]
     Var1 Var2 Freq
2007 2007  175   62
> collmax[which.max(collmax$Var2),]
     Var1 Var2 Freq
1957 1957  238   24
> summary(lm(Var2~Var1, data=collmax))

Call:
lm(formula = Var2 ~ Var1, data = collmax)

Residuals:
     Min       1Q   Median       3Q      Max 
-28.9215 -11.0555  -0.1605  11.5206  31.2017 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)  
(Intercept) 472.9720   223.4115   2.117   0.0385 *
Var1         -0.1341     0.1128  -1.188   0.2395  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 15.52 on 59 degrees of freedom
Multiple R-squared:  0.02337,	Adjusted R-squared:  0.006814 
F-statistic: 1.412 on 1 and 59 DF,  p-value: 0.2395

> 
> library(RCurl)
> bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/QR_final_R_plant_climate_data_2.csv"))
> 
> head(bloom)
  plantID institutionCode catalogNumber                                                          Scientific.Name
1   21862              RM               Acomastylis rossii (R. Brown) Greene ssp turbinata (Rydberg) W. A. Weber
2   21863              RM        276570 Acomastylis rossii (R. Brown) Greene ssp turbinata (Rydberg) W. A. Weber
3   21864              CU        197557 Acomastylis rossii (R. Brown) Greene ssp turbinata (Rydberg) W. A. Weber
4   21865              CU        423185 Acomastylis rossii (R. Brown) Greene ssp turbinata (Rydberg) W. A. Weber
5   21866              CU        520710 Acomastylis rossii (R. Brown) Greene ssp turbinata (Rydberg) W. A. Weber
6   21867              RM               Acomastylis rossii (R. Brown) Greene ssp turbinata (Rydberg) W. A. Weber
  sppListID      eventDate earliestBloomDate year_plant Month Day startDayOfYear              reproductiveCondition
1         2 6/11/1998 0:00                 1       1998     6  11            162              Phenology: Flowering.
2         2 6/13/1963 0:00                 1       1963     6  13            164              Phenology: Flowering.
3         2 6/13/1963 0:00                 0       1963     6  13            164              Phenology: Flowering.
4         2 6/13/1979 0:00                 1       1979     6  13            164 Phenology: Flowering and Fruiting.
5         2 6/15/2001 0:00                 1       2001     6  15            166              Phenology: Flowering.
6         2 6/15/2004 0:00                 1       2004     6  15            167              Phenology: Flowering.
    county decimalLatitude decimalLongitude minimumElevationInMeters verbatimElevation ID Year Raw_Precip Avg_Hi Med_Hi
1 Huerfano         37.5948        -105.4949                     3810         12500 ft. 49 1998      79954   8.65   8.57
2  Larimer                                                      3445         11300 ft. 14 1963      67301   8.89   8.83
3  Larimer                                                      3444             11300 14 1963      67301   8.89   8.83
4     Park         39 12'N         105 25'W                     3383             11100 30 1979      81308   7.59   7.57
5  Jackson                                                      3200             10500 52 2001      73220   9.53   9.44
6 Saguache          37.904        -106.5857                     3414         11200 ft. 55 2004      77968   8.96   8.91
  Avg_Lo Med_Lo Av_Temp Med_Temp   GDD
1  -5.55  -5.53    1.55     1.52 -8.45
2  -6.07  -6.07    1.41     1.38 -8.59
3  -6.07  -6.07    1.41     1.38 -8.59
4  -7.45  -7.45    0.07     0.06 -9.93
5  -5.37  -5.34    2.08     2.05 -7.92
6  -5.36  -5.36    1.80     1.78 -8.20
> head(bloom[,c(19,20,21,23)])
  Year Raw_Precip Avg_Hi Avg_Lo
1 1998      79954   8.65  -5.55
2 1963      67301   8.89  -6.07
3 1963      67301   8.89  -6.07
4 1979      81308   7.59  -7.45
5 2001      73220   9.53  -5.37
6 2004      77968   8.96  -5.36
> 
> # units for precip are: ppt (mm*100) (even though it just says mm on the main website you look at when reading about the variables). So, we need to divide our values by 100 for our figures. 
> bloom$Raw_Precip <- (bloom$Raw_Precip)/100
> 
> # merge.name$Raw_Precip <- (merge.name$Raw_Precip)/100
> 
> # If already have precip and hi lo, don't merge again, don't want .x and .y!
> head(merge.name)
     ID                           scientificName Accepted.Symbol Synonym.Symbol Symbol     Family  Duration Growth.Habit
1 10059 Chamerion angustifolium ssp. circumvagum           CHANC                 CHANC Onagraceae Perennial    Forb/herb
2 10059 Chamerion angustifolium ssp. circumvagum           CHANC                 CHANC Onagraceae Perennial    Forb/herb
3 10059 Chamerion angustifolium ssp. circumvagum           CHANC                 CHANC Onagraceae Perennial    Forb/herb
4 10059 Chamerion angustifolium ssp. circumvagum           CHANC                 CHANC Onagraceae Perennial    Forb/herb
5 10059 Chamerion angustifolium ssp. circumvagum           CHANC                 CHANC Onagraceae Perennial    Forb/herb
6 10059 Chamerion angustifolium ssp. circumvagum           CHANC                 CHANC Onagraceae Perennial    Forb/herb
                      Native.Status Bloom.Period Fruit.Seed.Period.Begin Fruit.Seed.Period.End startDayOfYear Year
1 L48 (N), AK (N), CAN (N), SPM (N)                                                                       203 1972
2 L48 (N), AK (N), CAN (N), SPM (N)                                                                       197 1954
3 L48 (N), AK (N), CAN (N), SPM (N)                                                                       202 2007
4 L48 (N), AK (N), CAN (N), SPM (N)                                                                       178 1958
5 L48 (N), AK (N), CAN (N), SPM (N)                                                                       240 1981
6 L48 (N), AK (N), CAN (N), SPM (N)                                                                       206 1971
  DataYrs Growth.Habit.sm
1      23            Forb
2      23            Forb
3      23            Forb
4      23            Forb
5      23            Forb
6      23            Forb
> merge.name <- merge(merge.name,unique(bloom[,c(19,20,21,23)]), by="Year")
> 
> write.table(merge.name, file="P:/hackathon/alpine-phenology/datasets/merge.name.csv", sep=",")
> 
> unbloom <- unique(bloom[,c(19,20,21,23)])
> cor(unbloom[,-1])
           Raw_Precip     Avg_Hi    Avg_Lo
Raw_Precip  1.0000000 -0.4709202 0.1554382
Avg_Hi     -0.4709202  1.0000000 0.4670595
Avg_Lo      0.1554382  0.4670595 1.0000000
> cor.test(unbloom[,2],unbloom[,3])

	Pearson's product-moment correlation

data:  unbloom[, 2] and unbloom[, 3]
t = -4.1349, df = 60, p-value = 0.0001121
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.6448416 -0.2506315
sample estimates:
       cor 
-0.4709202 

> cor.test(unbloom[,2],unbloom[,4])

	Pearson's product-moment correlation

data:  unbloom[, 2] and unbloom[, 4]
t = 1.2188, df = 60, p-value = 0.2277
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.09814017  0.39006277
sample estimates:
      cor 
0.1554382 

> cor.test(unbloom[,3],unbloom[,4])

	Pearson's product-moment correlation

data:  unbloom[, 3] and unbloom[, 4]
t = 4.0915, df = 60, p-value = 0.0001298
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.2459874 0.6419411
sample estimates:
      cor 
0.4670595 

> 
> tiff("Q:/Research/Projects/alpine-phenology/Fig. ordinalxyear.tiff", width = 174, height = 150, compression="lzw", units = "mm", res=dpi)
> 
> 
> ggplot(merge.name, aes(Year, startDayOfYear)) +
+   geom_point(shape=1)+
+   stat_smooth(method="lm",colour = "black", size = 0.75)+
+   theme_bw()+
+   xlab("Year")+
+   ylab("Ordinal date")+
+   scale_x_continuous(breaks = seq(1950,2011,10)) +
+   theme(axis.text=element_text(size=9),
+         axis.title=element_text(size=12)) 
> 
> dev.off()
RStudioGD 
        2 
> 
> summary(lm(startDayOfYear~Year, data=merge.name))

Call:
lm(formula = startDayOfYear ~ Year, data = merge.name)

Residuals:
     Min       1Q   Median       3Q      Max 
-190.338  -13.947   -1.619   13.115  108.709 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 479.71777   24.22712   19.80   <2e-16 ***
Year         -0.14062    0.01221  -11.52   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 19.97 on 10131 degrees of freedom
Multiple R-squared:  0.01293,	Adjusted R-squared:  0.01283 
F-statistic: 132.7 on 1 and 10131 DF,  p-value: < 2.2e-16

> 
> segmented.start.year <- segmented(lm(startDayOfYear~Year, data=merge.name), 
+                                   seg.Z = ~Year, psi=1980)
> summary(segmented.start.year)

	***Regression Model with Segmented Relationship(s)***

Call: 
segmented.lm(obj = lm(startDayOfYear ~ Year, data = merge.name), 
    seg.Z = ~Year, psi = 1980)

Estimated Break-Point(s):
     Est.   St.Err 
1977.822    1.689 

Meaningful coefficients of the linear terms:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept) -137.48616   92.55344  -1.485 0.137448    
Year           0.17329    0.04711   3.678 0.000236 ***
U1.Year       -0.52147    0.05446  -9.575       NA    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 19.87 on 10129 degrees of freedom
Multiple R-Squared: 0.02313,  Adjusted R-squared: 0.02285 

Convergence attained in 4 iterations with relative change -1.164445e-16 
> slope(segmented.start.year)
$Year
          Est. St.Err. t value CI(95%).l CI(95%).u
slope1  0.1733 0.04711   3.678   0.08094    0.2656
slope2 -0.3482 0.02732 -12.740  -0.40170   -0.2946

> tiff("Q:/Research/Projects/alpine-phenology/Fig. 3a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)
> 
> ggplot(unbloom, aes(Year,Avg_Hi))+
+   stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
+   geom_point(shape=1, size=0.5)+
+ #  stat_smooth(geom = "smooth")+
+   theme_bw()+
+ #  labs(title="Average High Temperature by Year")+
+   xlab("Year")+
+   ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
+   scale_x_continuous(breaks = seq(1950,2011,10))+
+   theme(axis.text=element_text(size=6),
+         axis.title=element_text(size=8))
> 
> dev.off()
RStudioGD 
        2 
> 
> summary(lm(Avg_Hi~Year, data=unbloom))

Call:
lm(formula = Avg_Hi ~ Year, data = unbloom)

Residuals:
    Min      1Q  Median      3Q     Max 
-1.2432 -0.5494 -0.1859  0.5220  1.7896 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)
(Intercept)  4.606321  10.504625   0.439    0.663
Year         0.001724   0.005304   0.325    0.746

Residual standard error: 0.7474 on 60 degrees of freedom
Multiple R-squared:  0.001759,	Adjusted R-squared:  -0.01488 
F-statistic: 0.1057 on 1 and 60 DF,  p-value: 0.7462

> segmented.Avg_Hi.year <- segmented(lm(Avg_Hi~Year, data=unbloom), 
+                                   seg.Z = ~Year, 
+                                   psi= list(Year = c(1985,2000)))
> summary(segmented.Avg_Hi.year)

	***Regression Model with Segmented Relationship(s)***

Call: 
segmented.lm(obj = lm(Avg_Hi ~ Year, data = unbloom), seg.Z = ~Year, 
    psi = list(Year = c(1985, 2000)))

Estimated Break-Point(s):
               Est. St.Err
psi1.Year 1994.464  1.185
psi2.Year 2001.342  0.816

Meaningful coefficients of the linear terms:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 48.589711  11.965759   4.061 0.000154 ***
Year        -0.020651   0.006068  -3.403 0.001236 ** 
U1.Year      0.367437   0.100084   3.671       NA    
U2.Year     -0.635998   0.115617  -5.501       NA    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.5286 on 56 degrees of freedom
Multiple R-Squared: 0.5339,  Adjusted R-squared: 0.4923 

Convergence attained in 6 iterations with relative change 1.135076e-16 
> slope(segmented.Avg_Hi.year)
$Year
           Est.  St.Err. t value CI(95%).l CI(95%).u
slope1 -0.02065 0.006068  -3.403  -0.03281 -0.008496
slope2  0.34680 0.099900   3.471   0.14670  0.546900
slope3 -0.28920 0.058200  -4.969  -0.40580 -0.172600

> segmented.Avg_Hi.year$psi #1994.5 and 2001.3
          Initial     Est.    St.Err
psi1.Year    1985 1994.464 1.1847222
psi2.Year    2000 2001.342 0.8161864
> #Fitted data
> seg.fit <- fitted(segmented.Avg_Hi.year)
> seg.model <- data.frame(Year = unbloom$Year, Avg_Hi = seg.fit)
> 
> #plot fitted model
> ggplot(unbloom, aes(Year,Avg_Hi))+
+   stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
+   geom_point(shape=1)+
+ #  stat_smooth(geom = "smooth")+
+   theme_bw()+
+ #  labs(title="Average High Temperature by Year")+
+   xlab("Year")+
+   ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
+   scale_x_continuous(breaks = seq(1950,2011,10))+
+   geom_line(data = seg.model, aes(Year,Avg_Hi), colour = "tomato")
> tiff("Q:/Research/Projects/alpine-phenology/Fig. 3b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)
> 
> 
> ggplot(unbloom, aes(Year,Avg_Lo))+
+   stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
+   geom_point(shape=1, size = 0.5)+
+   theme_bw()+
+ #  labs(title="Average Low Temperature by Year")+
+   xlab("Year")+
+   ylab(~degree~C)+
+   scale_x_continuous(breaks = seq(1950,2011,10))+
+   theme(axis.text=element_text(size=5),
+         axis.title=element_text(size=7))
> 
> dev.off()
RStudioGD 
        2 
> 
> 
> summary(lm(Avg_Lo~Year, data = unbloom))

Call:
lm(formula = Avg_Lo ~ Year, data = unbloom)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.31348 -0.42294 -0.05916  0.52004  1.65712 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept) -67.723676   9.213559   -7.35 6.31e-10 ***
Year          0.030981   0.004652    6.66 9.49e-09 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.6555 on 60 degrees of freedom
Multiple R-squared:  0.425,	Adjusted R-squared:  0.4154 
F-statistic: 44.35 on 1 and 60 DF,  p-value: 9.491e-09

> 
> tiff("Q:/Research/Projects/alpine-phenology/Fig. 3c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)
> 
> ggplot(unbloom, aes(Year,Raw_Precip))+
+   stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
+   geom_point(shape=1, size = 0.5)+
+   theme_bw()+
+ #  labs(title="Average Precipitation by Year")+
+   xlab("Year")+
+   ylab("Precipitation (mm)")+
+   scale_x_continuous(breaks = seq(1950,2011,10))+
+   theme(axis.text=element_text(size=5),
+         axis.title=element_text(size=7))
> 
> dev.off()
RStudioGD 
        2 
> 
> 
> summary(lm(Raw_Precip~Year, data = unbloom))

Call:
lm(formula = Raw_Precip ~ Year, data = unbloom)

Residuals:
    Min      1Q  Median      3Q     Max 
-273.55  -69.59   -2.62   55.73  349.97 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)  
(Intercept) -2537.7346  1508.9971  -1.682   0.0978 .
Year            1.6812     0.7619   2.207   0.0312 *
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 107.4 on 60 degrees of freedom
Multiple R-squared:  0.07506,	Adjusted R-squared:  0.05964 
F-statistic: 4.869 on 1 and 60 DF,  p-value: 0.03118


Segmented test
```{r}
segmented.Raw_Precip.year <- segmented(lm(Raw_Precip~Year, data=unbloom), 
                                  seg.Z = ~Year, 
                                  psi= 1965)
summary(segmented.Raw_Precip.year)
slope(segmented.Raw_Precip.year)
segmented.Raw_Precip.year$psi
#Fitted data
seg.fit <- fitted(segmented.Raw_Precip.year)
seg.model <- data.frame(Year = unbloom$Year, Raw_Precip = seg.fit)

#plot fitted model
ggplot(unbloom, aes(Year,Raw_Precip))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  geom_line(data = seg.model, aes(Year,Raw_Precip), colour = "tomato")
```

#Figure 4A  
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Avg_Hi, startDayOfYear))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=7))


dev.off()

summary(lm(startDayOfYear~Avg_Hi, data=merge.name))

```
lm(formula = startDayOfYear ~ Avg_Hi, data = merge.name)

Residuals:
    Min      1Q  Median      3Q     Max 
-186.33  -13.76   -1.33   13.15  111.47 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 235.9715     2.0153  117.09   <2e-16 ***
Avg_Hi       -4.3695     0.2482  -17.61   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 19.8 on 10131 degrees of freedom
Multiple R-squared:  0.02968,	Adjusted R-squared:  0.02959 
F-statistic: 309.9 on 1 and 10131 DF,  p-value: < 2.2e-16


# By growth type
```{r}
ggplot(merge.name, aes(Avg_Hi, startDayOfYear, colour = Growth.Habit.sm))+
  geom_point(shape=1)+
  stat_smooth(method="lm",size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Hi, data=merge.name))

```


#Figure 4B
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1, size= 0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Avg_Lo, data = merge.name))
```
lm(formula = startDayOfYear ~ Avg_Lo, data = merge.name)

Residuals:
     Min       1Q   Median       3Q      Max 
-189.129  -13.656   -0.779   13.022  108.584 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 175.6159     1.5049  116.70   <2e-16 ***
Avg_Lo       -4.0062     0.2386  -16.79   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 19.83 on 10131 degrees of freedom
Multiple R-squared:  0.02707,	Adjusted R-squared:  0.02697 
F-statistic: 281.8 on 1 and 10131 DF,  p-value: < 2.2e-16


```{r}
ggplot(merge.name, aes(Avg_Lo, startDayOfYear, colour = Growth.Habit.sm))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Lo+Growth.Habit.sm, data = merge.name))
```

#Figure 4C
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1,size=0.25)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Raw_Precip, data = merge.name))

```
lm(formula = startDayOfYear ~ Raw_Precip, data = merge.name)

Residuals:
     Min       1Q   Median       3Q      Max 
-191.608  -13.441   -2.082   12.917  109.006 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 1.889e+02  1.604e+00 117.740  < 2e-16 ***
Raw_Precip  1.466e-02  1.979e-03   7.405 1.42e-13 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 20.05 on 10131 degrees of freedom
Multiple R-squared:  0.005383,	Adjusted R-squared:  0.005285 
F-statistic: 54.83 on 1 and 10131 DF,  p-value: 1.419e-13


```{r}
ggplot(merge.name, aes(Raw_Precip, startDayOfYear, colour = Growth.Habit.sm))+
  geom_point()+
  stat_smooth(method="lm", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Raw_Precip+Growth.Habit.sm, data = merge.name))

```

Growing Degree Days   
```{r, eval=FALSE}
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
# mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

# Takes an hour to run
avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)
# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

```


Calculate Growing Degree Days
```{r}
tbase <- 0

#method 1 from McMaster and Wilhelm 1997
HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})

HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all
```

# Now merge GDD with merge.name
```{r}
nrow(merge.name[merge.name$Year > 1980,]) #7295 -> 6426

#min.dates <- merge(min.dates, tmps, 
#                   by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))

min1950GDD_2 <- mergeMinGDD(merge.name,tmps)

length(unique(min1950GDD_2$day)) #1152 -> 1145 -> 1111
length(unique(min1950GDD_2$scientificName)) #486 -> 408

#Years of data for GDD years per species
gdddatayrs <- as.data.frame(table(min1950GDD_2$Year,min1950GDD_2$scientificName))
yrspsp <- aggregate(gdddatayrs[,3], by = list(gdddatayrs$Var2), FUN=sum)
nrow(yrspsp[yrspsp$x>=10,]) #373 -> 319


### Reduce min1950GDD_2 to only species where 10 or more years of data
min1950GDD_2_10 <- merge(min1950GDD_2,yrspsp[yrspsp$x>=10,],
                         by.x="scientificName",by.y="Group.1")
length(unique(min1950GDD_2_10$scientificName)) #319

```

```{r}
avg.HDD.yrs <- lapply(HDD.yrs, function(x){
  mean(x)
})

avg.yrs <- do.call(c, avg.HDD.yrs)
hddyrs <- data.frame(Year=1981:2011, avgHDD = avg.yrs)
```

correlations with GDD and climate factors
```{r}
unbloomGDD <- merge(unbloom,hddyrs,by="Year")
cor(unbloomGDD[,-1])
cor.test(unbloomGDD$avgHDD,unbloomGDD$Raw_Precip)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Hi)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Lo)

```

#Figure 5A   
Average GDD for the ealiest collection date did! change significantly over the study years, just the r^2 is next to nothing
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDD_2_10, aes(Year,HDD))+
  geom_point(size=0.25, shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=6))

dev.off()


summary(lm(HDD~Year, data=min1950GDD_2_10))
```
lm(formula = HDD ~ Year, data = min1950GDD_2_10)

Residuals:
    Min      1Q  Median      3Q     Max 
-628.25 -154.49  -22.08  131.85  755.85 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept) -3580.8233   659.9441  -5.426 6.00e-08 ***
Year            2.1007     0.3308   6.351 2.31e-10 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 205.5 on 5754 degrees of freedom
Multiple R-squared:  0.006961,	Adjusted R-squared:  0.006788 
F-statistic: 40.33 on 1 and 5754 DF,  p-value: 2.306e-10


```{r}
ggplot(min1950GDD_2_10, aes(Year,HDD, colour=Growth.Habit.sm))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))

summary(lm(HDD~Year+Growth.Habit.sm, data=min1950GDD_2_10))
```

Growing Degree Days over time
```{r}

ggplot(unbloomGDD, aes(Year,avgHDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("average annual GDD")

summary(lm(avgHDD~Year, data=unbloomGDD))
```

```{r}
totalGDD <- lapply(HDD.yrs, function(x){
  max(x)
})
totalGDDyr <- data.frame(Year=1981:2011,MaxGDD = do.call(rbind,totalGDD))
head(totalGDDyr)
```

#5b
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point(size=0.5,shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab(expression(paste("GDD at ordinal date 273 (T"[base] == 0, degree*C,")")))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(MaxGDD~Year,data=totalGDDyr))

```
lm(formula = MaxGDD ~ Year, data = totalGDDyr)

Residuals:
     Min       1Q   Median       3Q      Max 
-199.051  -66.605   -6.118   62.893  160.943 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept) -19652.703   3735.051  -5.262 1.23e-05 ***
Year            10.561      1.871   5.644 4.25e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 93.19 on 29 degrees of freedom
Multiple R-squared:  0.5234,	Adjusted R-squared:  0.507 
F-statistic: 31.85 on 1 and 29 DF,  p-value: 4.249e-06


#Figure 4C
```{r}
#meltd is from Results figures and tables.Rmd
fit1 <- lapply(unique(meltd$Year), function(x){
  stepAIC(lm(GDD~Day+I(Day^2), data=meltd[meltd$Year==x,]),
          scope = lm(GDD~1, data=meltd[meltd$Year==x,]),
          direction = "backward")
})

poly.p <- lapply(fit1, function(fx){
  polynomial(coef(fx))
})
sday <- 1
eday <- 273

secant.poly <- lapply(poly.p,function(x){
  ((as.function(x)(eday)+1000) - (as.function(x)(sday)+1000))/(eday-sday)
})
secant.poly.all <- data.frame(Year=1981:2011, 
                              Secant= do.call(rbind,secant.poly))

ggplot(secant.poly.all, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Average rate of change in GDD (day 1 to 273)")

summary(lm(Secant~Year, data=secant.poly.all))

```

#Secant instead of max 
```{r}
min1950GDDsecant2 <- merge(min1950GDD_2_10, secant.poly.all,by="Year")
head(min1950GDDsecant2)

ggplot(min1950GDDsecant2, aes(Secant,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by average rate of GDD accumulation") +
  xlab("Average rate of GDD accumulation")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Secant, data=min1950GDDsecant2))

```

```{r}
ggplot(min1950GDDsecant2, aes(Secant,startDayOfYear, colour=Growth.Habit.sm))+
  geom_point()+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by average rate of GDD accumulation") +
  xlab("Average rate of GDD accumulation")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Secant+Growth.Habit.sm, data=min1950GDDsecant2))

```

#SKIP this, not informative!
Because of course the GDD of a certain day of the year will be very similar every year even if it's increasing over the years. 
```{r, eval=FALSE}
ggplot(min1950GDD_2_10, aes(HDD,startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("GDD")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~HDD, data=min1950GDD_2_10))

```


NPN species   
(from Climate)    
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

#although lots of these might not have 10 years    
#Match names - synonyms and all
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big) #27 -> 77
npn.big.m <- merge(npn.all,bloom2,by.x="SciName",by.y="scientificName")
length(unique(npn.big.m$ID)) #77

# How many IDs that match have collections within 1950 to 2011
npn.foo <- merge.name[merge.name$ID %in% npn.IDs,]
nrow(npn.foo)
length(unique(npn.foo$ID)) #28
sort(unique(npn.foo$scientificName))
```

Clunky but need to change the function
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "Fam", "adj.r.squ")
  JYC
}

```


Phenology summary tables    
```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",merge.name)

nrow(yr.1950_2) #486
sort(table(yr.1950_2$Species)) #No repeats!

write.table(yr.1950_2, file = "Q:/Research/Projects/alpine-phenology/phensum_yr.csv", sep=",")

nrow(yr.1950_2) #488 -> 487
nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #433 -> 431
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #55

nrow(yr.1950_2[yr.1950_2$p.value<0.05,])/nrow(yr.1950_2) #0.1129363

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #46
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #-0.5309595
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #0.2259684

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,]) #5 -> 1
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #0.8140648
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #0.2182915

```

```{r}
TPL.merge.names <- TPL(yr.1950_2$Species)
tpl.syn <- TPL.merge.names[TPL.merge.names$Taxonomic.status == "Synonym",]
tpl.syn$Abbrev[is.na(tpl.syn$Abbrev)] <- ""

trim.trailing <- function (x) sub("\\s+$", "", x)

foo.list.2 <- lapply(1:nrow(tpl.syn), function(row){
  sps <- yr.1950_2[yr.1950_2$Species %in% grep(paste(c(tpl.syn$Genus[row], tpl.syn$New.Genus[row]), collapse="|"),
                       yr.1950_2$Species, value = TRUE) & 
              yr.1950_2$Species %in% grep(paste(c(tpl.syn$Species[row], 
                                                  tpl.syn$New.Species[row]), collapse="|"),
                       yr.1950_2$Species, value = TRUE),]
  New.sp <- trim.trailing(do.call(paste, list(tpl.syn$New.Genus[row],tpl.syn$New.Species[row]))) 
  #, tpl.syn$Abbrev[row], tpl.syn$New.Infraspecific[row]
#  New.sp <- paste("^",New.sp,"$", collapse = '', sep = '')
  y.n <- if(grepl(New.sp, sps$Species)) {
    print("Yes")
  }
  else (print("No"))
  y.n
})

write.table(do.call(rbind, foo.list.2), "clipboard", sep="\t", row.names=FALSE)

foo.list.1 <- lapply(1:nrow(tpl.syn), function(row){
  sps <- yr.1950_2[yr.1950_2$Species %in% grep(paste(c(tpl.syn$Genus[row], tpl.syn$New.Genus[row]), collapse="|"),
                       yr.1950_2$Species, value = TRUE) & 
              yr.1950_2$Species %in% grep(paste(c(tpl.syn$Species[row], 
                                                  tpl.syn$New.Species[row]), collapse="|"),
                       yr.1950_2$Species, value = TRUE),]
})
foo.list.1[[15]] #both Draba breweri var. cana and Draba breweri
#### START HERE!! with the list of 'Yes' for species that is synonym where accepted is already in there
#can look through the Yes list and combine earlier - reduce by 18, should check the unresolved names too
foo.list.1[[91]]


unique(TPL.merge.names$Taxonomic.status)
TPL.merge.names[TPL.merge.names$Taxonomic.status == "Unresolved",]


write.table(TPL.merge.names[TPL.merge.names$Taxonomic.status == "Synonym",], 
            file = "Q:/Research/Projects/alpine-phenology/synonyms.csv", sep=",")


write.table(TPL.merge.names[TPL.merge.names$Taxonomic.status == "Unresolved",], 
            file = "Q:/Research/Projects/alpine-phenology/Unresolved.csv", sep=",")
```

###High Temperature     
```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", merge.name)

nrow(high.1950_2) #487
sort(table(high.1950_2$Species)) #No repeats!

write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,]) #79
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2)

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,])  #69
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) # -10.50008
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) #0.2190323

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) # 2
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #8.893071
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #0.3025555

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.1740196
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2) #0.8259804

```

```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", merge.name)

nrow(low.1950_2) #486
sort(table(low.1950_2$Species)) #No repeats!

write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #79 -> 74
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2)

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #66
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #-9.691339
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #0.1787917

#later
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #2
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #9.253998
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #0.2248121
```

### Precipitation
```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", merge.name)

nrow(precip.1950_2) #487

write.table(precip.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2.csv", sep=",")

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #51 -> 45
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2)

#earlier
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #2
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) # -0.06127949
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) #0.2274756

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #33
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.08201873
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.2329733
```

Growing Degree Days at time of earliest collection
```{r}
ggplot(min1950GDD_2_10, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD))


```

# NPN only precip, high, low
###NPN year     
```{r}
npn.min1950 <- npn.foo
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

nrow(yr.npn_2) #28 

write.table(yr.npn_2, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr.csv", sep=",")

nrow(yr.npn_2) 
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2)

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) #3
mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #-0.5594091
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #0.1777188

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #5 -> 0
mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0])
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0])

```
###NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

nrow(high.npn_2) #28

write.table(high.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,])

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) #4
mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #-9.74149
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #0.1705335

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) #0
mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0])
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0])
```
###NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

nrow(low.npn_2) #27 -> 28

write.table(low.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_2.csv", sep=",")

nrow(low.npn_2[low.npn_2$p.value<0.05,])
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2)

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) # 7
mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #-10.56014
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #0.173146

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,]) #0
mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0])
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0])

```
###NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

nrow(precip.NPN_2) #27 -> 28

write.table(precip.NPN_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_precip_2.csv", sep=",")

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #1
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2) #0.04166667

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) #1
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.09425329
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.4683842

```


Growing Degree Days - GDD at time of collection  ~ Year
```{r}
#reset between time of collection and next, max per year
rm(results,rst)
results <- lapply(unique(min1950GDD_2_10$ID), function(x){
  if(nrow(min1950GDD_2_10[min1950GDD_2_10$ID==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=min1950GDD_2_10[min1950GDD_2_10$ID==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          ID = x,
                          unique(min1950GDD_2_10$scientificName[min1950GDD_2_10$ID == x])[1],
                          unique(min1950GDD_2_10$Family[min1950GDD_2_10$ID == x])[1],
                          foo1$adj.r.squared,
                          N = nrow(min1950GDD_2_10[min1950GDD_2_10$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF",
                   "ID", "Species","Family.Name","adj.r.squ","N")
  JYC
  }
  })


results[[1]]
rst <- do.call(rbind,results)
head(rst)


nrow(rst) #406 -> 373
rst[rst$p.value<0.05,]
nrow(rst[rst$p.value<0.05,]) #27

#smaller HDD at time of collection
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #4
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -10.73456
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.2570544

#bigger HDD at time of collection
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,])  #23
rst$Species[rst$p.value<0.05 & rst$Slope >= 0]
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) #10.40766
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0])  #0.2585075

write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_table5a.csv", sep=",")
```

# Informative part, like average precip, temp per year, does the earliest collection date change as the MaxGDD (up through ordinal day 273) changes per year?
#GDD high per year
```{r}
head(totalGDDyr)
#Reset for time of collection and now max
rm(results,rst,min1950GDDmax)
min1950GDDmax <- merge(totalGDDyr,min1950GDD_2_10, by="Year")
results <- lapply(unique(min1950GDDmax$ID), function(x){
  if(nrow(min1950GDDmax[min1950GDDmax$ID==x,])>=10){
  foo1 <- summary(lm(startDayOfYear~MaxGDD,data=min1950GDDmax[min1950GDDmax$ID==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          ID = x,
                          unique(min1950GDDmax$scientificName[min1950GDDmax$ID == x])[1],
                          unique(min1950GDDmax$Family[min1950GDDmax$ID == x])[1],
                          foo1$adj.r.squared,
                          N = nrow(min1950GDDmax[min1950GDDmax$ID==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF",
                   "ID", "Species","Family.Name","adj.r.squ","N")
  JYC
  }
  })


results[[1]]
rst <- do.call(rbind,results)
head(rst)


nrow(rst) #319
rst[rst$p.value<0.05,]
nrow(rst[rst$p.value<0.05,]) #61

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #60
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -0.06494145
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.2688013

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) #1
rst[rst$p.value<0.05 & rst$Slope >= 0,] #Sambucus racemosa var. racemosa
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) #0.06436998
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) #0.2293882

write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_max.csv", sep=",")
```


,group=scientificName
#Overall MaxGDD
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. maxGDD by year.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDDmax, aes( MaxGDD, startDayOfYear))+
  geom_point(shape=1, size=0.5)+
  geom_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()

summary(lm(startDayOfYear~MaxGDD, data = min1950GDDmax))

```


###NPN Growing Degree Days     
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)
rm(results,rst)

results.npn <- lapply(unique(minNPNGDD_2$scientificName), function(x){
  if(nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=minNPNGDD_2[minNPNGDD_2$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  }
  })


results.npn[[1]]
rst.npn <- do.call(rbind,results.npn)
head(rst.npn)


nrow(rst.npn) #19
rst[rst.npn$p.value<0.05,]
nrow(rst.npn[rst.npn$p.value<0.05,])

#lower GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #0
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) 
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) 

#bigger GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) #1
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) #7.896939
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) #0.1250017

rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,] #Deschampsia cespitosa

rst.npn$genus <- gsub(" .*$", "", rst.npn$Species)

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a.csv", sep=",")

```


### Startdayofyear ~ MaxGDD for that year 
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)
rm(results,rst)
minNPNGDD_2_max <- merge(totalGDDyr, minNPNGDD_2, by="Year")

results.npn <- lapply(unique(minNPNGDD_2_max$scientificName), function(x){
  if(nrow(minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,])>=10){
  foo1 <- summary(lm(startDayOfYear~MaxGDD,
                     data=minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  }
  })


results.npn[[1]]
rst.npn <- do.call(rbind,results.npn)
head(rst.npn)


nrow(rst.npn) #19
rst.npn[rst.npn$p.value<0.05,] #Achillea millefolium, Calamagrostis canadensis, Salix glauca
nrow(rst.npn[rst.npn$p.value<0.05,])

#earlier
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #3
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) # -0.0720336
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) #0.2299413

#later
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) 
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) 
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) 

rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]

rst.npn$genus <- gsub(" .*$", "", rst.npn$Species)

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a_MaxGDD.csv", sep=",")

```


Figure 4C too ????
```{r}
ggplot(minNPNGDD_2, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "black")+
  theme_bw()+
  ylab(expression(GDD))
```

```{r}
ggplot(minNPNGDD_2, aes(Year, HDD, group=Growth.Habit, colour=Growth.Habit))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5)+
  theme_bw()+
  ylab(expression(GDD))
```

#Snow   
Snow report generator <http://wcc.sc.egov.usda.gov/reportGenerator/>   
```{r}
snow <- read.table(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/Monthly19782016_over3200m.txt"),
                   skip=7, header=FALSE,sep=",", na.strings = " ")


header <- scan(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/Monthly19782016_over3200m.txt"),skip=5,nlines=1, what=character(),sep=",")
header2 <- scan(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/Monthly19782016_over3200m.txt"),skip=6,nlines=1,what=character(),sep=",")
names(snow)<-paste(header,header2,sep="_")

head(snow)
```

Average of snow over all stations per month over the years
```{r}
#average over all stations per year
avg.p.yr <- do.call(rbind,lapply(split(snow[,grep("_Snow Depth", names(snow))], 
                                       snow$`Water Year_`), 
                                 function(x) colMeans(x, na.rm = TRUE)))

# get rid of years with no data (every month says 0) - should remove 2016 and Oct and Nov from 1997
avg.p.yr.cc <- avg.p.yr[!is.nan(avg.p.yr[,4]),]
avg.p.yr.cc
# Not to be confused with snowmelt - this is just reformating the data
melt.snow <- melt(avg.p.yr.cc)
head(melt.snow)
melt.snow <- melt.snow[!is.nan(melt.snow$value),]
melt.snow$Var2 <- factor(melt.snow$Var2)
str(melt.snow)


ggplot(melt.snow, aes(as.numeric(Var2),value))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Var1)
```

Reformat snow data:
```{r}
snow.depth <- grep("_Snow Depth", names(snow))
avg.snow <- aggregate(snow[,c(snow.depth)], by=list(snow$`Water Year_`),
                      function(x) mean(x,na.rm=TRUE))
avg.snow <- avg.snow[!is.na(avg.snow[,5]),]

snow.long <- reshape(avg.snow, direction="long",
                     varying=list(names(avg.snow[,-1])),
                     timevar="Month",
                     times=names(avg.snow[,-1]),
                     idvar=c("Group.1"),
                     v.names="Snow.Depth")


snow.long <- snow.long[!is.nan(snow.long$Snow.Depth),]
snow.long$Month <- factor(snow.long$Month, levels = unique(snow.long$Month))
levels(snow.long$Month)
names(snow.long) <- c("Year","Month","Snow.Depth")
```

```{r}
ggplot(snow.long, aes(Year, Snow.Depth, colour=Month))+
  geom_line()+
  theme_bw()+
  facet_wrap(~Month)+
  geom_smooth(method="lm")
```

## LM of snow depth per month over 1997-2015    
```{r}
summary(aov(Snow.Depth~Year*Month, data=snow.long))

summary(lm(Snow.Depth~Year*Month, data=snow.long))

```

```{r}
yr.snow <- aggregate(snow.long$Snow.Depth, by = list(snow.long$Year),
          function(x) sum(x))
#missing data for 1997 and 2016, take those out
yr.snow <- yr.snow[yr.snow$Group.1 %in% c(1998:2015),]
```

#Correlation of snow depth to precip, high and low   
#Snow depth is averaged over sites and then summed for Oct-Sept water year   
Snow depth is only 1998-2015    
precip (unbloom) is only 1950 - 2011
Overlap is 14 years
```{r}
raw.precip.snow <- merge(unbloom, yr.snow, by.x = "Year", by.y = "Group.1")
colnames(raw.precip.snow) <- c("Year","Precip","HighTemp","LowTemp","SnowDepth")

cor(raw.precip.snow[,-1])
pairs(raw.precip.snow[,-1])
```

Growth traits for tables
```{r}
plantinfo <- read.table("P:/hackathon/alpine-phenology/datasets/USDAplantsdata.txt",
                        header=TRUE, sep = ",")
head(plantinfo)


gtyr <- merge(yr.1950_2, plantinfo, by.x = "Species", by.y = "Scientific.Name")

```

## Streamflow
```{r}
streamflow <- read.delim(path.expand("C:/Users/deprengm/Downloads/dv.csv"),
                       strip.white=TRUE,
                       blank.lines.skip=TRUE,
                       skipNul=TRUE,
                       sep=c(",","\t","/"),
                       comment.char = "#")
head(streamflow)
streamflow[2000:2030,]
streamflow[1000:1500,]
```




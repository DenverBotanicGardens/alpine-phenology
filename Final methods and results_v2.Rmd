---
title: "Final methods and results v2"
author: "Michelle DePrenger-Levin"
date: "January 10, 2017"
output: html_document
---
---
title: "Final Methods and Results"
author: "Michelle DePrenger-Levin"
date: "March 3, 2016"
output: html_document
---

load libraries   
```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
library(Taxonstand)
```

#Fresh start
Save the GDD variables - those take hours to calculate/extract
```{r, eval=FALSE}
rm(list= setdiff(ls(), c("avgTemps.max","avgTemps.min","tmps","HDD","HDD.all", "HDD.yrs")))
```

## load functions   
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    blnew$ID[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "Fam", "adj.r.squ","ID")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

# exact match multisub
multisub <- function(pattern,replacement,x){
  result <- x
  for(i in 1:length(pattern)){
    result <- gsub(paste("^",pattern[i],"$"), paste("^",replacement[i],"$"),result)
  }
  result
}

appd <- function(x){
  x <- merge(x,merge.name[!duplicated(merge.name$ID),c("ID","scientificName","AUTH",
                                                       "Growth.Habit","Duration")], 
                      by.x = "Species", by.y = "scientificName")
  lmodel <- paste("F(",x$numDF,",",x$denDF,") = ",round(x$`F Stat`,2),
                  ", Slope = ",round(x$Slope,2),
                  ", p-value = ", round(x$p.value,2),
                  ", r2 = ", round(x$adj.r.squ,2), 
                  sep = "")
  data.frame(Family = x$Fam,
             Species = x$AUTH,
             Sp = x$Species,
             GrowthHabit = x$Growth.Habit,
             Duration = x$Duration,
             CollectionDate = lmodel)
  }
```

From Q:\Reserach\Plant Lists\Data to subset
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/CO_SEINet_3200_20160304.csv"))
```

Manipulate dates and names to be consistant before rbind databases
```{r}
colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr")
colo.sm <- colo[colo$Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE)),]

colo.sm <- colo[,c(1,5,40,13,31,32,21,22,23,24)] #added 5 = Authority
names(colo.sm)

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm <- colo.sm[nchar(colo.sm$Year)==4,] #keep years with 4 digits 
colo.sm <- colo.sm[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year),] #keep ones that are 4 digits but all numeric
colo.sm <- colo.sm[colo.sm$Year>=1950,] #only years 1950 and beyond, before 2011
colo.sm <- colo.sm[colo.sm$Year<2012,] #only years 1950 and beyond, before 2012
barplot(table(colo.sm$Year))

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
max.meter <- 14500/3.2808
colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[colo.sm$elevation<max.meter,] #four are recorded wrong
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
wrongdates <- colo.sm$Date..dd.month.yyyy.[colo.sm$Date..dd.month.yyyy. %in% grep("-", colo.sm$Date..dd.month.yyyy., value=TRUE)]

colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))

colo.sm <- colo.sm[!is.na(colo.sm$startDayOfYear),]

barplot(table(colo.sm$startDayOfYear))
```

SEInet  
pull out names to match colo.sm and have data needed to subset   
 [1] "family"                   "scientificNameAuthorship" "scientificName"          
 [4] "stateProvince"            "decimalLatitude"          "decimalLongitude"        
 [7] "year"                     "minimumElevationInMeters" "startDayOfYear"          
[10] "reproductiveCondition"
```{r}
seinet <- seinet[seinet$scientificName!="",]
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert","fl","Fr")
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]

seinet.sm <- seinet[,c(12,14,13,56,63:64,31,73,34)]

# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]

# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]

# Remove any rows missing startDayOfYear
seinet.sm <- seinet.sm[!is.na(seinet.sm$startDayOfYear),]

barplot(table(seinet.sm$startDayOfYear))
```

```{r}
names <- names(colo.sm[,c(1:3,5:6,11:13)]) 
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:3,5:6,11:13)]
seinet.bind <- seinet.sm[,-4] #take out state
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)
```

####### BLOOM2 ##########
```{r}
bloom2 <- rbind(seinet.bind,colo.bind) 
barplot(table(bloom2$Year))
barplot(table(bloom2$startDayOfYear))

ggplot(bloom2, aes(as.factor(Year),startDayOfYear))+
  geom_boxplot(aes(fill=Year))

proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
```

#Find names on herbarium sheets that aren't in the USDA plants list  
Names from herbarium labels contain errors
Fix spelling errors   
<http://cumuseum-archive.colorado.edu/Research/Botany/Databases/vascular_plants.pdf>
```{r}
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

tochar <- c(1:3) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)
```

## 3. Remove any herbarium specimens with Genus only
remove genus only, 241 records of only genus
```{r}
bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), 
                         function(x) sum(x > 0))) != 1,]
```


## 4. found herbarium sheets where name was not in database. 
Check for synonyms - Add ID numbers for unique taxa (link synonyms)    
synonym_list_byhand2.txt? 
added a few synonyms at the end that weren't in there. SEINet and Weber and Hartman to find what ID those names (from Herbarium specimens) should be assigned to. 
```{r,eval=TRUE}
synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt")) # from DBG database taken from USDA (got from Rick)

#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.", synonyms$SYNONYMS)
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# names before the merge from our dataset
namebloom2 <- unique(bloom2$scientificName)
length(namebloom2) #2162 -> 2219

# deal with the auct non (wrong use of name) from synonym list
nrow(bloom2[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE),]) #87
nrow(synonyms[synonyms$AUTH %in% grep("auct. non", synonyms$AUTH, value=TRUE),]) #827
```

### 4f. Remove auct. non records from the synonyms list. 
```{r}
# remove all auct. non
synonyms <- synonyms[synonyms$AUTH %in% grep("auct.", synonyms$AUTH, value = TRUE, invert = TRUE),]
synonyms <- synonyms[synonyms$AUTH %in% grep(" non ", synonyms$AUTH, value = TRUE, invert = TRUE),]
# Agroelymus adamsii is in there twice with all the same information
synonyms <- unique(synonyms) # gets rid of 13 rows

# Check for more than one ID for a species name 
bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")

foo <- table(synonyms$SYNONYMS)
foo[foo > 1]

# Acarospora squamulosa twice, one with "sensu Th. Fr." two differnt IDs - lichen, remove all
# Aletris japonica, "nom. obsc." with two same ID
#Alisma lanceolatum either A. Gray or different ID with "With." <- git rid of "With."
synonyms[synonyms$SYNONYMS == names(foo[foo>1][1]),]
synonyms[synonyms$SYNONYMS == names(foo[foo>1][11]),]
bloom2[bloom2$scientificName == names(foo[foo>1][2]),] #not in there, don't worry about it
namesinbloom2 <- unique(bloom2$scientificName[bloom2$scientificName %in% names(foo[foo>1])])

# find to get rid of thse but doesn't appear in herbarium records
synonyms <- synonyms[synonyms$SYNONYMS != "Acarospora squamulosa",] #lichen
synonyms <- synonyms[synonyms$AUTH != "Alisma lanceolatum With.",] #UDSA plants has this one only in CA

# These two do!
synonyms <- synonyms[synonyms$AUTH != "Aster foliaceus Lindl. ex DC., database artifact",]
takeoutAste <- which(synonyms$AUTH == "" & synonyms$SYNONYMS == "Astragalus tenellus")
synonyms <- synonyms[-takeoutAste,]

rm(bloom.sp)
bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")

```

## 4 ID links synonyms
### 4d. to not lose ones from bloom2 that have no match in synonyms, add all.x = TRUE (left outer join), see which aren't in the original and assign those names the appropriate ID to link synonyms
```{r}
#which names are in bloom2 before merge (namebloom2) vs. after merge (bloom.sp$scientificName)
length(unique(bloom2$scientificName[!(bloom2$scientificName %in% bloom.sp$scientificName)])) #290

badnames.o <- setdiff(namebloom2,bloom.sp$scientificName)
length(badnames.o) #293 -> 502 (after linking plantsyn to synonyms (our version of USDA)) #290

write.table(badnames.o,"clipboard", sep="\t", row.names=FALSE)

```

####Use these 'badnames.o' which are names in bloom2 not found in the USDA synonym list to correct errors some are crosses, some misspellings. 
###### fixbloom2 csv has $Wrong: list of bloom2 names with no UDSA match 
######                   $Replacement: corrected or NA if it should just be removed/ignored     
```{r}
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

```

#  #2 - after finding names that are on herbarium sheets but not in the USDA list (for a unique ID per name with synonyms and nativity, habit....) then use nomenclature from Jennifer Ackerfield's Flora (2015) and link. 
9/30/2016 add Melissa's corrections (synonyms2) to bloom2 and synonyms (and plantsyn) before linking by  names
# Bloom2 final
```{r}
rm(bloom2)
bloom2 <- rbind(seinet.bind,colo.bind) 
proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)

bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

```


Replace names with accepted by Ackerfield
```{r}
synonyms2 <- read.csv("Q:/Research/Projects/alpine-phenology/synonyms2_MI.csv")

bloom2$scientificName <- multisub(synonyms2$Species,
                                    synonyms2$SYNONYMS,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]

fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

bloom2$scientificName <- multisub(fixbloom2$Wrong.1,
                                    fixbloom2$Replacement,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]

# This was SpellingErrorCorrections_v3plus where I must have added to Melissa's version after losing some species. I think the loss is from linking to traits, will add that in after pick species iwth 10 years or more data

#bloom2$scientificName <- multisub(fixbloom3$Wrong,
#                                    fixbloom3$Replacement,bloom2$scientificName)
#bloom2 <- bloom2[!is.na(bloom2$scientificName),]
```

#4e
#Bloom2 post Ackerfield nomenclature   
need to add the linking ID numbers contained in synonyms
```{r}
bloom.aftercorrections <- bloom2

## One set of collection in SEINet entered as 02/07/1996 should be July 2, not Feb 7th.
bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1996] <- 184

#entered wrong in SEINet
bloom2$startDayOfYear[bloom2$scientificName == "Androsace septentrionalis" & 
                        bloom2$Year == 1999 &
                        bloom2$startDayOfYear < 100] <- 203

bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 1996] <- 184



#synonyms is the current USDA plant list that we have at DBG
bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")
```


After combining datasets, find species with at least 10 years of data
```{r}
bloom2 <- bloom.sp


write.table(unique(bloom2[,c("ID","Family.Name","scientificName")]),
            file="P:/hackathon/alpine-phenology/datasets/bloom2_170116.csv", sep=",")

#Collection days each year, over the years for all herbarium records
ggplot(bloom2, aes(Year, startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()

summary(lm(startDayOfYear~Year,data=bloom2)) 

#Peak collection period throughout the study
ggplot(bloom2, aes(as.factor(Year), startDayOfYear))+
  geom_boxplot()+
  theme_bw()+
  ylab("Flowering day")+
  xlab("")

mean(bloom2$startDayOfYear, na.rm = TRUE)

#how many species in dataset
length(unique(bloom2$scientificName)) #1820 -> 1588, 1703, 1918
length(unique(bloom2$ID)) #1516 -> 1319, 1371, 1570
```


# how many years collected per species
```{r}

temp.split <- split(bloom2, bloom2$ID)
temp.split$`43359`
id <- temp.split$`43359`[order(temp.split$`43359`$Year),]
id

earl.sp.yr <- do.call(rbind,
                      lapply(split(bloom2, bloom2$ID), function(id){
                        id <- id[order(id$Year),]
                        id$DataYrs <- nrow(id[!duplicated(id$Year) & !is.na(id$Year),])
                        rows <- aggregate(startDayOfYear~Year, id, FUN=min)
                        out <- merge(id, rows, by=c("startDayOfYear","Year"))
                        out <- out[order(out$Year),]
                        out <- out[!duplicated(out$Year),]
                        out
                        })
)

earl.sp.yr[earl.sp.yr$startDayOfYear < 100,]

#How many species were collected each year? For all specimens
byyr <- split(earl.sp.yr, earl.sp.yr$Year, drop=TRUE)

species.per.year <- do.call(rbind,
                            lapply(byyr, function(x){
                              data.frame(SpeciesTotal = length(unique(x$ID)), Year = unique(x$Year))
                            }))

species.per.year[which.max(species.per.year$SpeciesTotal),] #357, 398 -> 593 species total for all specimens 610 in 1998

ggplot(species.per.year, aes( Year,SpeciesTotal))+
  geom_point()+
  stat_smooth(method = "lm")


#How many years have each species been collected?
bysp <- split(earl.sp.yr, earl.sp.yr$ID, drop=TRUE)

spyears <- do.call(rbind,
                   lapply(bysp, function(x){
                     data.frame(DataYrs = length(unique(x$Year)),ID = unique(x$ID))
                     })
                   )

# Still all species, not just ones with 10+ years
spyears[which.max(spyears$DataYrs),] # 51
spyears[which.min(spyears$DataYrs),] # 1
nrow(spyears[spyears$DataYrs>=10,]) #414 -> 402 -> 300, 346 -> 468 -> 480
mean(spyears$DataYrs[spyears$DataYrs>=10]) #23.77708

# Now 10 plus years
sp.10plus <- earl.sp.yr[earl.sp.yr$DataYrs>=10,]
length(unique(sp.10plus$ID)) #414 -> 402 -> 300, 480
```

#Results: 3rd para
```{r}
# earliest collections for species with 10+ yrs data
summary(lm(startDayOfYear~Year, data=sp.10plus))

ggplot(sp.10plus, aes(Year, startDayOfYear))+
  geom_point()+
  theme_bw()+
  stat_smooth(method="lm")

# Seems legit??
sp.10plus[sp.10plus$startDayOfYear < 100,]
```



### START HERE###
Instead of merging first, do this stuffs now...
```{r}
merge.name <- sp.10plus

```

#Figure 2 Year x Bloom date
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4.tiff", width = 174, height = 150, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 

dev.off()

summary(lm(startDayOfYear~Year, data=merge.name))

```



Of the first bloom data of species that matched sampling critera, the hightest diversity of species collections were made in the 1990s and early 2000s with a peak of 449 species collected in 1998. Average over the study period was 211 alpine/subalpine species collected per year. 
```{r}

#merge.name has only one collection per species ID per year?
foo <- data.frame(table(merge.name$Year,merge.name$ID))
head(foo[foo$Freq>1,])

earliestcollection <- data.frame(colSums(table(merge.name$ID, #should be only one name now
                                                merge.name$Year)))
sort(unique(merge.name$DataYrs))

earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),]
mean(earcol$Collections) #168.4098 -> 190.7869

```
     Year Collections
1998 1998         406


#Figure 1A
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of Study Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()
```

Average number of collections over the study period was 187 species collected per year
```{r}
mean(earcol$Collections) # 187.0984
```
 
```{r}
allcollections <- data.frame(colSums(table(bloom2$ID,bloom2$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])
```

#Figure 1B  
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()
```


The day each year with the most collections has on average been Julian day 206 and the day with the most collections has not moved significantly over time from 1950 to 2011. The earliest peak collection day was Julian day 175 (June 30th) in 2007 and the latest peak collection day was Julian day 238 in 1957 (August 29th)   
```{r}
collJ.sp <- data.frame(table(bloom2$Year,bloom2$startDayOfYear))

str(collJ.sp)

collJ.sp[,1:2] <- sapply(collJ.sp[,1:2], function(x){
  as.numeric.factor(x)
})

coll.per.julianday <- aggregate(collJ.sp$Freq, list(collJ.sp$Var2), sum)
coll.per.julianday[which.max(coll.per.julianday$x),]

# split the number of collections per Julian day by year, find which day had the most each year
collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
collmax <- do.call(rbind,collJ.max)
collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))

mean(collmax$Var2)
collmax[which.min(collmax$Var2),] # smallest Julian day with most collections
collmax[which.max(collmax$Var2),] # biggest julian day with most collections
summary(lm(Var2~Var1, data=collmax))

```

# Bloom
```{r}
library(RCurl)
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/QR_final_R_plant_climate_data_2.csv"))

```

Average high, low, and precip per year  
Take annual climate data from previous dataset
```{r}
head(bloom)
head(bloom[,c(19,20,21,23)])

# units for precip are: ppt (mm*100) (even though it just says mm on the main website you look at when reading about the variables). So, we need to divide our values by 100 for our figures. 
bloom$Raw_Precip <- (bloom$Raw_Precip)/100

# merge.name$Raw_Precip <- (merge.name$Raw_Precip)/100

# If already have precip and hi lo, don't merge again, don't want .x and .y!
head(merge.name)
merge.name <- merge(merge.name,unique(bloom[,c(19,20,21,23)]), by="Year")

write.table(merge.name, file="P:/hackathon/alpine-phenology/datasets/merge.name.csv", sep=",")

unbloom <- unique(bloom[,c(19,20,21,23)])
```

Correlations of climate
```{r}
cor(unbloom[,-1])
cor.test(unbloom[,2],unbloom[,3])
cor.test(unbloom[,2],unbloom[,4])
cor.test(unbloom[,3],unbloom[,4])

```



#Figure 3A  
Using just the average temp per year, not repeated for everytime we have specimen data in a year
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Avg_Hi))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression("Average high"~degree*C)) + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8))

dev.off()

summary(lm(Avg_Hi~Year, data=unbloom))
```


#Figure 3B
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)


ggplot(unbloom, aes(Year,Avg_Lo))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab(expression("Average low"~degree*C))+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Avg_Lo~Year, data = unbloom))

```



#Figure 3C   
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Raw_Precip))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Raw_Precip~Year, data = unbloom))

```



#Figure 4A  
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Avg_Hi, startDayOfYear))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=7))


dev.off()

summary(lm(startDayOfYear~Avg_Hi, data=merge.name))

```




#Figure 4B
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1, size= 0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Avg_Lo, data = merge.name))
```


#Figure 4C
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1,size=0.25)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Raw_Precip, data = merge.name))

```



Growing Degree Days   
```{r, eval=FALSE}
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
# mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

# Takes an hour to run
avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)
# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

```


Calculate Growing Degree Days
```{r}
tbase <- 0

#method 1 from McMaster and Wilhelm 1997
HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})

HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all

write.table(tmps, file="P:/hackathon/alpine-phenology/datasets/tmps.csv", sep=",")
```

# Now merge GDD with merge.name
```{r}
nrow(merge.name[merge.name$Year > 1980,]) #6499 -> 7436

#min.dates <- merge(min.dates, tmps, 
#                   by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))

min1950GDD_2 <- mergeMinGDD(merge.name,tmps)

length(unique(min1950GDD_2$day)) #1110
length(unique(min1950GDD_2$scientificName)) #516

#Years of data for GDD years per species
gdddatayrs <- as.data.frame(table(min1950GDD_2$Year,min1950GDD_2$ID))
yrspsp <- aggregate(gdddatayrs[,3], by = list(gdddatayrs$Var2), FUN=sum)
nrow(yrspsp[yrspsp$x>=10,]) #308 -> 375

### Reduce min1950GDD_2 to only species where 10 or more years of data
min1950GDD_2_10 <- merge(min1950GDD_2,yrspsp[yrspsp$x>=10,],
                         by.x="ID",by.y="Group.1")
length(unique(min1950GDD_2_10$ID)) #375
```

```{r}
avg.HDD.yrs <- lapply(HDD.yrs, function(x){
  mean(x)
})

avg.yrs <- do.call(c, avg.HDD.yrs)
hddyrs <- data.frame(Year=1981:2011, avgHDD = avg.yrs)
```

correlations with GDD and climate factors
```{r}
unbloomGDD <- merge(unbloom,hddyrs,by="Year")
cor(unbloomGDD[,-1])
cor.test(unbloomGDD$avgHDD,unbloomGDD$Raw_Precip)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Hi)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Lo)

```

#Figure 5A   
Average GDD for the ealiest collection date did! change significantly over the study years, just the r^2 is next to nothing
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDD_2_10, aes(Year,HDD))+
  geom_point(size=0.25, shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=6))

dev.off()


summary(lm(HDD~Year, data=min1950GDD_2_10))
```


Growing Degree Days over time
```{r}

ggplot(unbloomGDD, aes(Year,avgHDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("average annual GDD")

summary(lm(avgHDD~Year, data=unbloomGDD))
```

```{r}
totalGDD <- lapply(HDD.yrs, function(x){
  max(x)
})
totalGDDyr <- data.frame(Year=1981:2011,MaxGDD = do.call(rbind,totalGDD))
head(totalGDDyr)
```

#5b -> 3d to go with the others
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point(size=0.5,shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab(expression(paste("GDD at ordinal date 273 (T"[base] == 0, degree*C,")")))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(MaxGDD~Year,data=totalGDDyr))

```


#Fig.
```{r}
col.hdd.yrs <- lapply(HDD.yrs, function(x) x[1:273])
col.hdd.yrs <- do.call(cbind,col.hdd.yrs)
meltd<-melt(col.hdd.yrs)
names(meltd) <- c("Day","Year","GDD")

#meltd is from Results figures and tables.Rmd
fit1 <- lapply(unique(meltd$Year), function(x){
  stepAIC(lm(GDD~Day+I(Day^2), data=meltd[meltd$Year==x,]),
          scope = lm(GDD~1, data=meltd[meltd$Year==x,]),
          direction = "backward")
})

poly.p <- lapply(fit1, function(fx){
  polynomial(coef(fx))
})
sday <- 1
eday <- 273

secant.poly <- lapply(poly.p,function(x){
  ((as.function(x)(eday)+1000) - (as.function(x)(sday)+1000))/(eday-sday)
})
secant.poly.all <- data.frame(Year=1981:2011, 
                              Secant= do.call(rbind,secant.poly))

ggplot(secant.poly.all, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Average rate of change in GDD (day 1 to 273)")

summary(lm(Secant~Year, data=secant.poly.all))

```

#Secant instead of max 
```{r}
min1950GDDsecant2 <- merge(min1950GDD_2_10, secant.poly.all,by="Year")
head(min1950GDDsecant2)

ggplot(min1950GDDsecant2, aes(Secant,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by average rate of GDD accumulation") +
  xlab("Average rate of GDD accumulation")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Secant, data=min1950GDDsecant2))

```

```{r}
ggplot(min1950GDDsecant2, aes(Secant,startDayOfYear, colour=Growth.Habit.sm))+
  geom_point()+
  stat_smooth(method="lm", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by average rate of GDD accumulation") +
  xlab("Average rate of GDD accumulation")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Secant+Growth.Habit.sm, data=min1950GDDsecant2))

```


#############################################################################################
#############################################################################################
# Select the accepted name (according to USDA)
```{r}
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",") # missing those extra ones but including life habit... and indicating which are accepted (to later be double checked according to akerfield.) 
# Merge is an exact match, that's what we want
synonyms.plantsyn <- merge(synonyms,plantsyn,by.x="SYNONYMS",by.y="Scientific.Name")
synonyms.plantsyn <- synonyms.plantsyn[!duplicated(synonyms.plantsyn$SYNONYMS),]

#First change names according to Ackerfield
allIDs <- unique(synonyms.plantsyn$ID) # all the unique IDs within both USDA plant list and 
length(unique(synonyms.plantsyn$ID)) #5497 -> 5547
synonyms.plantsyn.accpt <- synonyms.plantsyn[synonyms.plantsyn$Synonym.Symbol=="",]
accptIds <- unique(synonyms.plantsyn.accpt$ID)
length(unique(synonyms.plantsyn.accpt$ID)) #5444; why do we lose some?

missingIDs <- setdiff(allIDs,accptIds)

missingnames <- unique(sp.10plus$scientificName[sp.10plus$ID %in% grep(paste(missingIDs, collapse="|"),
                                 sp.10plus$ID, value=TRUE)])

```


Need to add these in as accpted names
```{r}
accpt <- data.frame(matrix(vector(), 1, 33,
                           dimnames=list(c(), names(synonyms.plantsyn.accpt))),
                    stringsAsFactors=F)

accpt <- rbind(accpt,c("Besseya alpina",5603,rep(NA, 24),"Plantaginaceae","Perennial",
           "Forb/herb","L48 (N)","Late Summer",rep(NA,2)))

accpt <- rbind(accpt,c("Carex phaeocephala",8560,rep(NA, 24),"Cyperaceae","Perennial",
           "Graminoid","L48 (N)","Fall",rep(NA,2)))

accpt <- rbind(accpt,c("Poa secunda",35604,rep(NA, 24),"Poaceae","Perennial",
           "Graminoid","L48 (N)","Summer",rep(NA,2)))
accpt <- accpt[-1,]
```

## LATER
#just need the ID and accpt name once...
```{r}
fin.accpt <- rbind(synonyms.plantsyn.accpt,accpt)

cols2keep <- setdiff(names(sp.10plus),names(fin.accpt))
head(sp.10plus[,cols2keep])

merge.name <- merge(fin.accpt, sp.10plus[,c(cols2keep,"ID")], by="ID") #will keep SYNONYMS

length(unique(merge.name$ID)) #402 -> 300, 468


merge.name[merge.name$startDayOfYear < 100,] #could remove?

unique(merge.name$Family)

```


#############################################################################################
#############################################################################################


############################################################################################
############################################################################################
### MOVE LATER
# How many forbs vs. grasses vs. tree? How many 
#Smaller groups for Growth.Habit
```{r}
merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Graminoid",merge.name$Growth.Habit, value=TRUE)] <- "Graminoid"

merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Forb",merge.name$Growth.Habit, value=TRUE)] <- "Forb"

merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Forb", 
                                  grep("shrub", merge.name$Growth.Habit, 
                                       value=TRUE, ignore.case=TRUE), 
                                  value=TRUE, invert=TRUE)] <- "Shrubs"

merge.name$Growth.Habit.sm[merge.name$Growth.Habit %in% 
                             grep("Shrub", 
                                  grep("Tree", merge.name$Growth.Habit, 
                                       value=TRUE, ignore.case=TRUE), 
                                  value=TRUE, invert=TRUE, ignore.case=TRUE)] <- "Trees"

```

```{r}
GH <- data.frame(table(merge.name$Growth.Habit[!duplicated(merge.name$ID)]))
GH[GH$Freq>0,]
sum(GH$Freq)#488 -> 487

# Number of Families represented!
length(table(merge.name$Family[!duplicated(merge.name$ID)]))

# Growth Habit numbers
table(merge.name$Growth.Habit[!duplicated(merge.name$ID)])

sum(  GH$Freq[GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE)]) #348 Forb/herbs

sum(  GH$Freq[GH$Var1 %in% grep("Forb", grep("shrub", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #33 shrubs/subshrubs

sum(  GH$Freq[GH$Var1 %in% grep("Shrub", grep("Tree", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE, ignore.case=TRUE)]) #11->5 trees


GD <- data.frame(table(merge.name$Duration[!duplicated(merge.name$ID)]))
GD[GH$Freq>0,]
sum(GD$Freq)#487 -> 300

# Duration
table(merge.name$Duration[!duplicated(merge.name$ID)])

sum(GD$Freq[GD$Var1 %in% grep("Biennial", grep("Annual", GD$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #7

NAT <- data.frame(table(merge.name$Native.Status[!duplicated(merge.name$ID)]))
NAT[NAT$Freq>0,]
sum(NAT$Freq)#487 -> 300

# Native status
sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE), "Freq"]) #300
sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE, invert = TRUE), "Freq"]) #0

#which are missing a native status?
length(unique(merge.name$scientificName[grep("L48", merge.name$Native.Status)])) #427
length(unique(merge.name$ID[grep("L48", merge.name$Native.Status)])) #477 native 
length(unique(merge.name$ID[grep("L48", merge.name$Native.Status,
                                             invert=TRUE)])) #0 non-native
length(unique(merge.name$scientificName[grep("L48", merge.name$Native.Status,
                                             invert=TRUE)])) #0 non-native

```


############################################################################################
############################################################################################




# By growth type
```{r}
ggplot(merge.name, aes(Avg_Hi, startDayOfYear, colour = Growth.Habit.sm))+
  geom_point(shape=1)+
  stat_smooth(method="lm",size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Average high"~degree*C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Hi, data=merge.name))

```

# By family
```{r}
ggplot(merge.name, aes(Avg_Hi, startDayOfYear, colour = Family))+
  geom_point(shape=1)+
  stat_smooth(method="lm",size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Average high"~degree*C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Hi, data=merge.name))

```


```{r}
ggplot(merge.name, aes(Avg_Lo, startDayOfYear, colour = Family))+
  geom_point(shape=1)+
  stat_smooth(method="lm", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression(~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

summary(lm(startDayOfYear~Avg_Lo+Growth.Habit.sm, data = merge.name))
```

```{r}
ggplot(merge.name, aes(Raw_Precip, startDayOfYear, colour = Family))+
  geom_point()+
  stat_smooth(method="lm", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

summary(lm(startDayOfYear~Raw_Precip+Family, data = merge.name))

```


```{r}
ggplot(min1950GDD_2_10, aes(Year,HDD, colour=Family))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))+
  theme(legend.position="none")

summary(lm(HDD~Year+Family, data=min1950GDD_2_10))
```



NPN species   
(from Climate)    
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

#although lots of these might not have 10 years    
#Match names - synonyms and all
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big) #68

npn.all$SciName <- multisub(synonyms2$Species,
                                    synonyms2$SYNONYMS,npn.all$SciName)
npn.all <- npn.all[!is.na(npn.all$SciName),]

npn.all$SciName <- multisub(fixbloom3$Wrong,
                                    fixbloom3$Replacement,npn.all$SciName)
npn.all <- npn.all[!is.na(npn.all$SciName),]

npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big) #68

npn.min1950 <- merge(npn.all, merge.name, by.x = "SciName", by.y = "SYNONYMS")
length(unique(npn.min1950$ID)) #27
```


############START HERE. get summary tables, then link to accepted name without losing species
Phenology summary tables    
```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",merge.name)

nrow(yr.1950_2) #480

write.table(yr.1950_2, file = "Q:/Research/Projects/alpine-phenology/phensum_yr.csv", sep=",")

nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #410
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #58

nrow(yr.1950_2[yr.1950_2$p.value<0.05,])/nrow(yr.1950_2) #0.119403

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #57
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #--0.5440048
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #0.2231147

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,]) #4->1
unique(bloom2$AUTH[bloom2$scientificName %in% grep(paste(
  yr.1950_2$Species[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]
  ,
                                        collapse="|"), yr.1950_2$Species, value=TRUE)])

merge.name[merge.name$scientificName == "Achillea lanulosa",
           c("Year","ID","scientificName","startDayOfYear")]

mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #0.8793068
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #0.2976751

```

#Year later
```{r}
ggplot(merge.name[merge.name$ID %in% 
                    grep(paste(yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                              yr.1950_2$Slope>=0],
                                          collapse="|"),yr.1950_2$ID,
                         value=TRUE),], 
       aes(Year, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

#Year earlier
```{r}
ggplot(merge.name[merge.name$ID %in%
                    grep(paste(yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                              yr.1950_2$Slope<0],
                               collapse="|"),yr.1950_2$ID,
                         value=TRUE),], 
       aes(Year, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

###High Temperature     
```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", merge.name)

nrow(high.1950_2) #404
write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,]) #69
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.1707921

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,])  #67
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) # -10.60067
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) #0.2187695

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) # 2
unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(high.1950_2$Species[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0],
                                collapse="|"), high.1950_2$Species, value=TRUE)])

merge.name[merge.name$scientificName == "Askellia nana",c("startDayOfYear","Year")] ##NOOO, doubles!

mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #8.893071
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #0.3145635

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.1707921
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2) #0.8292079

```


```{r}
ggplot(merge.name[merge.name$scientificName %in% 
                    grep(paste("^", paste(high.1950_2$Species[high.1950_2$p.value<0.05 &
                                                                high.1950_2$Slope<0], 
                               collapse="|"), "$", sep=""),high.1950_2$Species,
                         value=TRUE),], 
       aes(Avg_Hi, startDayOfYear, colour = scientificName))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
ggplot(merge.name[merge.name$scientificName %in% 
                    grep(paste("^", paste(high.1950_2$Species[high.1950_2$p.value<0.05 &
                                                                high.1950_2$Slope>=0], 
                               collapse="|"), "$", sep=""),high.1950_2$Species,
                         value=TRUE),], 
       aes(Avg_Hi, startDayOfYear, colour = scientificName))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", merge.name)

nrow(low.1950_2) #404

write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2.Table3.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #70
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2) #0.1732673
mean(low.1950_2$Slope)

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #74
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #-9.550934
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #0.1691973

#later
# Still have double entries
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #2
unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(
      low.1950_2$Species[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]
      ,
                                collapse="|"), low.1950_2$Species, value=TRUE)])
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #8.362067
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #0.2722874
```

```{r}
ggplot(merge.name[merge.name$scientificName == "Castilleja rhexiifolia",], 
       aes(Avg_Lo, startDayOfYear, colour = scientificName))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
ggplot(merge.name[merge.name$scientificName %in% 
                    grep(paste("^", paste(low.1950_2$Species[low.1950_2$p.value<0.05 &
                                                                low.1950_2$Slope<0], 
                               collapse="|"), "$", sep=""),low.1950_2$Species,
                         value=TRUE),], 
       aes(Avg_Lo, startDayOfYear, colour = scientificName))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```




### Precipitation
```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", merge.name)
precip.1950_2[,c("Species")]<-sapply(precip.1950_2[,c("Species")], function(ch) as.character(ch))
write.table(precip.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2.Table4.csv", sep=",")

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #35
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2) # 0.08663366

mean(precip.1950_2$Slope)


#earlier
### ISSUE with exact match!
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #2
unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(
          precip.1950_2$Species[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]
          ,
                                collapse="|"), precip.1950_2$Species, value=TRUE)])
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) # -0.06062124
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) #0.2277311

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #33
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.08322917
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.2431201
```

```{r}
ggplot(merge.name[merge.name$scientificName %in% 
                    grep(paste("^", paste(precip.1950_2$Species[precip.1950_2$p.value<0.05 &
                                                       precip.1950_2$Slope>0], 
                               collapse="|"), "$", sep=""),precip.1950_2$Species,
                         value=TRUE),], 
       aes(Raw_Precip, startDayOfYear, colour = scientificName))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
ggplot(merge.name[merge.name$scientificName %in% 
                    grep(paste("^", paste(precip.1950_2$Species[precip.1950_2$p.value<0.05 &
                                                       precip.1950_2$Slope<0], 
                               collapse="|"), "$", sep=""),precip.1950_2$Species,
                         value=TRUE),], 
       aes(Raw_Precip, startDayOfYear, colour = scientificName))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

Growing Degree Days at time of earliest collection
```{r}
ggplot(min1950GDD_2_10, aes(Year, HDD, group=scientificName))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD))
```

# NPN only precip, high, low
###NPN year     
```{r}
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

nrow(yr.npn_2) #27 
mean(yr.npn_2$Slope)

write.table(yr.npn_2, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr.csv", sep=",")
nrow(yr.npn_2[yr.npn_2$p.value<0.05,]) #3
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2) #0.1153846

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) #3
unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(
                       yr.npn_2$Species[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]
                       ,
                                collapse="|"), yr.npn_2$Species, value=TRUE)])
mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #-0.6255507
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #0.2055609

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #0
```

```{r}

ggplot(npn.min1950, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 


summary(lm(startDayOfYear~Year, data=npn.min1950))
```

#Year later
```{r}
ggplot(npn.min1950[npn.min1950$ID %in% 
                    grep(paste(yr.npn_2$ID[yr.npn_2$p.value<0.05 &
                                              yr.npn_2$Slope>=0],
                                          collapse="|"),yr.npn_2$ID,
                         value=TRUE),], 
       aes(Year, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

#NPN Year earlier
```{r}
ggplot(npn.min1950[npn.min1950$ID %in%
                    grep(paste(yr.npn_2$ID[yr.npn_2$p.value<0.05 &
                                              yr.npn_2$Slope<0],
                               collapse="|"),yr.npn_2$ID,
                         value=TRUE),], 
       aes(Year, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

###NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

nrow(high.npn_2) #27

write.table(high.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,]) #4

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) #4

unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(high.npn_2$Species[high.npn_2$p.value<0.05 & high.npn_2$Slope<0],
                                collapse="|"), high.npn_2$Species, value=TRUE)])

mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #-9.59834
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #0.1678493

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) #0
```
###NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

nrow(low.npn_2) #26
mean(low.npn_2$Slope)

write.table(low.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_2.csv", sep=",")

nrow(low.npn_2[low.npn_2$p.value<0.05,]) #6
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2) #0.2307692

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) # 6

low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]

mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #-12.8648
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #0.2435738

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,]) #0
```


```{r}
ggplot(npn.min1950, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab(expression("Average low"~degree*C))

summary(lm(startDayOfYear~Avg_Lo, data = npn.min1950))
```

#NPN low earlier
```{r}
ggplot(npn.min1950[npn.min1950$ID %in%
                    grep(paste(low.npn_2$ID[low.npn_2$p.value<0.05 & low.npn_2$Slope<0],
                               collapse="|"),low.npn_2$ID,
                         value=TRUE),], 
       aes(Year, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average low"~degree*C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```


###NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

nrow(precip.NPN_2) #27

write.table(precip.NPN_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_precip_2.csv", sep=",")

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #2
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2) #0.07407407

#earlier
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0,]) #1
unique(bloom2$AUTH[bloom2$scientificName == precip.NPN_2$Species[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]])
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #-0.05782597
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #0.1592876

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) #1
unique(bloom2$AUTH[bloom2$scientificName == precip.NPN_2$Species[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]])
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.09425329
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.4683842
```

```{r}


ggplot(npn.min1950, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Raw_Precip, data = npn.min1950))
```


#precip later
```{r}
ggplot(npn.min1950[npn.min1950$ID %in% 
                    grep(paste(precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                              precip.NPN_2$Slope>=0],
                                          collapse="|"),precip.NPN_2$ID,
                         value=TRUE),], 
       aes(Raw_Precip, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

#NPN precip earlier
```{r}
ggplot(npn.min1950[npn.min1950$ID %in%
                    grep(paste(yr.npn_2$ID[yr.npn_2$p.value<0.05 &
                                              yr.npn_2$Slope<0],
                               collapse="|"),yr.npn_2$ID,
                         value=TRUE),], 
       aes(Year, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```






Growing Degree Days - GDD at time of collection  ~ Year
```{r}
#reset between time of collection and next, max per year
rm(results,rst)
results <- lapply(unique(min1950GDD_2_10$ID), function(x){
  if(nrow(min1950GDD_2_10[min1950GDD_2_10$ID==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=min1950GDD_2_10[min1950GDD_2_10$ID==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          ID = x,
                          unique(min1950GDD_2_10$scientificName[min1950GDD_2_10$ID == x])[1],
                          unique(min1950GDD_2_10$Family[min1950GDD_2_10$ID == x])[1],
                          foo1$adj.r.squared,
                          N = nrow(min1950GDD_2_10[min1950GDD_2_10$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF",
                   "ID", "Species","Family.Name","adj.r.squ","N")
  JYC
  }
  })


rst <- do.call(rbind,results)
head(rst)


nrow(rst) #304
nrow(rst[rst$p.value<0.05,]) #30

#smaller HDD at time of collection
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #5
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -11.77443
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.249709

#bigger HDD at time of collection
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,])  #25
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) #11.07281
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0])  #0.273644

write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_table5a.csv", sep=",")
```

# Informative part, like average precip, temp per year, does the earliest collection date change as the MaxGDD (up through ordinal day 273) changes per year?
#GDD high per year
```{r}

#Reset for time of collection and now max
rm(results,rst,min1950GDDmax)
min1950GDDmax <- merge(totalGDDyr,min1950GDD_2_10, by="Year")
results <- lapply(unique(min1950GDDmax$ID), function(x){
  if(nrow(min1950GDDmax[min1950GDDmax$ID==x,])>=10){
  foo1 <- summary(lm(startDayOfYear~MaxGDD,data=min1950GDDmax[min1950GDDmax$ID==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          ID = x,
                          unique(min1950GDDmax$scientificName[min1950GDDmax$ID == x])[1],
                          unique(min1950GDDmax$Family[min1950GDDmax$ID == x])[1],
                          foo1$adj.r.squared,
                          N = nrow(min1950GDDmax[min1950GDDmax$ID==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF",
                   "ID", "Species","Family.Name","adj.r.squ","N")
  JYC
  }
  })

rst <- do.call(rbind,results)
mean(rst$Slope)

nrow(rst) #304
nrow(rst[rst$p.value<0.05,]) #54

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #54
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -0.06105381
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.2509337

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) 
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) # 0.06457972
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) #0.2357394


write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_max.Table5.csv", sep=",")
```

#Overall MaxGDD
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDDmax, aes( MaxGDD, startDayOfYear))+
  geom_point(shape=1, size=0.5)+
  geom_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab("Maximum annual GDD (by ordinal day 273)")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~MaxGDD, data = min1950GDDmax))

```

#SYNONYMS is accepted name, need to worry about accepted family too

```{r}
ggplot(min1950GDDmax[min1950GDDmax$ID %in% 
                    grep(paste(rst$ID[rst$p.value<0.05 & rst$Slope<0], 
                               collapse="|"),rst$ID,
                         value=TRUE),], 
       aes(MaxGDD, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Maximum annual GDD (by ordinal day 273)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
ggplot(min1950GDDmax[min1950GDDmax$ID == "40268",], 
       aes(MaxGDD, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Maximum annual GDD (by ordinal day 273)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```




###NPN Growing Degree Days     
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)
rm(results,rst)

results.npn <- lapply(unique(minNPNGDD_2$scientificName), function(x){
  if(nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=minNPNGDD_2[minNPNGDD_2$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(minNPNGDD_2[minNPNGDD_2$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  }
  })

rst.npn <- do.call(rbind,results.npn)

nrow(rst.npn) #24
nrow(rst.npn[rst.npn$p.value<0.05,]) #2

#lower GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #0

#bigger GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) #2
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) #14.25831
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope >= 0]) #0.498273

rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,] #Deschampsia cespitosa and Dryas hookeriana
unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(rst.npn$Species[rst.npn$p.value<0.05 & rst.npn$Slope >= 0],
                                collapse="|"), rst.npn$Species, value=TRUE)])

rst.npn$genus <- gsub(" .*$", "", rst.npn$Species)

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a.csv", sep=",")
```


### Startdayofyear ~ MaxGDD for that year 
### CHANGE THIS TO INCLUDE ID
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)
rm(results,rst)
minNPNGDD_2_max <- merge(totalGDDyr, minNPNGDD_2, by="Year")

results.npn <- lapply(unique(minNPNGDD_2_max$scientificName), function(x){
  if(nrow(minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,])>=10){
  foo1 <- summary(lm(startDayOfYear~MaxGDD,
                     data=minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,]),
                          unique(minNPNGDD_2_max$Family[minNPNGDD_2_max$scientificName==x])),
                    unique(minNPNGDD_2_max$ID[minNPNGDD_2_max$scientificName==x]))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N","Fam","ID")
  JYC
  }
  })

rst.npn <- do.call(rbind,results.npn)

nrow(rst.npn) #22
rst.npn[rst.npn$p.value<0.05,] #Zigadenus elegans
nrow(rst.npn[rst.npn$p.value<0.05,]) #1

#earlier
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #1
unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(
      rst.npn$Species[rst.npn$p.value<0.05 & rst.npn$Slope < 0]
      ,
                                collapse="|"), rst.npn$Species, value=TRUE)])
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) # -0.05142886
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) #0.3363666

#later
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) 
rst.npn$genus <- gsub(" .*$", "", rst.npn$Species)

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a_MaxGDD.csv", sep=",")
```


```{r}
ggplot(minNPNGDD_2_max, aes(MaxGDD, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))

summary(lm(startDayOfYear~MaxGDD, data = minNPNGDD_2_max))
```

#NPN low earlier
```{r}
ggplot(minNPNGDD_2_max[minNPNGDD_2_max$ID %in%
                    grep(paste(rst.npn$ID[rst.npn$p.value<0.05 & rst.npn$Slope < 0],
                               collapse="|"),rst.npn$ID,
                         value=TRUE),], 
       aes(MaxGDD, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))+
  theme(legend.position="none")

```




```{r}
ggplot(minNPNGDD_2, aes(Year, HDD, group=Growth.Habit, colour=Growth.Habit))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5)+
  theme_bw()+
  ylab(expression(GDD))
```

# Appendix
```{r}
coll.year <- appd(yr.1950_2)
coll.high <- appd(high.1950_2)
coll.low <- appd(low.1950_2)
coll.precip <- appd(precip.1950_2)
coll.year.NPN <- appd(yr.npn_2)
coll.high.NPN <- appd(high.npn_2)
coll.low.NPN <- appd(low.npn_2)
coll.precip.NPN <- appd(precip.NPN_2)
# startDayOfYear ~ MaxGDD
coll.GDD <- appd(rst)
coll.GDD.npn <- appd(rst.npn)

appendixA.404 <- cbind(coll.year[,-6],
                       Year = coll.year$CollectionDate,
                       High = coll.high$CollectionDate,
                       Low = coll.low$CollectionDate,
                       Precip = coll.precip$CollectionDate)

appendixA <- merge(appendixA.404, coll.GDD, by = c("Family","Species","Sp","GrowthHabit","Duration"),
                   all=TRUE)

appendixA$NPN <- NA
appendixA$NPN[appendixA$Sp %in% grep(paste("^", paste(npn.min1950$SciName, collapse="|"),
                                       "$", sep=""),
                                 npn.min1950$SciName, value=TRUE)] <- "NPN"

write.table(appendixA,file="Q:/Research/Projects/alpine-phenology/AppendixA.csv", sep=",")
```


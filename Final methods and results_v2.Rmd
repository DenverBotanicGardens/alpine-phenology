---
title: "Final methods and results v2"
author: "Michelle DePrenger-Levin"
date: "January 10, 2017"
output: html_document
---
---
title: "Final Methods and Results"
author: "Michelle DePrenger-Levin"
date: "March 3, 2016"
output: html_document
---

load libraries   
```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
# install.packages("segmented")
library(segmented)
library(Taxonstand)
library(directlabels)
```

#Fresh start
Save the GDD variables - those take hours to calculate/extract
```{r, eval=FALSE}
rm(list= setdiff(ls(), c("avgTemps.max","avgTemps.min","tmps","HDD","HDD.all", "HDD.yrs")))
```

## load functions   
```{r}
JulBloomDate.min1950 <- function(variable,dataset){
  namesID <- unique(dataset$ID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$ID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    blnew$AUTH.x[1],
                                    blnew$scientificName[1],
                                    blnew$Family[1],
                                    foo1$adj.r.squared,
                                    blnew$ID[1],
                                    blnew$Duration[1],
                                    blnew$Growth.Habit[1]))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "SpeciesAuthority","Species", "Fam", "adj.r.squ","ID",
                   "Duration","GrowthHabit")
  JYC
}

mergeMinGDD <- function(mindates,GDD){
  merge(mindates, GDD, by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))
}

# exact match multisub
multisub <- function(pattern,replacement,x){
  result <- x
  for(i in 1:length(pattern)){
    result <- gsub(paste("^",pattern[i],"$"), paste("^",replacement[i],"$"),result)
  }
  result
}

appd <- function(x){
  x <- merge(x,merge.name[!duplicated(merge.name$ID),c("ID","scientificName","AUTH",
                                                       "Growth.Habit","Duration")], 
                      by.x = "Species", by.y = "scientificName")
  lmodel <- paste("F(",x$numDF,",",x$denDF,") = ",round(x$`F Stat`,2),
                  ", Slope = ",round(x$Slope,2),
                  ", p-value = ", round(x$p.value,2),
                  ", r2 = ", round(x$adj.r.squ,2), 
                  sep = "")
  data.frame(Family = x$Fam,
             Species = x$AUTH,
             Sp = x$Species,
             GrowthHabit = x$Growth.Habit,
             Duration = x$Duration,
             CollectionDate = lmodel)
  }
```

From Q:\Reserach\Plant Lists\Data to subset
```{r}
colo <- read.csv("P:/hackathon/alpine-phenology/datasets/Complete COLO DB .csv") 
seinet <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/CO_SEINet_3200_20160304.csv"))
```

Manipulate dates and names to be consistant before rbind databases
```{r}
colo$scientificName <- paste(colo$Genus,colo$Specific.Epithet,sep=" ")
colo$Reproductive.Status <- as.character(colo$Reproductive.Status)

# Select only reprodutive or post reproductive records
repro <- c("Flr","Bulblets","Seed","Fr","Bud")
colo.sm <- colo[colo
                $Reproductive.Status %in% unique(grep(paste(repro,collapse="|"),
                                                                colo$Reproductive.Status,
                                                                value=TRUE,ignore.case = TRUE)),]

table(colo.sm$Reproductive.Status)

colo.sm <- colo[,c(1,5,40,13,31,32,21,22,23,24)] #added 5 = Authority
names(colo.sm)

#Year
colo.sm$Year <- (sub('.*(\\d{4}).*', '\\1', as.character(colo.sm$Date..dd.month.yyyy.)))

# Removing any with dates that aren't entered correctly or are missing year, not exact date
colo.sm <- colo.sm[nchar(colo.sm$Year)==4,] #keep years with 4 digits 
colo.sm <- colo.sm[nchar(colo.sm$Year)==4 & !grepl("^[A-Za-z]+$",colo.sm$Year),] #keep ones that are 4 digits but all numeric
colo.sm <- colo.sm[colo.sm$Year>=1950,] #only years 1950 and beyond, before 2011
colo.sm <- colo.sm[colo.sm$Year<2012,] #only years 1950 and beyond, before 2012
barplot(table(colo.sm$Year))

# Only collections above or equal to 3200 meters, remove any without elevation
# only collections above or equal to 10,498.69 ft, remove any without elevation
# 15000 ft is 4572 m, remove anything over 4572 meters as a typo 
#  - highest in CO is Mt. Elbert at 4401.2 m
max.meter <- 14500/3.2808
colo.sm$elevation <- (colo.sm$Elevation..feet.)/3.2808
colo.sm$elevation[!is.na(colo.sm$Elevation..meters.)] <-
  colo.sm$Elevation..meters.[!is.na(colo.sm$Elevation..meters.)]
colo.sm <- colo.sm[colo.sm$elevation>=3200,]
colo.sm <- colo.sm[colo.sm$elevation<max.meter,] #four are recorded wrong
colo.sm <- colo.sm[!is.na(colo.sm$Elevation..meters.),]

# add a julian day column as $startDayOfYear
colo.sm$Date..dd.month.yyyy. <- as.character(colo.sm$Date..dd.month.yyyy.)
wrongdates <- colo.sm$Date..dd.month.yyyy.[colo.sm$Date..dd.month.yyyy. %in% grep("-", colo.sm$Date..dd.month.yyyy., value=TRUE)]

colo.sm$startDayOfYear<-as.numeric(format(
    as.Date(as.character(colo.sm$Date..dd.month.yyyy.), format="%d %B %Y")    ,"%j"))

colo.sm <- colo.sm[!is.na(colo.sm$startDayOfYear),]

barplot(table(colo.sm$startDayOfYear))
```

SEInet  
pull out names to match colo.sm and have data needed to subset   
 [1] "family"                   "scientificNameAuthorship" "scientificName"          
 [4] "stateProvince"            "decimalLatitude"          "decimalLongitude"        
 [7] "year"                     "minimumElevationInMeters" "startDayOfYear"          
[10] "reproductiveCondition"
```{r}
seinet <- seinet[seinet$scientificName!="",]
seinet$reproductiveCondition <- as.character(seinet$reproductiveCondition)

repro <- c("Fl","fr","Fert","fl","Fr")
seinet.sm <- seinet[seinet$reproductiveCondition %in% unique(grep(paste(repro,collapse="|"),
                                                             seinet$reproductiveCondition,
                                                             value=TRUE)),]
seinet.sm <- seinet[,c(12,14,13,56,63:64,31,73,34)]

# get to 1950-2011
seinet.sm <- seinet.sm[seinet.sm$year >=1950,]
#seinet.sm <- seinet.sm[seinet.sm$year <= 2011,]
seinet.sm <- seinet.sm[!is.na(seinet.sm$year),]

# Elevation over 3200 meters - was gathered from SEINet with that limitation. 
seinet.sm <- seinet.sm[!is.na(seinet.sm$minimumElevationInMeters),]

# Remove any rows missing startDayOfYear
seinet.sm <- seinet.sm[!is.na(seinet.sm$startDayOfYear),]

barplot(table(seinet.sm$startDayOfYear))
```

```{r}
names <- names(colo.sm[,c(1:3,5:6,11:13)]) 
#names(seinet.sm[,c(1:4,7,5,8)])
colo.bind <- colo.sm[,c(1:3,5:6,11:13)]
seinet.bind <- seinet.sm[,-4] #take out state
names(seinet.bind) <- names

i<-sapply(colo.bind, is.factor)
colo.bind[i]<-lapply(colo.bind[i], as.character)
colo.bind$Year <- as.numeric(colo.bind$Year)
i<-sapply(seinet.bind, is.factor)
seinet.bind[i]<-lapply(seinet.bind[i],as.character)
i<-sapply(seinet.bind, is.integer)
seinet.bind[i]<-lapply(seinet.bind[i],as.numeric)
```

####### BLOOM2 ##########
```{r}
bloom2 <- rbind(seinet.bind,colo.bind) 
barplot(table(bloom2$Year))
barplot(table(bloom2$startDayOfYear))

ggplot(bloom2, aes(as.factor(Year),startDayOfYear))+
  geom_boxplot(aes(fill=Year))

proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
```

#Find names on herbarium sheets that aren't in the USDA plants list  
Names from herbarium labels contain errors
Fix spelling errors   
<http://cumuseum-archive.colorado.edu/Research/Botany/Databases/vascular_plants.pdf>
```{r}
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

tochar <- c(1:3) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)
```

#1
## 3. Remove any herbarium specimens with Genus only
remove genus only, 241 records of only genus
```{r}
bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), 
                         function(x) sum(x > 0))) != 1,]
```


## 4. found herbarium sheets where name was not in database. 
Check for synonyms - Add ID numbers for unique taxa (link synonyms)    
synonym_list_byhand2.txt? 
added a few synonyms at the end that weren't in there. SEINet and Weber and Hartman to find what ID those names (from Herbarium specimens) should be assigned to. 
```{r,eval=TRUE}
synonyms <- read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/synonym_list_byhand2.txt")) # from DBG database taken from USDA (got from Rick)

#use of ssp and subsp
synonyms$SYNONYMS <- gsub(pattern = "subsp.", replacement = "ssp.", synonyms$SYNONYMS)
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

# names before the merge from our dataset
namebloom2 <- unique(bloom2$scientificName)
length(namebloom2) #2162 -> 2219

# deal with the auct non (wrong use of name) from synonym list
nrow(bloom2[bloom2$Authority %in% grep("auct. non", bloom2$Authority, value = TRUE),]) #87
nrow(synonyms[synonyms$AUTH %in% grep("auct. non", synonyms$AUTH, value=TRUE),]) #827
```

### 4f. Remove auct. non records from the synonyms list. 
```{r}
# remove all auct. non
synonyms <- synonyms[synonyms$AUTH %in% grep("auct.", synonyms$AUTH, value = TRUE, invert = TRUE),]
synonyms <- synonyms[synonyms$AUTH %in% grep(" non ", synonyms$AUTH, value = TRUE, invert = TRUE),]
# Agroelymus adamsii is in there twice with all the same information
synonyms <- unique(synonyms) # gets rid of 13 rows

# find to get rid of thse but doesn't appear in herbarium records
#synonyms <- synonyms[synonyms$SYNONYMS != "Acarospora squamulosa",] #lichen
#synonyms <- synonyms[synonyms$AUTH != "Alisma lanceolatum With.",] #UDSA plants has this one only in CA

# These two do!
synonyms <- synonyms[synonyms$AUTH != "Aster foliaceus Lindl. ex DC., database artifact",]
takeoutAste <- which(synonyms$AUTH == "" & synonyms$SYNONYMS == "Astragalus tenellus")
synonyms <- synonyms[-takeoutAste,]


bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")

```

## 4 ID links synonyms
### 4d. to not lose ones from bloom2 that have no match in synonyms, add all.x = TRUE (left outer join), see which aren't in the original and assign those names the appropriate ID to link synonyms
```{r}
#which names are in bloom2 before merge (namebloom2) vs. after merge (bloom.sp$scientificName)
length(unique(bloom2$scientificName[!(bloom2$scientificName %in% bloom.sp$scientificName)])) #290

badnames.o <- setdiff(namebloom2,bloom.sp$scientificName)
length(badnames.o) #293 -> 502 (after linking plantsyn to synonyms (our version of USDA)) #290

write.table(badnames.o,"clipboard", sep="\t", row.names=FALSE)

```

####Use these 'badnames.o' which are names in bloom2 not found in the USDA synonym list to correct errors some are crosses, some misspellings. 
###### fixbloom2 csv has $Wrong: list of bloom2 names with no UDSA match 
######                   $Replacement: corrected or NA if it should just be removed/ignored     
```{r}
fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

```

#2
#  after finding names that are on herbarium sheets but not in the USDA list (for a unique ID per name with synonyms and nativity, habit....) then use nomenclature from Jennifer Ackerfield's Flora (2015) and link. 
9/30/2016 add Melissa's corrections (synonyms2) to bloom2 and synonyms (and plantsyn) before linking by  names
# Bloom2 first
```{r}
rm(bloom2, bloom.sp)
bloom2 <- rbind(seinet.bind,colo.bind) 
proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)

bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

```

#3
Replace names with accepted by Ackerfield
```{r}
synonyms2 <- read.csv("Q:/Research/Projects/alpine-phenology/synonyms2_MI.csv")

bloom2$scientificName <- multisub(synonyms2$Species,
                                    synonyms2$SYNONYMS,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]

fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

bloom2$scientificName <- multisub(fixbloom2$Wrong.1,
                                    fixbloom2$Replacement,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]

```

#4e
#Bloom2 post Ackerfield nomenclature   
need to add the linking ID numbers contained in synonyms
```{r}
bloom.aftercorrections <- bloom2

## One set of collection in SEINet entered as 02/07/1996 should be July 2, not Feb 7th.
bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1996] <- 184

#entered wrong in SEINet
bloom2$startDayOfYear[bloom2$scientificName == "Androsace septentrionalis" & 
                        bloom2$Year == 1999 &
                        bloom2$startDayOfYear < 100] <- 203

bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 1996] <- 184

bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1998] <- 183

bloom2$startDayOfYear[bloom2$startDayOfYear == 8 & bloom2$Year == 2001] <- 213 #Aug 1, 2001

bloom2$startDayOfYear[bloom2$startDayOfYear == 66 & bloom2$Year == 2009] <- 184 #July 3, 2009

bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 2004] <- 185 #July 3, 2004 leap year


#synonyms is the current USDA plant list that we have at DBG
bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")
```


After combining datasets, find species with at least 10 years of data    
Check on collections earlier than April 9/10 (Julian day 100) - not so likely to be in bloom colleciton, some are typos  
mean collection date for all herbarium records (not just >10 years of data)
```{r}
bloomfoo <- bloom2
rm(bloom2)
bloom2 <- bloom.sp


write.table(unique(bloom2),
            file="P:/hackathon/alpine-phenology/datasets/bloom2_170126.csv", sep=",")

#Collection days each year, over the years for all herbarium records
ggplot(bloom2, aes(Year, startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()

summary(lm(startDayOfYear~Year,data=bloom2)) 

mean(bloom2$startDayOfYear)
mean.per.year <- aggregate(bloom2$startDayOfYear, list(bloom2$Year), mean)
mean(mean.per.year$x) #207.6

#Peak collection period throughout the study
ggplot(bloom2, aes(as.factor(Year), startDayOfYear))+
  geom_boxplot()+
  theme_bw()+
  ylab("Flowering day")+
  xlab("")

mean(bloom2$startDayOfYear, na.rm = TRUE) #207.588

#how many species in dataset
length(unique(bloom2$scientificName)) #1820 -> 1588, 1703, 1918
length(unique(bloom2$ID)) #1516 -> 1319, 1371, 1570
```



# how many years collected per species
```{r}

earl.sp.yr <- do.call(rbind,
                      lapply(split(bloom2, bloom2$ID), function(id){
                        id <- id[order(id$Year),]
                        id$DataYrs <- nrow(id[!duplicated(id$Year) & !is.na(id$Year),])
                        rows <- aggregate(startDayOfYear~Year, id, FUN=min)
                        out <- merge(id, rows, by=c("startDayOfYear","Year"))
                        out <- out[order(out$Year),]
                        out <- out[!duplicated(out$Year),]
                        out
                        })
)

earl.sp.yr[earl.sp.yr$startDayOfYear < 100,] # Abies concolor, Picea engelmannii, and Tetradymia stenolepis

#How many species were collected each year? For all specimens
byyr <- split(earl.sp.yr, earl.sp.yr$Year, drop=TRUE)

species.per.year <- do.call(rbind,
                            lapply(byyr, function(x){
                              data.frame(SpeciesTotal = length(unique(x$ID)), Year = unique(x$Year))
                            }))

species.per.year[which.max(species.per.year$SpeciesTotal),] #357, 398 -> 593 species total for all specimens 610 in 1998

ggplot(species.per.year, aes( Year,SpeciesTotal))+
  geom_point()+
  stat_smooth(method = "lm")


#How many years have each species been collected?
bysp <- split(earl.sp.yr, earl.sp.yr$ID, drop=TRUE)

spyears <- do.call(rbind,
                   lapply(bysp, function(x){
                     data.frame(DataYrs = length(unique(x$Year)),ID = unique(x$ID))
                     })
                   )

# Still all species, not just ones with 10+ years
spyears[which.max(spyears$DataYrs),] # 51
spyears[which.min(spyears$DataYrs),] # 1
nrow(spyears[spyears$DataYrs>=10,]) #414 -> 402 -> 300, 346 -> 468 -> 480
mean(spyears$DataYrs[spyears$DataYrs>=10]) #23.77708

# Now 10 plus years
sp.10plus <- earl.sp.yr[earl.sp.yr$DataYrs>=10,]
length(unique(sp.10plus$ID)) #414 -> 402 -> 300, 480
```


#5
#############################################################################################
#############################################################################################
# Select the accepted name (according to USDA)
```{r}
plantsyn <- read.table("Q:/Research/Projects/alpine-phenology/USDAplants20160510.txt",
                        header=TRUE, sep = ",") # missing those extra ones but including life habit... and indicating which are accepted (to later be double checked according to akerfield.) 
# Merge is an exact match, that's what we want

f <- sapply(plantsyn, is.factor)
plantsyn[f] <- lapply(plantsyn[f], as.character)

#A. Remove Antennaria parvifolia sensu Greene, non Nutt. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author != "sensu Greene, non Nutt.",]

#Remove auct. non. 
plantsyn <- plantsyn[plantsyn$Genera.Binomial.Author %in% 
                       grep("auct.", plantsyn$Genera.Binomial.Author,
                            value = TRUE, invert = TRUE),]
# in as non Poir, want real Anemone mutifida as accepted name, not synonym for Pulsatilla patens ssp. multifida
plantsyn$Synonym.Symbol[plantsyn$Synonym.Symbol == "ANMU8"] <- ""

# plantsyn is missing both the synonym Chlorocrepis tristis and accepted name Hieracium triste.
plantsyn <- rbind(plantsyn, c("HITR2","","HITR2","Hieracium triste","","Hieracium","",
                              "triste","","",
                              "","","","","","","","","","","","","","",
                              "Asteraceae","Perennial","Forb/herb",
                              "L48 (N), AK (N), CAN (N)", "Late Summer",
                              "",""))

synonyms$ID <- as.numeric(synonyms$ID)


######## do this to bloom2 ###########
TPL("Carex atrata")
synonyms[synonyms$SYNONYMS == "Carex atrata",] #8105
synonyms[synonyms$ID == 8105,]
# bloom2 <- bloom2[bloom2$scientificName != "Carex atrata",] # No, it should be fine...

# Per Melissa - lump Carex atrata under chalciolepis!
bloom2[bloom2$scientificName == "Carex atrata",]
plantsyn[plantsyn$Scientific.Name == "Carex atrata",]
plantsyn[plantsyn$Scientific.Name == "Carex heteroneura var. epapillosa",] #syn according to USDA Plants only
bloom2[bloom2$scientificName == "Carex chalciolepis",] #8325

synonyms[synonyms$ID == 8325,]

bloom2[bloom2$ID == 8105,]
synonyms[synonyms$ID == 8105,]
plantsyn[plantsyn$Scientific.Name == "Carex atrata",]


synonyms.plantsyn <- merge(synonyms,plantsyn,by.x="SYNONYMS",by.y="Scientific.Name")
synonyms.plantsyn <- synonyms.plantsyn[!duplicated(synonyms.plantsyn$SYNONYMS),]
synonyms.plantsyn.accpt <- synonyms.plantsyn[synonyms.plantsyn$Synonym.Symbol=="",]
str(synonyms.plantsyn.accpt)
synonyms.plantsyn.accpt$ID   <- as.numeric(synonyms.plantsyn.accpt$ID)
accptIds <- unique(synonyms.plantsyn.accpt$ID)


# sp.10plus == merge.name but might need to check it here, not made yet
sp.10plus <- earl.sp.yr[earl.sp.yr$DataYrs>=10,]
missingIDs <- setdiff(unique(sp.10plus$ID),accptIds)
unique(sp.10plus$scientificName[sp.10plus$ID %in% grep(paste(missingIDs, collapse="|"),
                                                       sp.10plus$ID, value=TRUE)])

###when clearing at the beginning (rm(ls)), get stuck here, this was circular! Taking this from below
```

# Need to check Family names are the accepted names!!

# Names missing 
"Antennaria parvifolia" (A above)   "Carex atrata"        "Carex micropoda"     "Eritrichium aretioides"     
"Eritrichium nanum var. aretioides" "Eutrema edwardsii"   "Chlorocrepis tristis"     
"Noccaea montana"                   "Poa nervosa"         "Salix arctica"       "Ligularia bigelovii"     
"Aster foliaceus"                   "Symphyotrichum foliaceum var. foliaceum"   "Veratrum californicum" 

# Names missing from plantsyn (but they ARE there?!) somehow not merged with sp.10plus == merge.name
[1] "Potentilla fruticosa"  "Antennaria parvifolia" "Antennaria umbrinella"       
"Chlorocrepis tristis"      "Carex atrata"          "Carex micropoda"      
"Veratrum californicum"     "Hieracium triste"  [9] "Dasiphora fruticosa"        
"Veratrum tenuipetalum"

# Not the same - fixed above now??? 
# Names that were in bloom2 (herbarium sheets) but not in synonym list
 [1] "Ligularia bigelovii"                     "Noccaea montana"                        
 [3] "Eritrichium aretioides"                  "Aster foliaceus"                        
 [5] "Eutrema edwardsii"                       "Salix arctica"                          
 [7] "Poa nervosa"                             "Chlorocrepis tristis"                   
 [9] "Symphyotrichum foliaceum var. foliaceum" "Carex micropoda"                        
[11] "Veratrum californicum"                   "Hieracium triste"                       
[13] "Eritrichium nanum var. aretioides"
```{r}
missingIDs[2] #8105
synonyms[synonyms$ID == 8105,] #not in there!
bloom.sp[bloom.sp$ID == 8105,]
plantsyn[plantsyn$Scientific.Name == "Antennaria parvifolia",]


synonyms[synonyms$ID == 2389,]
bloom.sp[bloom.sp$ID == 2389,]
plantsyn[plantsyn$Scientific.Name == "Antennaria parvifolia",]

# Eritrichium aretioides and Eritrichium nanum var. aretioides; Snow -> Eritrichium nanum var. elongatum from Eritrichium nanum var. aretioides and Eritrichum aretioides; Ackerfield -> Eritrichium nanum var. elongatum
synonyms[synonyms$SYNONYMS ==  "Eritrichium nanum var. aretioides" ,]
synonyms[synonyms$SYNONYMS ==  "Eritrichium aretioides" ,] #17900 !! now both 17897
bloom2[bloom2$ID == 17897,]
plantsyn[grep("Eritrichium", plantsyn$Scientific.Name),]

synonyms[synonyms$SYNONYMS ==  "Eritrichium aretioides" ,]
synonyms[synonyms$SYNONYMS ==  "Eritrichium nanum var. elongatum" ,]

synonyms$ID[synonyms$SYNONYMS=="Eritrichium aretioides"]<-
  synonyms$ID[synonyms$SYNONYMS=="Eritrichium nanum var. elongatum"]

# Snow - synonyms, V. californicum accepted in Ackerfield
synonyms[synonyms$SYNONYMS ==  "Veratrum californicum" ,] #46683
synonyms[synonyms$SYNONYMS ==  "Veratrum tenuipetalum" ,] #46691

plantsyn[grep("Veratrum tenuipetalum", plantsyn$Scientific.Name),]
plantsyn$Scientific.Name[grep("Veratrum tenuipetalum", plantsyn$Scientific.Name)] <- 
  "Veratrum californicum"
synonyms$ID[synonyms$SYNONYMS=="Veratrum tenuipetalum"]<-
  synonyms$ID[synonyms$SYNONYMS=="Veratrum californicum"]

# "Carex atrata" - throw it out, auct p.p. non L. 
# Carex micropoda in Snow: -> Carex pyrenaica ssp pyrenaica; Plants -> C. pyrenaica ssp micropoda but not in CO;  Ackerfield -> C. micropoda accpt (from C. pyrenaica Wahl.)
synonyms[synonyms$SYNONYMS ==  "Carex micropoda" ,]
plantsyn$Scientific.Name[grep("pyrenaica", plantsyn$Scientific.Name)] <- "Carex micropoda"

synonyms$ID[synonyms$SYNONYMS == "Carex pyrenaica"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Carex micropoda"] 
synonyms$ID[synonyms$SYNONYMS == "Carex pyrenaica ssp. pyrenaica"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Carex micropoda"] 
synonyms$ID[synonyms$SYNONYMS == "Carex pyrenaica ssp. pyrenaica"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Carex crandallii"] 


synonyms[grep("Agoseris aurantiaca", synonyms$SYNONYMS),]  # 
synonyms$ID[synonyms$SYNONYMS == "Agoseris aurantiaca var. purpurea"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Agoseris aurantiaca"] 
 
synonyms$ID[synonyms$SYNONYMS == "Agoseris aurantiaca var. aurantiaca"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Agoseris aurantiaca"] 

plantsyn[grep("Agoseris aurantiaca", plantsyn$Scientific.Name),]
plantsyn <- plantsyn[plantsyn$Scientific.Name != "Agoseris aurantiaca var. aurantiaca",]
plantsyn <- plantsyn[plantsyn$Scientific.Name != "Agoseris aurantiaca var. purpurea",]

#remove!
synonyms[synonyms$SYNONYMS ==  "Symphyotrichum foliaceum var. foliaceum" ,]

synonyms <- synonyms[synonyms$SYNONYMS!="Symphyotrichum foliaceum var. foliaceum",]


#Combine Achillea millefolium var. occidentalis with Achillea millefolium
plantsyn[grep("Achillea millefolium", plantsyn$Scientific.Name),]
synonyms[synonyms$SYNONYMS == "Achillea millefolium var. occidentalis",] #544
synonyms[synonyms$SYNONYMS == "Achillea millefolium",] #534
synonyms$ID[synonyms$SYNONYMS=="Achillea millefolium var. occidentalis"]<-
  synonyms$ID[synonyms$SYNONYMS=="Achillea millefolium"]

synonyms$ID[synonyms$SYNONYMS=="Achillea lanulosa"]<-
  synonyms$ID[synonyms$SYNONYMS=="Achillea millefolium"]



# Ackerfield
synonyms[synonyms$SYNONYMS ==  "Chlorocrepis tristis" ,]
synonyms[synonyms$SYNONYMS ==  "Hieracium triste" ,]

synonyms$ID[synonyms$SYNONYMS=="Chlorocrepis tristis"]<-
  synonyms$ID[synonyms$SYNONYMS=="Hieracium triste"]

# good
synonyms[synonyms$SYNONYMS ==  "Poa nervosa" ,]
synonyms[synonyms$SYNONYMS ==  "Poa wheeleri" ,]

synonyms$ID[synonyms$SYNONYMS=="Poa nervosa"]<-
  synonyms$ID[synonyms$SYNONYMS=="Poa wheeleri"]

# good
synonyms[synonyms$SYNONYMS ==  "Salix arctica" ,]
synonyms[synonyms$SYNONYMS ==  "Salix petrophila" ,]

synonyms$ID[synonyms$SYNONYMS=="Salix arctica"]<-
  synonyms$ID[synonyms$SYNONYMS=="Salix petrophila"]

# Ackerfield has E. penlandii
synonyms[synonyms$SYNONYMS ==  "Eutrema edwardsii" ,]
synonyms[synonyms$SYNONYMS ==  "Eutrema penlandii" ,]

synonyms$ID[synonyms$SYNONYMS=="Eutrema edwardsii"]<-
  synonyms$ID[synonyms$SYNONYMS=="Eutrema penlandii"]

synonyms[synonyms$SYNONYMS ==  "Aster foliaceus" ,]
synonyms[synonyms$SYNONYMS ==  "Symphyotrichum foliaceum var. apricum" ,]

synonyms$ID[synonyms$SYNONYMS=="Aster foliaceus"]<-
  synonyms$ID[synonyms$SYNONYMS=="Symphyotrichum foliaceum var. apricum"]

# 
synonyms[synonyms$SYNONYMS ==  "Noccaea montana" ,]
synonyms[synonyms$SYNONYMS ==  "Thlaspi montanum var. montanum" ,]
synonyms.plantsyn[synonyms.plantsyn$SYNONYMS == "Thlaspi montanum var. montanum",]

synonyms$ID[synonyms$SYNONYMS=="Noccaea montana"]<-
  synonyms$ID[synonyms$SYNONYMS=="Thlaspi montanum var. montanum"]

#should combine 
synonyms[synonyms$SYNONYMS ==  "Ligularia bigelovii" ,]
synonyms[synonyms$SYNONYMS ==  "Senecio bigelovii var. hallii" ,]
synonyms.plantsyn[synonyms.plantsyn$SYNONYMS == "Senecio bigelovii var. hallii",]

synonyms[synonyms$SYNONYMS ==  "Ligularia bigelovii" ,]
synonyms$ID[synonyms$SYNONYMS ==  "Ligularia bigelovii"] <-
  synonyms.plantsyn$ID[synonyms.plantsyn$SYNONYMS == "Senecio bigelovii var. hallii"]

synonyms$ID[synonyms$SYNONYMS == "Carex atrata"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Carex chalciolepis"]


synonyms$ID[synonyms$SYNONYMS == "Carex crandallii"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Carex micropoda"]


synonyms$ID[synonyms$SYNONYMS == "Carex pyrenaica ssp. pyrenaica"] <- 
  synonyms$ID[synonyms$SYNONYMS == "Carex micropoda"]

synonyms[synonyms$ID == 8591,]
synonyms[synonyms$SYNONYMS == "Carex pyrenaica ssp. pyrenaica",]

rm(synonyms.plantsyn, synonyms.plantsyn.accpt)
synonyms.plantsyn <- merge(synonyms,plantsyn,by.x="SYNONYMS",by.y="Scientific.Name")
synonyms.plantsyn <- synonyms.plantsyn[!duplicated(synonyms.plantsyn$SYNONYMS),]
synonyms.plantsyn.accpt <- synonyms.plantsyn[synonyms.plantsyn$Synonym.Symbol=="",]
str(synonyms.plantsyn.accpt)
synonyms.plantsyn.accpt$ID   <- as.numeric(synonyms.plantsyn.accpt$ID)

```

#6
# Bloom2 Final
Found issues from 480 - will be down a few but do again after synonyms and plantsyn have been 'fixed' with accepted name
```{r}
rm(bloom2)
bloom2 <- rbind(seinet.bind,colo.bind) 
proper <- function(s) sub("(.)", ("\\U\\1"), tolower(s), pe=TRUE)
bloom2$Family.Name <- proper(bloom2$Family.Name)
bloom2 <- as.data.frame(sapply(bloom2, gsub, 
                               pattern = "caerulea",
                               replacement = "coerulea"))

bloom2 <- as.data.frame(sapply(bloom2, gsub,
                               pattern = "Eritrichum",
                               replacement = "Eritrichium"))

str(bloom2)
tochar <- c(1:3) #added authority
bloom2[,tochar] <- sapply(bloom2[,tochar], function(ch){
  as.character(ch)
})
rm(tochar)

tonumeric <- c(4:length(bloom2))
bloom2[,tonumeric] <- sapply(bloom2[,tonumeric], function(s){
  as.numeric(as.character(s))
})
rm(tonumeric)

bloom2 <- bloom2[(sapply(gregexpr("[[:alpha:]]+",bloom2$scientificName), function(x) sum(x > 0))) != 1,]
bloom2$scientificName <- gsub(pattern = "subsp.", replacement = "ssp.", bloom2$scientificName)

synonyms2 <- read.csv("Q:/Research/Projects/alpine-phenology/synonyms2_MI.csv")

bloom2$scientificName <- multisub(synonyms2$Species,
                                    synonyms2$SYNONYMS,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]

fixbloom2 <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/SpellingErrorCorrections_v4.csv"),
                      na.strings = c("NA", "", " "), colClasses = "character")

bloom2$scientificName <- multisub(fixbloom2$Wrong.1,
                                    fixbloom2$Replacement,bloom2$scientificName)
bloom2 <- bloom2[!is.na(bloom2$scientificName),]

```

#7
#Bloom2 post Ackerfield nomenclature Final
```{r}
bloom.aftercorrections <- bloom2

## One set of collection in SEINet entered as 02/07/1996 should be July 2, not Feb 7th.
bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1996] <- 184

#entered wrong in SEINet
bloom2$startDayOfYear[bloom2$scientificName == "Androsace septentrionalis" & 
                        bloom2$Year == 1999 &
                        bloom2$startDayOfYear < 100] <- 203

bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 1996] <- 184

bloom2$startDayOfYear[bloom2$startDayOfYear == 38 & bloom2$Year == 1998] <- 183

bloom2$startDayOfYear[bloom2$startDayOfYear == 8 & bloom2$Year == 2001] <- 213 #Aug 1, 2001

bloom2$startDayOfYear[bloom2$startDayOfYear == 66 & bloom2$Year == 2009] <- 184 #July 3, 2009

bloom2$startDayOfYear[bloom2$startDayOfYear == 67 & bloom2$Year == 2004] <- 185 #July 3, 2004 leap year

#synonyms is the current USDA plant list that we have at DBG
bloom.sp <- merge(bloom2, synonyms, by.x = "scientificName", by.y = "SYNONYMS")
```

#8
# find 10 years or more after final synonymy checked
```{r}
bloom2 <- bloom.sp


write.table(unique(bloom2[,c("ID","Family.Name","scientificName")]),
            file="P:/hackathon/alpine-phenology/datasets/bloom2.csv", sep=",")

#Collection days each year, over the years for all herbarium records
ggplot(bloom2, aes(Year, startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()

summary(lm(startDayOfYear~Year,data=bloom2)) 

mean(bloom2$startDayOfYear)
mean.per.year <- aggregate(bloom2$startDayOfYear, list(bloom2$Year), mean)
mean(mean.per.year$x) #207.6

#Peak collection period throughout the study
ggplot(bloom2, aes(as.factor(Year), startDayOfYear))+
  geom_boxplot()+
  theme_bw()+
  ylab("Flowering day")+
  xlab("")

mean(bloom2$startDayOfYear, na.rm = TRUE)

#how many species in dataset
length(unique(bloom2$scientificName)) #1820 -> 1588, 1703, 1918 -> 1916 (1917)
length(unique(bloom2$ID)) #1516 -> 1319, 1371, 1563, 1559

```

#9
# how many years collected per species FINAL   
bloom2 == bloom.sp which was linked to synonyms
```{r}

earl.sp.yr <- do.call(rbind,
                      lapply(split(bloom2, bloom2$ID), function(id){
                        id <- id[order(id$Year),]
                        id$DataYrs <- nrow(id[!duplicated(id$Year) & !is.na(id$Year),])
                        rows <- aggregate(startDayOfYear~Year, id, FUN=min)
                        out <- merge(id, rows, by=c("startDayOfYear","Year"))
                        out <- out[order(out$Year),]
                        out <- out[!duplicated(out$Year),]
                        out
                        })
)

earl.sp.yr[earl.sp.yr$startDayOfYear < 100,]

#How many species were collected each year? For all specimens
byyr <- split(earl.sp.yr, earl.sp.yr$Year, drop=TRUE)

species.per.year <- do.call(rbind,
                            lapply(byyr, function(x){
                              data.frame(SpeciesTotal = length(unique(x$ID)), Year = unique(x$Year))
                            }))

#Before refining data to species with 10 or more years of data, peak of XX species collected in XX year
species.per.year[which.max(species.per.year$SpeciesTotal),] #357, 398 -> 593 species total for all specimens 602 in 1998

ggplot(species.per.year, aes( Year,SpeciesTotal))+
  geom_point()+
  stat_smooth(method = "lm")


#How many years have each species been collected?
bysp <- split(earl.sp.yr, earl.sp.yr$ID, drop=TRUE)

spyears <- do.call(rbind,
                   lapply(bysp, function(x){
                     data.frame(DataYrs = length(unique(x$Year)),ID = unique(x$ID))
                     })
                   )

# Still all species, not just ones with 10+ years
spyears[which.max(spyears$DataYrs),] # 51
spyears[which.min(spyears$DataYrs),] # 1
nrow(spyears[spyears$DataYrs>=10,]) #414 -> 402 -> 300, 346 -> 468 -> 480 -> 472 -> 470 -> 467
mean(spyears$DataYrs[spyears$DataYrs>=10]) #24.15632

# Now 10 plus years
sp.10plus <- earl.sp.yr[earl.sp.yr$DataYrs>=10,]
length(unique(sp.10plus$ID)) #414 -> 402 -> 300, 480 -> 473 -> 467

```

Previous naming conventions switched between 'merge.name' and 'sp.10plus' They are the same
```{r}
merge.name <- sp.10plus

```


#10   
Accpted name link it up!   
merge.name and sp.10plus are identical
```{r}
accptIds <- unique(synonyms.plantsyn.accpt$ID)
missingIDs <- setdiff(unique(sp.10plus$ID),accptIds) # None!! Yay! 544 -Achillea 

bloom2[bloom2$ID == missingIDs,]
```


# To the manuscript! 
Herbarium specimen data   
```{r}
# average XX species were collected per year
#How many species were collected each year? For species with 10 or more years
byyr.10 <- split(earl.sp.yr[earl.sp.yr$DataYrs >= 10,], earl.sp.yr$Year[earl.sp.yr$DataYrs >= 10], drop=TRUE)

species.per.year.10 <- do.call(rbind,
                            lapply(byyr.10, function(x){
                              data.frame(SpeciesTotal = length(unique(x$ID)), Year = unique(x$Year))
                            }))

species.per.year.10[which.max(species.per.year.10$SpeciesTotal),] # 398 in 1998
mean(species.per.year.10$SpeciesTotal) # 185.2623 -> 184.9344

```

Figure 1a
Of the first bloom data of species that matched sampling critera, the hightest diversity of species collections were made in the 1990s and early 2000s with a peak of 449 species collected in 1998. Average over the study period was 211 alpine/subalpine species collected per year. 
```{r}

earliestcollection <- data.frame(colSums(table(merge.name$ID, #should be only one name now
                                                merge.name$Year)))
sort(unique(merge.name$DataYrs))

earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
earcol[which.max(earcol$Collections),]
mean(earcol$Collections) #168.4098 -> 184.9344

```

#Figure 1A
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of species collected")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()
```

Peak collection period, which day is the peak collection day each year

#Results: 3rd para
```{r}
# earliest collections for species with 10+ yrs data
summary(lm(startDayOfYear~Year, data=sp.10plus))

ggplot(sp.10plus, aes(Year, startDayOfYear))+
  geom_point()+
  theme_bw()+
  stat_smooth(method="lm")

# Maybe? March 11th
sp.10plus[sp.10plus$startDayOfYear < 100,] # Picea engelmannii

# Collections included in this study
#average of each year's average
meancollday <- aggregate(sp.10plus$startDayOfYear, list(sp.10plus$Year), mean)
mean(meancollday$x) # 202.107

#Has this average moved?
# The earliest collection date per year
summary(lm(x~Group.1, data=meancollday))

#Earliest average collection day was what in what year?
meancollday[which.min(meancollday$x),]
#Latest average colleciton day
meancollday[which.max(meancollday$x),]


# 469 species with 10 or more years of collections
summary(lm(startDayOfYear~Year, data = merge.name))

#overall average
mean(sp.10plus$startDayOfYear) #200.6033

#All data, not just earliest collection per species
col.yr <- data.frame(table(bloom2$startDayOfYear, bloom2$Year))
peak.yr <- do.call(rbind, lapply(split(col.yr, col.yr$Var2), function(x) x[which.max(x$Freq),]))
peak.yr$Var1 <- as.numeric(levels(peak.yr$Var1))[peak.yr$Var1]
mean(peak.yr$Var1) #206.541
rm(col.yr, peak.yr)

#peak as mode
# for earliest collections
col.yr <- data.frame(table(sp.10plus$startDayOfYear, sp.10plus$Year))
peak.yr <- do.call(rbind, lapply(split(col.yr, col.yr$Var2), function(x) x[which.max(x$Freq),]))
peak.yr$Var1 <- as.numeric(levels(peak.yr$Var1))[peak.yr$Var1]
mean(peak.yr$Var1) #195.5738
```

Average number of collections over the study period was 185 species collected per year
```{r}
mean(earcol$Collections) # 184.9344
```


#Figure 4
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 4.tiff", width = 174, height = 150, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.75)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 

dev.off()

summary(lm(startDayOfYear~Year, data=merge.name))

```

 
```{r}
allcollections <- data.frame(colSums(table(bloom2$ID,bloom2$Year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])
```

#Figure 1B  
```{r}
dpi = 1200
tiff("Q:/Research/Projects/alpine-phenology/Fig. 1b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2011, by=10))+
  scale_y_continuous(limits = c(0,4700),breaks = seq(0,4700, by=500)) +
  theme(axis.text=element_text(size=7),
        axis.title=element_text(size=9))

dev.off()
```


The day each year with the most collections has on average been Julian day 206 and the day with the most collections has not moved significantly over time from 1950 to 2011. The earliest peak collection day was Julian day 175 (June 30th) in 2007 and the latest peak collection day was Julian day 238 in 1957 (August 29th)   
```{r}
collJ.sp <- data.frame(table(bloom2$Year,bloom2$startDayOfYear))

str(collJ.sp)

collJ.sp[,1:2] <- sapply(collJ.sp[,1:2], function(x){
  as.numeric.factor(x)
})

coll.per.julianday <- aggregate(collJ.sp$Freq, list(collJ.sp$Var2), sum)
coll.per.julianday[which.max(coll.per.julianday$x),]

# split the number of collections per Julian day by year, find which day had the most each year
# "Peak" or mode, not average
collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
collmax <- do.call(rbind,collJ.max)
collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))

mean(collmax$Var2) #206.541
collmax[which.min(collmax$Var2),] # smallest Julian day with most collections
collmax[which.max(collmax$Var2),] # biggest julian day with most collections
summary(lm(Var2~Var1, data=collmax))

```

# Bloom
```{r}
library(RCurl)
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/QR_final_R_plant_climate_data_2.csv"))

```

Average high, low, and precip per year  
Take annual climate data from previous dataset
```{r}
head(bloom)
head(bloom[,c(19,20,21,23)])

# units for precip are: ppt (mm*100) (even though it just says mm on the main website you look at when reading about the variables). So, we need to divide our values by 100 for our figures. 
bloom$Raw_Precip <- (bloom$Raw_Precip)/100

# merge.name$Raw_Precip <- (merge.name$Raw_Precip)/100

# If already have precip and hi lo, don't merge again, don't want .x and .y!
head(merge.name)
merge.name <- merge(merge.name,unique(bloom[,c(19,20,21,23)]), by="Year")

write.table(merge.name, file="P:/hackathon/alpine-phenology/datasets/merge.name.csv", sep=",")

unbloom <- unique(bloom[,c(19,20,21,23)])
```

Correlations of climate
```{r}
cor(unbloom[,-1])
cor.test(unbloom[,2],unbloom[,3])
cor.test(unbloom[,2],unbloom[,4])
cor.test(unbloom[,3],unbloom[,4])

```



#Figure 3A  
Using just the average temp per year, not repeated for everytime we have specimen data in a year
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Avg_Hi))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size=0.5)+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
#  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression("Average high"~degree*C)) + 
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8))

dev.off()

summary(lm(Avg_Hi~Year, data=unbloom))
```


#Figure 3B
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)


ggplot(unbloom, aes(Year,Avg_Lo))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab(expression("Average low"~degree*C))+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Avg_Lo~Year, data = unbloom))

```



#Figure 3C   
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(unbloom, aes(Year,Raw_Precip))+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  geom_point(shape=1, size = 0.5)+
  theme_bw()+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()


summary(lm(Raw_Precip~Year, data = unbloom))

```




Growing Degree Days   
```{r, eval=FALSE}
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath = TRUE)[,2])
# mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

# Takes an hour to run
avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)
# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

```


Calculate Growing Degree Days
```{r}
tbase <- 0

#method 1 from McMaster and Wilhelm 1997
HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})

HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all

write.table(tmps, file="P:/hackathon/alpine-phenology/datasets/tmps.csv", sep=",")
```



On average, ordinal day XX () has the highest number of specimen records and this day has not moved signficantly over time...   
```{r}
ggplot(merge.name, aes(Year, startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()

#Same
summary(lm(startDayOfYear ~ Year, data = merge.name))
summary(lm(startDayOfYear ~ Year, data = sp.10plus))

identical(merge.name[,-c((length(sp.10plus)+1):length(merge.name))], sp.10plus)
setdiff(merge.name$ID, sp.10plus$ID)

#average of each year's average
meancollday <- aggregate(sp.10plus$startDayOfYear, list(sp.10plus$Year), mean)
mean(meancollday$x) # 202.052

head(meancollday)
summary(lm(x~Group.1, data=meancollday))
ggplot(meancollday, aes(Group.1, x))+
  geom_point()+
  stat_smooth(method="lm")

meancollday[which.max(meancollday$x),]
meancollday[which.min(meancollday$x),]
```


```{r}
avg.HDD.yrs <- lapply(HDD.yrs, function(x){
  mean(x)
})

avg.yrs <- do.call(c, avg.HDD.yrs)
hddyrs <- data.frame(Year=1981:2011, avgHDD = avg.yrs)
```

correlations with GDD and climate factors
```{r}
unbloomGDD <- merge(unbloom,hddyrs,by="Year")
cor(unbloomGDD[,-1])
cor.test(unbloomGDD$avgHDD,unbloomGDD$Raw_Precip)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Hi)
cor.test(unbloomGDD$avgHDD,unbloomGDD$Avg_Lo)

```

############################################################################################
############################################################################################


#Need to merge the accepted names with merge.name
```{r}

head(table(synonyms.plantsyn.accpt$ID,synonyms.plantsyn.accpt$SYNONYMS))

names.p.ID <- colSums(table(synonyms.plantsyn.accpt$SYNONYMS,synonyms.plantsyn.accpt$ID))
names.p.ID[names.p.ID > 1] #534

synonyms.plantsyn.accpt <- 
  synonyms.plantsyn.accpt[synonyms.plantsyn.accpt$SYNONYMS != "Achillea millefolium var. occidentalis",]

synonyms.plantsyn.accpt[grep("Agoseris",synonyms.plantsyn.accpt$SYNONYMS),]

head(synonyms.plantsyn.accpt[synonyms.plantsyn.accpt$SYNONYMS %in% merge.name$scientificName,])

merge.name.accpt <- merge(merge.name, synonyms.plantsyn.accpt, by = "ID") 
head(merge.name.accpt)

# USDA has Achillea millefolium L. var. occidentails DC. we want Achillea millefolium 

length(unique(merge.name.accpt$ID)) #467

```

Phenology summary tables    
```{r}
yr.1950_2 <- JulBloomDate.min1950("Year",merge.name.accpt)

nrow(yr.1950_2) #467

write.table(yr.1950_2, file = "Q:/Research/Projects/alpine-phenology/phensum_yr.csv", sep=",")

nrow(yr.1950_2[yr.1950_2$p.value>=0.05,]) #411
nrow(yr.1950_2[yr.1950_2$p.value<0.05,]) #56

nrow(yr.1950_2[yr.1950_2$p.value<0.05,])/nrow(yr.1950_2) #0.119403

#earlier
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0,]) #56
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #-0.5555133
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0])*61 #-33.88631
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope<0]) #0.2231147

#later
nrow(yr.1950_2[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0,]) #4->0

unique(merge.name.accpt$ID[merge.name.accpt$scientificName %in% grep(paste(
  yr.1950_2$Species[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0],
  collapse="|"), yr.1950_2$Species, value=TRUE)])


mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #NaN
mean(yr.1950_2$Slope[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0])*61
mean(yr.1950_2$adj.r.squ[yr.1950_2$p.value<0.05 & yr.1950_2$Slope>=0]) #NaN

```

Any different names since Melissa first looked at the list?
```{r}
checksame <- read.csv("Q:/Research/Projects/alpine-phenology/phensum_yr.mi_samelist.csv")
head(checksame)


yr.1950_2[grep("Agoseris", yr.1950_2$SpeciesAuthority),]

notin <- setdiff(yr.1950_2$Species, checksame$Species)
write.table(yr.1950_2$SpeciesAuthority[yr.1950_2$Species %in% notin],
            file = "Q:/Research/Projects/alpine-phenology/notSameaspreviouslist.csv", sep=",")

writeClipboard(setdiff(yr.1950_2$Species, checksame$Species))
length(setdiff(yr.1950_2$Species, checksame$Species)) #63

# Names needing some action
synnames <- checksame$SYNONYMS[checksame$SYNONYMS != "" & !is.na(checksame$SYNONYMS)]

nrow(yr.1950_2[yr.1950_2$Species %in% synnames,]) #53

inyr.notcheck <- setdiff(yr.1950_2$Species, checksame$Species)
length(inyr.notcheck) 63

inyr.notcheck[inyr.notcheck %in% synnames] # "Draba cana"         "Cymopterus alpinus"

#Which are in that first list that are no longer in the current list
write.table(yr.1950_2[yr.1950_2$Species %in% checksame$Species,], 
            file = "Q:/Research/Projects/alpine-phenology/Sameaspreviouslist.csv", sep=",")

nrow(yr.1950_2[yr.1950_2$Species %in% checksame$Species,]) # 1 -> 404 already dealt with these, plust the 63 that haven't been checked before gets to all 467 species

setdiff(checksame$Species,yr.1950_2$Species)
```



#Year later  - NONE!
```{r}
ggplot(merge.name[merge.name$ID == paste(yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                       yr.1950_2$Slope>=0],collapse="|"),],
       aes(Year, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
unique(merge.name.accpt$SYNONYMS[merge.name.accpt$Bloom.Period == ""])

```

#Year earlier
```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                              yr.1950_2$Slope<0]),],
       aes(Year, startDayOfYear, colour = Bloom.Period))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

```


```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% yr.1950_2$ID[yr.1950_2$p.value<0.05 &
                                              yr.1950_2$Slope<0]),],
       aes(Year, startDayOfYear, colour = Family))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

```

#Families with significant changes over time
```{r}
ggplot(merge.name[which(merge.name$ID %in% yr.1950_2$ID[yr.1950_2$p.value<0.05]),],
       aes(Year, startDayOfYear, colour = Family.Name))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

```

#Families with insignificant changes over time
```{r}
ggplot(merge.name[which(merge.name$ID %in% yr.1950_2$ID[yr.1950_2$p.value>=0.05]),],
       aes(Year, startDayOfYear, colour = Family.Name))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")

```


```{r}
ggplot(merge.name[which(merge.name$ID %in% yr.1950_2$ID[yr.1950_2$Slope<0]),],
       aes(Year, startDayOfYear, colour = Family.Name))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")
  

```


###High Temperature     
```{r}
high.1950_2 <- JulBloomDate.min1950("Avg_Hi", merge.name.accpt)

nrow(high.1950_2) #467
write.table(high.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_summary_high_2.csv", sep=",")

nrow(high.1950_2[high.1950_2$p.value<0.05,]) #78
nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.1670236

#earlier
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope<0,])  #76
mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) # -10.79536
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope<0]) #0.2375394

#later
nrow(high.1950_2[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0,]) # 2
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(high.1950_2$Species[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0],
                                collapse="|"), high.1950_2$Species, value=TRUE)])

merge.name[merge.name$scientificName == "Askellia nana",] #
merge.name[merge.name$ID == 12586,]

mean(high.1950_2$Slope[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #8.893071
mean(high.1950_2$adj.r.squ[high.1950_2$p.value<0.05 & high.1950_2$Slope>=0]) #0.3025555

nrow(high.1950_2[high.1950_2$p.value<0.05,])/nrow(high.1950_2) #0.1707921
nrow(high.1950_2[high.1950_2$p.value>=0.05,])/nrow(high.1950_2) #0.8292079

```

Later with heat
```{r}
ggplot(merge.name[which(merge.name$ID %in% high.1950_2$ID[high.1950_2$p.value<0.05 &
                                                          high.1950_2$Slope>=0]),],
       aes(Avg_Hi, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```


earlier  with heat
```{r}
ggplot(merge.name[which(merge.name$ID %in% high.1950_2$ID[high.1950_2$p.value<0.05 &
                                                          high.1950_2$Slope<0]),],
       aes(Avg_Hi, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```


Average high
#Figure 5A  
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name, aes(Avg_Hi, startDayOfYear))+
  geom_point(shape=1,size=0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Average high"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=7))


dev.off()

summary(lm(startDayOfYear~Avg_Hi, data=merge.name.accpt))

```




```{r}
low.1950_2 <- JulBloomDate.min1950("Avg_Lo", merge.name.accpt)

nrow(low.1950_2) #467

write.table(low.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_low_2.Table3.csv", sep=",")

nrow(low.1950_2[low.1950_2$p.value<0.05,]) #74
nrow(low.1950_2[low.1950_2$p.value<0.05,])/nrow(low.1950_2) #0.1584582
mean(low.1950_2$Slope)

#earlier
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope<0,]) #73
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #-9.757442
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope<0]) #0.186121

#later
# Still have double entries
nrow(low.1950_2[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0,]) #1
unique(merge.name.accpt$AUTH.y[merge.name.accpt$scientificName %in% 
                     grep(paste(
      low.1950_2$Species[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]
      ,
                                collapse="|"), low.1950_2$Species, value=TRUE)])
mean(low.1950_2$Slope[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #10.08779
mean(low.1950_2$adj.r.squ[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]) #0.249457

# are the same set of species signficantly changing with high temps as with low temps?
setdiff(high.1950_2$SpeciesAuthority[high.1950_2$p.value<0.05 &
                                       high.1950_2$Slope<0],
        low.1950_2$SpeciesAuthority[low.1950_2$p.value<0.05 & low.1950_2$Slope<0])

intersect(high.1950_2$SpeciesAuthority[high.1950_2$p.value<0.05 &
                                       high.1950_2$Slope<0],
        low.1950_2$SpeciesAuthority[low.1950_2$p.value<0.05 & low.1950_2$Slope<0])
```

```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% 
                                low.1950_2$ID[low.1950_2$p.value<0.05 & low.1950_2$Slope>=0]),],
       aes(Avg_Lo, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                low.1950_2$ID[low.1950_2$p.value<0.05 &
                                                     low.1950_2$Slope<0]),],
       aes(Avg_Lo, startDayOfYear, colour = scientificName))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```


#Figure 5B
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5b.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1, size= 0.5)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression("Average low"~degree~C))+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Avg_Lo, data = merge.name.accpt))
```


### Precipitation
```{r}
precip.1950_2 <- JulBloomDate.min1950("Raw_Precip", merge.name.accpt)

#precip.1950_2[,c("Species")]<-sapply(precip.1950_2[,c("Species")], function(ch) as.character(ch))
write.table(precip.1950_2, file = "Q:/Research/Projects/alpine-phenology/phen_sum_precip_2.Table4.csv", sep=",")

nrow(precip.1950_2[precip.1950_2$p.value<0.05,]) #42
nrow(precip.1950_2[precip.1950_2$p.value<0.05,])/nrow(precip.1950_2) # 0.08663366

mean(precip.1950_2$Slope)


#earlier
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0,]) #1
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                               precip.1950_2$ID[precip.1950_2$p.value<0.05 & 
                                                  precip.1950_2$Slope<0])]) 
# Oxytropis borealis var. viscida
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) # -0.06341651
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope<0]) #0.2961746

#later
nrow(precip.1950_2[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0,]) #41
mean(precip.1950_2$Slope[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.09132756
mean(precip.1950_2$adj.r.squ[precip.1950_2$p.value<0.05 & precip.1950_2$Slope>=0]) #0.2560726
```

```{r}
ggplot(merge.name[which(merge.name$ID %in% precip.1950_2$ID[precip.1950_2$p.value<0.05 &
                                                       precip.1950_2$Slope>0]),],
       aes(Raw_Precip, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in%
                                precip.1950_2$ID[precip.1950_2$p.value<0.05 &
                                                   precip.1950_2$Slope<=0]),],
       aes(Raw_Precip, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```


#Figure 5C
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5c.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(merge.name.accpt, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1,size=0.25)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~Raw_Precip, data = merge.name.accpt))

```


```{r}
totalGDD <- lapply(HDD.yrs, function(x){
  max(x)
})
totalGDDyr <- data.frame(Year=1981:2011,MaxGDD = do.call(rbind,totalGDD))
head(totalGDDyr)
```

#5b -> 3d to go with the others
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 3d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point(size=0.5,shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab(expression(paste("GDD at ordinal date 273 (T"[base] == 0, degree*C,")")))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(MaxGDD~Year,data=totalGDDyr))

```



# Now merge GDD with merge.name
```{r}

min1950GDD_2 <- mergeMinGDD(merge.name.accpt,tmps)

length(unique(min1950GDD_2$day)) #1130  1128
length(unique(min1950GDD_2$scientificName)) #639  638
length(unique(min1950GDD_2$ID)) #467

#Years of data for GDD years per species
gdddatayrs <- as.data.frame(table(min1950GDD_2$Year,min1950GDD_2$ID))
yrspsp <- aggregate(gdddatayrs$Freq, by = list(gdddatayrs$Var2), FUN=sum)
# Group.1 = the ID; x = number of years of data

head(colSums(table(min1950GDD_2$Year,min1950GDD_2$ID)))
head(yrspsp)

nrow(yrspsp[yrspsp$x>=10,]) #308 -> 375 -> 366

### Reduce min1950GDD_2 to only species where 10 or more years of data
min1950GDD_2_10 <- merge(min1950GDD_2,yrspsp[yrspsp$x>=10,],
                         by.x="ID",by.y="Group.1")
length(unique(min1950GDD_2_10$ID)) #375 -> 366

```


#Figure 5A   
Average GDD for the ealiest collection date did! change significantly over the study years, just the r^2 is next to nothing
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5a.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDD_2_10, aes(Year,HDD))+
  geom_point(size=0.25, shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=6))

dev.off()


summary(lm(HDD~Year, data=min1950GDD_2_10))
```



See row 1280 for making of min1950GDD_2_10, with 10 or more years of data
Growing Degree Days - GDD at time of collection  ~ Year

```{r}
#reset between time of collection and next, max per year
#rm(results,rst)
#results <- lapply(unique(min1950GDD_2_10$ID), function(x){
  if(nrow(min1950GDD_2_10[min1950GDD_2_10$ID==x,])>=10){
  foo1 <- summary(lm(HDD~Year,data=min1950GDD_2_10[min1950GDD_2_10$ID==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          ID = x,
                          unique(min1950GDD_2_10$scientificName[min1950GDD_2_10$ID == x])[1],
                          unique(min1950GDD_2_10$Family[min1950GDD_2_10$ID == x])[1],
                          foo1$adj.r.squared,
                          N = nrow(min1950GDD_2_10[min1950GDD_2_10$scientificName==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF",
                   "ID", "Species","Family.Name","adj.r.squ","N")
  JYC
  }
  })


#rst <- do.call(rbind,results)
#head(rst)


rst1 <- JulBloomDate.min1950("HDD",min1950GDD_2_10)


nrow(rst1) #366
nrow(rst1[rst1$p.value<0.05,]) #364

min1950GDD_2_10[which(min1950GDD_2_10$ID %in% rst1$ID[rst1$denDF < 10]),]

#smaller HDD at time of collection
nrow(rst1[rst1$p.value<0.05 & rst1$Slope < 0,]) #0
mean(rst1$Slope[rst1$p.value<0.05 & rst1$Slope < 0]) # -NaN
mean(rst1$adj.r.squ[rst1$p.value<0.05 & rst1$Slope < 0]) #NaN

#bigger HDD at time of collection
nrow(rst1[rst1$p.value<0.05 & rst1$Slope >= 0,])  #364
mean(rst1$Slope[rst1$p.value<0.05 & rst1$Slope >= 0]) #0.08304057
mean(rst1$adj.r.squ[rst1$p.value<0.05 & rst1$Slope >= 0])  #0.7458853

#write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_table5a.csv", sep=",")
```

```{r}
ggplot(merge.name.accpt[which(merge.name.accpt$ID %in% rst1$ID[rst1$p.value<0.05 & 
                                                                rst1$Slope>=0]),],
       aes(Year, startDayOfYear, colour = AUTH.y))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```


# Informative part, like average precip, temp per year, does the earliest collection date change as the MaxGDD (up through ordinal day 273) changes per year?
#GDD high per year
```{r}

#Reset for time of collection and now max
rm(results,rst,min1950GDDmax)
min1950GDDmax <- merge(totalGDDyr,min1950GDD_2_10, by="Year")
#results <- lapply(unique(min1950GDDmax$ID), function(x){
#  if(nrow(min1950GDDmax[min1950GDDmax$ID==x,])>=10){
#  foo1 <- summary(lm(startDayOfYear~MaxGDD,data=min1950GDDmax[min1950GDDmax$ID==x,]))
#  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
#                          foo1$coefficients[1,1],
#                          t(foo1$fstatistic),
#                          ID = x,
#                          unique(min1950GDDmax$scientificName[min1950GDDmax$ID == x])[1],
#                          unique(min1950GDDmax$Family[min1950GDDmax$ID == x])[1],
#                          foo1$adj.r.squared,
#                          N = nrow(min1950GDDmax[min1950GDDmax$ID==x,])))
#  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
#                   "F Stat", "numDF","denDF",
#                   "ID", "Species","Family.Name","adj.r.squ","N")
#  JYC
#  }
#  })

#rst <- do.call(rbind,results)
# mean(rst$Slope)


min1950GDDmax <- merge(totalGDDyr,min1950GDD_2_10, by="Year")
rm(rst)
rst <- JulBloomDate.min1950("MaxGDD",min1950GDDmax)
  
  
nrow(rst) #366
nrow(rst[rst$p.value<0.05,]) #66

#earlier
nrow(rst[rst$p.value<0.05 & rst$Slope < 0,]) #65
mean(rst$Slope[rst$p.value<0.05 & rst$Slope < 0]) # -0.06514325
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope < 0]) #0.2729272

#later
nrow(rst[rst$p.value<0.05 & rst$Slope >= 0,]) #1
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                             rst$ID[rst$p.value<0.05 & rst$Slope>=0])]) #Sambucus racemosa L. var. racemosa
mean(rst$Slope[rst$p.value<0.05 & rst$Slope >= 0]) # 0.06436998
mean(rst$adj.r.squ[rst$p.value<0.05 & rst$Slope >= 0]) #0.2293882


write.table(rst,file="Q:/Research/Projects/alpine-phenology/GDD_max.Table5.csv", sep=",")
```

#Overall MaxGDD
```{r}
tiff("Q:/Research/Projects/alpine-phenology/Fig. 5d.tiff", width = 84, height = 75, compression="lzw", units = "mm", res=dpi)

ggplot(min1950GDDmax, aes( MaxGDD, startDayOfYear))+
  geom_point(shape=1, size=0.5)+
  geom_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab("Maximum annual GDD")+
  theme(axis.text=element_text(size=5),
        axis.title=element_text(size=7))

dev.off()

summary(lm(startDayOfYear~MaxGDD, data = min1950GDDmax))

```

Earlier with hotter overall
```{r}
ggplot(min1950GDDmax[which(min1950GDDmax$ID %in% 
                             rst$ID[rst$p.value<0.05 & rst$Slope<0]),], 
       aes(MaxGDD, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Maximum annual GDD")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```

later with hotter overall
```{r}
ggplot(min1950GDDmax[which(min1950GDDmax$ID %in% 
                             rst$ID[rst$p.value<0.05 & rst$Slope>=0]),], 
       aes(MaxGDD, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Maximum annual GDD")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```



NPN species   
(from Climate)    
```{r}
npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

#although lots of these might not have 10 years    
#Match names - synonyms and all
npn.big2 <- intersect(npn.all$SciName, merge.name$scientificName)
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big2) #28
length(npn.big) #68 -> 75

npn.all$SciName <- multisub(synonyms2$Species,
                                    synonyms2$SYNONYMS,npn.all$SciName)
npn.all <- npn.all[!is.na(npn.all$SciName),]

npn.big2 <- intersect(npn.all$SciName, merge.name$scientificName)
npn.big <- intersect(npn.all$SciName, bloom2$scientificName) 
length(npn.big2) #28
length(npn.big) #68 -> 75

head(synonyms.plantsyn.accpt)
npn.big3 <- intersect(npn.all$SciName, synonyms.plantsyn$SYNONYMS)
length(npn.big3) #214

npn.ID <- merge(npn.all, synonyms, by.x = "SciName", by.y = "SYNONYMS")
length(unique(npn.ID$ID)) #716

npn.min1950 <- merge(npn.ID, merge.name.accpt, by ="ID")
length(unique(npn.min1950$ID)) #29

29/467
```

# NPN only precip, high, low
###NPN year     
```{r}
yr.npn_2 <- JulBloomDate.min1950("Year",npn.min1950)

nrow(yr.npn_2) #29 
mean(yr.npn_2$Slope)

write.table(yr.npn_2, file = "Q:/Research/Projects/alpine-phenology/phenNPN_yr.csv", sep=",")
nrow(yr.npn_2[yr.npn_2$p.value<0.05,]) #5
nrow(yr.npn_2[yr.npn_2$p.value<0.05,])/nrow(yr.npn_2) #0.1724138

#earlier
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0,]) #5
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       yr.npn_2$ID[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0])])

mean(yr.npn_2$Slope[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #-0.5096975
mean(yr.npn_2$adj.r.squ[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]) #0.177051

#later
nrow(yr.npn_2[yr.npn_2$p.value<0.05 & yr.npn_2$Slope>=0,]) #0
```

```{r}

ggplot(npn.min1950, aes(Year, startDayOfYear)) +
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "black", size = 0.95)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal date")+
  scale_x_continuous(breaks = seq(1950,2011,10)) +
  theme(axis.text=element_text(size=9),
        axis.title=element_text(size=12)) 


summary(lm(startDayOfYear~Year, data=npn.min1950))
```

#Year earlier NPN
```{r}
ggplot(npn.min1950[which(npn.min1950$ID %in% 
                    yr.npn_2$ID[yr.npn_2$p.value<0.05 & yr.npn_2$Slope<0]),], 
       aes(Year, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Year")+
  ylab("Ordinal Date")+
  facet_wrap(~ID, scales ="free_x")#+
#  theme(legend.position="none")+
#  geom_dl(aes(label = ID), method = list(dl.combine("first.points","last.points"),
#                                             ces = 0.75)) # Oh, by the first and last points! 
  

```


###NPN high
```{r}
high.npn_2 <- JulBloomDate.min1950("Avg_Hi", npn.min1950)

nrow(high.npn_2) #29

write.table(high.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_high_2.csv", sep=",")

nrow(high.npn_2[high.npn_2$p.value<0.05,]) #3

#earlier
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope<0,]) #3

unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in%
                                       high.npn_2$ID[high.npn_2$p.value<0.05 &
                                                       high.npn_2$Slope<0])])

mean(high.npn_2$Slope[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #-9.284255
mean(high.npn_2$adj.r.squ[high.npn_2$p.value<0.05 & high.npn_2$Slope<0]) #0.1581989

#later
nrow(high.npn_2[high.npn_2$p.value<0.05 & high.npn_2$Slope>=0,]) #0
```
###NPN low
```{r}
low.npn_2 <- JulBloomDate.min1950("Avg_Lo", npn.min1950)

nrow(low.npn_2) #29
mean(low.npn_2$Slope)

write.table(low.npn_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_low_2.csv", sep=",")

nrow(low.npn_2[low.npn_2$p.value<0.05,]) #7
nrow(low.npn_2[low.npn_2$p.value<0.05,])/nrow(low.npn_2) #0.2413793

#earlier
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]) # 7

low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope<0,]

mean(low.npn_2$Slope[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #-12.11458
mean(low.npn_2$adj.r.squ[low.npn_2$p.value<0.05 & low.npn_2$Slope<0]) #0.2098808

#later
nrow(low.npn_2[low.npn_2$p.value<0.05 & low.npn_2$Slope>=0,]) #0
```


```{r}
ggplot(npn.min1950, aes(Avg_Lo, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab(expression("Average low"~degree*C))

summary(lm(startDayOfYear~Avg_Lo, data = npn.min1950))
```

#NPN low earlier
```{r}
ggplot(npn.min1950[npn.min1950$ID %in%
                    grep(paste(low.npn_2$ID[low.npn_2$p.value<0.05 & low.npn_2$Slope<0],
                               collapse="|"),low.npn_2$ID,
                         value=TRUE),], 
       aes(Year, startDayOfYear, colour = as.factor(ID)))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab(expression("Average low"~degree*C))+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```


###NPN precip
```{r}
precip.NPN_2 <- JulBloomDate.min1950("Raw_Precip", npn.min1950)

nrow(precip.NPN_2) #29

write.table(precip.NPN_2, file = "Q:/Research/Projects/alpine-phenology/phen_NPN_precip_2.csv", sep=",")

nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,]) #1
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05,])/nrow(precip.NPN_2) #0.07407407

#earlier
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0,]) #0
unique(bloom2$AUTH[bloom2$scientificName == precip.NPN_2$Species[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]])
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #-0.05782597
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope<0]) #0.1592876

#later
nrow(precip.NPN_2[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0,]) #1
unique(merge.name.accpt$AUTH.x[which(merge.name.accpt$ID %in%
                                 precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                                   precip.NPN_2$Slope>=0])])
mean(precip.NPN_2$Slope[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.09425329
mean(precip.NPN_2$adj.r.squ[precip.NPN_2$p.value<0.05 & precip.NPN_2$Slope>=0]) #0.4683842
```

```{r}


ggplot(npn.min1950, aes(Raw_Precip, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Raw_Precip, data = npn.min1950))
```


#precip later
```{r}
ggplot(npn.min1950[npn.min1950$ID %in% 
                    grep(paste(precip.NPN_2$ID[precip.NPN_2$p.value<0.05 &
                                              precip.NPN_2$Slope>=0],
                                          collapse="|"),precip.NPN_2$ID,
                         value=TRUE),], 
       aes(Raw_Precip, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")+
  theme(legend.position="none")

```



###NPN Growing Degree Days     
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)

minNPNGDDmax <- merge(minNPNGDD_2,totalGDDyr, by="Year")

npngdd <- data.frame(table(minNPNGDDmax$Year,minNPNGDDmax$ID))
names(npngdd)
colSums(table(minNPNGDDmax$Year,minNPNGDDmax$ID)) >=10

ID.10 <- aggregate(npngdd$Freq, list(npngdd$Var2), sum)
minNPNGDD_2 <- merge(minNPNGDDmax, ID.10[ID.10$x >=10,], by.x = "ID", by.y = "Group.1")

length(unique(minNPNGDD_2$ID)) #23

rst.npn <- JulBloomDate.min1950("MaxGDD", minNPNGDD_2)

nrow(rst.npn) #23
nrow(rst.npn[rst.npn$p.value<0.05,]) #2

#lower GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #2
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) #
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope< 0]) #
unique(merge.name.accpt$AUTH.y[which(merge.name.accpt$ID %in% 
                                rst.npn$ID[rst.npn$p.value<0.05 & rst.npn$Slope < 0])])

#bigger GDD
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) #0


write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a.csv", sep=",")
```


### Startdayofyear ~ MaxGDD for that year 
### CHANGE THIS TO INCLUDE ID
```{r}
minNPNGDD_2 <- mergeMinGDD(npn.min1950,tmps)
rm(results,rst)
minNPNGDD_2_max <- merge(totalGDDyr, minNPNGDD_2, by="Year")

results.npn <- lapply(unique(minNPNGDD_2_max$scientificName), function(x){
  if(nrow(minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,])>=10){
  foo1 <- summary(lm(startDayOfYear~MaxGDD,
                     data=minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(minNPNGDD_2_max[minNPNGDD_2_max$scientificName==x,]),
                          unique(minNPNGDD_2_max$Family[minNPNGDD_2_max$scientificName==x])),
                    unique(minNPNGDD_2_max$ID[minNPNGDD_2_max$scientificName==x]))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N","Fam","ID")
  JYC
  }
  })

rst.npn <- do.call(rbind,results.npn)

nrow(rst.npn) #22
rst.npn[rst.npn$p.value<0.05,] #Zigadenus elegans
nrow(rst.npn[rst.npn$p.value<0.05,]) #1

#earlier
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope < 0,]) #1
unique(bloom2$AUTH[bloom2$scientificName %in% 
                     grep(paste(
      rst.npn$Species[rst.npn$p.value<0.05 & rst.npn$Slope < 0]
      ,
                                collapse="|"), rst.npn$Species, value=TRUE)])
mean(rst.npn$Slope[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) # -0.05142886
mean(rst.npn$adj.r.squ[rst.npn$p.value<0.05 & rst.npn$Slope < 0]) #0.3363666

#later
nrow(rst.npn[rst.npn$p.value<0.05 & rst.npn$Slope >= 0,]) 
rst.npn$genus <- gsub(" .*$", "", rst.npn$Species)

write.table(rst.npn,file="Q:/Research/Projects/alpine-phenology/GDDNPN_table5a_MaxGDD.csv", sep=",")
```


```{r}
ggplot(minNPNGDD_2_max, aes(MaxGDD, startDayOfYear))+
  geom_point(shape=1)+
  stat_smooth(method="lm",colour = "dark grey", size = 0.5)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))

summary(lm(startDayOfYear~MaxGDD, data = minNPNGDD_2_max))
```

#NPN low earlier
```{r}
ggplot(minNPNGDD_2_max[minNPNGDD_2_max$ID %in%
                    grep(paste(rst.npn$ID[rst.npn$p.value<0.05 & rst.npn$Slope < 0],
                               collapse="|"),rst.npn$ID,
                         value=TRUE),], 
       aes(MaxGDD, startDayOfYear, colour = ID))+
  geom_point(shape=1)+
  stat_smooth(method="lm", alpha=0.05)+
  theme_bw()+
  ylab("Ordinal Date")+
  xlab(expression(paste("GDD at collection date (T"[base] == 0, degree*C,")")))+
  theme(legend.position="none")

```




############################################################################################
############################################################################################



```{r}
GH <- data.frame(table(merge.name.accpt$Growth.Habit[!duplicated(merge.name.accpt$ID)]))
GH[GH$Freq>0,]
sum(GH$Freq)#488 -> 467

# Number of Families represented!
length(table(merge.name.accpt$Family[!duplicated(merge.name.accpt$ID)])) #45

# Growth Habit numbers
table(merge.name.accpt$Growth.Habit[!duplicated(merge.name.accpt$ID)])
merge.name.accpt[merge.name.accpt$Growth.Habit == "",]
merge.name.accpt$Growth.Habit[merge.name.accpt$Growth.Habit == ""] <- "Forb/herb"

sum(  GH$Freq[GH$Var1 %in% grep("Forb", GH$Var1, value=TRUE)]) #337 Forb/herbs

sum(  GH$Freq[GH$Var1 %in% grep("Forb", grep("shrub", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #32 shrubs/subshrubs

sum(  GH$Freq[GH$Var1 %in% grep("Shrub", grep("Tree", GH$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE, ignore.case=TRUE)]) #3 trees


GD <- data.frame(table(merge.name.accpt$Duration[!duplicated(merge.name.accpt$ID)]))
GD[GH$Freq>0,]
sum(GD$Freq)#487 -> 467

# Duration
table(merge.name.accpt$Duration[!duplicated(merge.name.accpt$ID)])
merge.name.accpt$Duration[merge.name.accpt$Duration == ""] <- "Perennial"

sum(GD$Freq[GD$Var1 %in% grep("Biennial", grep("Annual", GD$Var1, value=TRUE, ignore.case=TRUE), value=TRUE, invert=TRUE)]) #12

NAT <- data.frame(table(merge.name.accpt$Native.Status[!duplicated(merge.name.accpt$ID)]))
NAT[NAT$Freq>0,]
sum(NAT$Freq)#487 -> 467

# Native status
sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE), "Freq"]) #466
sum(NAT[NAT$Var1 %in% grep("L48", NAT$Var1, value=TRUE, ignore.case=TRUE, invert = TRUE), "Freq"]) #1

merge.name.accpt[which(merge.name.accpt$Native.Status %in% "I"),] # none, all native

merge.name.accpt$Family.Name[merge.name.accpt$Family.Name == ""] <- "Boraginaceae"


```

# How many forbs vs. grasses vs. tree? How many 
#Smaller groups for Growth.Habit
```{r}
unique(merge.name.accpt$Growth.Habit[which(merge.name.accpt$Growth.Habit %in% "Graminoid")])

merge.name.accpt$Growth.Habit.sm <- "Graminoid"

merge.name.accpt$Growth.Habit.sm[which(merge.name.accpt$Growth.Habit %in% 
                                         "Graminoid")] <- "Graminoid"

merge.name.accpt$Growth.Habit.sm[which(merge.name.accpt$Growth.Habit %in% "Forb")] <- "Forb"

merge.name.accpt$Growth.Habit.sm[merge.name.accpt$Growth.Habit %in% 
                             grep("Forb", 
                                  grep("shrub", merge.name.accpt$Growth.Habit, 
                                       value=TRUE, ignore.case=TRUE), 
                                  value=TRUE, invert=TRUE)] <- "Shrubs"

merge.name.accpt$Growth.Habit.sm[merge.name.accpt$Growth.Habit %in% 
                             grep("Shrub", 
                                  grep("Tree", merge.name.accpt$Growth.Habit, 
                                       value=TRUE, ignore.case=TRUE), 
                                  value=TRUE, invert=TRUE, ignore.case=TRUE)] <- "Trees"

```

# By growth type
```{r}
ggplot(merge.name.accpt, aes(Year, startDayOfYear, colour = Growth.Habit.sm))+
  geom_point(shape=1)+
  stat_smooth(method="lm",size = 0.5)+
  theme_bw()+
  xlab(expression("Year"))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Year, data=merge.name.accpt))

```


```{r}
ggplot(merge.name.accpt, aes(Avg_Hi, startDayOfYear, colour = Growth.Habit.sm))+
  geom_point(shape=1)+
  stat_smooth(method="lm",size = 0.5)+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression("Average high"~degree*C))+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~Avg_Hi, data=merge.name.accpt))

```




```{r}
ggplot(minNPNGDD_2, aes(Year, HDD, group=Growth.Habit, colour=Growth.Habit))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5)+
  theme_bw()+
  ylab(expression(GDD))
```

# Appendix
```{r}
coll.year <- appd(yr.1950_2)
coll.high <- appd(high.1950_2)
coll.low <- appd(low.1950_2)
coll.precip <- appd(precip.1950_2)
coll.year.NPN <- appd(yr.npn_2)
coll.high.NPN <- appd(high.npn_2)
coll.low.NPN <- appd(low.npn_2)
coll.precip.NPN <- appd(precip.NPN_2)
# startDayOfYear ~ MaxGDD
coll.GDD <- appd(rst)
coll.GDD.npn <- appd(rst.npn)

appendixA.404 <- cbind(coll.year[,-6],
                       Year = coll.year$CollectionDate,
                       High = coll.high$CollectionDate,
                       Low = coll.low$CollectionDate,
                       Precip = coll.precip$CollectionDate)

appendixA <- merge(appendixA.404, coll.GDD, by = c("Family","Species","Sp","GrowthHabit","Duration"),
                   all=TRUE)

appendixA$NPN <- NA
appendixA$NPN[appendixA$Sp %in% grep(paste("^", paste(npn.min1950$SciName, collapse="|"),
                                       "$", sep=""),
                                 npn.min1950$SciName, value=TRUE)] <- "NPN"

write.table(appendixA,file="Q:/Research/Projects/alpine-phenology/AppendixA.csv", sep=",")
```


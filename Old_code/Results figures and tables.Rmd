---
title: "Alpine-phenology figures and tables"
author: "Michelle DePrenger-Levin"
date: "February 1, 2016"
output: html_document
---

Some data taken from "Climate.Rmd" will not be rerun (takes too long)   
   

```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)
# devtools::install_github("ropensci/prism")
library(prism)
library(MASS)
```

Bring csv in from the website
```{r, echo=FALSE}
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/QR_final_R_plant_climate_data_2.csv"))

head(bloom)
```

Rid of repeated yearly climate data for changes of average annual climate over time
```{r}
grep("Year",names(bloom)) #11, 19

climate <- unique(bloom[,c(19:length(bloom))])
head(climate)
```

##Figure 2a
```{r}
summary(lm(Avg_Hi~Year, data=climate))
ggplot(climate, aes(Year,Avg_Hi))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))
```

##Figure 2b     
```{r, echo=FALSE}
ggplot(climate, aes(Year,Avg_Lo))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab(~degree~C)+
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Lo~Year, data = climate))
```

##Figure 2c
```{r, echo=FALSE}
ggplot(climate, aes(Year,Raw_Precip))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))


summary(lm(Raw_Precip~Year, data = climate))
```

Number of species collected from herbarium before refining:   
```{r}
# number of years per species
yrs.specimens <- apply(table(bloom$Year,bloom$Scientific.Name),2,function(x){
  sapply(x,function(y){
    if(y>0){
      1
    } else {0}})
})

rowSums(yrs.specimens)
sort(colSums(yrs.specimens))
length(colSums(yrs.specimens)[colSums(yrs.specimens)<=10])

length(colSums(yrs.specimens)[colSums(yrs.specimens)>=10])


```

```{r}
sort(apply(table(bloom$Year,bloom$Scientific.Name),2,max))
sort(apply(table(bloom$Year,bloom$Scientific.Name),2,function(x){
  min(do.call(c,sapply(x,function(y){
    if(y==1) NA
  })),na.rm = T)
}))

```


Appendix A
```{r}
head(min1950)
write.table(rowSums(table(min1950$Scientific.Name,min1950$Year)), file = "Q:/Research/Projects/alpine-phenology/AppendixA_r.csv", sep=",")
```

Pull out the earliest bloom date per year per species   

```{r}

minJul.dates <- lapply(unique(bloom$sppListID), function(x){
  this.species <- bloom[bloom$sppListID == x,c(4:5,11,19:26)]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species, these.rows, by = c("startDayOfYear","Year")))
  })

names(minJul.dates) <- unique(bloom$sppListID)

min.dates <- do.call(rbind,minJul.dates)

#Fix spelling error
min.dates <- as.data.frame(sapply(min.dates, gsub, 
                                  pattern = "coerulea", 
                                  replacement = "caerulea"))

#Fix double space in Hierochola hirta
min.dates <- as.data.frame(sapply(min.dates, gsub,
                                  pattern="Hierochlo  hirta",
                                  replacement = "Hierochlo hirta"))


tonumeric <- c(1:2,4:length(min.dates))
min.dates[,tonumeric] <- sapply(min.dates[,tonumeric], function(s){
  as.numeric(as.character(s))
})

```


##Figure 1
```{r}
earliestcollection <- data.frame(colSums(table(min.dates$sppListID,
                                                min.dates$Year)))
earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
max(earcol$Collections)
earcol[which.max(earcol$Collections),]
mean(earcol$Collections)
```
START HERE!!!
```{r}
ggplot(earcol, aes(Year, Collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Number of Study Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10))

```

Compare to all collections, not just earliest, for alpine in CO from SEINet
```{r}
#allalpine <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/CO_SEINet_3200csv.csv"))
allalpine <- bloom


allcollections <- data.frame(colSums(table(allalpine$sppListID,allalpine$year)))
allcol <- data.frame(Year = row.names(allcollections),
                     allcollections)
colnames(allcol)[2] <- "collections"

as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
allcol[,1] <- as.numeric.factor(allcol[,1])
allcol<-allcol[allcol$Year!=4,]
```

```{r}
ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2015), breaks = seq(1950,2015, by=10))+
  scale_y_continuous(limits = c(0,3680),breaks = seq(0,3700, by=200))
```
```{r}
ggplot(allcol,  aes(x = Year, y = collections))+
  geom_bar(stat="identity")+
  stat_density(aes(y=..density..))+
  xlab("Year")+
  ylab("Total Collections")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2015), breaks = seq(1950,2015, by=10))+
  scale_y_continuous(limits = c(0,80))
```
```{r}
ggplot(allcol, aes(Year, collections, group = 1))+
  geom_line()+
  stat_smooth()+
  xlab("Year")+
  ylab("Number of Study Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10))

```

## This repeats climate for every specimen sampled, want to just see change over time
Figure 2a
Avg high temperature     
```{r, echo=FALSE}
ggplot(min1950, aes(Year,Avg_Hi))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
#  stat_smooth(geom = "smooth")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab(expression(~degree~C)) + #ylab(expression("Average high temperature"~degree~C))
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Hi~Year, data=min1950))

```

Figure 2b     
```{r, echo=FALSE}
ggplot(min1950, aes(Year,Avg_Lo))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab(~degree~C)+
  scale_x_continuous(breaks = seq(1950,2011,10))

summary(lm(Avg_Lo~Year, data = min1950))
```

Figure 2c
```{r, echo=FALSE}
ggplot(min1950, aes(Year,Raw_Precip))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")+
  scale_x_continuous(breaks = seq(1950,2011,10))


summary(lm(Raw_Precip~Year, data = min1950))
```


#Now we want repeated climate for each start day of year
##Figure 3a
```{r, eval=FALSE}
ggplot(min1950, aes(Avg_Hi, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab(expression(~degree~C))+
  ylab("Julian Date")

summary(lm(startDayOfYear~Avg_Hi, data=min1950))
```

##Figure 3b

```{r}
ggplot(min1950, aes(Avg_Lo, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab(expression(~degree~C))+
  ylab("Julian Date")

summary(lm(startDayOfYear~Avg_Lo, data = min1950))
```

##Figure 3c
```{r}
ggplot(min1950, aes(Raw_Precip, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Raw_Precip, data = min1950))
```


#Daily temperatures for growing degree days
```{r, eval=FALSE}
latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)
# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

```

```{r, eval=FALSE}
tbase <- 0

HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})
  
HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all

nrow(min.dates[min.dates$Year > 1980,]) # 4404

#min.dates <- merge(min.dates, tmps, 
#                   by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))

min1950GDD <- mergeMinGDD(min1950,tmps)

length(unique(min1950GDD$day)) #824
```




##Figure 4a.  Growing Degree Days (GDD)    
Only data from 1981 - 2011   
Average HDD? per year
```{r}
ggplot(min1950GDD, aes(Year,HDD)) +
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title="Cumulative Growing Degree Days (GDD) by Bloom Date")+
  xlab("Year")+
  ylab("GDD per First Bloom")

summary(lm(HDD~Year, data=min1950GDD))

```

Figure 4b     
HDD.yrs is the cumsum of the HDD over each year Jan-Julian date 273 (274 for leap years) the latest blooming first bloom date
```{r}
avg.HDD.yrs <- lapply(HDD.yrs, function(x){
  mean(x)
})

avg.yrs <- do.call(c, avg.HDD.yrs)
hddyrs <- data.frame(Year=1981:2011, avgHDD = avg.yrs)


ggplot(hddyrs, aes(Year, avgHDD))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average cumulative GDD by Year")+
  xlab("Year")+
  ylab("Cumulative GDD")

summary(lm(avgHDD~Year, data=hddyrs))

```

# Figure 4a 
```{r}
ggplot(min1950GDD, aes(Year,HDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("cummulative GDD at collection date")

summary(lm(HDD~Year, data=min1950GDD))

```

#Figure 4b   
is the total accumulated GDD getting more each year?   
```{r}
totalGDD <- lapply(HDD.yrs, function(x){
  max(x)
})
totalGDDyr <- data.frame(Year=1981:2011,MaxGDD = do.call(rbind,totalGDD))
head(totalGDDyr)

ggplot(totalGDDyr, aes(Year,MaxGDD))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Maximum cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("Year")+
  ylab("cummulative GDD at end of year")
summary(lm(MaxGDD~Year,data=totalGDDyr))
```

was: Figure 4c
```{r}
ggplot(min1950GDD, aes(HDD,startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()+
  labs(title= expression("Cumulative GDD (Tbase = 0"~degree*C~")"))+
  xlab("GDD")+
  ylab("Julian Date")

summary(lm(startDayOfYear~HDD, data=min1950GDD))

```


LM summary results 
1980:2011
```{r}
summary(lm(Avg_Hi~Year, data=min1950GDD))
summary(lm(Avg_Lo~Year, data=min1950GDD))
summary(lm(Raw_Precip~Year, data=min1950GDD))
```

1950:2010  
variable by year
```{r}
summary(lm(Avg_Hi~Year, data=min1950))
summary(lm(Avg_Lo~Year, data=min1950))
summary(lm(Raw_Precip~Year, data=min1950))
```

1950:2010
First bloom by variable   
```{r}
summary(lm(startDayOfYear ~ Avg_Hi, data=min1950))
summary(lm(startDayOfYear ~ Avg_Lo, data=min1950))
summary(lm(startDayOfYear ~ Raw_Precip, data=min1950))
```


Phenology summary table
```{r}
yr.1950 <- JulBloomDate.subset("Year",min1950)
write.table(yr.1950, file = "Q:/Research/Projects/alpine-phenology/phenology_summary.csv", sep=",")
```

## make sure I didn't change names in the excel sheets from the original ... I think that's why I'm missing some signficant ones for the tables.   
Families per species
```{r}
fams <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/phenology_summary.csv"))

head(fams)

```

```{r}
nrow(yr.1950)
nrow(yr.1950[yr.1950$p.value>=0.05,])
nrow(yr.1950[yr.1950$p.value<0.05,])
sig.yr.1950 <- yr.1950[yr.1950$p.value<0.05,]
nrow(sig.yr.1950)
foo1 <- merge(fams[,c(2,4)],sig.yr.1950, by = "Species")
nrow(foo1)
write.table(foo1, file = "Q:/Research/Projects/alpine-phenology/phenology_summaryYearsig.csv", sep=",")


```

```{r}
high.1950 <- JulBloomDate.subset("Avg_Hi", min1950)
write.table(high.1950, file = "Q:/Research/Projects/alpine-phenology/phenology_summary_high.csv", sep=",")
foo2 <- merge(fams[,c(2,4)], high.1950[high.1950$p.value<0.05,])
nrow(high.1950[high.1950$p.value<0.05,])
nrow(foo2)
write.table(foo2, file = "Q:/Research/Projects/alpine-phenology/phenology_summaryhighsig.csv", sep=",")
nrow(high.1950[high.1950$p.value<0.05,])
nrow(high.1950[high.1950$p.value>=0.05,])

```


```{r}
low.1950 <- JulBloomDate.subset("Avg_Lo", min1950)
write.table(low.1950, file = "Q:/Research/Projects/alpine-phenology/phenology_summary_low.csv", sep=",")
nrow(low.1950)
foo3 <- merge(fams[,c(2,4)], low.1950[low.1950$p.value<0.05,])
nrow(foo3)
write.table(foo3, file = "Q:/Research/Projects/alpine-phenology/phenology_summarylowsig.csv", sep=",")

nrow(low.1950[low.1950$p.value<0.05,])
nrow(low.1950[low.1950$p.value>=0.05,])

```



```{r}
precip.1950 <- JulBloomDate.subset("Raw_Precip", min1950)
write.table(precip.1950, file = "Q:/Research/Projects/alpine-phenology/phenology_summary_Raw_Precip.csv", sep=",")
nrow(precip.1950)
foo4 <- merge(fams[,c(2,4)], precip.1950[precip.1950$p.value<0.05,])
nrow(foo4)
write.table(foo4, file = "Q:/Research/Projects/alpine-phenology/phenology_summaryprecipsig.csv", sep=",")

# later date
nrow(precip.1950[precip.1950$p.value<0.05 & precip.1950$Slope > 0,])
mean(precip.1950$Slope[precip.1950$p.value<0.05& precip.1950$Slope > 0])
# earlier date
nrow(precip.1950[precip.1950$p.value<0.05 & precip.1950$Slope < 0,])
mean(precip.1950$Slope[precip.1950$p.value<0.05& precip.1950$Slope < 0])

nrow(precip.1950[precip.1950$p.value>=0.05,])

```

#NPN species   
from Climate.Rmd
```{r}
m.a.s.1
table(npnonly$Scientific.Name)

table(npnonly$Scientific.Name, npnonly$Year)
rowSums(table(npnonly$Scientific.Name, npnonly$Year))
nrow(table(npnonly$Scientific.Name, npnonly$Year)) #17


```

# don't want this for GDD:
```{r}
GDD.1981 <- JulBloomDate.subset("HDD", min1950GDD)
write.table(GDD.1981, file = "Q:/Research/Projects/alpine-phenology/phenology_summary_GDD.csv", sep=",")
nrow(GDD.1981)
foo5 <- merge(fams[,c(2,4)], GDD.1981[GDD.1981$p.value<0.05,])
nrow(foo5)
write.table(foo5, file = "Q:/Research/Projects/alpine-phenology/phenology_summaryGDDsig.csv", sep=",")

ggplot(min1950GDD,aes(HDD,startDayOfYear,group=Scientific.Name))+
  geom_point()+
  geom_smooth(method="lm", alpha = 0.05)+
  theme(legend.position="none")
  

head(GDD.1981)
nrow(GDD.1981[GDD.1981$p.value<0.05 & GDD.1981$Slope > 0,])
mean(GDD.1981$Slope[GDD.1981$p.value<0.05& GDD.1981$Slope > 0],na.rm = TRUE)

nrow(GDD.1981[GDD.1981$p.value>=0.05,])

```
# want THIS for GDD:   
```{r}
ggplot(min1950GDD, aes(Year, HDD, group=Scientific.Name))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD[cum]))

results <- lapply(unique(min1950GDD$Scientific.Name), function(x){
  foo1 <- summary(lm(HDD~Year,data=min1950GDD[min1950GDD$Scientific.Name==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(min1950GDD[min1950GDD$Scientific.Name==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  })


results[[1]]
rst <- do.call(rbind,results)
head(rst)


nrow(rst)
rst[rst$p.value<0.05,]

rst[is.na(rst$adj.r.squ),] # Kobresia schoenoides and Carex misandra have two records
rst1 <- rst[complete.cases(rst),] 
nrow(rst1[complete.cases(rst1),]) #288, removing the two with only two records. 
nrow(rst1)

nrow(rst1[rst1$p.value<0.05,]) #16
rst1 <- merge(fams[,c(2,4)],rst1, by="Species")

nrow(rst1[rst1$p.value>=0.05,])#272
nrow(rst1[rst1$p.value<0.05 & rst1$Slope >0,])#7
rst1[rst1$p.value<0.05 & rst1$Slope >0,]
write.table(rst1[rst1$p.value<0.05 & rst1$Slope >0,],
            file="Q:/Research/Projects/alpine-phenology/table5a.csv", sep=",")
nrow(rst1[rst1$p.value<0.05 & rst1$Slope <=0,])#9
write.table(rst1[rst1$p.value<0.05 & rst1$Slope <=0,],
            file="Q:/Research/Projects/alpine-phenology/table5b.csv", sep=",")


ggplot(min1950GDD, aes(Year, HDD, group=Scientific.Name))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD[cum]))


```


Figure : First day of accumulated GDD each year
```{r}
hdd.first <- lapply(HDD.yrs, function(x){
  min(which(x>0))
})

hdd.first.all <- do.call(c,hdd.first)
hdd.f <- data.frame(Year=1981:2011, FirstGDD = hdd.first.all)

ggplot(hdd.f, aes(Year,FirstGDD))+
  geom_point()+
  stat_smooth(method="lm")+
 # stat_smooth(method="loess",colour="green")+
  theme_bw()+
  labs(title="First cumulative GDD above zero")+
  xlab("Year")+
  ylab("Julian Date")

summary(lm(FirstGDD~Year, data=hdd.f))$coefficients

```


Plot a line for each year? 
```{r}
length(HDD.yrs[[1]])
length(HDD.yrs[[4]])
col.hdd.yrs <- lapply(HDD.yrs, function(x) x[1:273])
col.hdd.yrs <- do.call(cbind,col.hdd.yrs)
head(col.hdd.yrs)

meltd<-melt(col.hdd.yrs)
tail(meltd)
names(meltd) <- c("Day","Year","GDD")

ggplot(meltd, aes(Day,GDD, colour=factor(Year)))+
  stat_smooth(method="loess")

# group by decade?
meltd$Decade <- 3
meltd$Decade[meltd$Year<21] <- 2
meltd$Decade[meltd$Year<11] <- 1

ggplot(meltd, aes(Day,GDD,colour=factor(Decade)))+
  stat_smooth(method = "lm")

summary(lm(GDD~Day*Year, data=meltd))
```


## want to plot the coefiecent for each accumulation of GDD curve over years
```{r}
par(mfrow=c(2,2))
curve(x^2, from=1,to=100)
curve(x^(1/2), from=1,to=100)
curve(x^3, from=1,to=100)
curve(x^4, from=1,to=100)

par(mfrow=c(1,1))
lm.sum <- lapply(unique(meltd$Year), function(x){
  summary(lm(GDD~Day+I(Day^2), data=meltd[meltd$Year == x,]))
})

coefficients(lm.sum[[1]])[3,1]
lm.sum[2]

lm.coef <- lapply(lm.sum, function(x){
  coefficients(x)[3,1]
})

toplot <- data.frame(Year=1981:2011, sqcoef = do.call(rbind,lm.coef))
ggplot(toplot, aes(Year,sqcoef))+
  geom_point()+
  geom_smooth(method="lm")
summary(lm(sqcoef~Year, data=toplot))

```


```{r}
avg.HDD.yrs <- lapply(HDD.yrs, function(x){
  mean(x)
})


avg.yrs <- do.call(c, avg.HDD.yrs)
hddyrs <- cbind(Year=1981:2011, avgHDD = avg.yrs)


ggplot(data.frame(hddyrs), aes(Year, avgHDD))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average cumulative HDD by Year")+
  xlab("Year")+
  ylab("Cumulative HDD")


max.HDD.yrs <- lapply(HDD.yrs, function(x){
  max(x)
})

max.yrs <- do.call(c, max.HDD.yrs)
hddmaxyrs <- cbind(Year=1981:2011, maxHDD = max.yrs)

ggplot(data.frame(hddmaxyrs), aes(Year, maxHDD))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Cumulative GDD by Year")+
  xlab("Year")+
  ylab("Cumulative HDD")

summary(lm(maxHDD~Year,data=data.frame(hddmaxyrs)))

```

stepAIC models. Find the secant of the accumulation of GDD curve. First pick the best curve model for the data (for GDD/day each year. )
```{r}
head(meltd)
max(meltd$Day) #273 the day of the latest colleciton

fit1 <- lapply(unique(meltd$Year), function(x){
  stepAIC(lm(GDD~Day+I(Day^2), data=meltd[meltd$Year==x,]),
          scope = lm(GDD~1, data=meltd[meltd$Year==x,]),
          direction = "backward")
})

fit1[[29]]$coefficients[3]
summary(fit1[[2]])

ggplot(meltd, aes(Day,GDD,colour=factor(Year)))+
  stat_smooth()

xx <- seq(0,273,length.out = 273)
length(xx)
length(predict(fit1[[1]]))
plot(meltd$Day,meltd$GDD,pch=1, cex=0.25)
lines(xx,predict(fit1[[1]]),lwd=2, col = "#000000")

lapply(fit1,function(x){lines(xx,predict(x))})

# can't get it with different colors
palette <- colorRampPalette(colors=c("#000000", "#FFFFFF"))
colfunc<-colorRampPalette(c("red","yellow","springgreen","royalblue"))
colfunc(31)
cols <- as.factor(colfunc(31)) #palette(31)
mapply(function(y,x){lines(xx,predict(y), lwd=2, col = y)},
       y = fit1, x = cols, SIMPLIFY = FALSE)


lines(xx,predict(fit1[[1]]), col="blue", lwd=2)
lines(xx,predict(fit1[[20]]),col="red", lwd=2)
lines(xx,predict(fit1[[30]]),col="yellow", lwd=2)
``` 

#Figure 4b
```{r}
#install.packages("polynom")
#library(polynom)
as.function(polynomial(coef(fit1[[1]])))(273)
as.function(polynomial(coef(fit1[[1]])))(100)


poly.p <- lapply(fit1, function(fx){
  polynomial(coef(fx))
})
sday <- 1
eday <- 273

secant.poly <- lapply(poly.p,function(x){
  ((as.function(x)(eday)+1000) - (as.function(x)(sday)+1000))/(eday-sday)
})
secant.poly.all <- data.frame(Year=1981:2011, 
                              Secant= do.call(rbind,secant.poly))

ggplot(secant.poly.all, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  ylab("Average rate of change in GDD (day 1 to 273)")

summary(lm(Secant~Year, data=secant.poly.all))
```

#Figure 4C  
accumulation of GDD faster related to julian day per year
```{r}
head(secant.poly.all)
min1950GDDsecant <- merge(min1950GDD, secant.poly.all,by="Year")
head(min1950GDDsecant)

ggplot(min1950GDDsecant, aes(Secant,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by average rate of GDD accumulation") +
  xlab("Average rate of GDD accumulation")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Secant, data=min1950GDDsecant))
```

No no
```{r}

f_x <- lapply(fit1, function(x){
  data.frame(m1 = x$coefficients[2],
             m2 = x$coefficients[3],
             b = x$coefficients[1])
})

f_x[[1]]

```
 No no no  
```{r}
#f(x) = m1x + m2x^2 + b
# secant from day 50 to day 273?
# change in y=GDD over x=day
# change of Day 2 to day 273
secant <- lapply(f_x,function(fx){
  (((fx$m1*273)+(fx$m2*273)+(fx$b+1000))-((fx$m1*50)+(fx$m2*50)+(fx$b+1000)))/(273-50)
})

secant1 <- do.call(rbind,secant)
length(secant1)
secant2<-data.frame(Year=1981:2011,Secant=secant1)
ggplot(secant2, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm")
```


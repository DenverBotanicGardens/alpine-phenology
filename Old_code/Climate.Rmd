---
title: "Alpine Phenology"
author: "M. DePrenger-Levin and RA Hufft"
date: "August 28, 2015"
output:
  word_document: default
  pdf_document:
    latex_engine: xelatex
---

If you need these packages
`install.packages("RCurl")`      
`install.packages("ggplot2")`     
`install.packages("data.table")`
'install.packages("curl")'
install.packages("Rcpp")

#Try a `rm(list=ls())` before running

```{r}
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
```

Bring csv in from the website
I get an error: `Error in str.default(obj, ...) : invalid multibyte string 2` but will see if it matters...   
looks like it's the lat long that didn't get in correctly
```{r, echo=FALSE}
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/QR_final_R_plant_climate_data_2.csv"))

head(bloom)
```

About the data:
```{r}
length(unique(bloom$sppListID)) #290
datatbl <- as.data.frame(table(bloom$sppListID, bloom$Year))

# length of years that aren't zero
# Var1 is the sppListID - unique identifier per species
# Var2 is the number of bloomdates for that species:year (Var1:Var2)
yrswithdata <- lapply(unique(datatbl$Var1), function(x){
  length(datatbl$Var2[datatbl$Var1 == x & datatbl$Freq > 0]) #not consecutive years
}) 

sort(do.call(c,yrswithdata)) # years of data (not consecutive) 9 to 44


```

If not working to load from github:
```{r}
#bloom<-read.csv(path.expand("P:/alpine-phenology/QR_final_R_plant_climate_data.csv"))

#Bring in Q/All.Projects_by_species/aa_Spapefiles_Maps/aa_QGIS Projects/AlpinePhenologyproject/

#bloom<-read.csv(path.expand("P:/alpine-phenology/TB_tempPrecipData.csv"),        
#                header = TRUE, as.is=TRUE)   
```

# Add growing degree days   
White etal 2015     
Cumulative Growing Degree Days 
$\sum_{i=1}^{n} \left(T_{mean} - T_{base})$   
$T_{base}$ should be the lowest air temperature when flowering will occur    
Temperature Threshold and GDD models...
       
 McMaster and Wilhelm 1997:      
Tbase = -10    
Corn $T_{base} = 10$   
Winter wheat $T_{base} = 0$   
temperature below which the process of interest does not progress
$$GDD = \frac{T_{MAX} + T_{MIN}}{2} - T_{BASE}$$   
Growing degree days in csv is wrong - not cummulative

```{r}
#created new column that divides Raw_precip by 100 (see PRISM documentation) to get mm
head(bloom)
names(bloom)
str(bloom)  #tells me column name, data type and examples, errors in lat long when brought in from web

#Climate data figures
#This section runs linear regression on Avg High temp by Year
#hist(bloom$Avg_Hi)
plot(bloom$Year,bloom$Avg_Hi, main="Average High Temperature by Year",xlab="Year", ylab="Degrees Celsius")
abline(lm(bloom$Avg_Hi~bloom$Year))
summary(lm(bloom$Avg_Hi~bloom$Year))
#plot(lm(bloom$Avg_Hi~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```

```{r}
#This section runs linear regression on Avg Low temp by Year
#hist(bloom$Avg_Lo)
plot(bloom$Year,bloom$Avg_Lo, main="Average Low Temperature by Year",xlab="Year", ylab="Degrees Celsius")
abline(lm(bloom$Avg_Lo~bloom$Year))
summary(lm(bloom$Avg_Lo~bloom$Year))
#plot(lm(bloom$Avg_Lo~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```

### not cumulative GDD
### This section runs linear regression on GDD by Year
```{r}
#hist(bloom$GDD)
#hist(bloom$GDD2) #if Tbase is -10
plot(bloom$Year,bloom$GDD, main="Average Growing Degree Days by Year",xlab="Year", ylab="Degrees Celsius")
abline(lm(bloom$GDD~bloom$Year))
summary(lm(bloom$GDD~bloom$Year))
#plot(lm(bloom$Avg_Lo~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity


ggplot(bloom, aes(Year,GDD)) +
  geom_point()+
  stat_smooth() #uses loess()
```

```{r}

#This section runs linear regression on Precipitation by Year
hist(bloom$Raw_Precip)
plot(bloom$Year,bloom$Raw_Precip, main="Precipitation by Year",xlab="Year", ylab="Precipitation (mm)")
abline(lm(bloom$Raw_Precip~bloom$Year))
summary(lm(bloom$Raw_Precip~bloom$Year))
#plot(lm(bloom$Raw_Precip ~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```



#Graph just the significant spp by year to see how many days earlier for these species that are showing a signal by year
#re-run code that runs regressions on each species to create table to subset from
#Limit all data to after 1949, 7220 obs. from table (7217 obs. from query in Access)
```{r}

bl50 <- subset(bloom, bloom$year_plant > 1949) #Our dataset already has this subset but re-running as a double check

nrow(bl50)
nrow(subset(bloom, bloom$year_plant > 1949))

str(bl50)
head(bl50)
```


# All bloom dates, not just the earliest per year per species

```{r}
 names <- unique(bl50$Scientific.Name)		# Names includes synonyms, sspListID contains unique taxa
 namesID <- unique(bl50$sppListID)
length(namesID)	# 290
head(namesID)
names(bl50)

#There are multiple bloom dates per year for many species. Want to narrow down to one, earliest, per year
head(table(bl50$sppListID, bl50$Year))

collections<-data.frame(table(bl50$sppListID,bl50$Year))

ggplot(collections, aes(Var2, Freq))+
  geom_boxplot()+
  stat_smooth()+
  xlab("Year")+
  ylab("Number of Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))
```
# When are collections made
```{r}
ggplot(bl50, aes(x=startDayOfYear))+
  geom_histogram(position="identity",binwidth = 7)+
  xlim(0,365)+
  xlab("Julian Day")+
  labs(title="Alpine Collections")

```
# When are collections made
```{r}
bl50.gr <- data.frame(bl50, Group=
                    
mapply(
  
  bl50,1,function(x){
  if(bl50$Year <= 1951+(20*x)){
    x
  }
})

)

ggplot(bl50.gr, aes(x=startDayOfYear))+
  geom_histogram(position="identity",binwidth = 7)+
#  xlim(0,365)+
  xlab("Julian Day")+
  labs(title="Alpine Collections")+
  facet_wrap(~Group)

lm.1 <- summary(lm(startDayOfYear~Year, data=bl50))
lm.1$coefficients[2,1]*365.25
#22.85 days earlier - per year, right?

```


# collections per month
```{r}
collJ <- data.frame(table(bl50$sppListID, bl50$startDayOfYear))

ggplot(collJ, aes(Var2, Freq, group =1))+
  stat_smooth()+
  xlab("Julian date")+
  ylab("Collections per species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  labs(title="All collections per species")

# collections getting 

collJ.sp <- data.frame(table(bl50$Year,bl50$startDayOfYear))

ggplot(collJ.sp, aes(Var2, Freq, group =Var1, colour = Var1))+
  stat_smooth(level = 0)+
  xlab("Julian date")+
  ylab("Collections per species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  labs(title="All collections per species")

collJ.max <- lapply(split(collJ.sp, collJ.sp$Var1), function(x) x[which.max(x$Freq),])
collmax <- do.call(rbind,collJ.max)
collmax[,1:2]<-sapply(collmax[,1:2], function(x) as.numeric(as.character(x)))

mean(collmax$Var2)
max(collmax$Var2)
min(collmax$Var2)
collmax[which.min(collmax$Var2),]
collmax[which.max(collmax$Var2),]
summary(lm(Var2~Var1, data=collmax))
```


Don't worry about bloom vs. bl50, they are identical... and other checks    
```{r}
#bl50 and bloom are the same
identical(bl50, bloom)

#There should be 290 species
length(unique(bl50$sppListID))

#Only need some columns of bloom:bl50 for minimum julian dates
names(bl50[,c(4:5,11,19:28)])
```


Pull out the earliest bloom date per year per species
## Break up the function into gathering the earliest bloom day per year seperate from regression per species
## Earliest bloom date held in min.dates
Aggregate instead of apply?
Much faster and more corrector!
```{r}

minJul.dates <- lapply(unique(bl50$sppListID), function(x){
  this.species <- bl50[bl50$sppListID == x,c(4:5,11,19:28)]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species, these.rows, by = c("startDayOfYear","Year")))
  })

names(minJul.dates) <- unique(bl50$sppListID)

head(minJul.dates[[219]])

min.dates <- do.call(rbind,minJul.dates)

#Fix spelling error
min.dates <- as.data.frame(sapply(min.dates, gsub, 
                                  pattern = "coerulea", 
                                  replacement = "caerulea"))

#Fix double space in Hierochola hirta
min.dates <- as.data.frame(sapply(min.dates, gsub,
                                  pattern="Hierochlo  hirta",
                                  replacement = "Hierochlo hirta"))


tonumeric <- c(1:2,4:13)
min.dates[,tonumeric] <- sapply(min.dates[,tonumeric], function(s){
  as.numeric(as.character(s))
})

head(table(min.dates$Year, min.dates$sppListID))

```


#Check that there is only one minimum date per year
```{r}
minpyear <- table(min.dates$Year, min.dates$sppListID)
mpy.df <- data.frame(minpyear)
mpy.df[mpy.df$Freq > 1,] 
```

```{r}
library(psych)
#cor.plot(cor(min.dates[,-(1:4)]), numbers = TRUE)
# should keep Raw_Precip and Avg_Lo

cor(min.dates[,-(1:4)])

#getting a ggplot error of "Error in .Call.graphics(C_palette2, .Call(C_palette2, NULL)) : 
#  invalid graphics state"

#fix error by running dev.off()
# dev.off()

```

## Subsetted data to only earliest bloom observation

ggplot option after subset to earliest observation per year per species    
Avg high temperature    
```{r}
ggplot(min.dates, aes(Year,Avg_Hi))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab("Degrees Celsius")

summary(lm(Avg_Hi~Year, data=min.dates))

```

```{r}
ggplot(min.dates, aes(Avg_Hi, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab("Degrees Celsius")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Avg_Hi, data=min.dates))
```

Average low temperature
```{r}
ggplot(min.dates, aes(Year,Avg_Lo))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab("Degrees Celsius")

summary(lm(Avg_Lo~Year, data = min.dates))

```

```{r}
ggplot(min.dates, aes(Avg_Lo, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab("Degrees Celsius")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Avg_Lo, data = min.dates))
```



Average precipitation
```{r}
ggplot(min.dates, aes(Year,Raw_Precip))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")


summary(lm(Raw_Precip~Year, data = min.dates))
```

```{r}
ggplot(min.dates, aes(Raw_Precip, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Raw_Precip, data = min.dates))
```


### Minimum Julian bloom date by year
```{r}
ggplot(min.dates, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

summary(lm(min.dates$startDayOfYear~min.dates$Year))
max(min.dates$startDayOfYear)
```
    
    
    
Graph of all spp data by year using plot instead of ggplot

```{r}
#bloom<-read.csv(path.expand("P:/alpine-phenology/QR_final_R_plant_climate_data.csv"),        
#                header = TRUE, as.is=TRUE)   
hist(min.dates$startDayOfYear)#need to log transform data

plot(min.dates$Year,min.dates$startDayOfYear, main="First Collection Date for All 
Species",xlab="Year", ylab="Julian Date")
abline(lm(min.dates$startDayOfYear~min.dates$Year))
summary(lm(min.dates$startDayOfYear~min.dates$Year)) 
#both intercept and slope significant. If include all data, the date of first collection is statistically earlier by 0.062563/year, or 3.75 days earlier over the course of the study period. 
#plot(lm(bloom$startDayOfYear ~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```

Collections now that data is only earliest bloom date
```{r}
earliestcollection <- data.frame(colSums(table(min.dates$sppListID,
                                                min.dates$Year)))
earcol <- data.frame(Year = row.names(earliestcollection),
                     Collections = earliestcollection)
colnames(earcol)[2] <- "Collections"
earcol[,1] <- as.numeric(levels(earcol[,1]))
max(earcol$Collections)
earcol[which.max(earcol$Collections),]
mean(earcol$Collections)

ggplot(earcol, aes(Year, Collections, group = 1))+
  geom_line()+
  stat_smooth()+
  xlab("Year")+
  ylab("Number of Species")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10))


```


#Regression per species
#updated regression loop to match pulling minimum dates above    
The variable can be set to which variable you want to use. Choose from "Year", "Raw_Precip", "Avg_Hi", or "Avg_Lo"...    

```{r}
JulBloomDate <- function(variable){
  namesID <- unique(min.dates$sppListID)
  
  #Which column number has the variable of interest
  colnum <- match(variable,names(min.dates))
  
  JYC <- lapply(namesID, function(x){
    blnew <- min.dates[min.dates$sppListID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$Scientific.Name[1],
                                    foo1$adj.r.squared))
    })
  
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}
```


# "Year" regression per species    

```{r}
yr.bl <- JulBloomDate("Year")

head(yr.bl)
#subset that signficantchange over time
yr.sig <- yr.bl[yr.bl$p.value < 0.05,]

#merge the significant species with the min.dates species
#yr.sig.min <- merge(yr.sig, min.dates, by.x = "Species", by.y = "Scientific.Name")  
yr.sig.min <- min.dates[min.dates$Scientific.Name %in% yr.sig$Species,]

ggplot(yr.sig.min, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

summary(lm(yr.sig.min$startDayOfYear~yr.sig.min$Year))

nrow(yr.sig) #53 species
nrow(yr.sig[yr.sig$Slope > 0,]) # no species have later bloom dates over time
nrow(yr.sig[yr.sig$adj.r.squ > 0.25,]) # 18 species have adj.r.squares over 0.25
yr.sig[yr.sig$adj.r.squ > 0.25,]


```



# "Raw_Precip" regression per species    

```{r}
precip.bl <- JulBloomDate("Raw_Precip")

head(precip.bl)
#subset that signficant change by precipitation
precip.sig <- precip.bl[precip.bl$p.value < 0.05,]

#merge the significant species with the min.dates species
#precip.sig.min <- merge(precip.sig, min.dates, by.x = "Species", by.y = "Scientific.Name")
precip.sig.min <- min.dates[min.dates$Scientific.Name %in% yr.sig$Species, ]

ggplot(precip.sig.min, aes(Raw_Precip,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by precipitation")+
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

 summary(lm(precip.sig.min$startDayOfYear~precip.sig.min$Year))



```



# "GDD" regression per species    

```{r}
gdd.bl <- JulBloomDate("GDD")

head(gdd.bl)
#subset that signficant change by GDD
gdd.sig <- gdd.bl[gdd.bl$p.value < 0.05,]

#merge the significant species with the min.dates species
#gdd.sig.min <- merge(gdd.sig, min.dates, by.x = "Species", by.y = "Scientific.Name")
gdd.sig.min <- min.dates[min.dates$Scientific.Name %in% gdd.sig$Species,]

ggplot(gdd.sig.min, aes(GDD,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by GDD")+
  xlab("GDD")+
  ylab("Julian Date")

 summary(lm(gdd.sig.min$startDayOfYear~gdd.sig.min$Year))


nrow(gdd.sig) #101 species
nrow(gdd.sig[gdd.sig$Slope > 0,]) # no species have later bloom dates as the GDD increases

```



########## Columns that you can use to compare to earliest bloom date (taken from "startDayOfYear")
              
[11] "startDayOfYear"   [20] "Raw_Precip"                 
[21] "Avg_Hi"                "Med_Hi"                      
[23] "Avg_Lo"                "Med_Lo"                       
[25] "Av_Temp"               "Med_Temp"       





# multiple linear regression
#### precipitation and average low temperature multiple linear regression
```{r}
  namesID <- unique(min.dates$sppListID)
  
  ml.JYC <- lapply(namesID, function(x){
    blnew <- min.dates[min.dates$sppListID == x,]
    foo1 <- summary(lm(startDayOfYear~Raw_Precip*Avg_Lo, data = blnew))
    jul.yr.coef <- data.frame(row.names(foo1$coefficients[-1,]),
                              foo1$coefficients[-1,],
                              foo1$coefficients[1,1],
                              t(foo1$fstatistic),
                              Species = blnew$Scientific.Name[1],
                              foo1$adj.r.squared)
    })
  
  ml.JYC <- do.call(rbind, ml.JYC)
  colnames(ml.JYC) <- c("Variables", "Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  head(ml.JYC)

sig.ml.JYC <- ml.JYC[ml.JYC$p.value < 0.05,]

# there are 19 species significant for Avg_Lo, 15 for Raw_Precip, and 14 for the interaction 
table(sig.ml.JYC$Variables)
```


# Species signficantly changing with the interaction of precipitation and low temperature
```{r}
sig.interaction.JYC <- ml.JYC[ml.JYC$p.value < 0.05 & ml.JYC$Variables == "Raw_Precip:Avg_Lo",]

#sig.in.merge <- merge(sig.interaction.JYC, min.dates, by.x = "Species",
#                      by.y = "Scientific.Name")
sig.in.merge <- min.dates[min.dates$Scientific.Name %in% sig.interaction.JYC$Species,]

ggplot(sig.in.merge, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

 summary(lm(startDayOfYear~Year, data = sig.in.merge))


```

# Signficant interaction species     
Precip
```{r}
ggplot(sig.in.merge, aes(Raw_Precip,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Precipitation")+
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

 summary(lm(startDayOfYear~Raw_Precip, data = sig.in.merge))

```


```{r}
ggplot(sig.in.merge, aes(Avg_Lo,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Low Temperature")+
  xlab("Degrees Celcius")+
  ylab("Julian Date")

 summary(lm(startDayOfYear~Avg_Lo, data = sig.in.merge))

```


# extract climate data from .bil file time series    
<https://github.com/ropensci/prism>  
```{r, eval=FALSE}
# slice out only elevations above 10,500" (3200m)
latlongs <- read.delim(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Sampling Points/LatLongabove3200m.txt"), sep=",")

ll <- mapply(FUN = function(x,y){
  c(x,y)
  },
  latlongs$Long,latlongs$Lat
  )

head(latlongs)
ll[,1]

prism_slice(ll[,1],ls_prism_data()[3,1]) # picks one max temp at one point
```

Into Climate_MEDL
```{r, eval=FALSE}
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")
# takes a long long long time!!! Don't run again!
 get_prism_dailys(type="tmin", 
                 minDate = "1981-01-01", 
                 maxDate = "2011-12-31", keepZip = FALSE)


ls_prism_data()[3:13,]
ls_prism_data(absPath = TRUE)[3:13,] #to see path to where they are
ls_prism_data(name = TRUE)[3:13,] #details of the file
prism_image(ls_prism_data()[3,1])

ls_prism_data()[3,]


```

Into Climate_MEDL
```{r, eval=FALSE}
# error in download length != reported length
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

#get_prism_dailys(type="tmin", minDate = "1981-01-01", maxDate = "1981-02-01",
#                 keepZip = FALSE, mode="wb") #but I don't think mode is a thing...


# run 12/3/2015
get_prism_dailys(type="tmax", 
                 minDate = "1981-01-01", 
                 maxDate = "2011-12-31", keepZip = FALSE)
```


Calculate average daily temperatures averaged over all locations above 3200m 10500"

```{r, eval=FALSE}
# combine by year
sliceyear <- grep("1981",ls_prism_data()[,1],value = TRUE)
sliceyear <- grep("tmin", sliceyear, value = TRUE) #only have tmin in this folder
str(sliceyear)
str(sliceyear[[1]][1])
p <- prism_slice(c(-106.688031183,40.9074207425), sliceyear)
prism_slice(ll[,1], sliceyear)
p$data

head(p$data)
head(ll[,1:10])
mean(p$data$data)

# going through first 10 days of 1981
ptest <- prism_slice(ll[,1],sliceyear[[1]][1:10]) 
head(ptest)
ptest$data

length(ls_prism_data()[,1]) #22,644

# test apply through a few points to get values for a mean
test1981 <- lapply(1:5, function(y){
  prism_slice(ll[,y], sliceyear[[1]][1:10])
  })

test1981[[1]]$data
# data frame each $data part and then bind them
test1981one <- do.call(rbind, lapply(test1981, function(x){
  do.call(data.frame, x$data)
  }))

#aggregate for average over all the locations
aggregate(data~date, data = test1981one, FUN = mean)

length(ll) #2529 above 3200m points
```

```{r testing, eval=FALSE}
# All the data held here
options(prism.path = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Climate_MEDL")

samplell <- sample(1:length(ll), 5)

# raster instead of slice!
avgTemps <- lapply(c(1:5,2000:2005), function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[1,2])
  r2points <- data.frame(rasterToPoints(rastertemps))  # pulls out data from raster
  r2p <- data.frame(r2points, colnames(r2points)[3])
  merge(r2points, latlongs[,3:4], by.x = c("x","y"), by.y = c("Long","Lat"))
})

# no points match, that's silly!
head(avgTemps[[1]])
```

Could limit days to months before latest of the earliest bloom days... 
```{r Temp data, eval=FALSE}
# raster and extract
maxs <- grep("tmax", ls_prism_data(absPath=TRUE)[,2])
mins <- grep("tmin", ls_prism_data(absPath=TRUE)[,2], value=TRUE)
#Jan - Sept, exclude Oct, Nov, and Dec. Latest first bloom is 269 = Sept 26
# exclude <- c("_[1-2][09][0-9][0-9][1][0]","_[1-2][09][0-9][0-9][1][1]","_[1-2][09][0-9][0-9][1][2]")
mins <- grep("_[1-2][09][0-9][0-9][0][1-9]", mins)

avgTemps.max <- lapply(maxs, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})

avgTemps.min <- lapply(mins, function(x){
  rastertemps <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rastertemps, latlongs[,c(4,3)]), date = ls_prism_data()[x,])
})
```

```{r}
nrow(latlongs)
# they all got pulled out!!! yay!!
nrow(avgTemps.min[[1]])
nrow(avgTemps.max[[1]])


mins.avg <- do.call(rbind, avgTemps.min)
meanmins <- aggregate(data~date, data = mins.avg, mean)
maxs.avg <- do.call(rbind, avgTemps.max)
meanmaxs <- aggregate(data~date, data = maxs.avg, mean)

head(mins.avg)
head(as.Date(substr(meanmins$date, 25, 32), "%Y%m%d"))

# Make a day column
meanmins$day <- as.Date(substr(meanmins$date, 25, 32), "%Y%m%d")
meanmaxs$day <- as.Date(substr(meanmaxs$date, 25, 32), "%Y%m%d")

# make a julian day column
meanmins$Julian <- yday(meanmins$day)
meanmaxs$Julian <- yday(meanmaxs$day)

# merge min and max per day
temps <- merge(meanmins, meanmaxs, by = "day")  #.x min, .y max
tmps <- temps[,c(1,3:4,6)]
names(tmps) <- c("day","tmin","Julian","tmax")


#make a year column
tmps$Year <- as.numeric(format(temps$day, "%Y"))

head(tmps)

ggplot(tmps, aes(as.factor(Year)))+
  geom_boxplot(aes(y=tmin, colour = "red"))+
  geom_boxplot(aes(y=tmax, colour = "blue"))
```

Calculate cumulative HDD per year   
10 celsius is 50 fahrenheit   
5 celsius is 41  
Gordon and Bootsma (1993)   
```{r, eval=FALSE}
tbase <- 0

cumsum(((tmps$tmax-tmps$tmin)/2)-5)

HDD <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

# now have daily HDD, need to cumsum each year, which is each list. 
head(HDD)

HDD.yrs <- lapply(HDD, function(x){
  cumsum(x)
})
  
head(HDD.yrs[[1]])
HDD.all <- do.call(c,HDD.yrs)
tmps$HDD <- HDD.all
head(tmps)
tail(tmps)
```

# Calculate GDD or HDD
Combine HDD per Julian day for 1981 through 2011 with herbarium data
```{r}
# remove two attempts at not real HDD
min.dates <- min.dates[,grep("GDD", names(min.dates), invert=TRUE)]
head(min.dates)

#assign real HDD
nrow(min.dates)
data.frame(min.dates, tmps[match(min.dates$startDayOfYear, tmps$Julian)]) #... use %in%? 

min.dates <- merge(min.dates, tmps, 
                   by.x = c("Year","startDayOfYear"), by.y = c("Year","Julian"))

nrow(min.dates[complete.cases(min.dates),])
nrow(min.dates)

# HDD regression per species
hdd.bl <- JulBloomDate("HDD")
nrow(hdd.bl)
nrow(hdd.bl[complete.cases(hdd.bl),]) # 2 rows with missing data? why!?
hdd.bl[!complete.cases(hdd.bl),] # Kobresia schoenoides and Carex misandra

hdd.bl <- hdd.bl[complete.cases(hdd.bl),]
head(hdd.bl) #290
hdd.sig <- hdd.bl[hdd.bl$p.value < 0.05,]

#select significant species from min.dates species
hdd.sig.min <- min.dates[min.dates$Scientific.Name %in% unique(hdd.sig$Species),]


nrow(hdd.sig) #277
nrow(hdd.bl) #288
hdd.bl[hdd.bl$p.value > 0.049,]
nrow(hdd.bl[hdd.bl$p.value < 0.05 & hdd.bl$Slope < 0,])
nrow(hdd.bl[hdd.bl$Slope < 0,])
nrow(hdd.bl[hdd.bl$p.value < 0.05 & hdd.bl$Slope > 0,]) #277
mean(hdd.bl$Slope[hdd.bl$p.value < 0.05 & hdd.bl$Slope > 0]) #0.08373384
mean(hdd.bl$adj.r.squ[hdd.bl$p.value < 0.05 & hdd.bl$Slope > 0]) #0.7130227

```

GDD accumulation over a year
```{r}
ggplot(data.frame(Day = 1:length(HDD.yrs[[1]]),GDD = HDD.yrs[[1]]),
       aes(Day,GDD))+
         geom_point()

```

First day of some GDD acumulation
```{r}
hdd.first <- lapply(HDD.yrs, function(x){
  min(which(x>0))
})

hdd.first.all <- do.call(c,hdd.first)
hdd.f <- data.frame(Year=1981:2011, FirstGDD = hdd.first.all)

ggplot(hdd.f, aes(Year,FirstGDD))+
  geom_point()+
  stat_smooth(method="lm")+
 # stat_smooth(method="loess",colour="green")+
  theme_bw()+
  labs(title="First cumulative GDD above zero")+
  xlab("Year")+
  ylab("Julian Date")

summary(lm(FirstGDD~Year, data=hdd.f))
```

Average HDD? per year
```{r}
avg.HDD.yrs <- lapply(HDD.yrs, function(x){
  mean(x)
})

avg.yrs <- do.call(c, avg.HDD.yrs)
hddyrs <- cbind(Year=1981:2011, avgHDD = avg.yrs)


ggplot(data.frame(hddyrs), aes(Year, avgHDD))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average cumulative Growing Degree Days by Year")+
  xlab("Year")+
  ylab("Cumulative GDD")

```

```{r}
ggplot(hdd.sig.min, aes(HDD,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title= expression("HDD with Tbase = 0"~degree*C))+
  xlab("GDD")+
  ylab("Julian Date")

summary(lm(hdd.sig.min$startDayOfYear~hdd.sig.min$HDD))

```

HDD with Tbase = 0$^\circ$C
```{r}
ggplot(min.dates, aes(as.factor(Year), HDD))+
  geom_boxplot()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="HDD by Year")+
  xlab("Year")+
  ylab("HDD")

```

First bloom date by HDD for all species
```{r}
ggplot(min.dates, aes(HDD, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="First bloom by HDD")+
  xlab("HDD")+
  ylab("First bloom date")

```

Heating degree days 

```{r}
ggplot(min.dates, aes(Year,HDD))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="HDD for each first bloom day")+
  xlab("Year")+
  ylab("HDD")
```

```{r}
ggplot(min.dates, aes(HDD, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by HDD")+
  xlab("HDD")+
  ylab("Julian Date")
```


HDD
```{r}
ggplot(min.dates, aes(Year,Raw_Precip))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")


summary(lm(Raw_Precip~Year, data = min.dates))
```

```{r}
ggplot(min.dates, aes(Raw_Precip, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Raw_Precip, data = min.dates))
```



# Match herbarium data with NPN data
```{r}
npn.sp <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/Study species data 20160104.csv"))

npn.all <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/NPN data/2015_species_list_complete.csv"))

head(npn.sp)
head(min.dates)
head(npn.all)

min.dates$SciName <- sub( "(^[^ ]+[ ][^ ]+)(.+$)", "\\1", min.dates$Scientific.Name)
npn.sp$SciName <- apply(npn.sp[,c("Genus","Species")], 1, 
                        function(x) paste(x[1],x[2],collapse=" "))
npn.all$SciName <- apply(npn.all[,c("Genus","Species")], 1,
                         function(x) paste(x[1],x[2], collapse=" "))

#npn.sp$Observation_Date <- 
#  as.POSIXct(as.numeric(as.character(npn.sp$Observation_Date)), fomat="%m/%e/%Y")



# need to match year 
#npn.sp$Year <- format(as.Date(npn.sp$Observation_Date),format="%Y")


spec.sps <- unique(min.dates$SciName)
length(spec.sps) #284
length(unique(min1950$Scientific.Name)) #290

npn.sps <- unique(npn.sp$SciName)
length(npn.sps) #6
npn.all.sps <- unique(npn.all$SciName)
length(npn.all.sps) #735

#three and three shorted? 
#firstword <- sub("(?<=.{3})(.)*", "", spec.sps, perl = TRUE) 
#secondword <- substr(sub(".*? (.+)", "\\1", spec.sps),1,3) 
#spec.three <- paste(firstword,secondword,sep="")

#Fix spelling error
min1950 <- as.data.frame(sapply(min1950, gsub, 
                                  pattern = "coerulea", 
                                  replacement = "caerulea"))

#Fix double space in Hierochola hirta
min1950 <- as.data.frame(sapply(min1950, gsub,
                                  pattern="Hierochlo  hirta",
                                  replacement = "Hierochlo hirta"))

tonumeric <- c(1:2,4:length(min1950))
min1950[,tonumeric] <- sapply(min1950[,tonumeric], function(s){
  as.numeric(as.character(s))
})

i <- sapply(min1950,is.factor)
min1950[i] <- lapply(min1950[i], as.character)


#three and three shorted? 
firstword <- sub("(?<=.{3})(.)*", "", unique(min1950$Scientific.Name), perl = TRUE) 
secondword <- substr(sub(".*? (.+)", "\\1", unique(min1950$Scientific.Name)),1,3) 
spec.three <- paste(firstword,secondword,sep="")
length(spec.three) #290



#NPN three shortened, only 6 species. these must be ones in CO
firstwordn <- sub("(?<=.{3})(.)*", "", npn.sps, perl = TRUE) 
secondwordn <- substr(sub(".*? (.+)", "\\1", npn.sps),1,3) 
spec.threenpn <- paste(firstwordn,secondwordn,sep="")

#NPN.all three shortened
firstwordna <- sub("(?<=.{3})(.)*", "", npn.all.sps, perl = TRUE) 
secondwordna <- substr(sub(".*? (.+)", "\\1", npn.all.sps),1,3) 
spec.threenpna <- paste(firstwordna,secondwordna,sep="")
length(spec.threenpna) #735

npn.sps.1 <- match(spec.three,spec.threenpn)
m.s.1 <- npn.sps.1[complete.cases(npn.sps.1)]
spec.threenpn[m.s.1] #6 of them

m.sps <- match(spec.sps, npn.sps)
m.s <- m.sps[complete.cases(m.sps)]
npn.sps[m.s] #6 

# with all NPN
npn.all.sps.1 <- match(spec.three,spec.threenpna)
length(npn.all.sps.1) #of the 290, position of match

length(match(spec.threenpna,spec.three)) #735
length(match(spec.threenpna,spec.three)[complete.cases(match(spec.threenpna,spec.three))]) #20 after fixing spelling errors from Bloom

m.a.s.1 <- npn.all.sps.1[complete.cases(npn.all.sps.1)]
length(spec.threenpna[m.a.s.1] ) # 20 match, 
          #19 but is that with spelling error? Aqu
sort(spec.threenpna)
sort(m.a.s.1)

length(m.a.s.1) #20

m.sps <- match(spec.sps, npn.sps)
m.s <- m.sps[complete.cases(m.sps)]
npn.sps[m.s] #6 

min1950$SciName <- sub( "(^[^ ]+[ ][^ ]+)(.+$)", "\\1", min1950$Scientific.Name)

#all.scinames <- match(min.dates$SciName, npn.all$SciName)
all.scinames <- match(min1950$SciName, npn.all$SciName)
a.s <- all.scinames[complete.cases(all.scinames)]
npn.names <- sort(unique(npn.all$SciName[a.s]))

npnonly <- min1950[min1950$SciName %in%  npn.names,]

```

```{r}
ggplot(npnonly, aes(Year,startDayOfYear,colour=SciName))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")


```

NPN only species for regressions with Year, ??Precip, high, or low?
```{r}
summary(lm(startDayOfYear~Year,data = npnonly))
sort(unique(npnonly$Scientific.Name))

#Individuals
npnYear <- JulBloomDate.subset("Year", npnonly)
npnYear[npnYear$p.value<0.05,] # non signifcantly changed over years

npnPrecip <- JulBloomDate.subset("Raw_Precip", npnonly)
npnPrecip[npnPrecip$p.value<0.05,] #Mimulus guttatus

npnHigh <- JulBloomDate.subset("Avg_Hi", npnonly)
npnHigh[npnYear$p.value<0.05,] # none

npnLow <- 
```

```{r}
ggplot(min1950, aes(Year, startDayOfYear))+
  geom_point()+
  stat_smooth(method = "lm")+
  theme_bw()
```

How have NPN species faired?
```{r}
npns <- unique(npn.all$SciName[a.s])

npn.only <- min.dates[grep(paste(npns,collapse="|"), min.dates$SciName),]
npn.only.1950 <- min1950[grep(paste(npns,collapse="|"), min1950$SciName),]

#Convert all factor columns to numeric
npn.only[,-c(3,13,length(npn.only))] <- 
  sapply(npn.only[,-c(3,13,length(npn.only))], 
         function(x) as.numeric(as.character(x)))

npn.only.1950[,-c(3,13,length(npn.only.1950))] <-
  sapply(npn.only.1950[,-c(3,13,length(npn.only.1950))],
         function(x) as.numeric(as.character(x)))


summary(lm(startDayOfYear~Year+HDD,data=npn.only))
summary(lm(startDayOfYear~Year,data=npn.only))
summary(lm(startDayOfYear~Year+HDD+SciName,data=npn.only))

spelledright <- unique(npn.only.1950$Scientific.Name[grep("Aquilegia cae", npn.only.1950$SciName)])
spelledwrong <- fams$Species[grep("Aquilegia coe",fams$Species)]
levels(fams$Species)[levels(fams$Species)==spelledwrong] <- spelledright

npn.only.1950 <- merge(fams[,c(2,4)],npn.only.1950,by.x="Species",by.y="Scientific.Name")
head(fams)
names(npn.only.1950)
head(npn.only.1950)

ggplot(npn.only.1950, aes(Year,startDayOfYear,group=SciName))+
  facet_wrap(~Family, ncol = 2)+
  scale_shape_manual(values=rep(1:6, length.out = length(unique(npn.only.1950$SciName))))+ 
  geom_point(aes(shape=interaction(SciName,Family)))+
  stat_smooth(method="lm", level = 0, color="black")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")+
  scale_x_continuous(limits = c(1950,2011), breaks = seq(1950,2010, by=10))

# do function on npn.only
JulBloomDate.subset <- function(variable,dataset){
  namesID <- unique(dataset$sppListID)
  colnum <- match(variable,names(dataset))
  JYC <- lapply(namesID, function(x){
    blnew <- dataset[dataset$sppListID == x,]
    foo1 <- summary(lm(dataset$startDayOfYear~dataset[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$Scientific.Name[1],
                                    foo1$adj.r.squared))
    })
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}

records.yr <- colSums(table(npn.only.1950$Year,npn.only.1950$Species))
length(records.yr[records.yr>0])#17
str(npn.only.1950)

yr.npn <- JulBloomDate.subset("Year",npn.only.1950) # all negative except Carex aquatilis and Eriphorum - the two Cyperaceae, the grass was even positive
yr.npn[yr.npn$p.value<0.05,] # none!

hi.npn <- JulBloomDate.subset("Avg_Hi", npn.only.1950) #mostly positive slope
hi.npn[hi.npn$p.value<0.05,]
colMeans(hi.npn[hi.npn$p.value<0.05,-9])


lo.npn <- JulBloomDate.subset("Avg_Lo", npn.only.1950) #mostly positive slope
lo.npn.Jul <- lo.npn[lo.npn$p.value<0.05,]
colMeans(lo.npn.Jul[-4,-9])
colMeans(lo.npn[lo.npn$p.value<0.05,-9])

precip.npn <- JulBloomDate.subset("Raw_Precip", npn.only.1950) #mostly positive slope
precip.npn[precip.npn$p.value<0.05,]



rm(yr.npn)
rm(hi.npn)
rm(lo.npn)
rm(precip.npn)
```

These are only 1981:2011
```{r}
# need to have the commented out Species=blnew$Scientific.Name
results <- lapply(unique(npn.only$Scientific.Name), function(x){
  foo1 <- summary(lm(HDD~Year,data=npn.only[npn.only$Scientific.Name==x,]))
  JYC <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                          foo1$coefficients[1,1],
                          t(foo1$fstatistic),
                          Species = x,
                          foo1$adj.r.squared,
                          N = nrow(npn.only[npn.only$Scientific.Name==x,])))
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ","N")
  JYC
  })

rsts <- do.call(rbind,results)
rsts[rsts$p.value<0.05,]
nrow(rsts[rsts$p.value<0.05,])
colMeans(rsts[rsts$p.value<0.05,-9])

ggplot(npn.only, aes(Year, HDD, group=Scientific.Name))+
  geom_point()+
  geom_smooth(method="lm", level=0, lwd = .5, colour = "grey")+
  theme_bw()+
  ylab(expression(GDD[cum]))

```


NPN only by year
```{r}

#subset that signficantchange over time
yr.npn.sig1 <- yr.npn[yr.npn$p.value < 0.05,]
yr.npn.sig <- merge(yr.npn.sig1,npn.only,by.x="Species",by.y="Scientific.Name")

ggplot(yr.npn.sig, aes(Year,startDayOfYear,colour=SciName))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Year+SciName,data=yr.npn.sig))

nrow(yr.npn.sig1) 
yr.npn.sig1[yr.npn.sig1$Slope > 0,] #Eriophorum angustifolium

```
NPN only by precipiation
```{r}

#subset that signficantchange over time
precip.npn.sig1 <- precip.npn[precip.npn$p.value < 0.05,]
precip.npn.sig <- merge(precip.npn.sig1,npn.only,by.x="Species",by.y="Scientific.Name")

ggplot(precip.npn.sig, aes(Year,startDayOfYear,colour=SciName))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Year+SciName,data=precip.npn.sig))

nrow(precip.npn.sig1) 
precip.npn.sig1[precip.npn.sig1$Slope > 0,] 

```

NPN only by HDD
```{r}

#subset that signficantchange over time
HDD.npn.sig1 <- HDD.npn[HDD.npn$p.value < 0.05,]
HDD.npn.sig <- merge(HDD.npn.sig1,npn.only,by.x="Species",by.y="Scientific.Name")

ggplot(HDD.npn.sig, aes(Year,startDayOfYear,colour=SciName))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Year+SciName,data=HDD.npn.sig))
summary(lm(startDayOfYear~Year, data=HDD.npn.sig))

nrow(npn.only)
nrow(HDD.npn) 
nrow(HDD.npn[HDD.npn$Slope > 0,] )

```



## Can get worldclim data
```{r, eval=FALSE}
library(rgdal)

w <- getData('worldclim', var='tmin', res=0.5, lon=5, lat=45)


```


Poop: this is for python, not R....
Snowmelt data from [Snotel NRCS](http://wcc.sc.egov.usda.gov/nwcc/rgrpt?report=snowmonth_hist&state=CO) through [github](https://github.com/gunnarleffler/getSnotel/blob/master/getSnotel) 
```{r}





```

http://wcc.sc.egov.usda.gov/reportGenerator/view_csv/customGroupByMonthReport/monthly/05L05:CO:SNOW%7Cid=%22%22%7Cname/POR_BEGIN,POR_END:1,2,3,4,5,6/WTEQ::collectionDate,SNWD::value,WTEQ::value



### Annual precip, temps for a subset of species with lat/long per species for trends.   
Get annual average temperatures for all years over the US
```{r}
options(prism.path = "Q:/Research/Projects/alpine-phenology/Climate_files/Annual_subset_climate")

get_prism_monthlys(type="tmin", year=1981:2011, mon = 1:12, keepZip=FALSE)
get_prism_monthlys(type="tmax", year=1981:2011, mon = 1:12, keepZip=FALSE)
get_prism_monthlys(type="ppt", year=1981:2011, mon = 1:12, keepZip=FALSE)

#get_prism_monthlys(type = "ppt", year=1982, mon=8, keepZip=FALSE)

ls_prism_data(name=TRUE)[1:10,]
prism_image(ls_prism_data()[1,1])
```


Errors in downloading
```{r, eval=FALSE}
get_prism_monthlys(type="ppt", year=1983, mon=7, keepZip = FALSE)

get_prism_monthlys(type="ppt", year=1988, mon=8, keepZip = FALSE)
get_prism_monthlys(type="ppt", year=1989, mon=6, keepZip = FALSE)
get_prism_monthlys(type="ppt", year=1992, mon=8, keepZip = FALSE)
get_prism_monthlys(type="ppt", year=1993, mon=7, keepZip = FALSE)
get_prism_monthlys(type="ppt", year=1993, mon=11, keepZip = FALSE)
get_prism_monthlys(type="ppt", year=1996, mon=11, keepZip = FALSE)
get_prism_monthlys(type="ppt", year=1997, mon=8, keepZip = FALSE)
get_prism_monthlys(type="ppt", year=2011, mon=7, keepZip = FALSE)

```


# Get monthly precip 
```{r}
options(prism.path = "Q:/Research/Projects/alpine-phenology/Climate_files/Annual_subset_climate")
ppt <- grep("ppt", ls_prism_data(absPath=TRUE)[,2])

avgPrecip <- lapply(ppt, function(x){
  rasterppt <- raster(ls_prism_data(absPath=TRUE)[x,2])
  data.frame(data = extract(rasterppt, latlongs[,c(4,3)]), data = ls_prism_data()[x,])
})

nrow(avgPrecip[[1]]) #1271 lat long points
length(avgPrecip) #12 months for 30 years
```

Average per month over all points 
```{r}
ppt.avg <- do.call(rbind, avgPrecip)
meanppt <- aggregate(data~data.1, data=ppt.avg, mean)

str(meanppt)
meanppt$data.1 <- as.character(meanppt$data.1)

#need to add 1st of the month to each date
meanppt$date <- as.Date(paste(substr(meanppt$data.1, 24,29), "01", sep=""), format = "%Y%m%d") 
meanppt$Year <- as.numeric(format(meanppt$date, "%Y"))

# average per year of July-June (07:06)
meanppt$Prev12 <- meanppt$Year
meanppt$month <- as.numeric(substr(meanppt$data.1, 28,29))
# Give july:december the next year so a Prev12 has months 7:12 of previous year and 1:6 of current
meanppt$Prev12[meanppt$month > 6] <- meanppt$Year[meanppt$month > 6]+1

# now calculate ANNual PreciPiTation as July-June
annppt <- aggregate(data~Prev12, data = meanppt, mean)
head(annppt)

# Minimum collection date, 10 years of data from 1981:2011 as set for GDD
min.precip <- merge(min1950GDD_2_10, annppt, by.x = "Year", by.y = "Prev12")

precip.1983 <- JulBloomDate.min1950("data", min.precip)
```

#Figure 2c
Precip over the years
```{r}
ggplot(annppt, aes(Prev12, data))+
  geom_point(shape=1)+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Precipitation by July-June year")+
  xlab("Year")+
  ylab("Precipitation (mm)")

summary(lm(data~Prev12, data=annppt))
```

#Figure 3c if we have years July:June
```{r}
ggplot(min.precip, aes(data, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
#  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Ordinal Date")

summary(lm(startDayOfYear~data, data = min.precip))

```

#How does snowmelt and precip relate?    
From Results_medl.Rmd   
May I think is the peak, September is the end of first collection times
```{r}
ggplot(se.posno, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  ylab("Average rate of change in snow pack (May to September)")

summary(lm(Secant~Year,data=se.posno))
```
```{r}
ggplot(snow2, aes(year,depth))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Snow depth")+
  xlab("Year")+
  ylab("Total snow depth (cm)")

summary(lm(depth~year,data=snow2))

```
##Start here! get a yearly snow depth correlated to precip either annual Jan-Dec or Jul-Jun
```{r}


```




Pull specific information per species location   
from Results figures and tables:  
```{r, eval=FALSE}
# high temps
highsigsp <- as.character(high.1950$Species[high.1950$p.value<0.05])
lats <- bloom$decimalLatitude[bloom$Scientific.Name %in% unique(grep(paste(highsigsp,collapse="|"),
                                            bloom$Scientific.Name, 
                                            value=TRUE)) &
                                lapply(split(bloom,list( which.min()]
length(lats)
nrow(bloom)
```




---
title: "Results"
author: "Michelle DePrenger-Levin"
date: "January 18, 2016"
output: html_document
---

Data without growing degree days or monthly precipitation
```{r}

library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)

bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/QR_final_R_plant_climate_data_2.csv"))

head(bloom)
```



Snowmelt data or time at which heating degree days reach a certain point per year
download of prism data in 'Climate.Rmd'
```{r}
tbase <- 0

HDD.0 <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

# now have daily HDD, need to cumsum each year, which is each list. 
head(HDD.0)

HDD.0.yrs <- lapply(HDD.0, function(x){
  cumsum(x)
})

head(HDD.0.yrs[[1]])
HDD.0.all <- do.call(c,HDD.0.yrs)
tmps.0 <- tmps
tmps.0$HDD.0 <- HDD.0.all
```

```{r}
#day of first HDD value > 0
first.hdd <- do.call(rbind,lapply(unique(tmps.0$Year), function(x){
  t.0 <- tmps.0[tmps.0$Year == x,]
  do.call(rbind, lapply(split(t.0, t.0$HDD.0), head, 1))[2,]
}))

  
ggplot(first.hdd, aes(Year,Julian))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="First non-zero HDD")+
  xlab("Year")+
  ylab("Julian Day")

summary(lm(Julian~Year, data=first.hdd))
```



test reading in 
read.table(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data/Black Mesa 11580 2013-2016.txt"),skip=7,header=TRUE,sep=",")

####Get snow pack depth 
```{r}
files <- list.files(path="Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data", pattern="*.txt", full.names=TRUE, recursive = FALSE)

snotel <- lapply(files, function(x){
  t<-read.table(path.expand(x),skip=9, header=FALSE,sep=",", na.strings = " ")
  header <- scan(x,skip=7,nlines=1, what=character(),sep=",")
  header2 <- scan(x,skip=8,nlines=1,what=character(),sep=",")
  names(t)<-paste(header,header2,sep=" ")
  t
})

snotel.all <- do.call(rbind,snotel)
head(snotel.all)
```

```{r}
snowdepth <- grep("Depth", names(snotel.all))

avg.snowdepth <- aggregate(snotel.all[,c(1,snowdepth)],
          by=list(snotel.all$'Water Year '), function(x) mean(x, na.rm=TRUE)) 

long.avg.snow <- reshape(avg.snowdepth[,-1], direction="long", 
                         varying= c(names(avg.snowdepth[,-c(1:2)])),
                         timevar = "Month",
                         times= names(avg.snowdepth[,-c(1:2)]),
                         idvar = "Water Year ",
                         v.names = "Snow.Depth",
                         new.row.names = 1:(nrow(avg.snowdepth)*(length(avg.snowdepth)-2))) 
head(long.avg.snow)
names(long.avg.snow) <- c("Year","Month","Snow.Depth")

```


```{r}
ggplot(long.avg.snow, aes(Year, Snow.Depth, colour = Month))+
  geom_line()+
#  geom_hline(yintercept="mean")+
  facet_wrap(~Month)+
  geom_smooth(method = "lm")


```

Snow report generator http://wcc.sc.egov.usda.gov/reportGenerator/
```{r}
snow <- read.table(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data 2/Monthly19782016_over3200m.txt"),
                   skip=7, header=FALSE,sep=",", na.strings = " ")


header <- scan("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data 2/Monthly19782016_over3200m.txt",skip=5,nlines=1, what=character(),sep=",")
header2 <- scan("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data 2/Monthly19782016_over3200m.txt",skip=6,nlines=1,what=character(),sep=",")
names(snow)<-paste(header,header2,sep="_")

head(snow)
```

sum of snow? 
```{r}
#average over all stations per year
avg.p.yr <- do.call(rbind,lapply(split(snow[,grep("_Snow Depth", names(snow))], 
                                       snow$`Water Year_`), 
                                 function(x) colMeans(x, na.rm = TRUE)))

avg.p.yr.cc <- avg.p.yr[complete.cases(avg.p.yr),]
avg.p.yr.cc
melt.snow <- melt(avg.p.yr.cc)
head(melt.snow)
melt.snow$Var2 <- factor(melt.snow$Var2)
str(melt.snow)


ggplot(melt.snow, aes(as.numeric(Var2),value))+
#  geom_smooth(method="lm")+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Var1)
```

Is the peak moving later (when tangent is 0?, decond derivative - local maxima)   
No, peak snow pack is consistantly 

```{r}
lapply(unique(melt.snow$Var1), function(x){
  which(diff(sign(diff(melt.snow$value[melt.snow$Var1==x])))==-2)+1
})

slope.loess <-function(X, data){
    # First your loess function:
    my_loess <- loess(y~x, data=data, subset=data$Year==X, degree=2)
    # Then the first difference
    first_diff <- diff(my_loess$fitted)
    # Then the corresponding x and y values for the minima and maxima
    res <- cbind(my_loess$x[c(which.min(first_diff), which.max(first_diff))], 
            my_loess$fitted[c(which.min(first_diff), which.max(first_diff))])
    colnames(res) <- c("x", "y")
    rownames(res) <- c("min", "max")
    res
    }

snow.data <- melt.snow
snow.data$Var2 <- as.numeric(snow.data$Var2)
str(snow.data)
names(snow.data) <- c("Year", "x", "y")

#Then apply the function to each group
slope.snow <- lapply(unique(melt.snow$Var1), FUN=slope.loess, data = snow.data)
names(slope.snow) <- levels(factor(snow.data$Year))

maxsnow <- do.call(rbind,lapply(slope.snow, function(x){
  x[1,1]
}))
head(maxsnow)
year<- as.numeric(as.character(rownames(maxsnow)))

summary(lm(maxsnow~year))
plot(year,maxsnow)
levels(melt.snow$Var2)[8]
levels(melt.snow$Var2)[12]
```

Find the secant (average rate) of snowmelt each year to see if it's speeding up/coorelated to secant (average rate) of accumulated GDD  
Most common to have peak snow depth in May   
calculate secant from May (8) to September (12)   
use library(polynom)
```{r}
fit1.snow <- lapply(unique(snow.data$Year), function(x){
  lm(y~x+I(x^2), data=snow.data[snow.data$Year == x,])
})

library(polynom)


poly.s <- lapply(fit1.snow, function(fx){
  polynomial(coef(fx))
})
smonth <- 8
emonth <- 12


as.function(poly.s[[1]])(emonth)

secant.polysnow <- lapply(poly.s,function(x){
  ((as.function(x)(emonth))-(as.function(x)(smonth)))/(emonth-smonth)
})

se.posno <- data.frame(Year=year,Secant=do.call(rbind,secant.polysnow))

ggplot(se.posno, aes(Year,Secant))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  ylab("Average rate of change in snow pack (May to September)")

summary(lm(Secant~Year,data=se.posno))
```

```{r}
snow.total <- rowSums(avg.p.yr,na.rm = TRUE)


head(snow)
snow.total

snow1 <- snow.total[snow.total>0]
snow2 <- data.frame(year = 1997:2016, depth = snow1)

ggplot(snow2, aes(year,depth))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Snow depth")+
  xlab("Year")+
  ylab("Total snow depth (cm)")

```



```{r}
hdd.snow <- merge(first.hdd,snow2,by.x="Year",by.y="year")
head(hdd.snow)

# the first day each year of some accumulated GDD against snow depth of the year
ggplot(hdd.snow, aes(Julian,depth))+
  geom_point()+
  xlab("Day of Year with some accumulated GDD")+
  ylab("Snow Depth (cm)")+
  stat_smooth(method = "lm")
```


```{r}
data.frame(hddyrs)
hddavg.snow <- merge(hddyrs, snow2,by.x="Year",by.y="year")
head(hddavg.snow)

ggplot(hddavg.snow, aes(avgHDD,depth))+
  geom_point()+
  xlab("Average annual cumulative GDD")+
  ylab("Annual total snow depth (cm)")+
  stat_smooth(method = "lm")+
  theme_bw()

summary(lm(depth~avgHDD, data=hddavg.snow))

```

Reformat snow data:
```{r}
snow.depth <- grep("Mean Monthly", names(snow))
avg.snow <- aggregate(snow[,c(3,snow.depth)], by=list(snow$`Water Year_`),
                      function(x) mean(x,na.rm=TRUE))
snow.long <- reshape(avg.snow[,-1], direction="long",
                     varying=c(names(avg.snow[,-c(1:2)])),
                     timevar="Month",
                     times=names(avg.snow[,-c(1:2)]),
                     idvar="Water Year_",
                     v.names="Snow.Depth",
                     new.row.names = 1:(nrow(avg.snow)*(length(avg.snow)-2)))

tail(snow.long)
snow.long$Month <- factor(snow.long$Month, levels = unique(snow.long$Month))
levels(snow.long$Month)
names(snow.long) <- c("Year","Month","Snow.Depth")
sort(unique(snow.long$Year[complete.cases(snow.long)]))

```

```{r}
ggplot(snow.long[complete.cases(snow.long),], aes(Year, Snow.Depth, colour=Month))+
  geom_line()+
  theme_bw()+
  facet_wrap(~Month)+
  geom_smooth(method="lm")

```

```{r}
snow.long <- snow.long[complete.cases(snow.long),]
```

```{r}
names <- unique(snow.long$Month)

lmlist <- lapply(names, function(month){
  summary(lm(Snow.Depth~Year,data=snow.long[snow.long$Month == month,]))
  })

names(lmlist) <- names

```

```{r}
min.dates.snow <- merge(min.dates, avg.snow[avg.snow$`Water Year_` > 1996,], by.x="Year",
                        by.y=names(snow)[3])

```

```{r}
maysnow <- JulBloomDate.subset("May_Mean Monthly Snow Depth (cm)",min.dates.snow)

maysnow.sig <- maysnow[maysnow$p.value < 0.05,]

maysnow.min <- min.dates[min.dates$Scientific.Name %in% maysnow.sig$Species,]
nrow(maysnow.min) #2375

head(maysnow.min)

```

```{r}
ggplot(min.dates.snow, aes(Year,startDayOfYear))+
   geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

```


```{r}
ggplot(min.dates.snow, aes(`May_Mean Monthly Snow Depth (cm)`,startDayOfYear))+
   geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("May snow depth")+
  ylab("Julian Date")

summary(lm(startDayOfYear~min.dates.snow$'May_Mean Monthly Snow Depth (cm)',
           data = min.dates.snow))

```


NPN data downloaded by Mary
```{r}
npn <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/Alpine spp. NPN download 2016-01-26/Alpine Species NPN data download.csv"))

head(npn)
table(npn$Common_Name,npn$First_Yes_Year)
table(npn$Genus,npn$State)



npn.CO <- npn[npn$State == "CO",]
table(npn.CO$Common_Name,npn.CO$First_Yes_Year)

npn.CO.alpine <- npn.CO[npn.CO$Elevation_in_Meters > 3199,]
# No collections from alpine sites.
table(npn.CO.alpine$Common_Name,npn.CO.alpine$First_Yes_Year)

```

Find earliest bloom date per year per species (to match the herbarium specimens)    for all collections across their range

```{r}
npn.first <- lapply(unique(npn$Common_Name), function(x){
  this.species <- npn[npn$Common_Name == x,]
  these.rows <- aggregate(First_Yes_DOY~First_Yes_Year, this.species, FUN=min)
  unique(merge(this.species,these.rows,by=c("First_Yes_Year","First_Yes_DOY")))
})

npn.first.dates <- do.call(rbind, npn.first)

table(npn.first.dates$Common_Name,npn.first.dates$First_Yes_Year)
npn.first.dates[npn.first.dates$Common_Name == "Colorado blue columbine",]

uni.npn.first <- unique(npn.first.dates[npn.first.dates$State == "CO",c(1:11)])
table(uni.npn.first$Common_Name,uni.npn.first$First_Yes_Year)
uni.npn.first[uni.npn.first$Common_Name == "Colorado blue columbine",]
```

```{r}
ggplot(npn.first.dates, aes(First_Yes_Year,First_Yes_DOY))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab("Degrees Celsius")

summary(lm(Avg_Hi~Year, data=min.dates))

```

```{r}
ggplot(uni.npn.first, aes(First_Yes_Year,First_Yes_DOY))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab("Degrees Celsius")

summary(lm(Avg_Hi~Year, data=min.dates))
```


### All colections in alpine   
```{r}
allalpine <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/CO_SEINet_3200csv.csv"))

names(allalpine)
alltable <- data.frame(table(allalpine$startDayOfYear,allalpine$year))
allalpine<-allalpine[allalpine$year!=4,]

#Start here! see if collections are moving in startDayOfYear over the years
ggplot(alltable,aes(x=Var1))+
  geom_histogram(aes(y=..density..))+
  facet_wrap(~Var2)

```

# Check family errors from SEINet download
```{r}
head(asuFams)
asuFams$genus <- gsub(" .*$", "", asuFams[,2])

#### Errors from upload
bloom2[grep("Potentilla", bloom2$scientificName),]
   colSums(table(bloom2$Year[grep("Potentilla", bloom2$scientificName)],
         bloom2$scientificName[grep("Potentilla", bloom2$scientificName)]))
asuFams[grep("Potent", asuFams$genus),]   
   
# listed as only Asteraceae - not 10 years of data anyway
bloom2[grep("Asteraceae", bloom2$scientificName),]
  table(bloom2$Year[grep("Asteraceae", bloom2$scientificName)])
  
bloom2[grep("Poaceae", bloom2$scientificName),] #only one record
  
bloom2[grep("Pinaceae", bloom2$scientificName),] 
  table(bloom2$Year[grep("Pinaceae", bloom2$scientificName)]) # not enough years
  
bloom2[grep("Iso", bloom2$scientificName),] 
  table(bloom2$Year[grep("Iso", bloom2$scientificName)]) # not enough years
  
bloom2[grep("Brassicaceae", bloom2$scientificName),] 
  table(bloom2$Year[grep("Brassicaceae", bloom2$scientificName)]) # not enough years
  
bloom2[grep("Caryoph", bloom2$scientificName),] # not enough years

bloom2[grep("Apia", bloom2$scientificName),] # not enough years
  
bloom2[grep("Hiero", bloom2$scientificName),] 
  table(bloom2$Year[grep("Hiero", bloom2$scientificName)]) # only 7 years


```

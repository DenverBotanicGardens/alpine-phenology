---
title: "VisTrails_models"
author: "Michelle DePrenger-Levin"
date: "September 6, 2017"
output: html_document
---
load libraries   
```{r}

rm(list=setdiff(ls(), c("applyavgElev","avgElev")))

  .libPaths(c(.libPaths(), "C:/Users/deprengm/Documents/R/win-library/3.3"))
library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
library(rasterVis)
require(rgdal)
library(RColorBrewer)
# devtools::install_github("ropensci/prism")
library(prism)
library(polynom)
library(MASS)
library(plotrix)
library(plyr)
library(list)
library(grid)
library(scales)
library(viridis)  # better colors for everyone
library(ggthemes)
library(gganimate)

```

Need make sure have right stuff for collections before 1980, exclude wrong dates
```{r}

#339 not significant
notsig_339 <- "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/NotSignEarl_385"
sig_45 <- "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/SignEarl_385"

#339
filenames <- list.files(notsig_339, pattern="*.csv")
#45
filenames_1 <- list.files(sig_45, pattern="*.csv")

# 339
sps_339 <- lapply(1:339, function(file){
  read.csv(paste(notsig_339, filenames[file], sep="/"))
})

# 45
signsps_45 <- lapply(1:45, function(file){
  read.csv(paste(sig_45,filenames_1[file], sep="/"))
})

#collections for use in VisTrails
cols4VT <- lapply(1:45, function(x){
  sp <- signsps_45[[x]][,c("scientificName","decimalLongitude",
                          "decimalLatitude","year",
                          "minimumElevationInMeters","institutionCode")]
  sp <- sp[sp$decimalLatitude < 41.1 & sp$decimalLatitude > 36.9 &
             sp$decimalLongitude > -109 & sp$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  sp <- sp[sp$year < 1980 & sp$year > 1800,]
  sp <- sp[!is.na(sp$year),]
  if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  sp
})


# need to be 46:384
cols4VT_339 <- lapply(1:339, function(x){
  sp1 <- sps_339[[x]][,c("scientificName","decimalLongitude",
                        "decimalLatitude","year",
                          "minimumElevationInMeters","institutionCode")]
  sp <- sp1[sp1$decimalLatitude < 41.1 & sp1$decimalLatitude > 36.9 &
             sp1$decimalLongitude > -109 & sp1$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  sp <- sp[sp$year < 1980 & sp$year > 1800,]
  sp <- sp[!is.na(sp$year),]
  if(nrow(sp) == 0){
    sp <- data.frame(scientificName = unique(sp1$scientificName),decimalLongitude = NA,
                     decimalLatitude = NA,year = NA,
                     minimumElevationInMeters = NA,
                     institutionCode = NA,
                     ID = NA, N=nrow(sp))
    } else {
    if(nrow(sp) > 79){
    sp <- cbind(sp, "ID"=x+45, "N"=nrow(sp))
  } else {
    sp <- cbind(sp, "ID" = NA, "N"=nrow(sp))
  }
  }
  sp
})


AlPh384 <- rbind(do.call(rbind,cols4VT), do.call(rbind,cols4VT_339))
AlPh384 <- AlPh384[!is.na(AlPh384$ID),]

seqAlPh <- transform(AlPh384, id=match(AlPh384$ID, unique(AlPh384$ID)))

#write.table(seqAlPh, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80pre1980.csv", sep=",", row.names=FALSE)


```


#create post 1980 list with the same species
```{r}
# Select only species that have more than 80 individual points
#Select only individuals with year before 1980
# "MaxEnt uses thenumber of presences to determine which feature classes to use, more than 80 presences leads to all feature classes being used" - Merow et al 2013
# the 45 significantly changed in phenology ones



#Pull in all data, then supset by ID
#collections for use in VisTrails
cols4VT <- lapply(1:45, function(x){
  sp <- signsps_45[[x]][,c("scientificName","decimalLongitude",
                          "decimalLatitude","year",
                          "minimumElevationInMeters","institutionCode")]
  sp <- sp[sp$decimalLatitude < 41.1 & sp$decimalLatitude > 36.9 &
             sp$decimalLongitude > -109 & sp$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]

  sp <- sp[!is.na(sp$year),]
  sp <- cbind(sp, "ID"=x, "N"=nrow(sp))
  sp
})


# need to be 46:384
cols4VT_339 <- lapply(1:339, function(x){
  sp1 <- sps_339[[x]][,c("scientificName","decimalLongitude",
                        "decimalLatitude","year",
                          "minimumElevationInMeters","institutionCode")]
  sp <- sp1[sp1$decimalLatitude < 41.1 & sp1$decimalLatitude > 36.9 &
             sp1$decimalLongitude > -109 & sp1$decimalLongitude < -102,]
  sp <- sp[!is.na(sp$decimalLatitude),]
  
  sp <- sp[!is.na(sp$year),]
  if(nrow(sp) == 0){
    sp <- data.frame(scientificName = unique(sp1$scientificName),decimalLongitude = NA,
                     decimalLatitude = NA,year = NA,
                     minimumElevationInMeters = NA,
                     institutionCode = NA,
                     ID = NA, N=nrow(sp))
    } else {
    sp <- cbind(sp, "ID"=x+45, "N"=nrow(sp))
  }
  sp
})


AlPh384 <- rbind(do.call(rbind,cols4VT), do.call(rbind,cols4VT_339))
AlPh384 <- AlPh384[!is.na(AlPh384$ID),]

#narrow down to 
unique(seqAlPh$ID) #Want these
# then do sequential ids

AlPh384 <- AlPh384[AlPh384$ID %in% unique(seqAlPh$ID),]

seqAlPh <- transform(AlPh384, id=match(AlPh384$ID, unique(AlPh384$ID)))

#write.table(seqAlPh, file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80post1980.csv", sep=",", row.names=FALSE)

rm(cols4VT,cols4VT_339,seqAlPh,AlPh384)

```



Don't really need those and take lots of space
```{r}
rm(cols4VT,cols4VT_339,signsps_45,sps_339)


```

#Take results from VisTrails and compare bin maps for each past projected to current with points from current
```{r}

#modelrun <- "PRISM_pre1980_current/"
#modelrun <- "PRISM_pre1980_current_beta5_minmaxtemp_precip/"
modelrun <- "PRISM_pre1980_current_beta5_minmaxtemp_precip_10reps/" #not 10 reps, just 10 folds, not enough data to do both
#applymax <- paste("ApplyMAXENT",1:89,"_1", sep="")
#Maxent <- paste("Maxent_",1:89,sep="")
applymax <- paste("ApplyMAXENT",1:87,"_1", sep="")
Maxent <- paste("Maxent_",1:87,sep="")

models <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_bin_map.tif",sep=""))
})

applymodels <- lapply(applymax, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_bin_map.tif",sep=""))
})


# Change the furture (current) models to 2 and 0 and keep past as 1 and 0, when added 3=in both, 2=in current only, 1=past only
overlap10 <- lapply(1:length(models), function(x){
  past <- models[[x]]
  current <- applymodels[[x]]
  current[applymodels[[x]] == 1] <- 2
  out <- past+current
  out
})
```


```{r}
JustMaxent <- paste("PRISM_justcurrent_beta5_minmaxtemp_precip/Maxent_",1:87,sep="")

justcurrentmodels <- lapply(JustMaxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",x,"/maxent_bin_map.tif",sep=""))
})

overlap_applycurrent <- lapply(1:length(models), function(x){
  apply <- applymodels[[x]]
  current <- justcurrentmodels[[x]]
  current[justcurrentmodels[[x]]==1]<-2
  out <- apply+current
  out
})
```


#when using just current 2:blue, when the applymodel 1:red, so way over estimating compared to where it really is. 
```{r}

# need ID when id is 1:89; ID is 1:384 (because no locaiton information for Ligusticum porteri); id is 1:302  
# FieldData_AlPh_over80.csv pulls in all records, all years per sepecies pulled from SEINet and then kept if there are at least 80 records. Then id was added to be sequential (for VisTrails python list looping) to account for missing species - those with fewer than 80 records.
# the "ID" from the sequential 1:89 "id" from FieldData_AlPh_over80pre1980.csv will match the "ID" from FieldData_AlPh_over80.csv that I want below 

# I've got pre1980 and FieldData_pre1980 that are identical
#identical(pre1980,FieldData_pre1980)

FieldData_pre1980 <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80pre1980.csv")

FieldData_all <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80post1980.csv")

for(x in 1:87){

  # Have some data that has years wrong like >2017 and less than 1800 down to 0
  pointsafter <- SpatialPointsDataFrame(FieldData_all[FieldData_all$id == x,
                                        c("decimalLongitude","decimalLatitude")],
                                        FieldData_all[FieldData_all$id == x,],
                                        proj4string=CRS("+init=epsg:4326"))
  
  pointsabefore <- SpatialPointsDataFrame(FieldData_pre1980[FieldData_pre1980$id == x,
                                          c("decimalLongitude","decimalLatitude")],
                                          FieldData_pre1980[FieldData_pre1980$id == x,],
                                          proj4string=CRS("+init=epsg:4326"))
  
    
  jpeg(paste("Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/",x,"justcurrentpostrangemap.jpg",sep=""), width = 200, height = 150,
       units = "mm", res = 300)
  
  print(levelplot(overlap_applycurrent[[x]], margin=FALSE,
            col.regions=c("white","red4","midnightblue","lavender"),
            colorkey=list(at=seq(0, 4, 1)),
                 labels=list(at=seq(0, 4, 1)))+
    layer(sp.points(pointsafter, pch=20, cex=0.5, col="lightblue4"))+
    layer(sp.points(pointsabefore, pch=22, cex=0.25, col="red3")) )
  
  rm(pointsafter,pointsabefore)
  
  dev.off()
}



```

### MAKE THIS MAP!  START HERE
```{r}



test_stack <- stack(overlap_applycurrent)
test_spdf <- as(test_stack, "SpatialPixelsDataFrame")
test_df <- as.data.frame(test_spdf)
test_df_long <- melt(test_df, id.vars = c("x","y"))

compareGIF <- ggplot(data=test_df_long[test_df_long$variable %in% 
                                         paste("layer.",seq(1,87, by=3),sep=""),],
                     aes(x,y,fill=as.factor(value), frame=variable))+
  geom_tile()+
  scale_fill_manual(values=c("white","red4","midnightblue","lavender"))+
  coord_equal()+
  guides(fill=guide_legend(title="1:apply model \n 2:current \n 3:both"))

gganimate(compareGIF, "Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/apply2current.gif", ani.width = 600, ani.height = 450, interval = 0.75)

#+
#  geom_point(data=FieldData_all[FieldData_all$year>1980 & FieldData_all$ID == 13,],
#             aes(decimalLongitude,decimalLatitude))
  

  

```





Attempt #1: use this as the approximate size of pixel across the whole landscape of Colroado
```{r}
# need to convert resolution into meters
# make SpatialPoints object
xtll <- matrix(extent(models[[1]]),byrow = FALSE, nrow = 2)
# <http://spatialreference.org/ref/epsg/32613/> 
xtll <- SpatialPoints(xtll, CRS("+init=epsg:4326")) #WGS 84
#convert to UTM 
transxtll <- spTransform(xtll,CRS("+init=epsg:32613")) 
rastextobj <- extent(transxtll)
c(rastextobj[1],rastextobj[2],rastextobj[3],rastextobj[4])      
#raster extent object rounded to km
ext <- extent(round_any(c(rastextobj[1],rastextobj[2],
                          rastextobj[3],rastextobj[4]),1000))

# make same ncol and nrow as previous ones
r <- raster(ext, ncol=dim(models[[1]])[2],
            nrow=dim(models[[1]])[1], crs="+init=epsg:32613")


r #resolution is now 724.4656, 916.8399 (x,y)


#habitat lost is just the new minus the old? 2s minus 1s because 3s represent what didn't change. 
change.newold <- lapply(overlap10, function(x){
  net <- (( sum(x[] == 2) - sum(x[] == 1) ) * (res(r)[1]*res(r)[2])/1000000) 
  net
})

netchangevector.newold <- do.call(rbind,change.newold)
boxplot(netchangevector.newold) #square km change
hist(netchangevector.newold)
```


```{r}
# how do herbarium specimens line up with habitat model?
FieldData_all <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80.csv")

# to match which number (id) is what species (ID)
FieldData_pre1980 <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80pre1980.csv")

max(FieldData_all$year[FieldData_all$year > 1800&
                         FieldData_all$year < 2017], na.rm=TRUE)
max(FieldData_all$minimumElevationInMeters[FieldData_all$minimumElevationInMeters>1000&
                                             FieldData_all$minimumElevationInMeters<4420],na.rm=TRUE)

nrow(FieldData_all)
nrow(FieldData_pre1980)
```

Plot results
```{r}
# 0 is not in range, 1/red = past, 2/blue = present, 3/purple = both
plot(overlap10[[59]], col = c("white","red","blue","lavender"))


# New minus old (not taking into account how much is maintained, that would subtract out anyway)
boxplot(netchangevector.newold)
hist(netchangevector.newold)

#convert raster to dataframes for plotting in ggplot
df1 <- data.frame(rasterToPoints(overlap10[[1]]))
colnames(df1) <- c("X","Y","SHM") #suitable habitat model

# vector for color breaks
b.col <- seq(0,3,length.out=4)

ggplot(df1,aes(X,Y,fill=SHM))+
  geom_raster()

#ids 1:12 significnatly changed
#ids 13:89 did not
x<-13
plot(overlap10[[x]], col = c("white","red","blue","lavender"))  #c("white","tomato","yellow2","antiquewhite1"))
points(FieldData_all$decimalLongitude[FieldData_all$year>1980 &
                                        FieldData_all$ID == x],
       FieldData_all$decimalLatitude[FieldData_all$year>1980 &
                                        FieldData_all$ID == x],
       pch = 21, cex = 0.5, col="lightblue4") #col = "orange")
points(FieldData_all$decimalLongitude[FieldData_all$year<1980 &
                                        FieldData_all$ID == x],
       FieldData_all$decimalLatitude[FieldData_all$year<1980 &
                                        FieldData_all$ID == x],
       pch = 8, cex = 0.5, col = "red3")
```
```{r}
for(i in 1:87){
  
  x <- unique(FieldData_pre1980$ID[FieldData_pre1980$id==i])
  species <- FieldData_all$scientificName[FieldData_all$ID==x]

  pntsaft <- FieldData_all[FieldData_all$year>1980 &
                             FieldData_all$year<2017 &
                             FieldData_all$ID == x,]
  pntsaft <- pntsaft[complete.cases(pntsaft),]
  
  pntsbf <- FieldData_all[FieldData_all$year<1981 &
                            FieldData_all$year>1800 &
                            FieldData_all$ID == x,]
  pntsbf <- pntsbf[complete.cases(pntsbf),]
  
  pointsafter <- SpatialPointsDataFrame(pntsaft[,c("decimalLongitude","decimalLatitude")],
                                        pntsaft,
                                        proj4string=CRS("+init=epsg:4326"))
  
  pointsbefore <- SpatialPointsDataFrame(pntsbf[,c("decimalLongitude","decimalLatitude")],
                                         pntsbf,
                                         proj4string=CRS("+init=epsg:4326"))
  
    
  jpeg(paste("Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/",species[1],"_prepostrangemap.jpg",sep=""), width = 200, height = 150,
       units = "mm", res = 300)
  
  print(levelplot(overlap10[[i]],
            col.regions=c("white","red4","midnightblue","lavender"),
            colorkey=list(at=seq(0, 4, 1)),
                 labels=list(at=seq(0, 4, 1)))+
    layer(sp.points(pointsafter, pch=20, cex=0.5, col="lightblue4"))+
    layer(sp.points(pointsbefore, pch=8, cex=0.5, col="red3"))
  )
  
  
  dev.off()
  
  rm(x,species,pointsafter,pointsbefore)
}
  

  
```


#Can I match the species information from phenology to the niche model data?   
1-11 of ids are signfiant change in phenology  
12-87 did not
```{r}
mergename <- read.csv(text=getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/datasets/mergenameaccpt.csv"))

test.merge <- merge(FieldData_pre1980,mergename,by.x = "scientificName", by.y="scientificName")
head(test.merge)

# get list of other attributes by id
otherinfo <- unique(test.merge[,c(8:9,46:51)])

```




```{r}
# 1 (apply model) minus 2 (current): showing how much the antipated correct model is compared to the predicted. Positive values show over estimation of the apply model to more accurate, while negative values are how much underestimated what should be assumed to be an accurate model

change.currentapply <- lapply(1:87, function(model){
  x<-overlap_applycurrent[[model]]
  net <- (( sum(x[] == 1) - sum(x[] == 2) ) * (res(r)[1]*res(r)[2])/1000000) 
  net <- data.frame(net, variable = model)
})
nc.ca <- do.call(rbind,change.currentapply)
nc.ca$Phenology[nc.ca$variable < 13] <- "SignficantChange"
nc.ca$Phenology[nc.ca$variable > 12] <- "NoChange"


hist(nc.ca$net)
par(mar = c(5, 7, 4, 2) + 0.1)
boxplot(nc.ca$net, ylab = expression(paste("Change in predicted area ( ",km^2,")")))

nc.ca <- merge(nc.ca,otherinfo,by.x =  "variable", by.y="id")
nc.ca$GrowthHabitGroup <- "Shrub/Tree"
nc.ca$GrowthHabitGroup[grep("Forb",nc.ca$Growth.Habit)] <- "Forb/herb"
nc.ca$GrowthHabitGroup[grep("Graminoid",nc.ca$Growth.Habit)] <- "Graminoid"
```

```{r}
ggplot(nc.ca, aes(y=net,x=Phenology))+
  geom_boxplot()+
#  geom_point()+
  labs(y = expression(atop("Difference between (1) model tracking climate ", paste("envelope from (2) the current evelope (", km^2,")"))), 
       x = "87 species \n 11 significantly changed in phenology \n 76 showed no change in phenology")+
  theme_bw()+
  facet_wrap(~GrowthHabitGroup)
```


```{r}
FieldData_pre1980 <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80pre1980.csv")

tblfoo <- data.frame(table(FieldData_pre1980$id,FieldData_pre1980$ID))

tblfoo[tblfoo$Freq != 0,] 
### 1:11 are sign in phenology
### 12:87 are not
```




# Model Performance   SKIP TO NEXT IF ALREADY RUN THIS!
check how many points from post 1980 fall within the predicted range. Do a PCA to see if there's a difference in points within and points that fall not in the range. What do those mean? They didn't shift so they're adapting? Are they tolerating a shift in one direction of certain environmental factors?    
```{r}

elevCO <- raster("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Elevation_VT/CO_Mosaic_Elevation_VT/co_elev_VT_WGS84.tif")

modelrun <- "PRISM_pre1980_current_beta5_minmaxtemp_precip/"
applymax <- paste("ApplyMAXENT",1:89,"_1", sep="")
Maxent <- paste("Maxent_",1:89,sep="")

past_models <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_bin_map.tif",sep=""))
})

elevCOcrop <- resample(elevCO, past_models[[1]], method='bilinear')

model <- past_models[[1]]

 
# Get Elevation where model says it will be
avgElev <- lapply(past_models, function(model){
  shape <- rasterToPolygons(model, fun=function(x){x ==1}, dissolve=TRUE) #make polygons where model bin map == 1
  cr <- crop(elevCOcrop, extent(shape), snap="out")
  shaper <- rasterize(shape, cr)
  elevr <- mask(x=cr, mask=shaper)
  elevr
  })
 
lapply(1:89, function(x){
  writeRaster(avgElev[[x]], 
              paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,"/Elevation",x,sep=""),format="GTiff",overwrite=TRUE)
})



## Didn't do this because different extents, saved all individually
writeRaster(stack(avgElev), 
            paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,"/Elevation",sep=""),
            bylayer=TRUE, suffix=1:89,overwrite=TRUE, format="GTiff")
```


#SKIP TO HERE 
Read back in the rasters (I think there's no errors...)
```{r}
elevrasterspast <- paste("Elevation",1:89,sep="")

avgElev <- lapply(elevrasterspast, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,".tif",sep=""))
})


```


```{r}

avgElev2 <- lapply(avgElev, function(x){
  mean(x[], na.rm=TRUE)
})
avgElev2 <- do.call(rbind,avgElev2)
mean(avgElev2)

#minimum elevation?
minElev2 <- do.call(rbind,
                    lapply(avgElev, function(x){
                      min(x[], na.rm=TRUE)
                      })
)

mean(minElev2)


#maximum elevation?
maxElev2 <- do.call(rbind,
                    lapply(avgElev, function(x){
                      max(x[], na.rm=TRUE)
                      })
)

```



# Now check the elevation for the apply model to the current time
## Can skip below if already made it
```{r}
apply_models <- lapply(applymax, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_bin_map.tif",sep=""))
})

past_models <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_bin_map.tif",sep=""))
})

elevCO <- raster("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Elevation_VT/CO_Mosaic_Elevation_VT/co_elev_VT_WGS84.tif")

modelrun <- "PRISM_pre1980_current_beta5_minmaxtemp_precip/"
applymax <- paste("ApplyMAXENT",1:89,"_1", sep="")
Maxent <- paste("Maxent_",1:89,sep="")

elevCOcrop <- resample(elevCO, past_models[[1]], method='bilinear')

# Elevation where apply model says it will be
applyavgElev <- lapply(apply_models, function(model){
  shape <- rasterToPolygons(model, fun=function(x){x ==1}, dissolve=TRUE) #make polygons where model bin map == 1
  cr <- crop(elevCOcrop, extent(shape), snap="out")
  shaper <- rasterize(shape, cr)
  elevr <- mask(x=cr, mask=shaper)
  elevr
  })



lapply(1:89, function(x){
    writeRaster(applyavgElev[[x]], 
                paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,"/applyElevation",x,sep=""),format="GTiff",overwrite=TRUE)
})


applyavgElev2 <- lapply(applyavgElev, function(x){
  mean(x[], na.rm=TRUE)
})
applyavgElev2 <- do.call(rbind,applyavgElev2)
mean(applyavgElev2)

#minimum elevation?
applyminElev2 <- do.call(rbind,
                    lapply(applyavgElev, function(x){
                      min(x[], na.rm=TRUE)
                      })
)

mean(applyminElev2)

#maximum elevation?
applymaxElev2 <- do.call(rbind,
                    lapply(applyavgElev, function(x){
                      max(x[], na.rm=TRUE)
                      })
)
```

#skip to here
```{r}
elevrasterscurrent <- paste("applyElevation",1:89,sep="")

applyavgElev <- lapply(elevrasterscurrent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,".tif",sep=""))
})

applyavgElev2 <- lapply(applyavgElev, function(x){
  mean(x[], na.rm=TRUE)
})
applyavgElev2 <- do.call(rbind,applyavgElev2)
mean(applyavgElev2)

#minimum elevation?
applyminElev2 <- do.call(rbind,
                    lapply(applyavgElev, function(x){
                      min(x[], na.rm=TRUE)
                      })
)

mean(applyminElev2)

#maximum elevation?
applymaxElev2 <- do.call(rbind,
                    lapply(applyavgElev, function(x){
                      max(x[], na.rm=TRUE)
                      })
)

```
 
```{r}
minavg <- rbind(data.frame("elevation (m)" = avgElev2,
                           stat = "avg",
                           Time = "Pre1980"),
                data.frame("elevation (m)" = minElev2,
                           stat = "min",
                           Time = "Pre1980"),
                data.frame("elevation (m)" = maxElev2,
                           stat = "max",
                           Time = "Pre1980"),
                data.frame("elevation (m)" = applyavgElev2,
                           stat = "avg",
                           Time = "Post1980"),
                data.frame("elevation (m)" = applyminElev2,
                            stat = "min",
                            Time = "Post1980"),
                data.frame("elevation (m)" = applymaxElev2,
                            stat = "max",
                            Time = "Post1980")
                )

```


Plot the change in mean min and max elevation of the models and the applymodels
```{r}
tiff("Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/changeavgminmax_tempprecip.tiff", width = 200, height = 75, compression="lzw",
     units = "mm", res = 1200)

ggplot(minavg, aes(Time, elevation..m., colour=Time))+
  geom_boxplot()+
  facet_wrap(~stat)+
  labs(y="elevation (m)")

dev.off()
```




```{r}

past_models_prob <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_prob_map.tif",sep=""))
})


apply_models_prob <- lapply(applymax, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_prob_map.tif",sep=""))
})

# All herbarium data points
all <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80.csv")

pre1980 <- read.csv("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/FieldData_AlPh_over80pre1980.csv")

# match id from pre1980, that matches order of models, to ID from all for which species
IDcode <- merge(all[,c("scientificName","ID")],
                pre1980[,c("ID","id")], by = "ID")
  

nrow(unique(IDcode)) #333 many synonyms
unique(IDcode$id)
```

#1:45 are sign changing phenology, 46:340 (339) are not sign changing in phenology   
```{r}
elevCO <- raster("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Elevation_VT/CO_Mosaic_Elevation_VT/co_elev_VT_WGS84.tif")

modelrun <- "PRISM_pre1980_current_beta5_minmaxtemp_precip/"
applymax <- paste("ApplyMAXENT",1:89,"_1", sep="")
Maxent <- paste("Maxent_",1:89,sep="")

past_models <- lapply(Maxent, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_bin_map.tif",sep=""))
})

x <- 1

plot(past_models[[x]], col = c("#696969","#ffffff"),
     legend=FALSE,
     xlab="Longitude", ylab="Latitude")
  points(all[all$id == x & all$year < 1980, c("decimalLongitude","decimalLatitude")],
         pch=16, cex=0.75, col="brown2")




```

# All points after 1980
Are post 1980 points within the applymodel for each?   
##somehow 0 and 1 seem switched, length says most are out (0) but proportion table says most are in (1)      

###Check just min, max temp, annual precip, AND GDD?   
ENVIREM    
<http://envirem.github.io/>    
GDD <https://deepblue.lib.umich.edu/data/concern/generic_works/gt54kn05f>  


```{r}
#install.packages("envirem")
library(envirem)


rasterFiles <- list.files(system.file('extdata', package='envirem'), full.names=TRUE)
env <- stack(rasterFiles) #bioclim data, 80 layers
meantemp <- env[[grep('tmean', names(env), value=TRUE)]]
growingDegDays(meantemp, 10)

```

For points after 1980 and climate averaged over 1981:2011
```{r}
apply_models <- lapply(applymax, function(x){
  raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxent_bin_map.tif",sep=""))
})

# need to extract all the climate variables for those points
bioclims <- lapply(1:89, function(x){
  allID <- unique(pre1980$ID[pre1980$id == x])
  pntplot <- all[all$ID ==allID & all$year > 1980,
                 c("decimalLongitude","decimalLatitude")]
    out <- extract(apply_models[[x]], pntplot, fun=mean) # to get a vector of 0|1
  if(allID < 46){   # IDs 1:45 are significantly changing in phenology
    out <- data.frame(InOut = out, PhenSign = "SignChange", id = x)
  } else {
    out <- data.frame(InOut = out, PhenSign = "NoChange", id = x)
  }
  for(i in 1:19){
    bioclimnow <- raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/prism_1900_1930/bio",i,".tif",
                               sep=""))
    out <- data.frame(out, bio = extract(bioclimnow, pntplot, fun=mean))
  }
  out
})

length(bioclims[[1]]$InOut[bioclims[[1]]$InOut==0])
length(bioclims[[1]]$InOut[bioclims[[1]]$InOut==1])

bioclimPCA <- do.call(rbind,bioclims)

shiftnames <- names(bioclimPCA)
names(bioclimPCA) <- c(shiftnames[-4],"bio.19")

# get rid of some NA values 379 rows with NA for inout and all bioclim
bioclimPCA <- bioclimPCA[!is.na(bioclimPCA$InOut),]
```


Start with only Bio5,6,and 12 to match min and max annual temp and annual precip from phenology
```{r}
lm_temprecip <- lm(InOut ~ bio.5 + bio.6 + bio.12, data=bioclimPCA[bioclimPCA$id==1,])
summary(lm_temprecip)
```

```{r}
lm_temprecip1 <- lm(InOut ~ bio.5 + bio.6 + bio.12, 
                    data=bioclimPCA[bioclimPCA$PhenSign== "SignChange",])
summary(lm_temprecip1)

lm_temprecip2 <- lm(InOut ~ bio.5 + bio.6 + bio.12, 
                    data=bioclimPCA[bioclimPCA$PhenSign=="NoChange",])
summary(lm_temprecip2)


```



##SKIP THIS ONE
```{r}
#who explains the most deviation, before exclude some correlated variables
# Why is bio.7 NA???


lm1 <- lm(InOut ~ bio.1+bio.2+bio.3+bio.4+bio.5+
            bio.6+bio.7+bio.8+bio.9+bio.10+
            bio.11+bio.12+bio.13+bio.14+bio.15+
            bio.16+bio.17+bio.18+bio.19, data=bioclimPCA[bioclimPCA$id==1,])

summary(lm1)

# if I want to narrow it down, use only these:
lmstep <- step(lm(InOut ~ bio.1+bio.2+bio.3+bio.4+bio.5+
            bio.6+bio.7+bio.8+bio.9+bio.10+
            bio.11+bio.12+bio.13+bio.14+bio.15+
            bio.16+bio.17+bio.18+bio.19, data=bioclimPCA[bioclimPCA$id==1,]))
summary(lmstep)
```

```{r}
alph.pca <- princomp(bioclimPCA[bioclimPCA$id==1,-c(1:3)], cor=TRUE)
summary(alph.pca)
alph.load <- loadings(alph.pca)
alph.pc <- predict(alph.pca)

ggplot(data.frame(alph.pc,bioclimPCA[bioclimPCA$id==1,1:2]), 
       aes(Comp.1,Comp.2, colour=as.factor(InOut)))+
  geom_point()+
  stat_ellipse()
```


```{r}
plots <- lapply(1:89, function(x){
  alph.pca <- princomp(bioclimPCA[bioclimPCA$id==x,c("bio.5","bio.6","bio.12")], cor=TRUE)
  sumr <- summary(alph.pca)
  alph.load <- loadings(alph.pca)
  alph.pc <- predict(alph.pca)
  
  p <- ggplot(data.frame(alph.pc,bioclimPCA[bioclimPCA$id==x,1:2]), 
              aes(Comp.1,Comp.2, colour=as.factor(InOut)))+
    geom_point()+
    stat_ellipse()
  list(p,sumr,alph.load,alph.pc)
  })


plots[[2]][3][[1]]

```



print apply models; make the Images folder first
```{r}
dpi = 1200
for(i in 1:89){
tiff(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,"Images/PCA",i,".tiff", 
           sep=""), width = 130, height = 90, compression="lzw", units = "mm", res=dpi)

print(plots[[i]][1])

dev.off()
}

```


Which species are directionally different, in and out, and what are the important factors (comp.1 and comp.2) in distigusihing points.   
What proportion of later points are in the model
```{r}
inout <- do.call(rbind,
                 lapply(bioclims, function(x){
                   out <- prop.table(table(x$InOut))
                   out <- data.frame(out,
                                     PhenoChange = unique(x$PhenSign),
                                     id = unique(x$id))
                   out
                   }))

ggplot(inout, aes(Var1,Freq,colour = Var1))+
  geom_boxplot()+
  facet_grid(~PhenoChange)+
  guides(fill=guide_legend(title="Apply Model"))


aggregate(Freq~Var1, inout, mean) #0: 0.629; 1: 0.371
aggregate(Freq~Var1, inout, sd) # 0: 0.1928782, 1:0.1928782   same? yes! proportions, same N, when one is bigger, one is smaller
aggregate(Freq~Var1, inout, function(x) c(mean=mean(x), sd=sd(x), se = std.error(x)))

length(unique(bioclimPCA$id[bioclimPCA$PhenSign=="SignChange"])) #12
length(unique(bioclimPCA$id[bioclimPCA$PhenSign=="NoChange"])) #77


```


#compare to how many points are in and out of first model - is the apply model just the same goodness?   
Points pre 1980 with past_models (1900-1930)
```{r}
# need to extract all the climate variables for those points
bioclims_past <- lapply(1:89, function(x){
  allID <- unique(pre1980$ID[pre1980$id == x])
  pntplot <- all[all$ID ==allID & all$year < 1981,
                 c("decimalLongitude","decimalLatitude")]
    out <- extract(past_models[[x]], pntplot, fun=mean) # to get a vector of 0|1
  if(allID < 46){
    out <- data.frame(InOut = out, PhenSign = "SignChange", id = x)
  } else {
    out <- data.frame(InOut = out, PhenSign = "NoChange", id = x)
  }
  for(i in 1:19){
    bioclimnow <- raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/prism_1900_1930/bio",i,".tif",
                               sep=""))
    out <- data.frame(out, bio = extract(bioclimnow, pntplot, fun=mean))
  }
  out
})

bioclimPCA_past <- do.call(rbind,bioclims_past)

shiftnames <- names(bioclimPCA_past)
names(bioclimPCA_past) <- c(shiftnames[-4],"bio.19")

write.table(bioclimPCA_past, 
            file = "Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta5_minmaxtemp_precip/bioclimPCA_past.csv", 
            sep=",", row.names=FALSE)


```


```{r}
lm1 <- (lm(InOut ~ bio.5+ bio.6+bio.12, 
               data=bioclimPCA_past[bioclimPCA_past$id==1,]))


summary(lm1)
```



#Skip!
```{r}
lm1 <- step(lm(InOut ~ bio.1+bio.2+bio.3+bio.4+bio.5+
            bio.6+bio.7+bio.8+bio.9+bio.10+
            bio.11+bio.12+bio.13+bio.14+bio.15+
            bio.16+bio.17+bio.18+bio.19, data=bioclimPCA_past[bioclimPCA_past$id==1,]))


summary(lm1)
```


```{r}
plots_past <- lapply(1:89, function(x){
  bionow <- bioclimPCA_past[bioclimPCA_past$id==x & 
                              !is.na(bioclimPCA_past$bio.1),] #some NA problems
  alph.pca <- princomp(bionow[,c("bio.5","bio.6","bio.12")],
                       cor=TRUE)
  sumr <- summary(alph.pca)
  alph.load <- loadings(alph.pca)
  alph.pc <- predict(alph.pca)
  
  p <- ggplot(data.frame(alph.pc,bionow[,1:2]), 
              aes(Comp.1,Comp.2, colour=as.factor(InOut)))+
    geom_point()+
    stat_ellipse()
  list(p,sumr,alph.load,alph.pc)
  })


```


print past models   
There is divergence in what was predicted to be in and in, vs. predicted to be in but out
```{r}
dpi = 1200
for(i in 1:89){
tiff(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,"Images/PCApast",i,".tiff", 
           sep=""), width = 130, height = 90, compression="lzw", units = "mm", res=dpi)

print(plots_past[[i]][1])

dev.off()
}

```


```{r}
inout_past <- do.call(rbind,lapply(bioclims_past, function(x){
  x <- x[complete.cases(x),]
  out <- prop.table(table(x$InOut))
#  out <- data.frame(out, c("Out","In"))
  out <- data.frame(Value = out,
                    PhenoChange = unique(x$PhenSign),
                    id = unique(x$id))
  out
}))

levels(inout_past$PhenoChange)[levels(inout_past$PhenoChange)=="SignChange"] <- "Significant change in phenology"
levels(inout_past$PhenoChange)[levels(inout_past$PhenoChange)=="NoChange"] <- "No significant change in phenology"


ggplot(inout_past, aes(Value.Var1,Value.Freq,colour = Value.Var1))+
  geom_boxplot()+
  facet_grid(~PhenoChange)+
  xlab("In or Out")+
  ylab("Freq")+
  theme(legend.position="none")

library(plotrix)
#bioclimPCA_past is rbind of list bioclims_past
aggregate(Value.Freq~Value.Var1, inout_past, mean) #0: 0.1749858; 1: 0.8250142
aggregate(Value.Freq~Value.Var1, inout_past, sd) #0: 0.07129328; 1: 0.07129328
aggregate(Value.Freq~Value.Var1, inout_past, function(x){
  c(mean=mean(x), sd=sd(x), SE = std.error(x))
  })


length(unique(bioclimPCA_past$id[bioclimPCA_past$PhenSign=="SignChange"])) #12
length(unique(bioclimPCA_past$id[bioclimPCA_past$PhenSign=="NoChange"])) #77


```



Examine PCA for models and for apply models. What direction are the points that are real collections, species found in that environmental space, but the model doesn't predict as should be found there.   
```{r}
# Importance of components  # can't find it!!
plots[[1]][2][[1]]$scores #same as components (next)
plots[[1]][2][[1]]$cutoff #question below, stop showing loadings below 0.1
plots[[1]][2][[1]]$call

# components - to be cbind with 0|1 column and t-tested
head(plots[[1]][4][[1]][,1:2])

# loadings of each component
plots[[1]][3][[1]][,1] #comp.1: values for loadings < 0.08 aren't shown, don't know the real cuttoff

plots[[1]][3][[1]][,2] #comp.2
sort(abs(plots[[1]][3][[1]][,2]))

# lm
p.df <- cbind(plots[[1]][4][[1]][,1:2],bioclimPCA[bioclimPCA$id==1,1:2])

sum.out <- summary(glm(InOut~Comp.1*Comp.2, data=p.df))
sum.out$coefficients[2,4] #significance of Comp.1
sum.out$coefficients[3,4] #significance of Comp.2
sum.out$coefficients[4,4] #significance of interaction Comp.1*Comp.2

# Top three loadings for signficant axes
top3 <- sort(abs(plots[[1]][3][[1]][,1]))[1:3] # top three but lost the actual values
plots[[1]][3][[1]][c(names(top3)),1] # Ha ha!! got 'em

# for comp.1
p.tt <- t.test(Comp.1~InOut, data=p.df, paired=FALSE)
p.tt$estimate[1]  #group mean for 0 (out)
p.tt$estimate[2]  #group mean for 1 (in)
p.tt$p.value

ggplot(p.df, aes(InOut, Comp.1, group=InOut))+
  geom_boxplot()+
  facet_wrap(~PhenSign) #When combine all values from all species


ggplot(p.df, aes(InOut, Comp.2, group=InOut))+
  geom_boxplot()+
  facet_wrap(~PhenSign) #When combine all values from all species


# need which component is signficant in explaining differences, need biggest loadings for each component, and then if there's a significant differece between the two groups for any component
pca.results <- lapply(1:89, function(x){
  loads <- cbind(plots[[x]][4][[1]][,1:2],bioclimPCA[bioclimPCA$id==x,1:2])
  lm.out <- summary(glm(InOut~Comp.1*Comp.2, data=loads, family="binomial")) #with logistic link as default
  top3.comp1 <- sort(abs(plots[[x]][3][[1]][,1]))[1:3] #top three loadings
  top3.comp2 <- sort(abs(plots[[x]][3][[1]][,2]))[1:3]

  p.df <- cbind(plots[[x]][4][[1]][,1:2],bioclimPCA[bioclimPCA$id==x,1:2],ID=x)

  #Component 1
  if(lm.out$coefficients[2,4]<0.05){
    load.comp1 <- data.frame(t(data.frame(plots[[x]][3][[1]][c(names(top3.comp1)),1])))
    p.df$Comp1Sign <- "Significant"
  } else {
    load.comp1 <- data.frame(none=NA)
    p.df$Comp1Sign <- "NotSignificant"
  }
  
  #Component 2
  if(lm.out$coefficients[3,4]<0.05){
    load.comp2 <- data.frame(t(data.frame(plots[[x]][3][[1]][c(names(top3.comp2)),2])))
    p.df$Comp2Sign <- "Significant"
  } else {
    load.comp2 <- data.frame(none=NA)
    p.df$Comp2Sign <- "NotSignificant"
  }
  
  #Component 1 * Component 2
  if(lm.out$coefficients[4,4]<0.05){
    load.comp1.2 <- cbind(data.frame(t(data.frame(plots[[x]][3][[1]][c(names(top3.comp1)),1]))),
                          data.frame(t(data.frame(plots[[x]][3][[1]][c(names(top3.comp2)),2]))))
    p.df$Comp1.2Sign <- "Significant"
  } else {
    load.comp1.2 <- data.frame(none=NA)
    p.df$Comp1.2Sign <- "NotSignificant"
  }
  
  out <- list(lm.out, load.comp1, load.comp2, load.comp1.2, p.df)
  out
})

comps <- do.call(rbind,lapply(pca.results, "[[", 5))

levels(comps$PhenSign)[levels(comps$PhenSign)=="SignChange"] <- "Significant change in phenology"
levels(comps$PhenSign)[levels(comps$PhenSign)=="NoChange"] <- "No significant change in phenology"


numcomp1 <- unique(comps[,c("ID","PhenSign","Comp1Sign")])
table(numcomp1$PhenSign,numcomp1$Comp1Sign)


ggplot(comps, aes(InOut, Comp.1, group=as.factor(InOut), colour=as.factor(InOut)))+
  geom_boxplot()+
  facet_wrap(~PhenSign+Comp1Sign)+
  theme(legend.position = "none")+
  theme_bw()


ggplot(comps, aes(InOut, Comp.2, group=as.factor(InOut), colour=as.factor(InOut)))+
  geom_boxplot()+
  facet_wrap(~PhenSign+Comp2Sign)+
  theme(legend.position = "none")+
  theme_bw()

pca.results.comp1 <- do.call(rbind.fill, sapply(pca.results, "[[", 2)) #sapply to get second list item and then rbind.fill for each of those

pca.results.comp2 <- do.call(rbind.fill, sapply(pca.results, "[[", 3)) 

pca.results.comp1.2 <- do.call(rbind.fill, sapply(pca.results, "[[", 4)) 

head(pca.results.comp1.2)

#Awesome but comp1 changes for each, need to summarize what's important for comp1 across...
comp1long <- melt(data.frame(pca.results.comp1,
                             ID=as.numeric(row.names(pca.results.comp1))),
                  id.vars="ID")

ggplot(comp1long[comp1long$variable != "none",], aes(variable,value))+
  geom_boxplot(varwidth = TRUE)
```




```{r}
ggplot(comps, aes(Comp.1,Comp.2,colour=as.factor(InOut)))+
  geom_point(alpha=0.25)+
  stat_ellipse(size=1.5)

ggplot(comps, aes(Comp.1,Comp.2,colour=as.factor(InOut)))+
  geom_point(alpha=0.25)+
  stat_ellipse(size=2)+
  facet_wrap(~PhenSign)

ggplot(comps, aes(Comp.1,Comp.2,colour=as.factor(InOut)))+
  geom_point(alpha=0.25)+
  stat_ellipse(size=2)+
  facet_wrap(~PhenSign+Comp1Sign)

```


#Compare the points of pre-1980 to 1900-1930 bioclim with points post-1980 and 1981-2011 bioclim averages. Do the same shifts in climate hold or is it just that the models aren't great?   
```{r}
compareprepost <- rbind(data.frame(bioclimPCA,Time="Post"),
                        data.frame(bioclimPCA_past,Time="Pre"))


pp.pca <- lapply(1:89, function(x){
  alph.pca <- princomp(compareprepost[compareprepost$id==x &
                                        complete.cases(compareprepost),
                                      -c(1:3,23)], cor=TRUE)
  sumr <- summary(alph.pca)
  alph.load <- loadings(alph.pca)
  alph.pc <- predict(alph.pca)
  
  toplot <- data.frame(alph.pc,compareprepost[compareprepost$id==x &
                                        complete.cases(compareprepost),
                                        c(1:3,23)])
  
  p <- ggplot(toplot, 
              aes(Comp.1,Comp.2, colour=as.factor(Time)))+
    geom_point()+
    stat_ellipse()
  list(p,sumr,alph.load,toplot)
  })

allpoints <- do.call(rbind, lapply(pp.pca, "[[", 4)) #bind the 4th element of each list

ggplot(allpoints, aes(Comp.1, Comp.2, colour=Time))+
  stat_ellipse(size=1.5)+
  geom_point(alpha=0.1)+
  facet_wrap(~PhenSign)
  


###start here! What are the loadings for Comp 2? That seems to be getting less spread in post from pre, experiencing a more narrow climate envelope
```


## bioclimPCA and bioclimPCA_past are the herbarium points per species (id) with notation of whether the model put them in or out of the threshold niche and bioclim value for all  
     1. Want to know if there is a shift in the temp or precip and what splits the pre and post points     
     2. does it make a difference if they are significantly changing in phenology or not
```{r}
bioclimPCA$Time <- "After 1980"
bioclimPCA_past$Time <- "Before 1980"

bioclimPCA_both <- rbind(bioclimPCA_past,bioclimPCA)

unique(bioclimPCA_both$id)

```

Would be great to use only specimens from <1930 vs. specimens from 1982:2011    
#Perform PCA compare bioclimatic envelop of <1930 to >1980
```{r}
bioclims_pastpre1930 <- lapply(1:89, function(x){
  allID <- unique(pre1980$ID[pre1980$id == x])
  pntplot <- all[all$ID ==allID & all$year < 1931 & all$year > 1800,
                 c("decimalLongitude","decimalLatitude")]
    out <- extract(past_models[[x]], pntplot, fun=mean) # to get a vector of 0|1
  if(allID < 46){
    out <- data.frame(InOut = out, PhenSign = "SignChange", id = x)
  } else {
    out <- data.frame(InOut = out, PhenSign = "NoChange", id = x)
  }
  for(i in 1:19){
    bioclimnow <- raster(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/prism_1900_1930/bio",i,".tif",
                               sep=""))
    out <- data.frame(out, bio = extract(bioclimnow, pntplot, fun=mean))
  }
  out
})

bioclimPCA_pastpre1930 <- do.call(rbind,bioclims_pastpre1930)

#bioclimPCA$Time <- "After 1980"
names(bioclimPCA_pastpre1930) <- c(shiftnames[-4],"bio.19")
bioclimPCA_pastpre1930$Time <- "Before 1930"

bioclimPCA_bothpre1930 <- rbind(bioclimPCA_pastpre1930,bioclimPCA)

lm.both.1930 <- glm(as.numeric(as.factor(Time))~bio.5+bio.6+bio.12, data=bioclimPCA_bothpre1930)
summary(lm.both.1930)

#Min temp and precip
ggplot(bioclimPCA_bothpre1930, aes(bio.6, bio.12, colour=Time))+
  geom_point()+
  stat_ellipse()

climateenv.1930 <- cbind(aggregate(bio.5~Time+PhenSign, mean, data=bioclimPCA_bothpre1930),
                    bio.5.sd = aggregate(bio.5~Time+PhenSign, sd, data=bioclimPCA_bothpre1930)[,3],
                    bio.6 =aggregate(bio.6~Time+PhenSign, mean, data=bioclimPCA_bothpre1930)[,3],
                    bio.6.sd = aggregate(bio.6~Time+PhenSign, sd, data=bioclimPCA_bothpre1930)[,3],
                    bio.12 = aggregate(bio.12~Time+PhenSign, mean,
                                       data=bioclimPCA_bothpre1930)[,3],
                    bio.12.sd = aggregate(bio.12~Time+PhenSign, sd,
                                          data=bioclimPCA_bothpre1930)[,3])

levels(climateenv.1930$PhenSign)[levels(climateenv.1930$PhenSign)=="SignChange"] <- "Significant change in phenology"
levels(climateenv.1930$PhenSign)[levels(climateenv.1930$PhenSign)=="NoChange"] <- "No significant change in phenology"


ggplot(climateenv.1930,aes(x = bio.6,y = bio.12, colour= Time))+
  geom_point()+
  geom_errorbarh(aes(xmin = bio.6-bio.6.sd, xmax = bio.6+bio.6.sd), height = 0.2)+
  geom_errorbar(aes(ymin = bio.12-bio.12.sd, ymax = bio.12+bio.12.sd),width = 0.2)+
  xlab("Min Temperature of Coldest Month")+
  ylab("Annual Precipitation")+
  facet_wrap(~PhenSign) #does it matter if they changed in phenology?


ggplot(climateenv.1930,aes(x = bio.5,y = bio.12, colour= Time))+
  geom_point()+
  geom_errorbarh(aes(xmin = bio.5-bio.5.sd, xmax = bio.5+bio.5.sd), height = 0.2)+
  geom_errorbar(aes(ymin = bio.12-bio.12.sd, ymax = bio.12+bio.12.sd),width = 0.2)+
#  geom_segment(data = reshape(climateenv.1930, idvar = "PhenSign",
#                       timevar="Time", direction="wide"),
#               aes(x="bio.5.Before 1930",xend="bio.5.After 1980",
#                   y="bio.12.Before 1930",yend="bio.12.After 1980"))+
  xlab("Max Temperature of Warmest Month")+
  ylab("Annual Precipitation")+
  facet_wrap(~PhenSign) #does it matter if they changed in phenology?

ggplot(climateenv.1930,aes(x = bio.5,y = bio.6, colour= Time))+
  geom_point()+
  geom_errorbarh(aes(xmin = bio.5-bio.5.sd, xmax = bio.5+bio.5.sd), height = 0.2)+
  geom_errorbar(aes(ymin = bio.6-bio.6.sd, ymax = bio.6+bio.6.sd),width = 0.2)+
  xlab("Max Temperature of Warmest Month")+
  ylab("Min Temperature of Coldest Month")+
  facet_wrap(~PhenSign)

```



#Perform PCA to compare bioclimatic envelop of pre 1980 to post 1980
```{r}
lm.both <- glm(as.numeric(as.factor(Time))~bio.5+bio.6+bio.12, data=bioclimPCA_both)
summary(lm.both)

ggplot(bioclimPCA_both, aes(bio.6, bio.12, colour=Time))+
  geom_point()+
  stat_ellipse()

climateenv <- cbind(aggregate(bio.5~Time+PhenSign, mean, data=bioclimPCA_both),
                    bio.5.sd = aggregate(bio.5~Time+PhenSign, sd, data=bioclimPCA_both)[,3],
                    bio.6 =aggregate(bio.6~Time+PhenSign, mean, data=bioclimPCA_both)[,3],
                    bio.6.sd = aggregate(bio.6~Time+PhenSign, sd, data=bioclimPCA_both)[,3],
                    bio.12 = aggregate(bio.12~Time+PhenSign, mean, data=bioclimPCA_both)[,3],
                    bio.12.sd = aggregate(bio.12~Time+PhenSign, sd, data=bioclimPCA_both)[,3])


levels(climateenv$PhenSign)[levels(climateenv$PhenSign)=="SignChange"] <- "Significant change in phenology"
levels(climateenv$PhenSign)[levels(climateenv$PhenSign)=="NoChange"] <- "No significant change in phenology"


ggplot(climateenv,aes(x = bio.6,y = bio.12, colour= Time))+
  geom_point()+
  geom_errorbarh(aes(xmin = bio.6-bio.6.sd, xmax = bio.6+bio.6.sd), height = 0.2)+
  geom_errorbar(aes(ymin = bio.12-bio.12.sd, ymax = bio.12+bio.12.sd),width = 0.2)+
  xlab("Min Temperature of Coldest Month")+
  ylab("Annual Precipitation")+
  facet_wrap(~PhenSign) #does it matter if they changed in phenology?

ggplot(climateenv,aes(x = bio.5,y = bio.12, colour= Time))+
  geom_point()+
  geom_errorbarh(aes(xmin = bio.5-bio.5.sd, xmax = bio.5+bio.5.sd), height = 0.2)+
  geom_errorbar(aes(ymin = bio.12-bio.12.sd, ymax = bio.12+bio.12.sd),width = 0.2)+
  xlab("Max Temperature of Warmest Month")+
  ylab("Annual Precipitation")+
  facet_wrap(~PhenSign)


ggplot(climateenv,aes(x = bio.5,y = bio.6, colour= Time))+
  geom_point()+
  geom_errorbarh(aes(xmin = bio.5-bio.5.sd, xmax = bio.5+bio.5.sd), height = 0.2)+
  geom_errorbar(aes(ymin = bio.6-bio.6.sd, ymax = bio.6+bio.6.sd),width = 0.2)+
  xlab("Max Temperature of Warmest Month")+
  ylab("Min Temperature of Coldest Month")+
  facet_wrap(~PhenSign)
```


maxentResults summarize   
```{r}
maxentResults <- do.call(rbind,
                         lapply(Maxent, function(x){
                           maxout <- read.csv( paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/",modelrun,x,"/maxentResults.csv", sep=""))
                         maxout})
                         )

head(maxentResults)
mean(maxentResults$Training.AUC)
min(maxentResults$Training.AUC)
max(maxentResults$Training.AUC)

hist(maxentResults$Training.AUC)

mean(maxentResults$Equal.training.sensitivity.and.specificity.cumulative.threshold)
mean(maxentResults$Equal.training.sensitivity.and.specificity.logistic.threshold)

mean(maxentResults$Maximum.training.sensitivity.plus.specificity.logistic.threshold)

```



Which species go up or down in elevation?
```{r}
habitXsp <- read.csv("Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/Table1.csv")


FD_all_habit <- merge(FD_all, habitXsp[,-4], by.x = "ID", by.y = "Order")

FD_all_habit <- FD_all_habit[FD_all_habit$minimumElevationInMeters>1600&
                             FD_all_habit$minimumElevationInMeters<4300,] #&FD_all_habit$year>1950
  
FD_all_habit$DurationGroup <- "Annual"
FD_all_habit$DurationGroup[grep("Perennial",FD_all_habit$Duration)] <- "Perennial"

FD_all_habit$Phenology[FD_all_habit$Phenology=="Significant"] <- "Significant change in phenology"
FD_all_habit$Phenology[FD_all_habit$Phenology=="NoChange"] <- "No significant change in phenology"


# Which species are increaseing or not elevation..  
# Assume annuals can move faster

ggplot(FD_all_habit, aes(year, minimumElevationInMeters,colour=as.factor(ID)))+
  geom_point()+
  stat_smooth(method="lm")+
  facet_wrap(~Duration)+
  theme(legend.position="none")


FD_all_habit$GrowthHabitGroup <- "Shrub/Tree"
FD_all_habit$GrowthHabitGroup[grep("Forb",FD_all_habit$GrowthHabit)] <- "Forb/herb"
FD_all_habit$GrowthHabitGroup[grep("Graminoid",FD_all_habit$GrowthHabit)] <- "Graminoid"

ggplot(FD_all_habit, 
       aes(year, minimumElevationInMeters))+  #,colour=as.factor(ID)
  geom_point(pch=21)+
  stat_smooth(method="lm", se=FALSE)+
  facet_wrap(~DurationGroup+Phenology+GrowthHabitGroup, ncol=4)+
  theme(legend.position="none")

ggplot(FD_all_habit, 
       aes(year, minimumElevationInMeters))+  #,colour=as.factor(ID)
  geom_point(pch=21)+
  stat_smooth(method="lm", se=FALSE)+
  facet_wrap(~DurationGroup+Phenology, ncol=4)+
  theme_bw()+
  theme(legend.position="none")


```



Elevation given latitude over time?   
```{r}
summary(lm(minimumElevationInMeters ~ decimalLatitude + year, data=FD_all_habit))


summary(lm(minimumElevationInMeters ~ Phenology + year, data=FD_all_habit))

summary(lm(minimumElevationInMeters ~ year,
           data=FD_all_habit[FD_all_habit$year>1949&FD_all_habit$year<2012,]))

summary(lm(decimalLatitude ~ year,
           data=FD_all_habit[FD_all_habit$year>1949&FD_all_habit$year<2012,]))

#What about just the ones that are not changing in phenology, are they instead changing in elevation or latitude
summary(lm(minimumElevationInMeters ~ year,
           data=FD_all_habit[FD_all_habit$year>1949&FD_all_habit$year<2012&
                               FD_all_habit$Phenology == "No significant change in phenology",]))


# can you predict if it'll change in phenology or not but whether it is changing in elevation and/or latidutde?

summary(lm(as.numeric(as.factor(Phenology)) ~ decimalLatitude + year,
           data=FD_all_habit))

summary(lm(as.numeric(as.factor(Phenology)) ~ (decimalLatitude + year + minimumElevationInMeters)^2,
           data=FD_all_habit))

summary(lm(as.numeric(as.factor(Phenology)) ~ year*minimumElevationInMeters,
           data=FD_all_habit))
```
```{r}


ggplot(FD_all_habit[FD_all_habit$year>1949&FD_all_habit$year<2012,], aes(year,decimalLatitude))+
  geom_point()+
  stat_smooth(method="lm")


ggplot(FD_all_habit[FD_all_habit$year>1949&FD_all_habit$year<2012,], aes(year,minimumElevationInMeters))+
  geom_point()+
  stat_smooth(method="lm")


ggplot(FD_all_habit, aes(year,decimalLatitude))+
  geom_point()+
  stat_smooth(method="lm")

```








<http://paldhous.github.io/ucb/2016/dataviz/week14.html> 
Animate map
```{r}


library(readr)
library(ggplot2)
library(gganimate)
library(scales)
library(dplyr)

FD_all <- FieldData_all[FieldData_all$year > 1800 &
                          FieldData_all$year < 2018,]

val <- getValues(overlap10[[1]])
xy <- as.data.frame(xyFromCell(overlap10[[1]], 1:ncell(overlap10[[1]])))
xy <- cbind(xy,val)

yearplot <- ggplot(data=na.omit(xy), aes(x,y,fill=factor(val)))+
  geom_tile()+
  geom_polygon(data=overlap10[[1]],aes(x=lon))
  geom_point(FD_all)
  
  
yearplot <- ggplot(FD_all[FD_all$minimumElevationInMeters>1600&
                             FD_all$minimumElevationInMeters<4300,], 
                   aes(x=decimalLongitude, y=decimalLatitude, frame=year))+
  geom_point(aes(colour = minimumElevationInMeters))

gganimate(yearplot)

gganimate(yearplot, "Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/herbariumxyear.gif", ani.width = 750, ani.height = 750, interval = 0.1)

```



```{r}
elevXyear <- ggplot(FD_all[FD_all$minimumElevationInMeters>1600&
                             FD_all$minimumElevationInMeters<4300,], 
                    aes(x=decimalLatitude, y=minimumElevationInMeters, frame=year,
                        cumulative = TRUE, colour = year))+
  geom_point()+
  scale_colour_gradientn(colours = terrain.colors(10))+
  stat_smooth(aes(group=year), method = "lm", se=FALSE, formula = y ~ x +I(x^2),
              size=0.5, color="black", linetype="dotted")+
  ylab("elevation (m)")+
  xlab("Latitude")

gganimate(elevXyear)

gganimate(elevXyear, "Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/elevationandLatxyear.gif", ani.width = 750, ani.height = 750, interval = 0.1)

```

```{r}
elevXyear1 <- ggplot(FD_all[FD_all$minimumElevationInMeters>1600&
                             FD_all$minimumElevationInMeters<4300,], 
                    aes(x=decimalLatitude, y=minimumElevationInMeters, frame=year,
                        cumulative = FALSE, colour = year))+
  geom_point()+
  scale_colour_gradientn(colours = terrain.colors(10))+
  stat_smooth(aes(group=year), method = "lm", se=FALSE, formula = y ~ x +I(x^2),
              size=0.5, color="black", linetype="dotted")+
  ylab("elevation (m)")+
  xlab("Latitude")

gganimate(elevXyear1, "Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/elevationandLatxyearNOTcumulative.gif", ani.width = 750, ani.height = 750, interval = 0.1)

```



```{r}
FD_all$Phenology[FD_all$ID<46] <- "Significant"
FD_all$Phenology[FD_all$ID>45] <- "NoChange"

FD_all <- FD_all[complete.cases(FD_all),]

elevXyear2 <- ggplot(FD_all[FD_all$minimumElevationInMeters>1600&
                             FD_all$minimumElevationInMeters<4300,], 
                    aes(x=Phenology, y=minimumElevationInMeters, frame=as.factor(year),
                        cumulative = TRUE))+
  geom_boxplot(position="identity")+
  ylab("elevation (m)")+
  xlab("Phenology")+
  theme(legend.position="none")

gganimate(elevXyear2, "Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/boxplotelevation.gif", ani.width = 750, ani.height = 750, interval = 0.2)


```


```{r}

elevXyear3 <- ggplot(FD_all[FD_all$minimumElevationInMeters>3200&
                             FD_all$minimumElevationInMeters<4300,], 
                    aes(x=year, y=minimumElevationInMeters, frame=year,
                        cumulative = TRUE, colour= as.factor(id)))+
  geom_point()+
  ylab("elevation (m)")+
  xlab("Phenology")+
  facet_wrap(~Phenology)+
  stat_smooth(method = "lm", se=FALSE)+# , #formula = y ~ x +I(x^2),
  theme(legend.position="none")

gganimate(elevXyear3, "Q:/Research/Presentations/External Conference presentations/Natural Areas Conference 2017/elevationXyearXphenology.gif", ani.width = 750, ani.height = 750, interval = 0.2)


```


So how many points pre 1980 correspond to 1 - lost, 2 - new, or 3 kept vs. how many points after 1980 correspond to 1, 2, or 3?
```{r}

collpnts_pre <- lapply(1:89, function(x){
  fullID <- unique(FieldData_pre1980$ID[FieldData_pre1980$id == x])
  pntsplot <- FieldData_all[FieldData_all$ID == fullID & FieldData_all$year <= 1980,
                            c("decimalLongitude","decimalLatitude")]
  out <- extract(overlap10[[x]], pntsplot, fun=mean)
})


hist(collpnts_pre[[7]])


collpnts_post <- lapply(1:89, function(x){
  fullID <- unique(FieldData_pre1980$ID[FieldData_pre1980$id == x])
  pntsplot <- FieldData_all[FieldData_all$ID == fullID & FieldData_all$year > 1980,
                            c("decimalLongitude","decimalLatitude")]
  out <- extract(overlap10[[x]], pntsplot, fun=mean)
})

hist(collpnts_post[[30]])

## Don't want chi square for model performance. 
# Want AUC for model performance for current, want 
anovatest <- lapply(1:89, function(x){
  zero <- length(collpnts_pre[[x]][collpnts_pre[[x]]==0])
  one <-length(collpnts_pre[[x]][collpnts_pre[[x]]==1])
  two <-length(collpnts_pre[[x]][collpnts_pre[[x]]==2])
  three <-length(collpnts_pre[[x]][collpnts_pre[[x]]==3])
  
  zero.p <- length(collpnts_post[[x]][collpnts_post[[x]]==0])
  one.p <-length(collpnts_post[[x]][collpnts_post[[x]]==1])
  two.p <-length(collpnts_post[[x]][collpnts_post[[x]]==2])
  three.p <-length(collpnts_post[[x]][collpnts_post[[x]]==3])
  
  pre2post <- matrix(c(zero,
    one,two,three,zero.p,
    one.p,two.p,three.p),
    nrow=2, byrow=TRUE)
  
  pre2post
  }
)

chitest <- do.call(rbind,anovatest)

#chitest[chitest$Pval<0.05,]
# 34 are signficantly different as you'd expect. The pre-distribution should have more 1s while the post should have more 2s.
```


#AUC or BIC from models?
```{r}
library(ENMeval)

exploreorder <- lapply(1:48, function(x){
  whatorder <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x,"/species_samplePredictions.csv", sep=""))
})

# are the Explore a list of betamultipliers [1,2,3,4,5] with 5 species done by species or by beta multplier?
# 6 species and 8 beta values [6, 8, 10, 12, 14, 16, 18, 20]

orderiswhat <- apply(expand.grid(1:6,1:48), 1, function(x){
  out <- data.frame(t(x),sameno = identical(exploreorder[[ x[1] ]]$X, exploreorder[[ x[2] ]]$X))
  out
})

orderis <- do.call(rbind,orderiswhat)

library(jpeg)

matched <- orderis[orderis$sameno == TRUE & orderis$Var1 != orderis$Var2,]

unique(matched$Var1)

## Look at how response curves compare
for(i in 1:6){
  x <- matched$Var2[matched$Var1 == i]
  
  for(y in 1:(length(x)-2)){
  
    file.rename(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x[y],"/responseCurves/all_response_curves.jpg",sep=""),
                paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/CompareImages/response_curves",i,"_",x[y],".jpg",sep=""))
    
 # jpeg(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/CompareImages/response_curves",i,"_",x[y],".jpg",sep=""))
    
 # print(readJPEG(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x[y],"/responseCurves/all_response_curves.jpg",sep="")))
    
    }

}



identical(exploreorder[[1]]$X, exploreorder[[2]]$X) # the first and 6th, so it goes through one beta value for the 5 species then then the next beta value...
match(exploreorder[[2]]$X, exploreorder[[7]]$X) 

#training samples

trainingsamples <- lapply(1:10, function(x){
  ts <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_1/cvSplit",x,"/trainingSamples.csv", sep=""))
  ts
})

head(trainingsamples[[1]])


#samplePredictions 
sampPred <- lapply(1:5, function(x){
  sp <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x,"/species_samplePredictions.csv", sep=""))
  sp
})

#omission
omm <- lapply(1:5, function(x){
  om <- read.csv(paste("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_ArcMap_Projects/Alpine_Phenology_2/Species_SEINet/PRISM_pre1980_current_beta1/Maxent_",x,"/species_omission.csv", sep=""))
  om
})

head(sampPred[[1]])

boxplot(sampPred[[1]]$Raw.prediction, col="red")

density(sampPred[[1]]$Cumulative.prediction)

library(dismo)
e <- evaluate(p=sampPred[[1]]$Raw.prediction, a=omm[[1]]$Raw.value)

density(e)
plot(e, 'ROC')

```





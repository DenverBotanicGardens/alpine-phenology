---
title: "Results"
author: "Michelle DePrenger-Levin"
date: "January 18, 2016"
output: html_document
---

Data without growing degree days or monthly precipitation
```{r}

library(RCurl)
library(ggplot2)
library(data.table)
library(raster)
require(rgdal)
library(devtools)

bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/DenverBotanicGardens/alpine-phenology/master/QR_final_R_plant_climate_data_2.csv"))

head(bloom)
```

Snowmelt data or time at which heating degree days reach a certain point per year
download of prism data in 'Climate.Rmd'
```{r}
tbase <- 0

HDD.0 <- sapply(unique(tmps$Year), function(year){
  sapply(grep(year, tmps$Year), function(x){
    if( (((tmps$tmax[x] + tmps$tmin[x])/2)-tbase) < tbase){
      0
      } else {
        ((tmps$tmax[x] + tmps$tmin[x])/2)-tbase
        }
    })
  })

# now have daily HDD, need to cumsum each year, which is each list. 
head(HDD.0)

HDD.0.yrs <- lapply(HDD.0, function(x){
  cumsum(x)
})

head(HDD.0.yrs[[1]])
HDD.0.all <- do.call(c,HDD.0.yrs)
tmps.0 <- tmps
tmps.0$HDD.0 <- HDD.0.all
```

```{r}
#day of first HDD value > 0
first.hdd <- do.call(rbind,lapply(unique(tmps.0$Year), function(x){
  t.0 <- tmps.0[tmps.0$Year == x,]
  do.call(rbind, lapply(split(t.0, t.0$HDD.0), head, 1))[2,]
}))

  
ggplot(first.hdd, aes(Year,Julian))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="First non-zero HDD")+
  xlab("Year")+
  ylab("Degrees Celsius")

summary(lm(Julian~Year, data=first.hdd))
```



test reading in 
read.table(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data/Black Mesa 11580 2013-2016.txt"),skip=7,header=TRUE,sep=",")

####Get snow pack depth 
```{r}
files <- list.files(path="Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data", pattern="*.txt", full.names=TRUE, recursive = FALSE)

snotel <- lapply(files, function(x){
  t<-read.table(path.expand(x),skip=9, header=FALSE,sep=",", na.strings = " ")
  header <- scan(x,skip=7,nlines=1, what=character(),sep=",")
  header2 <- scan(x,skip=8,nlines=1,what=character(),sep=",")
  names(t)<-paste(header,header2,sep=" ")
  t
})

snotel.all <- do.call(rbind,snotel)
head(snotel.all)
```

```{r}
snowdepth <- grep("Depth", names(snotel.all))

avg.snowdepth <- aggregate(snotel.all[,c(1,snowdepth)],
          by=list(snotel.all$'Water Year '), function(x) mean(x, na.rm=TRUE)) 

long.avg.snow <- reshape(avg.snowdepth[,-1], direction="long", 
                         varying= c(names(avg.snowdepth[,-c(1:2)])),
                         timevar = "Month",
                         times= names(avg.snowdepth[,-c(1:2)]),
                         idvar = "Water Year ",
                         v.names = "Snow.Depth",
                         new.row.names = 1:(nrow(avg.snowdepth)*(length(avg.snowdepth)-2))) 
head(long.avg.snow)
names(long.avg.snow) <- c("Year","Month","Snow.Depth")

```

```{r}
ggplot(long.avg.snow, aes(Year, Snow.Depth, colour = Month))+
  geom_line()+
#  geom_hline(yintercept="mean")+
  facet_wrap(~Month)+
  geom_smooth(method = "lm")


```

Snow report generator http://wcc.sc.egov.usda.gov/reportGenerator/
```{r}
snow <- read.table(path.expand("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data 2/Monthly19782016_over3200m.txt"),
                   skip=7, header=FALSE,sep=",", na.strings = " ")


header <- scan("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data 2/Monthly19782016_over3200m.txt",skip=5,nlines=1, what=character(),sep=",")
header2 <- scan("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_QGIS Projects/Alpine Phenology Project/Snowpack Data 2/Monthly19782016_over3200m.txt",skip=6,nlines=1,what=character(),sep=",")
names(snow)<-paste(header,header2,sep="_")

head(snow)
```

sum of snow? 
```{r}
#average over all stations per year
avg.p.yr <- do.call(rbind,lapply(split(snow[,grep("_Snow Depth", names(snow))], 
                                       snow$`Water Year_`), 
                                 function(x) colMeans(x, na.rm = TRUE)))

snow.total <- rowSums(avg.p.yr,na.rm = TRUE)

head(snow)
snow.total

snow1 <- snow.total[snow.total>0]
snow2 <- data.frame(year = 1997:2016, depth = snow1)

ggplot(snow2, aes(year,depth))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Snow depth")+
  xlab("Year")+
  ylab("Total snow depth (cm)")

```


Reformat snow data:
```{r}
snow.depth <- grep("Mean Monthly", names(snow))
avg.snow <- aggregate(snow[,c(3,snow.depth)], by=list(snow$`Water Year_`),
                      function(x) mean(x,na.rm=TRUE))
snow.long <- reshape(avg.snow[,-1], direction="long",
                     varying=c(names(avg.snow[,-c(1:2)])),
                     timevar="Month",
                     times=names(avg.snow[,-c(1:2)]),
                     idvar="Water Year_",
                     v.names="Snow.Depth",
                     new.row.names = 1:(nrow(avg.snow)*(length(avg.snow)-2)))

tail(snow.long)
snow.long$Month <- factor(snow.long$Month, levels = unique(snow.long$Month))
levels(snow.long$Month)
names(snow.long) <- c("Year","Month","Snow.Depth")
sort(unique(snow.long$Year[complete.cases(snow.long)]))

```

```{r}
ggplot(snow.long[complete.cases(snow.long),], aes(Year, Snow.Depth, colour=Month))+
  geom_line()+
  theme_bw()+
  facet_wrap(~Month)+
  geom_smooth(method="lm")

```

```{r}
snow.long <- snow.long[complete.cases(snow.long),]
```

```{r}
names <- unique(snow.long$Month)

lmlist <- lapply(names, function(month){
  summary(lm(Snow.Depth~Year,data=snow.long[snow.long$Month == month,]))
  })

names(lmlist) <- names

```

```{r}
min.dates.snow <- merge(min.dates, avg.snow[avg.snow$`Water Year_` > 1996,], by.x="Year",
                        by.y=names(snow)[3])

```

```{r}
maysnow <- JulBloomDate.subset("May_Mean Monthly Snow Depth (cm)",min.dates.snow)

maysnow.sig <- maysnow[maysnow$p.value < 0.05,]

maysnow.min <- min.dates[min.dates$Scientific.Name %in% maysnow.sig$Species,]
nrow(maysnow.min) #2375

head(maysnow.min)

```

```{r}
ggplot(min.dates.snow, aes(Year,startDayOfYear))+
   geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

```


```{r}
ggplot(min.dates.snow, aes(`May_Mean Monthly Snow Depth (cm)`,startDayOfYear))+
   geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("May snow depth")+
  ylab("Julian Date")

summary(lm(startDayOfYear~min.dates.snow$'May_Mean Monthly Snow Depth (cm)',
           data = min.dates.snow))

```


NPN data downloaded by Mary
```{r}
npn <- read.csv(path.expand("Q:/Research/Projects/alpine-phenology/Alpine spp. NPN download 2016-01-26/Alpine Species NPN data download.csv"))

head(npn)
table(npn$Common_Name,npn$First_Yes_Year)
table(npn$Genus,npn$State)

npn.CO <- npn[npn$State == "CO",]
table(npn.CO$Common_Name,npn.CO$First_Yes_Year)

npn.CO.alpine <- npn.CO[npn.CO$Elevation_in_Meters > 3199,]
# No collections from alpine sites.
table(npn.CO.alpine$Common_Name,npn.CO.alpine$First_Yes_Year)

```

Find earliest bloom date per year per species (to match the herbarium specimens)    for all collections across their range

```{r}
npn.first <- lapply(unique(npn$Common_Name), function(x){
  this.species <- npn[npn$Common_Name == x,]
  these.rows <- aggregate(First_Yes_DOY~First_Yes_Year, this.species, FUN=min)
  unique(merge(this.species,these.rows,by=c("First_Yes_Year","First_Yes_DOY")))
})

npn.first.dates <- do.call(rbind, npn.first)

table(npn.first.dates$Common_Name,npn.first.dates$First_Yes_Year)
npn.first.dates[npn.first.dates$Common_Name == "Colorado blue columbine",]
```

```{r}
ggplot(npn.first.dates, aes(First_Yes_Year,First_Yes_DOY))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab("Degrees Celsius")

summary(lm(Avg_Hi~Year, data=min.dates))

```



